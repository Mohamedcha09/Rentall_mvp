{% extends "base.html" %}
{% block content %}

<style>
/* --------------------------
   HEADER + SEARCH ICON
-------------------------- */
.inbox-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}

.inbox-title {
  font-size: 28px;
  font-weight: 700;
  color: #222;
}

.search-icon-btn {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 1px solid #ddd;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 18px;
  background: #fff;
  cursor: pointer;
}

/* --------------------------
   AIRBNB SEARCH OVERLAY
-------------------------- */
.search-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(4px);
  display: none;
  opacity: 0;
  transition: opacity .25s ease;
  z-index: 2000;
}

.search-overlay.active {
  display: block;
  opacity: 1;
}

.search-panel {
  background: #fff;
  padding: 16px;
  border-radius: 18px;
  margin: 20px;
  transform: translateY(-40px);
  opacity: 0;
  transition: all .25s ease;
}

.search-panel.active {
  transform: translateY(0);
  opacity: 1;
}

.search-results-box {
  background: #fff;
  margin: 20px;
  margin-top: 10px;
  padding: 10px;
  border-radius: 14px;
  max-height: 60vh;
  overflow-y: auto;
  display: none;
}

.search-results-box.active {
  display: block;
}

.search-input {
  width: 100%;
  padding: 14px 20px;
  border-radius: 40px;
  border: 1px solid #dcdcdc;
  font-size: 17px;
  background: #f7f7f7;
}

.cancel-search {
  margin-top: 12px;
  text-align: right;
  font-size: 17px;
  color: #ff385c;
  font-weight: 600;
  cursor: pointer;
}

/* --------------------------
   FILTER TABS
-------------------------- */
.msg-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.msg-tabs .tab {
  padding: 8px 18px;
  border-radius: 30px;
  font-size: 15px;
  border: 1px solid #ddd;
  cursor: pointer;
  background: #fff;
  color: #444;
  transition: .25s;
}

.msg-tabs .tab.active {
  background: linear-gradient(90deg, #8b5cf6, #5b9df9);
  color: #fff;
  border-color: transparent;
}

/* --------------------------
   THREAD LIST
-------------------------- */
.thread-row {
  display: flex;
  align-items: center;
  padding: 14px 10px;
  border-bottom: 1px solid #eee;
  gap: 14px;
  text-decoration: none;
  color: inherit;
}

.item-preview {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  overflow: hidden;
  position: relative;
}

.item-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.small-avatar {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 3px solid white;
  overflow: hidden;
  background: white;
  z-index: 10;
}

.msg-title { font-size: 17px; font-weight: 600; }
.msg-sub { font-size: 14px; color: #666; }
.msg-date { margin-left: auto; font-size: 13px; color: #777; }

/* Badge for ticket count */
.badge {
  background: #ff3b5c;
  color: white;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 12px;
  margin-left: 6px;
  font-weight: 600;
}

</style>

<!-- HEADER -->
<div class="inbox-header">
  <div class="inbox-title">Messages</div>
  <div class="search-icon-btn" id="openSearch">üîç</div>
</div>

<!-- FILTER TABS -->
<div class="msg-tabs">
  <div class="tab active" data-filter="all">Tout</div>

  <div class="tab" data-filter="support">
    <img src="/static/img/sevor-logo.png"
         style="width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-right:6px;">
    Soutien Sevor

    {% if tickets_count > 0 %}
    <span class="badge">{{ tickets_count }}</span>
    {% endif %}
  </div>
</div>

<!-- THREADS LIST -->
<div id="threadsContainer">

  <!-- ALWAYS SHOW SUPPORT BOT FIRST -->
  <a href="/chatbot" class="thread-row">

    <div class="item-preview">
      <img src="/static/img/sevor-logo.png">
    </div>

    <div class="flex-grow-1 text-zone">
      <div class="msg-title">
        Soutien Sevor
        {% if tickets_count > 0 %}
        <span class="badge">{{ tickets_count }}</span>
        {% endif %}
      </div>
      <div class="msg-sub">Contactez le support Sevor</div>
    </div>

    <div class="msg-date">Maintenant</div>
  </a>

  <!-- SUPPORT TICKETS LIST -->
  {% for t in support_tickets %}
  <a href="/support/ticket/{{ t.id }}" class="thread-row" style="border-left: 4px solid #8b5cf6;">

    <div class="item-preview">
      <img src="/static/img/sevor-logo.png">
    </div>

    <div class="flex-grow-1 text-zone">
      <div class="msg-title">Ticket #{{ t.id }}</div>
      <div class="msg-sub">{{ t.subject or 'Support Request' }}</div>
    </div>

    <div class="msg-date">{{ t.updated_at.strftime("%d-%m-%Y") }}</div>

  </a>
  {% endfor %}

  <!-- NORMAL USER THREADS -->
  {% for t in threads %}
  <a href="/messages/{{ t.id }}" class="thread-row">

    <div class="item-preview">
      <img src="{{ t.item_image }}">
      <div class="small-avatar">
        <img src="{{ t.other_avatar }}">
      </div>
    </div>

    <div class="flex-grow-1 text-zone">
      <div class="msg-title">{{ t.other_fullname }}</div>
      {% if t.item_title %}
      <div class="msg-sub">{{ t.item_title }}</div>
      {% endif %}
      {% if t.last_message_text %}
      <div class="msg-sub">{{ t.last_message_text }}</div>
      {% endif %}
    </div>

    <div class="msg-date">{{ t.last_message_at.strftime("%d-%m-%Y") }}</div>

  </a>
  {% endfor %}

</div>

<!-- SEARCH OVERLAY -->
<div class="search-overlay" id="searchOverlay">
  <div class="search-panel" id="searchPanel">
    <input id="searchInput" class="search-input" placeholder="Search messages‚Ä¶">
    <div class="cancel-search" id="cancelSearch">Annuler</div>
  </div>

  <div class="search-results-box" id="searchResults"></div>
</div>

<script>
const overlay = document.getElementById("searchOverlay");
const panel = document.getElementById("searchPanel");
const resultsBox = document.getElementById("searchResults");
const openBtn = document.getElementById("openSearch");
const cancelBtn = document.getElementById("cancelSearch");
const input = document.getElementById("searchInput");

const items = document.querySelectorAll(".normal-card");

/* SEARCH LOGIC */
input.addEventListener("input", () => {
  const q = input.value.toLowerCase().trim();
  resultsBox.innerHTML = "";
  if (!q) {
    resultsBox.classList.remove("active");
    return;
  }

  let found = 0;

  document.querySelectorAll(".thread-row").forEach(row => {
    if (row.innerText.toLowerCase().includes(q)) {
      found++;

      const clone = document.createElement("div");
      clone.className = "thread-row";
      clone.innerHTML = row.innerHTML;
      clone.onclick = () => window.location = row.href;
      resultsBox.appendChild(clone);
    }
  });

  if (found > 0) resultsBox.classList.add("active");
  else resultsBox.classList.remove("active");
});

/* FILTER TABS */
const tabs = document.querySelectorAll(".tab");

tabs.forEach(tab => {
  tab.onclick = () => {
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");

    const filter = tab.dataset.filter;

    if (filter === "all") {
      document.querySelectorAll(".thread-row").forEach(r => r.style.display = "flex");
    }

    else if (filter === "support") {
      document.querySelectorAll(".thread-row").forEach(r => r.style.display = "none");
      document.querySelectorAll(".thread-row")[0].style.display = "flex"; // bot
      {% for t in support_tickets %}
      document.querySelectorAll(".thread-row")[{{ loop.index }}].style.display = "flex";
      {% endfor %}
    }
  };
});
</script>

{% endblock %}
