{% extends "base.html" %}

{% block content %}

<!-- ============================
   ÿ•ÿÆŸÅÿßÿ° ÿπŸÜÿßÿµÿ± ÿßŸÑŸáÿßÿ™ŸÅ ŸÅŸÇÿ∑
============================ -->
<style>
@media (max-width: 768px) {

  /* Hide all navigation bars on mobile */
  header.topbar,
  .m-top-tabs,
  nav.desk-tabs,
  .mobile-tabbar,
  .searchbar,
  .stripe-callout,
  .stripe-connect-banner,
  .payout-banner,
  .connect-banner {
      display: none !important;
  }

  body.has-tabbar {
      padding-bottom: 0 !important;
  }
}
</style>

<style>
/* ================================
   ÿÆŸÑŸÅŸäÿ© ŸÜÿßÿπŸÖÿ© ŸÖÿ´ŸÑ Airbnb
================================ */
body {
    background: #f7f7fb !important;
}

/* ÿßŸÑÿ≠ÿßŸàŸäÿ© */
.container, form {
    background: transparent !important;
}

/* ================================
   ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ©
================================ */
h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 18px;
    color: #1c1c1e;
}

/* ================================
   ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ ‚Äî Airbnb Style
================================ */
.form-control, .form-select, textarea {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    border-radius: 16px !important;
    padding: 14px 16px !important;
    font-size: 16px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    transition: all .25s ease;
}

.form-control:focus, .form-select:focus, textarea:focus {
    border-color: #8b5cf6 !important;
    box-shadow: 0 0 0 3px rgba(139,92,246,0.15) !important;
    outline: none !important;
}

/* ================================
   ŸÑŸäÿ®ŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ
================================ */
.form-label {
    font-size: 15px;
    font-weight: 600;
    color: #2c2c2e;
    margin-bottom: 6px;
}

/* ================================
   ÿ≤ÿ± Use my location
================================ */
#useMyLocNew {
    border-radius: 14px !important;
    padding: 6px 12px !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    background: #fff !important;
    font-size: 14px;
}

#useMyLocNew:active {
    transform: scale(0.96);
}

/* ================================
   ÿ≤ÿ±ÿßÿ± Save ‚Äî Airbnb Purple
================================ */
.btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #5b9df9) !important;
    border: none !important;
    padding: 14px 22px !important;
    border-radius: 14px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    width: 100%;
    margin-top: 10px;
    box-shadow: 0 4px 16px rgba(139,92,246,0.25);
    transition: all .2s ease;
}

.btn-primary:active {
    transform: scale(0.97);
}

/* ================================
   ÿ≤ÿ± Back
================================ */
.btn-outline-light {
    border-radius: 14px !important;
    padding: 12px 18px !important;
    font-size: 15px !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    background: #fff !important;
}

/* ================================
   ÿßŸÑÿ¥ÿ±ÿ≠ ÿ™ÿ≠ÿ™ ÿßŸÑÿ≠ŸÇŸàŸÑ
================================ */
.text-muted {
    color: #6b7280 !important;
    font-size: 13px !important;
}

/* ================================
   City Suggestions Glass
================================ */
#cityNewSuggest {
    background: rgba(255,255,255,0.82) !important;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-radius: 14px !important;
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 8px 18px rgba(0,0,0,0.06);
}

.city-row:hover {
    background: rgba(139,92,246,0.08);
}

/* ================================
   ÿßŸÑŸáŸàÿßŸÖÿ¥ ‚Äî ÿ¥ŸÉŸÑ ÿ£ŸÜŸäŸÇ
================================ */
.mb-3 {
    margin-bottom: 22px !important;
}

/* ================================
   ÿ™ÿ≠ÿ≥ŸäŸÜ spacing ÿπŸÑŸâ ÿßŸÑŸáÿßÿ™ŸÅ
================================ */
@media (max-width: 768px){
  h2 {
      margin-top: 12px;
      padding-left: 4px;
  }

  form {
      padding: 0 6px;
  }
}
</style>


<!-- ============================
   BACK BUTTON ‚Äî iOS Floating
============================ -->
<style>
.back-floating {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 14px);
    left: 16px;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(255,255,255,0.90);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    z-index: 9999;
    color: #333;
}
@media (min-width: 769px){
  .back-floating { display:none; }
}

.btn-primary {
    margin-bottom: 40px !important;
}

/* Image Upload ‚Äî Airbnb Style */
.upload-box {
    background: #ffffff;
    border: 1px dashed rgba(0,0,0,0.2);
    border-radius: 18px;
    padding: 28px;
    text-align: center;
    cursor: pointer;
    transition: .25s ease;
    color: #444;
}

.upload-box:hover {
    background: #f3f1ff;
    border-color: #8b5cf6;
}

.upload-box i {
    font-size: 34px;
    color: #8b5cf6;
    margin-bottom: 8px;
}

#realFileInput {
    display: none;
}

.mb-3 { margin-bottom: 25px !important; }

</style>


<h2>Add New Item</h2>

<a href="/" class="back-floating"><i class="bi bi-chevron-left"></i></a>

<form method="post" enctype="multipart/form-data" id="newItemForm">

<div class="mb-3">
  <label class="form-label">Title</label>
  <input type="text" name="title" class="form-control" placeholder="Enter a clear title‚Ä¶" required>
</div>




<!-- Category -->
<div class="mb-3">
  <label class="form-label">Category</label>
  <select class="form-select" name="category" required>
    {% for cat in categories %}
      <option value="{{ cat.key }}">{{ cat.label }}</option>
    {% endfor %}
  </select>
</div>

<!-- Description -->
<div class="mb-3">
  <label class="form-label">Description</label>
  <textarea name="description" class="form-control" rows="4" required></textarea>
</div>

<div class="row">
  <!-- City -->
  <div class="col-md-6 mb-3 position-relative">
    <label class="form-label">City</label>

    <input type="text" name="city" id="cityNew" class="form-control" placeholder="Type the city / area‚Ä¶" autocomplete="off" required>

    <div id="cityNewSuggest" class="border rounded mt-1 bg-white shadow-sm"
         style="display:none; position:absolute; z-index:1000; max-height:260px; overflow:auto; inset-inline:0;"></div>

    <div class="d-flex gap-2 mt-2">
      <button type="button" id="useMyLocNew" class="btn btn-outline-secondary btn-sm">üìç Use my location</button>
      <input type="number" id="radiusNew" class="form-control form-control-sm" style="max-width:110px"
             placeholder="km" value="25" min="1">
    </div>

    <small class="text-muted d-block mt-1">Pick a city or use your location ‚Äî coordinates saved automatically.</small>

    <input type="hidden" name="latitude" id="latNew">
    <input type="hidden" name="longitude" id="lngNew">
  </div>

  <!-- Price -->
  <div class="col-md-3 mb-3">
    <label class="form-label">Price / day</label>
    <input type="number" name="price" class="form-control" value="0" min="0" step="0.01" required>
    <small class="text-muted">Amount the owner sets.</small>
  </div>

<!-- Currency -->
<div class="col-md-3 mb-3">
    <label class="form-label">Currency</label>
    <select class="form-select" name="currency" required>
      <option value="CAD">CAD</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <small class="text-muted">Listing currency.</small>
</div>   <!-- ‚Üê ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸáŸÖ ÿ¨ÿØÿßŸã -->

<!-- Upload Image -->
<div class="mb-3">
  <label class="form-label">Image</label>

  <div class="upload-box" onclick="document.getElementById('realFileInput').click()">
      <i class="bi bi-cloud-arrow-up"></i>
      <div class="mt-2">Upload Image</div>
  </div>

  <input id="realFileInput" type="file" name="image" accept=".jpg,.jpeg,.png" required>
</div>

</div>


<button class="btn btn-primary">Save</button>

</form>

{% endblock %}

{% block scripts %}
<script>
/* ===== GPS button ===== */
(function(){
  const btn = document.getElementById('useMyLocNew');
  const latEl = document.getElementById('latNew');
  const lngEl = document.getElementById('lngNew');
  const radEl = document.getElementById('radiusNew');

  function setCookie(name, value, days=180){
    try{
      const d=new Date(); d.setTime(d.getTime()+days*864e5);
      document.cookie = name+"="+encodeURIComponent(value||"")+";expires="+d.toUTCString()+";path=/;SameSite=Lax";
    }catch(_){}
  }

  btn?.addEventListener('click', function(){
    if(!navigator.geolocation){ alert('Your browser does not support geolocation.'); return; }
    const r = radEl?.value || "25";
    navigator.geolocation.getCurrentPosition(function(pos){
      const {latitude, longitude} = pos.coords;
      latEl.value = latitude;
      lngEl.value = longitude;
      setCookie('radius_km', r);
      alert('Location saved.');
    }, function(){ alert('Could not get your location.'); });
  });
})();

/* ===== Autocomplete ===== */
(function cityNewAutocomplete(){
  const input = document.getElementById('cityNew');
  const panel = document.getElementById('cityNewSuggest');
  const latEl = document.getElementById('latNew');
  const lonEl = document.getElementById('lngNew');

  if(!input || !panel) return;

  let tm=null, lastList=[], active=-1;

  function detectLang(q){
    const s = (q||'').trim();
    if (/[\u0600-\u06FF]/.test(s)) return 'ar';
    const hasFr = /[√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø≈ì√¶]/i.test(s);
    const frW = /\b(le|la|les|de|des|du|aux|√†|sur)\b/i.test(s);
    const enW = /\b(new|city|usa|uk|state)\b/i.test(s);
    if (hasFr || frW) return 'fr';
    if (enW) return 'en';
    return 'en';
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c =>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function hide(){ panel.style.display='none'; panel.innerHTML=''; active=-1; lastList=[]; }
  function show(){ panel.style.display='block'; }

  async function query(q){
    const lang = detectLang(q);
    const url = 'https://nominatim.openstreetmap.org/search'
              + '?format=json&addressdetails=1&limit=30&accept-language='+lang
              + '&q='+encodeURIComponent(q);
    const r = await fetch(url);
    if(!r.ok) return [];
    return await r.json();
  }

  function render(list){
    if(!list.length){ hide(); return; }
    lastList = list.slice(0,8);
    panel.innerHTML =
      '<div class="px-2 py-1 small text-muted border-bottom">Cities/Areas</div>' +
      lastList.map((p,i)=>`
        <div class="py-2 px-2 d-flex gap-2 city-row" data-i="${i}" style="cursor:pointer">
          <i class="bi bi-geo-alt"></i>
          <div>
            <div>${esc(p.display_name)}</div>
            <div class="text-muted small">lat ${esc(p.lat)} ‚Äî lon ${esc(p.lon)}</div>
          </div>
        </div>
      `).join('');
    show();
    active=-1;
  }

  function pick(i){
    const p = lastList[i]; if(!p) return;
    input.value = p.display_name;
    latEl.value = p.lat;
    lonEl.value = p.lon;
    hide();
  }

  input.addEventListener('input', function(){
    clearTimeout(tm);
    const q = input.value.trim();
    latEl.value = ''; lonEl.value = '';
    if(q.length < 2){ hide(); return; }
    tm = setTimeout(async()=>{
      try{ render(await query(q)); }
      catch(_){ hide(); }
    }, 220);
  });

  panel.addEventListener('click', e=>{
    const row = e.target.closest('.city-row');
    if(row) pick(Number(row.dataset.i));
  });

})();
</script>
{% endblock %}
