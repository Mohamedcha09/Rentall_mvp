{% extends "base.html" %}

{% block content %}

<!-- ============================
   Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‡Ø§ØªÙ ÙÙ‚Ø·
============================ -->
<style>
@media (max-width: 768px) {

  /* Hide all navigation bars on mobile */
  header.topbar,
  .m-top-tabs,
  nav.desk-tabs,
  .mobile-tabbar,
  .searchbar,
  .stripe-callout,
  .stripe-connect-banner,
  .payout-banner,
  .connect-banner {
      display: none !important;
  }

  body.has-tabbar {
      padding-bottom: 0 !important;
  }
}
</style>

<style>
/* ================================
   Ø®Ù„ÙÙŠØ© Ù†Ø§Ø¹Ù…Ø© Ù…Ø«Ù„ Airbnb
================================ */
body {
    background: #f7f7fb !important;
}

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
.container, form {
    background: transparent !important;
}

/* ================================
   Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
================================ */
h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 18px;
    color: #1c1c1e;
}

/* ================================
   Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ â€” Airbnb Style
================================ */
.form-control, .form-select, textarea {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    border-radius: 16px !important;
    padding: 14px 16px !important;
    font-size: 16px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    transition: all .25s ease;
}

.form-control:focus, .form-select:focus, textarea:focus {
    border-color: #8b5cf6 !important;
    box-shadow: 0 0 0 3px rgba(139,92,246,0.15) !important;
    outline: none !important;
}

/* ================================
   Ù„ÙŠØ¨Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„
================================ */
.form-label {
    font-size: 15px;
    font-weight: 600;
    color: #2c2c2e;
    margin-bottom: 6px;
}

/* ================================
   Ø²Ø± Use my location
================================ */
#useMyLocNew {
    border-radius: 14px !important;
    padding: 6px 12px !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    background: #fff !important;
    font-size: 14px;
}

#useMyLocNew:active {
    transform: scale(0.96);
}

/* ================================
   Ø²Ø±Ø§Ø± Save â€” Airbnb Purple
================================ */
.btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #5b9df9) !important;
    border: none !important;
    padding: 14px 22px !important;
    border-radius: 14px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    width: 100%;
    margin-top: 10px;
    box-shadow: 0 4px 16px rgba(139,92,246,0.25);
    transition: all .2s ease;
}

.btn-primary:active {
    transform: scale(0.97);
}

/* ================================
   Ø²Ø± Back
================================ */
.btn-outline-light {
    border-radius: 14px !important;
    padding: 12px 18px !important;
    font-size: 15px !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    background: #fff !important;
}

/* ================================
   Ø§Ù„Ø´Ø±Ø­ ØªØ­Øª Ø§Ù„Ø­Ù‚ÙˆÙ„
================================ */
.text-muted {
    color: #6b7280 !important;
    font-size: 13px !important;
}


.city-row:hover {
    background: rgba(139,92,246,0.08);
}

/* ================================
   Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ â€” Ø´ÙƒÙ„ Ø£Ù†ÙŠÙ‚
================================ */
.mb-3 {
    margin-bottom: 22px !important;
}

/* ================================
   ØªØ­Ø³ÙŠÙ† spacing Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
================================ */
@media (max-width: 768px){
  h2 {
      margin-top: 12px;
      padding-left: 4px;
  }

  form {
      padding: 0 6px;
  }
}
</style>


<!-- ============================
   BACK BUTTON â€” iOS Floating
============================ -->
<style>
.back-floating {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 14px);
    left: 16px;
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: rgba(255,255,255,0.90);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    z-index: 9999;
    color: #333;
}
@media (min-width: 769px){
  .back-floating { display:none; }
}

.btn-primary {
    margin-bottom: 40px !important;
}

/* Image Upload â€” Airbnb Style */
.upload-box {
    background: #ffffff;
    border: 1px dashed rgba(0,0,0,0.2);
    border-radius: 18px;
    padding: 28px;
    text-align: center;
    cursor: pointer;
    transition: .25s ease;
    color: #444;
}

.upload-box:hover {
    background: #f3f1ff;
    border-color: #8b5cf6;
}

.upload-box i {
    font-size: 34px;
    color: #8b5cf6;
    margin-bottom: 8px;
}

#realFileInput {
    display: none;
}

.mb-3 { margin-bottom: 25px !important; }

</style>

<style>
#cityNewSuggest {
    position: absolute;
    top: calc(100% + 4px); /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ */
    left: 0;
    right: 0;

    z-index: 999999;

    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);

    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 8px 18px rgba(0,0,0,0.06);

    max-height: 260px;
    overflow-y: auto;
    display: none;
}
</style>


<style>
form {
    position: relative;
    z-index: 10;
    padding-bottom: 80px;
}
</style>



<h2>Add New Item</h2>

<a href="/" class="back-floating"><i class="bi bi-chevron-left"></i></a>

<form method="post" enctype="multipart/form-data" id="newItemForm">

<div class="mb-3">
  <label class="form-label">Title</label>
  <input type="text" name="title" class="form-control" placeholder="Enter a clear titleâ€¦" required>
</div>




<!-- Category -->
<div class="mb-3">
  <label class="form-label">Category</label>
  <select class="form-select" name="category" required>
    {% for cat in categories %}
      <option value="{{ cat.key }}">{{ cat.label }}</option>
    {% endfor %}
  </select>
</div>

<!-- Description -->
<div class="mb-3">
  <label class="form-label">Description</label>
  <textarea name="description" class="form-control" rows="4" required></textarea>
</div>

<div class="row">
  <!-- City -->
  <div class="col-md-6 mb-3 position-relative">
    <label class="form-label">City</label>

    <input type="text" name="city" id="cityNew" class="form-control" placeholder="Type the city / areaâ€¦" autocomplete="off" required>

    <div id="cityNewSuggest"></div>

    <div class="d-flex gap-2 mt-2">
      <button type="button" id="useMyLocNew" class="btn btn-outline-secondary btn-sm">ğŸ“ Use my location</button>
      <input type="number" id="radiusNew" class="form-control form-control-sm" style="max-width:110px"
             placeholder="km" value="25" min="1">
    </div>

    <small class="text-muted d-block mt-1">Pick a city or use your location â€” coordinates saved automatically.</small>

    <input type="hidden" name="latitude" id="latNew">
    <input type="hidden" name="longitude" id="lngNew">
  </div>

  <!-- Price -->
  <div class="col-md-3 mb-3">
    <label class="form-label">Price / day</label>
    <input type="number" name="price" class="form-control" value="0" min="0" step="0.01" required>
    <small class="text-muted">Amount the owner sets.</small>
  </div>

<!-- Currency -->
<div class="col-md-3 mb-3">
    <label class="form-label">Currency</label>
    <select class="form-select" name="currency" required>
      <option value="CAD">CAD</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <small class="text-muted">Listing currency.</small>
</div>   <!-- â† Ø¥ØºÙ„Ø§Ù‚ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ -->

<!-- Upload Images (up to 10) -->
<div class="mb-3">
  <label class="form-label">Images (up to 10)</label>

  <div class="upload-box" onclick="document.getElementById('realFileInput').click()">
      <i class="bi bi-cloud-arrow-up"></i>
      <div class="mt-2">Upload Images</div>
      <div class="text-muted mt-1 small">You can select up to 10 images</div>
  </div>

  <input id="realFileInput" type="file" name="images" accept=".jpg,.jpeg,.png,.webp"
         multiple style="display:none">

  <!-- Preview -->
  <div id="previewContainer" class="mt-3 d-flex flex-wrap gap-2"></div>
</div>


</div>


<button class="btn btn-primary">Save</button>

</form>

{% endblock %}

{% block scripts %}

<script>
(function(){

  const input = document.getElementById("cityNew");
  const panel = document.getElementById("cityNewSuggest");
  const latEl = document.getElementById("latNew");
  const lngEl = document.getElementById("lngNew");

  if (!input) return;

  let timer = null;

  function hide(){
    panel.style.display = "none";
    panel.innerHTML = "";
  }

  function show(){
    panel.style.display = "block";
  }

  const pickName = p => {
    const a = p.address || {};
    return a.city || a.town || a.village || a.municipality ||
           (p.display_name || '').split(",")[0].trim();
  };

  const unique = list => {
    const map = new Map();
    for (const p of list) {
      const a = p.address || {};
      const cc = (a.country_code || "").toLowerCase();
      const name = pickName(p);
      if (!name || !a.country) continue;
      if (!map.has(cc)) {
        map.set(cc, {
          city: name,
          country: a.country,
          lat: p.lat,
          lon: p.lon
        });
      }
    }
    return [...map.values()];
  };

  input.addEventListener("input", function(){
    clearTimeout(timer);

    const q = input.value.trim();
    latEl.value = "";
    lngEl.value = "";

    if (q.length < 2){
      hide();
      return;
    }

    timer = setTimeout(async ()=>{

      try {
        const res = await fetch(
          "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=30&q=" 
          + encodeURIComponent(q)
        );

        if (!res.ok){
          hide();
          return;
        }

        const data = await res.json();

        const filtered = data.filter(x =>
          ["city","town","village","municipality"].includes((x.type || "").toLowerCase())
        );

        const list = unique(filtered);
        if (!list.length){
          hide();
          return;
        }

        panel.innerHTML =
          `<div class="px-2 py-1 small text-muted border-bottom">Cities</div>` +
          list.map((n,i)=>
            `<div class="py-2 px-2 d-flex gap-2 city-row" data-i="${i}" style="cursor:pointer">
               <i class="bi bi-geo-alt"></i>
               <div>
                 <div>${n.city}, ${n.country}</div>
                 <div class="text-muted small">lat ${n.lat} â€” lon ${n.lon}</div>
               </div>
             </div>`
          ).join('');

        show();

        panel.querySelectorAll(".city-row").forEach(row=>{
          row.addEventListener("click", ()=>{
            const n = list[row.dataset.i];
            input.value = `${n.city}, ${n.country}`;
            latEl.value = n.lat;
            lngEl.value = n.lon;
            hide();
          });
        });

      } catch(err){
        hide();
      }

    }, 300);
  });

  document.addEventListener("click", (e)=>{
    if (!panel.contains(e.target) && e.target !== input){
      hide();
    }
  });

})();
</script>



<script>
// Preview selected images (max 10)
document.getElementById('realFileInput').addEventListener('change', function(e) {
    const container = document.getElementById('previewContainer');
    container.innerHTML = "";
    const files = [...e.target.files];

    if (files.length > 10) {
        alert("You can upload up to 10 images only.");
        e.target.value = "";
        return;
    }

    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(ev) {
            const img = document.createElement("img");
            img.src = ev.target.result;
            img.style.width = "96px";
            img.style.height = "96px";
            img.style.objectFit = "cover";
            img.style.borderRadius = "12px";
            img.style.boxShadow = "0 2px 6px rgba(0,0,0,0.15)";
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
});
</script>

{% endblock %}
