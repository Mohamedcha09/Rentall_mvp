{% extends "base.html" %}

{% block content %}

<!-- ============================
   ÿ•ÿÆŸÅÿßÿ° ÿπŸÜÿßÿµÿ± ÿßŸÑŸáÿßÿ™ŸÅ ŸÅŸÇÿ∑
============================ -->
<style>
@media (max-width: 768px) {

  /* Hide all navigation bars on mobile */
  header.topbar,
  .m-top-tabs,
  nav.desk-tabs,
  .mobile-tabbar,
  .searchbar,
  .stripe-callout,
  .stripe-connect-banner,
  .payout-banner,
  .connect-banner {
      display: none !important;
  }

  body.has-tabbar {
      padding-bottom: 0 !important;
  }
}
</style>

<style>
/* ================================
   ÿÆŸÑŸÅŸäÿ© ŸÜÿßÿπŸÖÿ© ŸÖÿ´ŸÑ Airbnb
================================ */
body {
    background: #f7f7fb !important;
}

/* ÿßŸÑÿ≠ÿßŸàŸäÿ© */
.container, form {
    background: transparent !important;
}

/* ================================
   ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ©
================================ */
h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 18px;
    color: #1c1c1e;
}

/* ================================
   ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ÿØÿÆÿßŸÑ ‚Äî Airbnb Style
================================ */
.form-control, .form-select, textarea {
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    border-radius: 16px !important;
    padding: 14px 16px !important;
    font-size: 16px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    transition: all .25s ease;
}

.form-control:focus, .form-select:focus, textarea:focus {
    border-color: #8b5cf6 !important;
    box-shadow: 0 0 0 3px rgba(139,92,246,0.15) !important;
    outline: none !important;
}

/* ================================
   ŸÑŸäÿ®ŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ
================================ */
.form-label {
    font-size: 15px;
    font-weight: 600;
    color: #2c2c2e;
    margin-bottom: 6px;
}

/* ================================
   ÿ≤ÿ± Use my location
================================ */
#useMyLocNew {
    border-radius: 14px !important;
    padding: 6px 12px !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    background: #fff !important;
    font-size: 14px;
}

#useMyLocNew:active {
    transform: scale(0.96);
}

/* ================================
   ÿ≤ÿ±ÿßÿ± Save ‚Äî Airbnb Purple
================================ */
.btn-primary {
    background: linear-gradient(135deg, #8b5cf6, #5b9df9) !important;
    border: none !important;
    padding: 14px 22px !important;
    border-radius: 14px !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    width: 100%;
    margin-top: 10px;
    box-shadow: 0 4px 16px rgba(139,92,246,0.25);
    transition: all .2s ease;
}

.btn-primary:active {
    transform: scale(0.97);
}

/* ================================
   ÿ≤ÿ± Back
================================ */
.btn-outline-light {
    border-radius: 14px !important;
    padding: 12px 18px !important;
    font-size: 15px !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
    background: #fff !important;
}

/* ================================
   ÿßŸÑÿ¥ÿ±ÿ≠ ÿ™ÿ≠ÿ™ ÿßŸÑÿ≠ŸÇŸàŸÑ
================================ */
.text-muted {
    color: #6b7280 !important;
    font-size: 13px !important;
}

/* ================================
   City Suggestions Glass
================================ */
#cityNewSuggest {
    background: rgba(255,255,255,0.82) !important;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-radius: 14px !important;
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 8px 18px rgba(0,0,0,0.06);
}

.city-row:hover {
    background: rgba(139,92,246,0.08);
}

/* ================================
   ÿßŸÑŸáŸàÿßŸÖÿ¥ ‚Äî ÿ¥ŸÉŸÑ ÿ£ŸÜŸäŸÇ
================================ */
.mb-3 {
    margin-bottom: 22px !important;
}

/* ================================
   ÿ™ÿ≠ÿ≥ŸäŸÜ spacing ÿπŸÑŸâ ÿßŸÑŸáÿßÿ™ŸÅ
================================ */
@media (max-width: 768px){
  h2 {
      margin-top: 12px;
      padding-left: 4px;
  }

  form {
      padding: 0 6px;
  }
}
</style>


<h2>Add New Item</h2>

<form method="post" enctype="multipart/form-data" id="newItemForm">
  <div class="mb-3">
    <label class="form-label">Title</label>
    <input type="text" name="title" class="form-control" required>
  </div>

  <div class="mb-3">
    <label class="form-label">Category</label>
    <select class="form-select" name="category" required>
      {% for cat in categories %}
        <option value="{{ cat.key }}">{{ cat.label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">Description</label>
    <textarea name="description" class="form-control" rows="4" required></textarea>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3 position-relative">
      <label class="form-label">City</label>

      <!-- City field -->
      <input type="text" name="city" id="cityNew" class="form-control" placeholder="Type the city / area‚Ä¶" autocomplete="off" required>

      <!-- Suggestions list -->
      <div id="cityNewSuggest" class="border rounded mt-1 bg-white shadow-sm"
           style="display:none; position:absolute; z-index:1000; max-height:260px; overflow:auto; inset-inline:0;"></div>

      <!-- GPS + radius (optional) -->
      <div class="d-flex gap-2 mt-2">
        <button type="button" id="useMyLocNew" class="btn btn-outline-secondary btn-sm">üìç Use my location</button>
        <input type="number" id="radiusNew" class="form-control form-control-sm" style="max-width:110px"
               placeholder="km" value="25" min="1">
      </div>
      <small class="text-muted d-block mt-1">Pick a city from the list or use your location. When selected, coordinates are saved automatically.</small>

      <!-- Hidden coordinates -->
      <input type="hidden" name="latitude" id="latNew">
      <input type="hidden" name="longitude" id="lngNew">
    </div>

      <!-- ‚ñº‚ñº ÿßŸÑÿ≥ÿπÿ± + ÿßŸÑÿπŸÖŸÑÿ© ‚ñº‚ñº -->
  <div class="col-md-3 mb-3">
    <label class="form-label">Price / day</label>
    <input type="number" name="price" class="form-control" value="0" min="0" step="0.01" required>
    <small class="text-muted">Amount the owner sets.</small>
  </div>

  <div class="col-md-3 mb-3">
    <label class="form-label">Currency</label>
    <select class="form-select" name="currency" required>
      <option value="CAD">CAD</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
    <small class="text-muted">Required (original listing currency).</small>
  </div>
  <!-- ‚ñ≤‚ñ≤ ÿßŸÑÿ≥ÿπÿ± + ÿßŸÑÿπŸÖŸÑÿ© ‚ñ≤‚ñ≤ -->
</div>

  </div>

<div class="mb-3">
  <label class="form-label">Images (up to 10)</label>

  <div class="upload-box" onclick="document.getElementById('imgInput').click();">
      <div class="upload-icon">‚òÅÔ∏è</div>
      <div class="upload-text">Upload Images</div>
      <div class="upload-sub">You can select up to 10 images</div>
  </div>

  <input 
    type="file"
    id="imgInput"
    name="images"
    accept=".jpg,.jpeg,.png,.webp"
    multiple
    style="display:none"
  >
</div>

<style>
.upload-box{
    border: 2px dashed rgba(139,92,246,0.45);
    border-radius: 18px;
    padding: 28px 14px;
    text-align: center;
    cursor: pointer;
    background: rgba(255,255,255,0.6);
    transition: .25s ease;
}
.upload-box:hover{
    background: rgba(139,92,246,0.06);
}
.upload-icon{
    font-size: 38px;
    color: #8b5cf6;
    margin-bottom: 6px;
}
.upload-text{
    font-size: 17px;
    font-weight: 600;
    color: #1c1c1e;
}
.upload-sub{
    font-size: 13px;
    color: #6b7280;
}
</style>


  <button class="btn btn-primary">Save</button>
  <a href="/items" class="btn btn-outline-light">Back</a>
</form>

{% endblock %}

{% block scripts %}
<script>
/* ============ GPS button as-is ============ */
(function(){
  const btn = document.getElementById('useMyLocNew');
  const latEl = document.getElementById('latNew');
  const lngEl = document.getElementById('lngNew');
  const radEl = document.getElementById('radiusNew');

  function setCookie(name, value, days=180){
    try{
      const d=new Date(); d.setTime(d.getTime()+days*864e5);
      document.cookie = name+"="+encodeURIComponent(value||"")+";expires="+d.toUTCString()+";path=/;SameSite=Lax";
    }catch(_){}
  }

  btn?.addEventListener('click', function(){
    if(!navigator.geolocation){ alert('Your browser does not support geolocation.'); return; }
    const r = radEl?.value || "25";
    navigator.geolocation.getCurrentPosition(function(pos){
      const {latitude, longitude} = pos.coords;
      if (latEl) latEl.value = latitude;
      if (lngEl) lngEl.value = longitude;
      setCookie('radius_km', r);
      alert('Your location (coordinates) has been saved for this listing.');
    }, function(){ alert('Could not get your location.'); });
  });
})();

/* ============ City Autocomplete ============ */
(function cityNewAutocomplete(){
  const input = document.getElementById('cityNew');
  const panel = document.getElementById('cityNewSuggest');
  const latEl = document.getElementById('latNew');
  const lonEl = document.getElementById('lngNew');
  const form  = document.getElementById('newItemForm');
  if(!input || !panel) return;

  let tm=null, lastList=[], active=-1;

  function detectLang(q){
    const s = (q||'').trim();
    if (/[\u0600-\u06FF]/.test(s)) return 'ar';
    const hasFrMarks = /[√†√¢√ß√©√®√™√´√Æ√Ø√¥√ª√π√º√ø≈ì√¶√Ä√Ç√á√â√à√ä√ã√é√è√î√õ√ô√ú≈∏≈í√Ü]/.test(s);
    const frWords = /\b(le|la|les|de|des|du|aux|au|√†|sur|saint|sainte|chez)\b/i.test(s);
    const enWords = /\b(new|city|county|state|united|kingdom|usa|us|uk)\b/i.test(s);
    if (hasFrMarks || frWords) return 'fr';
    if (enWords) return 'en';
    const prefs = (navigator.languages || [navigator.language||'en']).map(x=>x.slice(0,2).toLowerCase());
    if (prefs.includes('fr')) return 'fr';
    if (prefs.includes('en')) return 'en';
    if (prefs.includes('ar')) return 'ar';
    return 'en';
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[c])); }
  function hide(){ panel.style.display='none'; panel.innerHTML=''; active=-1; lastList=[]; }
  function show(){ panel.style.display='block'; }

  const ALLOWED = new Set(['city','town','village','municipality']);
  const FALLBACK = new Set(['state','province']);
  function normalizePlace(p){
    const a = p.address || {};
    const type = (p.type || '').toLowerCase();
    const cc = (a.country_code || '').toLowerCase();
    const city = a.city || a.town || a.village || a.municipality || a.state || a.province || (p.display_name||'').split(',')[0];
    const prioMap = {city:1, town:2, village:3, municipality:3, state:6, province:6, administrative:8, county:8, region:8};
    const prio = prioMap[type] ?? 9;
    const country = a.country || '';
    return { city, country, cc, label: city + (country ? ', ' + country : ''), lat:p.lat, lon:p.lon, type, prio };
  }
  function dedupeByCountry(list){
    const best = new Map();
    for(const raw of list){
      const n = normalizePlace(raw);
      if (!n.city || !n.cc) continue;
      const key = n.city.trim().toLowerCase() + '|' + n.cc;
      const prev = best.get(key);
      if (!prev || n.prio < prev.prio) best.set(key, n);
    }
    return Array.from(best.values());
  }

  async function query(q){
    const lang = detectLang(q);
    const url = 'https://nominatim.openstreetmap.org/search'
              + '?format=json&addressdetails=1&limit=30&accept-language=' + encodeURIComponent(lang)
              + '&q=' + encodeURIComponent(q);
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!r.ok) return [];
    const data = await r.json();
    let filtered = data.filter(x => ALLOWED.has((x.type||'').toLowerCase()));
    if (!filtered.length) filtered = data.filter(x => FALLBACK.has((x.type||'').toLowerCase()));
    if (!filtered.length) filtered = data;
    return dedupeByCountry(filtered);
  }

  function render(list){
    if(!Array.isArray(list) || !list.length){ hide(); return; }
    lastList = list.slice(0,8);
    const html = [
      '<div class="px-2 py-1 small text-muted border-bottom">Cities/Areas</div>',
      ...lastList.map((p,i)=>(
        '<div class="py-2 px-2 d-flex gap-2 align-items-start city-row" data-i="'+i+'" style="cursor:pointer">'
        + '<i class="bi bi-geo-alt"></i>'
        + '<div><div>'+esc(p.label)+'</div><div class="text-muted small">lat '+esc(p.lat)+' ‚Äî lon '+esc(p.lon)+'</div></div>'
        + '</div>'
      ))
    ].join('');
    panel.innerHTML = html; show(); active=-1;
  }

  function pick(i){
    const p = lastList[i]; if(!p) return;
    input.value = p.label;
    if (latEl) latEl.value = p.lat || '';
    if (lonEl) lonEl.value = p.lon || '';
    hide();
  }

  input.addEventListener('input', function(){
    clearTimeout(tm);
    const q = input.value.trim();
    latEl.value = ''; lonEl.value = '';
    if (q.length < 2){ hide(); return; }
    tm = setTimeout(async ()=>{ try{ const list = await query(q); render(list); }catch(_){ hide(); } }, 220);
  });

  panel.addEventListener('click', function(e){
    const row = e.target.closest('.city-row'); if(!row) return;
    pick(Number(row.getAttribute('data-i')||'-1'));
  });

  // Arrows + Enter
  input.addEventListener('keydown', function(e){
    if (panel.style.display !== 'block') return;
    const rows = Array.prototype.slice.call(panel.querySelectorAll('.city-row'));
    if (!rows.length) return;
    if (e.key === 'ArrowDown'){ e.preventDefault(); active = (active+1) % rows.length; markActive(rows); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); active = (active-1+rows.length) % rows.length; markActive(rows); }
    else if (e.key === 'Enter'){ e.preventDefault(); if (active>=0) rows[active].click(); }
    else if (e.key === 'Escape'){ hide(); }
  });
  function markActive(rows){
    rows.forEach(r=>r.classList.remove('bg-light'));
    if (active>=0 && rows[active]){
      rows[active].classList.add('bg-light');
      rows[active].scrollIntoView({block:'nearest'});
    }
  }

  // Close on outside click
  document.addEventListener('click', (e)=>{
    if (!panel.contains(e.target) && e.target !== input){
      hide();
    }
  });

})();
</script>
{% endblock %}
