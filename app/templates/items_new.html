{% extends "base.html" %}

{% block content %}
<h2>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯</h2>

<form method="post" enctype="multipart/form-data" id="newItemForm">
  <div class="mb-3">
    <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
    <input type="text" name="title" class="form-control" required>
  </div>

  <div class="mb-3">
    <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
    <select class="form-select" name="category" required>
      {% for cat in categories %}
        <option value="{{ cat.key }}">{{ cat.label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
    <textarea name="description" class="form-control" rows="4"></textarea>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3 position-relative">
      <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>

      <!-- Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© -->
      <input type="text" name="city" id="cityNew" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø©â€¦" autocomplete="off">

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª -->
      <div id="cityNewSuggest" class="border rounded mt-1 bg-white shadow-sm"
           style="display:none; position:absolute; z-index:1000; max-height:260px; overflow:auto; inset-inline:0;"></div>

      <!-- GPS + Ù†ØµÙ Ù‚Ø·Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
      <div class="d-flex gap-2 mt-2">
        <button type="button" id="useMyLocNew" class="btn btn-outline-secondary btn-sm">ğŸ“ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <input type="number" id="radiusNew" class="form-control form-control-sm" style="max-width:110px"
               placeholder="km" value="25" min="1">
      </div>
      <small class="text-muted d-block mt-1">Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹Ùƒ. Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>

      <!-- Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø®ÙÙŠØ© -->
      <input type="hidden" name="latitude" id="latNew">
      <input type="hidden" name="longitude" id="lngNew">
    </div>

    <div class="col-md-6 mb-3">
      <label class="form-label">Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„ÙŠÙˆÙ…</label>
      <input type="number" name="price_per_day" class="form-control" value="0" min="0">
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">ØµÙˆØ±Ø©</label>
    <input type="file" name="image" class="form-control" accept=".jpg,.jpeg,.png">
  </div>

  <button class="btn btn-primary">Ø­ÙØ¸</button>
  <a href="/items" class="btn btn-outline-light">Ø±Ø¬ÙˆØ¹</a>
</form>
{% endblock %}

{% block scripts %}
<script>
/* ============ Ø²Ø± GPS ÙƒÙ…Ø§ Ù‡Ùˆ ============ */
(function(){
  const btn = document.getElementById('useMyLocNew');
  const latEl = document.getElementById('latNew');
  const lngEl = document.getElementById('lngNew');
  const radEl = document.getElementById('radiusNew');

  function setCookie(name, value, days=180){
    try{
      const d=new Date(); d.setTime(d.getTime()+days*864e5);
      document.cookie = name+"="+encodeURIComponent(value||"")+";expires="+d.toUTCString()+";path=/;SameSite=Lax";
    }catch(_){}
  }

  btn?.addEventListener('click', function(){
    if(!navigator.geolocation){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'); return; }
    const r = radEl?.value || "25";
    navigator.geolocation.getCurrentPosition(function(pos){
      const {latitude, longitude} = pos.coords;
      if (latEl) latEl.value = latitude;
      if (lngEl) lngEl.value = longitude;
      setCookie('radius_km', r);
      alert('ØªÙ… Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹Ùƒ (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª) Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.');
    }, function(){ alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ.'); });
  });
})();

/* ============ Autocomplete Ù„Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù‡ÙŠØ¯Ø±) ============ */
(function cityNewAutocomplete(){
  const input = document.getElementById('cityNew');
  const panel = document.getElementById('cityNewSuggest');
  const latEl = document.getElementById('latNew');
  const lonEl = document.getElementById('lngNew');
  const form  = document.getElementById('newItemForm');
  if(!input || !panel) return;

  let tm=null, lastList=[], active=-1;

  // ÙƒØ´Ù Ø§Ù„Ù„ØºØ© Ø¨Ø­Ø³Ø¨ Ù…Ø§ ÙŠÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  function detectLang(q){
    const s = (q||'').trim();
    if (/[\u0600-\u06FF]/.test(s)) return 'ar';                       // Ø¹Ø±Ø¨ÙŠ
    const hasFrMarks = /[Ã Ã¢Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã»Ã¹Ã¼Ã¿Å“Ã¦Ã€Ã‚Ã‡Ã‰ÃˆÃŠÃ‹ÃÃÃ”Ã›Ã™ÃœÅ¸Å’Ã†]/.test(s);  // Ø­Ø±ÙˆÙ ÙØ±Ù†Ø³ÙŠØ©
    const frWords = /\b(le|la|les|de|des|du|aux|au|Ã |sur|saint|sainte|chez)\b/i.test(s);
    const enWords = /\b(new|city|county|state|united|kingdom|usa|us|uk)\b/i.test(s);
    if (hasFrMarks || frWords) return 'fr';
    if (enWords) return 'en';
    // Ø§ÙØªØ±Ø§Ø¶ÙŠ: ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
    const prefs = (navigator.languages || [navigator.language||'en']).map(x=>x.slice(0,2).toLowerCase());
    if (prefs.includes('fr')) return 'fr';
    if (prefs.includes('en')) return 'en';
    if (prefs.includes('ar')) return 'ar';
    return 'en';
  }

  function esc(s){ return String(s||"").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;","&gt;":">","\"":"&quot;","'":"&#39;"}[c])); }
  function hide(){ panel.style.display='none'; panel.innerHTML=''; active=-1; lastList=[]; }
  function show(){ panel.style.display='block'; }

  const ALLOWED = new Set(['city','town','village','municipality']);
  const FALLBACK = new Set(['state','province']);
  function normalizePlace(p){
    const a = p.address || {};
    const type = (p.type || '').toLowerCase();
    const cc = (a.country_code || '').toLowerCase();
    const city = a.city || a.town || a.village || a.municipality || a.state || a.province || (p.display_name||'').split(',')[0];
    const prioMap = {city:1, town:2, village:3, municipality:3, state:6, province:6, administrative:8, county:8, region:8};
    const prio = prioMap[type] ?? 9;
    const country = a.country || '';
    return { city, country, cc, label: city + (country ? ', ' + country : ''), lat:p.lat, lon:p.lon, type, prio };
  }
  function dedupeByCountry(list){
    const best = new Map();
    for(const raw of list){
      const n = normalizePlace(raw);
      if (!n.city || !n.cc) continue;
      const key = n.city.trim().toLowerCase() + '|' + n.cc;
      const prev = best.get(key);
      if (!prev || n.prio < prev.prio) best.set(key, n);
    }
    return Array.from(best.values());
  }

  async function query(q){
    const lang = detectLang(q);
    const url = 'https://nominatim.openstreetmap.org/search'
              + '?format=json&addressdetails=1&limit=30&accept-language=' + encodeURIComponent(lang)
              + '&q=' + encodeURIComponent(q);
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!r.ok) return [];
    const data = await r.json();
    let filtered = data.filter(x => ALLOWED.has((x.type||'').toLowerCase()));
    if (!filtered.length) filtered = data.filter(x => FALLBACK.has((x.type||'').toLowerCase()));
    if (!filtered.length) filtered = data;
    return dedupeByCountry(filtered);
  }

  function render(list){
    if(!Array.isArray(list) || !list.length){ hide(); return; }
    lastList = list.slice(0,8);
    const html = [
      '<div class="px-2 py-1 small text-muted border-bottom">Ù…Ø¯Ù†/Ù…Ù†Ø§Ø·Ù‚</div>',
      ...lastList.map((p,i)=>(
        '<div class="py-2 px-2 d-flex gap-2 align-items-start city-row" data-i="'+i+'" style="cursor:pointer">'
        + '<i class="bi bi-geo-alt"></i>'
        + '<div><div>'+esc(p.label)+'</div><div class="text-muted small">lat '+esc(p.lat)+' â€” lon '+esc(p.lon)+'</div></div>'
        + '</div>'
      ))
    ].join('');
    panel.innerHTML = html; show(); active=-1;
  }

  function pick(i){
    const p = lastList[i]; if(!p) return;
    input.value = p.label;
    if (latEl) latEl.value = p.lat || '';
    if (lonEl) lonEl.value = p.lon || '';
    hide();
  }

  input.addEventListener('input', function(){
    clearTimeout(tm);
    const q = input.value.trim();
    latEl.value = ''; lonEl.value = '';
    if (q.length < 2){ hide(); return; }
    tm = setTimeout(async ()=>{ try{ const list = await query(q); render(list); }catch(_){ hide(); } }, 220);
  });

  panel.addEventListener('click', function(e){
    const row = e.target.closest('.city-row'); if(!row) return;
    pick(Number(row.getAttribute('data-i')||'-1'));
  });

  // Ø£Ø³Ù‡Ù… + Enter
  input.addEventListener('keydown', function(e){
    if (panel.style.display !== 'block') return;
    const rows = Array.prototype.slice.call(panel.querySelectorAll('.city-row'));
    if (!rows.length) return;
    if (e.key === 'ArrowDown'){ e.preventDefault(); active = (active+1) % rows.length; markActive(rows); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); active = (active-1+rows.length) % rows.length; markActive(rows); }
    else if (e.key === 'Enter'){ e.preventDefault(); if (active>=0) rows[active].click(); }
    else if (e.key === 'Escape'){ hide(); }
  });
  function markActive(rows){
    rows.forEach(r=>r.classList.remove('bg-light'));
    if (active>=0 && rows[active]){ rows[active].classList.add('bg-light'); rows[active].scrollIntoView({block:'nearest'}); }
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬
  document.addEventListener('click', (e)=>{ if (!panel.contains(e.target) && e.target !== input){ hide(); } });

  // ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØªØ¨ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªÙŠØ§Ø±ØŒ Ù†ØªØ±Ùƒ city ÙƒÙ…Ø§ Ù‡ÙŠ (lat/lon Ù‚Ø¯ ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ©)
  form?.addEventListener('submit', function(){
    // Ù„Ø§ Ø´ÙŠØ¡ Ø¥Ø¶Ø§ÙÙŠ â€” Ø§Ù„Ø³ÙŠØ±ÙØ± Ø³ÙŠØ³ØªÙ‚Ø¨Ù„ city + (lat/lon Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
  });
})();
</script>
{% endblock %}