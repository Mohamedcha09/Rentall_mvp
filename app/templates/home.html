{% extends "base.html" %}
{% from "_badges.html" import render_badges %}

{% block content %}

<!-- ======= Topbar (Ø²Ø¬Ø§Ø¬ÙŠ) ======= -->
<header class="topbar">
  <div class="topbar__inner container-fluid">

    <!-- Ø²Ø± Ø·ÙŠÙ‘ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <button class="btn btn-ghost btn-sm" type="button" onclick="toggleSidebar()" aria-label="Toggle sidebar">
      <i class="bi bi-layout-sidebar-inset-reverse"></i>
    </button>

    <!-- Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
    <a href="/" class="d-flex align-items-center gap-2 text-decoration-none text-reset">
      <img class="brand__logo" src="{{ url_for('static', path='img/logo.png') }}" alt="logo">
      <strong class="brand__name">RentAll</strong>
    </a>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« -->
    <form class="search" method="get" action="/">
      <i class="bi bi-search search__icon"></i>
      <input class="form-control search__input"
             name="q"
             value="{{ search_q|default('') }}"
             placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†ØµØ± Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù…â€¦">
      {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
      {% if search_city %}<input type="hidden" name="city" value="{{ search_city }}">{% endif %}
      {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}
    </form>

    <!-- Ø£Ø²Ø±Ø§Ø± ÙŠÙ…ÙŠÙ† Ø§Ù„ØªÙˆØ¨Ø¨Ø§Ø± -->
    <div class="d-flex align-items-center gap-2">
      <a href="/items/new" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-lg"></i> Ø¥Ù†Ø´Ø§Ø¡
      </a>

      <button class="btn btn-ghost btn-sm position-relative" type="button" onclick="toggleNotif(true)" aria-label="Notifications">
        <i class="bi bi-bell"></i>
      </button>

      <!-- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… -->
      <button class="btn btn-ghost btn-sm" type="button" onclick="document.body.dataset.theme = (document.body.dataset.theme === 'light' ? '' : 'light')" aria-label="Toggle theme">
        <i class="bi bi-brightness-high"></i>
      </button>

      <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
      {% if session_user %}
        <a href="/profile" class="d-inline-flex align-items-center gap-2 text-decoration-none text-reset">
          {% if session_user.avatar_path %}
            <img src="/{{ session_user.avatar_path }}" class="avatar ring" alt="avatar">
          {% else %}
            <div class="avatar ring">{{ (session_user.first_name or 'U')[:1] }}</div>
          {% endif %}
          <span class="small d-none d-md-inline">{{ session_user.first_name }} {{ session_user.last_name }}</span>
        </a>
      {% else %}
        <a href="/login" class="btn btn-ghost btn-sm">Ø¯Ø®ÙˆÙ„</a>
      {% endif %}
    </div>
  </div>
</header>
<!-- /Topbar -->

<!-- ======= Sidebar ======= -->
<aside class="sidebar" id="appSidebar" data-collapsed="false">
  <nav class="sidebar__nav">
    <a class="side-link {% if not current_category %}is-active{% endif %}" href="/" data-tooltip="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
      <i class="bi bi-house"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </a>

    <div class="side-sep"></div>

    <a class="side-link" href="/profile" data-tooltip="ØµÙØ­ØªÙŠ">
      <i class="bi bi-person"></i><span>ØµÙØ­ØªÙŠ</span>
    </a>

    {% if session_user and session_user.role == 'admin' %}
    <a class="side-link" href="/admin" data-tooltip="Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…ÙŠÙ†">
      <i class="bi bi-speedometer2"></i><span>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…ÙŠÙ†</span>
    </a>
    {% endif %}

    <div class="side-sep"></div>

    <a class="side-link" href="/items/new" data-tooltip="Ø£Ø¶Ù Ø¹Ù†ØµØ±">
      <i class="bi bi-plus-square"></i><span>Ø£Ø¶Ù Ø¹Ù†ØµØ±</span>
    </a>
  </nav>
</aside>
<!-- /Sidebar -->

<!-- ======= Right rail (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ======= -->
<aside class="right-rail d-none d-xxl-block">
  <div class="mb-3">
    <div class="widget__title">Ù…Ù‚ØªØ±Ø­Ø§Øª</div>
    <div class="small text-muted">Ø£Ø¶Ù Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø²ÙŠØ§Ø¯Ø© ÙØ±Øµ Ø§Ù„ØªØ£Ø¬ÙŠØ± ğŸ’¡</div>
  </div>
</aside>

<!-- ======= Ø§Ù„ØµÙØ­Ø© ======= -->
<main class="page container-fluid">

  <!-- ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
  {% if flash_message %}
    <div class="alert alert-warning stripe-callout d-flex justify-content-between align-items-center mb-3">
      <span>{{ flash_message }}</span>
      <a class="btn btn-ghost btn-sm" href="#">ØªØ¹Ø±Ù Ø£ÙƒØ«Ø±</a>
    </div>
  {% endif %}

  <!-- Ù‡ÙŠØ±Ùˆ -->
  <section class="home-hero text-center mb-4">
    <h1 class="mb-2">Ù…Ù†ØµØ© ØªØ£Ø¬ÙŠØ± Ø£ÙŠ Ø´ÙŠØ¡ â€” Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</h1>
    <p class="lead mb-3">Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ±ÙØ¹ ÙˆØ«ÙŠÙ‚Ø© Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ø§Ù„Ø£Ø¯Ù…ÙŠÙ†.</p>

    {% if not session_user %}
      <a href="/register" class="btn btn-primary btn-lg">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a>
      <a href="/login" class="btn btn-ghost btn-lg ms-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
    {% else %}
      <a href="/profile" class="btn btn-primary btn-lg">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØµÙØ­ØªÙŠ</a>
      {% if session_user.role == 'admin' %}
        <a href="/admin" class="btn btn-warning btn-lg ms-2">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…ÙŠÙ†</a>
      {% endif %}
    {% endif %}
  </section>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… -->
  <form method="get" action="/" class="card card-search mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <input type="text" name="q" value="{{ search_q|default('') }}"
                 class="form-control form-control-lg"
                 placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ (camera, Ø®ÙŠÙ…Ø©, Ø³ÙŠØ§Ø±Ø©...)">
        </div>
        <div class="col-md-3">
          <input type="text" name="city" value="{{ search_city|default('') }}"
                 class="form-control form-control-lg"
                 placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø«Ø§Ù„: montreal)">
        </div>
        <div class="col-md-3">
          <select class="form-select form-select-lg" name="category">
            <option value="" {{ '' == (current_category|default('')) and 'selected' or '' }}>ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
            {% for cat in categories %}
              <option value="{{ cat.key }}" {{ cat.key == (current_category|default('')) and 'selected' or '' }}>
                {{ cat.label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex gap-2">
          <select class="form-select form-select-lg" name="sort">
            <option value="" {{ not sort and 'selected' or '' }}>Ø§Ù„Ø£Ø­Ø¯Ø«</option>
            <option value="pop" {{ sort=='pop' and 'selected' or '' }}>Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ù‡Ø±Ø©</option>
            <option value="price_asc" {{ sort=='price_asc' and 'selected' or '' }}>Ø§Ù„Ø³Ø¹Ø± â†‘</option>
            <option value="price_desc" {{ sort=='price_desc' and 'selected' or '' }}>Ø§Ù„Ø³Ø¹Ø± â†“</option>
          </select>
          <button class="btn btn-primary btn-lg w-100" type="submit">Ø§Ø¨Ø­Ø«</button>
        </div>
      </div>
    </div>
  </form>

  <!-- ÙÙ„Ø§ØªØ± Ø³Ø±ÙŠØ¹Ø© -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <div class="mb-2 home-cats">
      <a class="btn btn-sm {{ not current_category and 'btn-primary' or 'btn-ghost' }}" href="/">Ø§Ù„ÙƒÙ„</a>
      {% for cat in categories %}
        <a class="btn btn-sm {{ current_category==cat.key and 'btn-primary' or 'btn-ghost' }}"
           href="/?category={{ cat.key }}">{{ cat.label }}</a>
      {% endfor %}
    </div>

    <div class="mb-2">
      <a class="btn btn-sm btn-ghost"
         href="{{ '/' if not current_category else '/?category=' ~ current_category }}">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± ğŸ”„</a>
    </div>
  </div>

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± -->
  <div class="home-grid">
    {% for it in items %}
      {% set owner = it.owner if it.owner is defined else None %}
      <article class="card spot">
        <!-- ØµÙˆØ±Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© Ø§Ù„Ù†Ø³Ø¨Ø© -->
        <div class="spot-media">
          {% if it.image_path %}
            <img src="/{{ it.image_path }}" alt="item">
          {% else %}
            <img src="{{ url_for('static', path='img/placeholder.jpg') }}" alt="no image">
          {% endif %}
          <div class="spot-overlay"></div>

          {% if it.price_per_day is not none %}
          <div class="price-badge">
            <strong>{{ it.price_per_day }}</strong><span> Ø¯/ÙŠÙˆÙ…</span>
          </div>
          {% endif %}

          {% if it.category_label %}
          <div class="category-chip">{{ it.category_label }}</div>
          {% endif %}
        </div>

        <div class="card-body">
          <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ø³Ø·Ø±Ø§Ù† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ -->
          <h5 class="spot-title" title="{{ it.title }}">{{ it.title }}</h5>

          <div class="spot-body">
            <!-- Ø³Ø·Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ -->
            <div class="owner-line d-flex align-items-center gap-2 mb-2">
              {% if owner and owner.avatar_path %}
                <img src="/{{ owner.avatar_path }}" class="owner-avatar" alt="avatar">
              {% else %}
                <div class="owner-avatar owner-avatar--placeholder">ğŸ‘¤</div>
              {% endif %}
              <span class="small text-muted d-inline-flex align-items-center gap-1">
                {{ (owner and (owner.first_name ~ ' ' ~ owner.last_name)) or 'Ù…Ø³ØªØ®Ø¯Ù…' }}
                {% if owner %}{{ render_badges(owner, '16px') }}{% endif %}
              </span>
            </div>

            <!-- Ø°ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
            <div class="d-flex align-items-center justify-content-between spot-footer">
              <div class="small city-chip" title="{{ it.city or '' }}">ğŸ™ï¸ {{ it.city or 'Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠÙ†Ø©' }}</div>
              <a href="/items/{{ it.id }}" class="btn btn-sm btn-primary">ØªÙØ§ØµÙŠÙ„</a>
            </div>
          </div>
        </div>
      </article>
    {% else %}
      <div class="card p-4 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø§Ù„Ø¢Ù†.</div>
    {% endfor %}
  </div>
</main>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© -->
<div class="notif-panel" id="notifPanel" aria-hidden="true">
  <div class="notif-panel__header d-flex justify-content-between align-items-center">
    <strong>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</strong>
    <button class="btn btn-sm btn-ghost" type="button" onclick="toggleNotif(false)">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <div class="notif-panel__body">
    <p class="text-muted small mb-0">Ù„Ø§ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯.</p>
  </div>
</div>
<div class="scrim" id="scrim" onclick="toggleNotif(false)"></div>

<!-- ======= Scripts ØµØºÙŠØ±Ø© ======= -->
<script>
  // Ø·ÙŠÙ‘ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
  const sidebar = document.getElementById('appSidebar');
  function toggleSidebar(){
    if(!sidebar) return;
    const collapsed = sidebar.getAttribute('data-collapsed') === 'true';
    sidebar.setAttribute('data-collapsed', collapsed ? 'false' : 'true');
    document.documentElement.style.setProperty('--sidebar-w', collapsed ? '268px' : '84px');
  }

  // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  const panel = document.getElementById('notifPanel');
  const scrim = document.getElementById('scrim');
  function toggleNotif(open){
    const willOpen = (open === true) || !panel.classList.contains('is-open');
    if(willOpen){
      panel.classList.add('is-open');
      scrim.classList.add('is-show');
      panel.setAttribute('aria-hidden','false');
    }else{
      panel.classList.remove('is-open');
      scrim.classList.remove('is-show');
      panel.setAttribute('aria-hidden','true');
    }
  }
</script>

{% endblock %}
