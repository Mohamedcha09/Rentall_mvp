{% extends "base.html" %}
{% from "_badges.html" import render_badges %}
{% block content %}

<!-- ===== Hero / Ù…Ù‚Ø¯Ù‘Ù…Ø© Ø®ÙÙŠÙØ© ===== -->
<section class="home-hero text-center mb-4">
  <h1 class="mb-2 fw-bold">Ø§ÙƒØªØ´Ù ÙˆØ§Ø¬Ø±Ù Ø¹Ù†Ø§ØµØ± Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©</h1>
  <p class="lead mb-0">Ø§Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ ÙˆØªØµÙÙ‘Ø­ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…Ù†Ø³Ù‘Ù‚Ø© Ø¨Ø¹Ù†Ø§ÙŠØ©.</p>
</section>

<!-- ===== Ø´Ø±ÙŠØ· Ø¨Ø­Ø« Ù…Ø¯Ù…Ø¬ Ø£Ù†ÙŠÙ‚ ===== -->
<form method="get" action="/" class="card card-search mb-3 border-0 shadow-sm">
  <div class="card-body py-3">
    <div class="row g-2 align-items-center">
      <div class="col-lg-5">
        <input
          class="form-control form-control-lg"
          name="q"
          value="{{ search_q | default('') }}"
          placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†ØµØ± (Ù…Ø«Ø§Ù„: ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ø®ÙŠÙ…Ø©ØŒ Ø¯Ø±ÙˆÙ†â€¦)"
          autocomplete="off"
        />
      </div>
      <div class="col-lg-4">
        <input
          class="form-control form-control-lg"
          name="city"
          value="{{ search_city | default('') }}"
          placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ù…Ø«Ø§Ù„: montreal)"
          autocomplete="off"
        />
      </div>
      <div class="col-lg-3 d-flex gap-2">
        {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
        <button class="btn btn-primary btn-lg w-100" type="submit">Ø¨Ø­Ø«</button>
      </div>
    </div>
  </div>
</form>

<!-- ===== Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª: ØªØµÙ†ÙŠÙØ§Øª + ÙØ±Ø² + ØªØ­Ø¯ÙŠØ« ===== -->
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div class="home-cats d-flex flex-wrap gap-2">
    <a class="btn btn-sm {% if not current_category %}btn-primary{% else %}btn-outline-light{% endif %}" href="/">Ø§Ù„ÙƒÙ„</a>
    {% for cat in categories %}
      <a class="btn btn-sm {% if current_category == cat.key %}btn-primary{% else %}btn-outline-light{% endif %}"
         href="/?category={{ cat.key }}">{{ cat.label }}</a>
    {% endfor %}
  </div>

  <div class="d-flex align-items-center gap-2">
    <form method="get" action="/" class="d-flex align-items-center gap-2">
      {% if search_q %}<input type="hidden" name="q" value="{{ search_q }}">{% endif %}
      {% if search_city %}<input type="hidden" name="city" value="{{ search_city }}">{% endif %}
      {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
      <select class="form-select form-select-sm" name="sort" onchange="this.form.submit()">
        <option value="">Ø§Ù„ÙØ±Ø²</option>
        <option value="new"   {% if sort == 'new' %}selected{% endif %}>Ø§Ù„Ø£Ø­Ø¯Ø«</option>
        <option value="price" {% if sort == 'price' %}selected{% endif %}>Ø§Ù„Ø£Ù‚Ù„ Ø³Ø¹Ø±Ù‹Ø§</option>
        <option value="pop"   {% if sort == 'pop' %}selected{% endif %}>Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©</option>
      </select>
    </form>
    <a class="btn btn-sm btn-outline-light"
       href="{{ '/' if not current_category and not search_q and not search_city else request.url.path }}">
      ØªØ­Ø¯ÙŠØ« ğŸ”„
    </a>
  </div>
</div>

<!-- ØªØ­Ø³ÙŠÙ†Ø§Øª Ø´ÙƒÙ„ÙŠØ© Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø· -->
<style>
  /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹ØµØ±ÙŠØ© */
  .spot-card{
    border:1px solid var(--border);
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    border-radius:18px; overflow:hidden;
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  }
  .spot-card:hover{ transform:translateY(-6px); border-color:rgba(124,92,255,.35); box-shadow:0 18px 40px rgba(124,92,255,.18); }

  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø³Ø¨Ø© Ø«Ø§Ø¨ØªØ© + ÙƒØ³ÙƒÙ„ÙŠØªÙˆÙ† */
  .spot-media{ position:relative; aspect-ratio:16/10; background:rgba(255,255,255,.04); }
  .spot-media img{ width:100%; height:100%; object-fit:cover; display:block; transition:transform .25s ease; }
  .spot-card:hover .spot-media img{ transform:scale(1.03); }

  /* Ø´Ø§Ø±Ø§Øª ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© */
  .price-badge{
    position:absolute; inset-inline-start:12px; top:12px;
    padding:.35rem .6rem; border-radius:999px; font-weight:700; color:#fff;
    background:rgba(10,12,16,.65); backdrop-filter:blur(8px); border:1px solid var(--border);
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }
  .category-chip{
    position:absolute; inset-inline-end:12px; top:12px;
    padding:.25rem .6rem; border-radius:999px; font-size:.8rem; color:#cfe2ff;
    background:rgba(124,92,255,.18); border:1px solid rgba(124,92,255,.35);
  }
  .new-ribbon{
    position:absolute; inset-inline-start:-6px; bottom:12px; padding:.25rem .55rem; font-size:.75rem;
    border-radius:0 999px 999px 0; background:rgba(34,197,94,.2); color:#34d399; border:1px solid rgba(34,197,94,.35);
    backdrop-filter:blur(6px);
  }

  /* Ø¬Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
  .spot-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.25; }
  .owner-avatar{ width:28px; height:28px; border-radius:999px; object-fit:cover; border:1px solid var(--border); }
  .owner-avatar--placeholder{ width:28px; height:28px; border-radius:999px; display:grid; place-items:center;
    background:rgba(255,255,255,.06); border:1px solid var(--border); }

  /* Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© */
  .spot-actions .btn{ border-radius:999px; padding:.3rem .55rem; }

  /* Ø´Ø¨ÙƒØ© Ù…Ø±Ù†Ø© */
  .home-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:18px; }

  /* ÙƒØ³ÙƒÙ„ÙŠØªÙˆÙ† ØªØ­Ù…ÙŠÙ„ */
  @keyframes shimmer{ 0%{background-position:-450px 0} 100%{background-position:450px 0} }
  .skeleton{ position:relative; overflow:hidden; background:#20242f; border-radius:18px; min-height:230px; border:1px solid var(--border); }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.07), rgba(255,255,255,0));
    background-size:900px 100%; animation:shimmer 1.2s infinite;
  }
</style>

<!-- ===== Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± ===== -->
<div id="items-grid" class="home-grid">
  {% if items %}
    {% for it in items %}
      <article class="spot-card">
        <div class="spot-media">
          {% if it.image_path %}
            <img loading="lazy" src="/{{ it.image_path }}" alt="{{ it.title }}">
          {% else %}
            <div class="d-flex w-100 h-100 align-items-center justify-content-center text-muted">Ù„Ø§ ØµÙˆØ±Ø©</div>
          {% endif %}
          <div class="price-badge"><strong>{{ it.price_per_day }}</strong> Ø¯/ÙŠÙˆÙ…</div>
          <div class="category-chip">{{ it.category_label }}</div>
          {% if it.is_new %}<div class="new-ribbon">Ø¬Ø¯ÙŠØ¯</div>{% endif %}
        </div>

        <div class="p-3">
          <h5 class="spot-title mb-2" title="{{ it.title }}">{{ it.title }}</h5>

          <!-- Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¹Ù†ØµØ± + Ø§Ù„Ø´Ø§Ø±Ø§Øª -->
          <div class="d-flex align-items-center gap-2 mb-2">
            {% if it.owner and it.owner.avatar_path %}
              <img class="owner-avatar" src="/{{ it.owner.avatar_path }}" alt="avatar">
            {% else %}
              <div class="owner-avatar owner-avatar--placeholder">ğŸ‘¤</div>
            {% endif %}
            <div class="small text-muted d-flex align-items-center gap-1">
              {{ it.owner.first_name }} {{ it.owner.last_name }}
              {% if it.owner %}{{ render_badges(it.owner, '16px') }}{% endif %}
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div class="small city-chip" title="{{ it.city or '' }}">ğŸ™ï¸ {{ it.city or 'Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠÙ†Ø©' }}</div>
            <div class="spot-actions d-flex gap-1">
              <a href="/items/{{ it.id }}" class="btn btn-sm btn-primary">ØªÙØ§ØµÙŠÙ„</a>
              <button class="btn btn-sm btn-outline-light" type="button" onclick="saveItem('{{ it.id }}')" title="Ø­ÙØ¸">â˜…</button>
              <button class="btn btn-sm btn-outline-light" type="button" onclick="shareItem('{{ request.url_for('item_detail', item_id=it.id) if false else '/items/' ~ it.id }}')" title="Ù…Ø´Ø§Ø±ÙƒØ©">â†—</button>
            </div>
          </div>
        </div>
      </article>
    {% endfor %}
  {% else %}
    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø§ØµØ± -->
    <div class="card border-0 shadow-sm">
      <div class="card-body text-center py-5">
        <h5 class="mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø·Ø§Ø¨Ù‚Ø©</h5>
        <p class="text-muted mb-3">Ø¬Ø±Ù‘Ø¨ ÙƒÙ„Ù…Ø§Øª Ø¨Ø­Ø« Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ ØªØµÙÙ‘Ø­ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª.</p>
        <a href="/owner/items/new" class="btn btn-primary">Ø£Ø¶Ù Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ù„Ùƒ</a>
      </div>
    </div>
  {% endif %}
</div>

<!-- ===== ÙƒØ³ÙƒÙ„ÙŠØªÙˆÙ† Ù„Ø­Ø¸ÙŠ Ø¹Ù†Ø¯ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙØ±Ø² (ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø©) ===== -->
<template id="skeleton-card">
  <div class="skeleton"></div>
</template>

<script>
  function saveItem(id){
    // ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±Ø¨Ø·Ù‡ Ø¨Ù€ API Ù„Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©
    try { localStorage.setItem('fav:' + id, '1'); } catch(e){}
  }
  function shareItem(url){
    if (navigator.share) {
      navigator.share({ url, title: 'RentAll' }).catch(()=>{});
    } else {
      navigator.clipboard?.writeText(url);
      alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ù†ØµØ±');
    }
  }

  // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø² Ø¨Ø§Ù„select Ø£Ø¹Ù„Ø§Ù‡ØŒ Ù†Ø¹Ø±Ø¶ ÙƒØ³ÙƒÙ„ÙŠØªÙˆÙ† Ø³Ø±ÙŠØ¹ Ø­ØªÙ‰ ØªØ¹ÙˆØ¯ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  (function(){
    const sel = document.querySelector('select[name="sort"]');
    if(!sel) return;
    sel.addEventListener('change', () => {
      const grid = document.getElementById('items-grid');
      if(!grid) return;
      grid.innerHTML = '';
      const tpl = document.getElementById('skeleton-card').content;
      for(let i=0;i<6;i++){ grid.appendChild(tpl.cloneNode(true)); }
    });
  })();
</script>

{% endblock %}
