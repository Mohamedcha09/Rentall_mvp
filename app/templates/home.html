{% extends "base.html" %}

{% block head %}
<style>
  /* Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© */
  .hero-search{ margin:.25rem 0 1rem; display:grid; gap:.75rem; }
  .hero-search .search__wrap{ position:relative; }
  .hero-search input[type="search"]{
    width:100%; height:46px; border-radius:999px;
    border:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    color:var(--text); padding-inline:44px 14px;
  }
  .hero-search .bi-search{
    position:absolute; inset-inline-start:14px; top:50%; transform:translateY(-50%);
    opacity:.7; font-size:1.05rem;
  }

  /* ÙƒØ¨Ø³ÙˆÙ„Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ) */
  .cat-tabs{
    display:flex; gap:.5rem; overflow-x:auto; padding-bottom:.25rem; scrollbar-width:thin;
  }
  .cat-pill{
    flex:0 0 auto; white-space:nowrap;
    padding:.4rem .7rem; border-radius:999px; text-decoration:none;
    border:1px solid var(--border); background:rgba(255,255,255,.06); color:var(--text);
    font-weight:700; font-size:.9rem;
  }
  .cat-pill.is-active{ background:rgba(124,92,255,.16); border-color:rgba(124,92,255,.35); }

  /* Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø³ØªØ§ÙŠÙ„Ùƒ) */
  .section-head{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin:.5rem 2px .65rem; }
  .section-title{ font-weight:800; font-size:1.1rem; }

  /* Ø£Ø³Ù‡Ù… Ø§Ù„ØªØ­Ø±ÙŠÙƒ */
  .arrow-btn{ border:1px solid var(--border); background:transparent; border-radius:10px; padding:.35rem .55rem; }
</style>
{% endblock %}

{% block content %}

<!-- ===== Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© + ÙƒØ¨Ø³ÙˆÙ„Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ===== -->
<section class="hero-search">
  <div class="search__wrap">
    <i class="bi bi-search"></i>
    <form action="/search" method="get">
      <input type="search" name="q" placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©â€¦"
             value="{{ request.query_params.get('q','') if request else '' }}">
    </form>
  </div>

  {% set cats = categories or [] %}
  {% if cats %}
    <nav class="cat-tabs">
      {% for cat in cats %}
        {% set cname = cat.name or cat.get('name','') %}
        {% set ccode = cat.code or cat.get('code') or (cname|replace(' ','-')|lower) %}
        <a class="cat-pill {% if request and request.query_params.get('cat') == ccode %}is-active{% endif %}"
           href="/items?cat={{ ccode }}">{{ cname }}</a>
      {% endfor %}
    </nav>
  {% endif %}
</section>

<!-- ===== Ù‚Ø³Ù… Ø´Ø§Ø¦Ø¹ ===== -->
<div class="section-head">
  <div class="section-title">Ø´Ø§Ø¦Ø¹ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù†Ùƒ</div>
  <div class="d-flex gap-2">
    <button class="arrow-btn" data-snap-prev="#row-pop"><i class="bi bi-chevron-right"></i></button>
    <button class="arrow-btn" data-snap-next="#row-pop"><i class="bi bi-chevron-left"></i></button>
  </div>
</div>
<div id="row-pop" class="hrow">
  {% for it in popular_items %}
  <a href="/items/{{ it.id }}" class="card spot hcard text-decoration-none">
    <div class="spot-media">
      <img src="{{ it.image_path or it.image or '/static/placeholder.jpg' }}" alt="">
      <div class="spot-overlay"></div>
      {% if it.price_per_day or it.price %}
        <span class="price-badge">{{ (it.price_per_day or it.price)|int }}$ /ÙŠÙˆÙ…</span>
      {% endif %}
      <span class="category-chip">{{ category_label(it.category) }}</span>
    </div>
    <div class="card-body spot-body">
      <div class="spot-title">{{ it.title }}</div>
      <div class="owner-line">
        <div class="owner-avatar--placeholder">ğŸ·ï¸</div>
        <span class="city-chip">{{ it.city or 'â€”' }}</span>
      </div>
      <div class="spot-footer">
        <small class="text-muted">ØªÙ‚ÙŠÙŠÙ… {{ it.rating|default(4.8) }}</small>
        <i class="bi bi-arrow-left-short"></i>
      </div>
    </div>
  </a>
  {% endfor %}
</div>

<!-- ===== Ø³Ù„Ø§ÙŠØ¯Ø± Ù„ÙƒÙ„ ØªØµÙ†ÙŠÙ ===== -->
{% for cat in categories %}
  {% set cname = cat.name or cat.get('name','') %}
  {% set code  = cat.code or cat.get('code') or (cname|replace(' ','-')|lower) %}
  {% set list  = items_by_category.get(code, []) %}
  {% if list %}
  <div class="section-head mt-3">
    <div class="section-title">{{ category_label(code) or cname }}</div>
    <a class="text-muted small" href="/items?category={{ code }}">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
  </div>
  <div id="row-{{ code }}" class="hrow">
    {% for it in list %}
    <a href="/items/{{ it.id }}" class="card spot hcard text-decoration-none">
      <div class="spot-media">
        <img src="{{ it.image_path or it.image or '/static/placeholder.jpg' }}" alt="">
        <div class="spot-overlay"></div>
        {% if it.price_per_day or it.price %}
          <span class="price-badge">{{ (it.price_per_day or it.price)|int }}$ /ÙŠÙˆÙ…</span>
        {% endif %}
        <span class="category-chip">{{ category_label(it.category) }}</span>
      </div>
      <div class="card-body spot-body">
        <div class="spot-title">{{ it.title }}</div>
        <div class="owner-line">
          <div class="owner-avatar--placeholder">ğŸ·ï¸</div>
          <span class="city-chip">{{ it.city or 'â€”' }}</span>
        </div>
        <div class="spot-footer">
          <small class="text-muted">ØªÙ‚ÙŠÙŠÙ… {{ it.rating|default(4.8) }}</small>
          <i class="bi bi-arrow-left-short"></i>
        </div>
      </div>
    </a>
    {% endfor %}
  </div>
  {% endif %}
{% endfor %}

<!-- ===== Ø´Ø¨ÙƒØ© Ù…Ø®ØªÙ„Ø·Ø© Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø© ===== -->
<div class="section-head mt-3">
  <div class="section-title">Ø§ÙƒØªØ´Ù Ø§Ù„Ù…Ø²ÙŠØ¯</div>
</div>
<div class="mixed-grid">
  {% for it in mixed_items %}
  <a href="/items/{{ it.id }}" class="card spot text-decoration-none">
    <div class="spot-media">
      <img src="{{ it.image_path or it.image or '/static/placeholder.jpg' }}" alt="">
      <div class="spot-overlay"></div>
      <span class="category-chip">{{ category_label(it.category) }}</span>
    </div>
    <div class="card-body spot-body">
      <div class="spot-title">{{ it.title }}</div>
      <div class="owner-line">
        <div class="owner-avatar--placeholder">ğŸ·ï¸</div>
        <span class="city-chip">{{ it.city or 'â€”' }}</span>
      </div>
    </div>
  </a>
  {% endfor %}
</div>

{% endblock %}

{% block scripts %}
<script>
  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
  function snap(el, dir=1){
    const node = document.querySelector(el);
    if(!node) return;
    const w = node.clientWidth * 0.9;
    node.scrollBy({left: dir*w, behavior:'smooth'});
  }
  document.querySelectorAll('[data-snap-prev]').forEach(b=>{
    b.addEventListener('click', ()=> snap(b.dataset.snapPrev, -1));
  });
  document.querySelectorAll('[data-snap-next]').forEach(b=>{
    b.addEventListener('click', ()=> snap(b.dataset.snapNext, +1));
  });
</script>
{% endblock %}