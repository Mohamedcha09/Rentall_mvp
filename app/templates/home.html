{# app/templates/home.html #}
{% extends "base.html" %}

{% block head %}
<style>
  .hrow{display:flex;gap:14px;overflow-x:auto;scroll-snap-type:x mandatory;padding:6px 4px 12px}
  .hrow::-webkit-scrollbar{height:8px}
  .hrow::-webkit-scrollbar-thumb{background:color-mix(in oklab,var(--text) 18%,transparent);border-radius:999px}
  .hcard{min-width:86%;max-width:86%;scroll-snap-align:start}
  @media (min-width:576px){.hcard{min-width:58%;max-width:58%}}
  @media (min-width:992px){.hcard{min-width:360px;max-width:360px}}
  .section-head{margin:12px 2px 8px;display:flex;align-items:center;justify-content:space-between}
  .section-title{font-weight:800;font-size:1.15rem}
  .arrow-btn{border:1px solid var(--border);background:transparent;border-radius:12px;width:42px;height:42px;display:grid;place-items:center}
  .arrow-btn:hover{background:color-mix(in oklab,var(--text) 8%,transparent)}
  .mixed-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
  @media (max-width:480px){.mixed-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .spot-media{position:relative;overflow:hidden;border-radius:16px 16px 0 0}
  .spot-media img{width:100%;height:220px;object-fit:cover;display:block}
  .spot-overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.05),rgba(0,0,0,.15));pointer-events:none}
  .price-badge{position:absolute;right:10px;top:10px;font-weight:800;font-size:.9rem;background:rgba(0,0,0,.75);color:#fff;padding:6px 10px;border-radius:999px}
  .category-chip{position:absolute;left:10px;top:10px;font-weight:700;font-size:.8rem;background:rgba(255,255,255,.9);color:var(--text);padding:6px 10px;border-radius:999px;backdrop-filter:blur(6px)}
  .fav-btn{position:absolute;right:10px;top:56px;width:40px;height:40px;border:none;outline:none;cursor:pointer;border-radius:999px;background:rgba(255,255,255,.92);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(0,0,0,.12)}
  .fav-btn .bi{font-size:18px;line-height:1;color:#a944ec}
  .fav-btn.is-fav{background:#a944ec}
  .fav-btn.is-fav .bi{color:#fff}

  /* ========= Hero Carousel (صور فقط) ========= */
  .hero-carousel{ position:relative; border-radius:16px; overflow:hidden; box-shadow: var(--shadow); }
  .hero-carousel .carousel-item{ max-height:520px; overflow:hidden; }
  .hero-carousel .carousel-item img{ width:100%; height:520px; object-fit:cover; object-position:center; display:block; }

  /* لا مؤشرات، ولا كابشن */
  .hero-carousel .carousel-indicators{ display:none !important; }
  .hero-carousel .carousel-caption{ display:none !important; }

  @media (max-width:992px){
    .hero-carousel .carousel-item img{ height:380px; }
  }
  @media (max-width:576px){
    .hero-carousel .carousel-item img{ height:300px; }
  }

  /* ===== Desktop-only Amazon look (edge bleed + white shelves) ===== */
  @media (min-width: 992px){
    .edge-bleed{ margin-inline: calc(50% - 50vw); width:100vw; }
    .hero-carousel::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:160px;
      background: linear-gradient(180deg, rgba(255,255,255,0) 0%, #ffffff 85%);
      pointer-events:none;
    }
    .home-shelves{
      background:#fff; border-radius:18px 18px 0 0; box-shadow:0 8px 26px rgba(0,0,0,.06);
      margin-top:-80px; padding:16px 18px 20px;
    }
    .home-shelves.container-xl{ max-width:1320px; }
  }

  /* ============== HERO FINAL OVERRIDE ============== */
  .edge-bleed .hero-carousel,
  .hero-carousel{
    border-radius:22px !important;
    overflow:hidden !important;
    box-shadow:0 12px 36px rgba(0,0,0,.10) !important;
  }
  .edge-bleed .hero-carousel .carousel-item,
  .hero-carousel .carousel-item{
    height:auto !important;
    max-height:none !important;
    aspect-ratio: 3 / 2 !important; /* صورك 1536x1024 */
    overflow:hidden !important;
    border-radius:22px !important;
  }
  .edge-bleed .hero-carousel .carousel-item img,
  .hero-carousel .carousel-item img{
    width:100% !important;
    height:100% !important;
    object-fit:contain !important;  /* عرض الصورة كاملة */
    object-position:center !important;
    display:block !important;
    background:#eef2f7 !important;
    border-radius:22px !important;
  }
  .edge-bleed .hero-carousel::before,
  .edge-bleed .hero-carousel::after,
  .hero-carousel::before,
  .hero-carousel::after{
    content:none !important;
    display:none !important;
  }
  .hero-carousel .carousel-control-prev,
  .hero-carousel .carousel-control-next{ width:8% !important; }
  @media (max-width:768px){
    .hero-carousel{ border-radius:18px !important; }
    .hero-carousel .carousel-item{ aspect-ratio:3/2 !important; }
  }
  @media (min-width:992px){
    .edge-bleed{ margin-inline:auto !important; width:auto !important; }
    .hero-carousel{ max-width:1100px !important; margin:0 auto 18px !important; }
    .home-shelves{ margin-top:16px !important; }
  }
</style>
{% endblock %}

{% block content %}
<!-- HERO -->
<div class="edge-bleed">
  <div id="heroCarousel" class="carousel slide hero-carousel mb-0"
       data-bs-ride="carousel" data-bs-interval="5000" data-bs-touch="true">

    <div class="carousel-inner">
      {% if banners and banners|length > 0 %}
        {% for src in banners %}
          <div class="carousel-item {% if loop.index0 == 0 %}active{% endif %}">
            <img src="{{ src }}" alt="">
          </div>
        {% endfor %}
      {% else %}
        <div class="carousel-item active">
          <img src="{{ url_for('static', path='img/banners/banner1.jpg') }}" alt="">
        </div>
        <div class="carousel-item">
          <img src="{{ url_for('static', path='img/banners/banner2.jpg') }}" alt="">
        </div>
        <div class="carousel-item">
          <img src="{{ url_for('static', path='img/banners/banner3.jpg') }}" alt="">
        </div>
      {% endif %}
    </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
    </button>
  </div>
</div>

<!-- رفوف المنتجات -->
<div class="home-shelves container-xl">
  {# ... بقية الكود بدون تعديل ... #}
  {{ super() }}
</div>
{% endblock %}

{% block scripts %}
<meta name="is-auth" content="{{ '1' if (session_user is defined and session_user) else '0' }}">
<script id="fav-data" type="application/json">{{ favorites_ids | default([]) | tojson }}</script>

<script>
  function snap(el, dir=1){
    const node=document.querySelector(el);
    if(!node) return;
    const step=Math.max(280,node.clientWidth*0.85);
    node.scrollBy({left:dir*step,behavior:'smooth'});
  }
  document.querySelectorAll('[data-snap-prev]').forEach(b=>b.addEventListener('click',()=>snap(b.dataset.snapPrev,-1)));
  document.querySelectorAll('[data-snap-next]').forEach(b=>b.addEventListener('click',()=>snap(b.dataset.snapNext,+1)));

  const IS_AUTH=(document.querySelector('meta[name="is-auth"]')?.content==='1');
  let FAVORITES_IDS=[];
  try{FAVORITES_IDS=JSON.parse(document.getElementById('fav-data')?.textContent||'[]')}catch(e){}

  function markExistingFavorites(){
    document.querySelectorAll('.fav-btn').forEach(btn=>{
      const id=Number(btn.dataset.id);
      if(FAVORITES_IDS.includes(id)){
        btn.classList.add('is-fav');
        const icon=btn.querySelector('.bi');
        if(icon){icon.classList.remove('bi-heart');icon.classList.add('bi-heart-fill');}
      }
    });
  }

  document.addEventListener('click',async e=>{
    const btn=e.target.closest('.fav-btn'); if(!btn)return;
    e.preventDefault(); e.stopPropagation();
    if(!IS_AUTH){window.location.href='/login';return;}
    const id=Number(btn.dataset.id);
    const add=!btn.classList.contains('is-fav');
    try{
      const res=await fetch(`/api/favorites/${id}`,{method:add?'POST':'DELETE'});
      if(!res.ok)throw new Error();
      btn.classList.toggle('is-fav',add);
      const icon=btn.querySelector('.bi');
      if(icon){icon.classList.toggle('bi-heart',!add);icon.classList.toggle('bi-heart-fill',add);}
    }catch{alert('تعذّر حفظ المفضلة مؤقتًا.');}
  });

  markExistingFavorites();
</script>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const el=document.getElementById('heroCarousel');
  if(!el)return;
  el.addEventListener('mouseenter',()=>bootstrap.Carousel.getOrCreateInstance(el).pause());
  el.addEventListener('mouseleave',()=>bootstrap.Carousel.getOrCreateInstance(el).cycle());
});
</script>
{% endblock %}