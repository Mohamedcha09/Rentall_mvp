{% extends "base.html" %}

{% block head %}
<style>
  /* رأس القسم + أزرار */
  .section-head{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; margin: 8px 2px; padding: 2px 4px;
  }
  .section-title{ font-weight:800; font-size:1.15rem }
  .arrow-btn{
    border:1px solid var(--border); background:rgba(255,255,255,.06);
    border-radius:12px; width:40px; height:40px; display:grid; place-items:center;
  }
  .arrow-btn:hover{ background:color-mix(in oklab, var(--text) 8%, transparent) }

  /* صف أفقي قابل للسحب */
  .hrow{
    display:grid; grid-auto-flow: column;
    grid-auto-columns: 88%; gap:12px;
    overflow-x:auto; overscroll-behavior-x: contain;
    scroll-snap-type: x mandatory; padding: 4px 2px 8px;
  }
  .hrow::-webkit-scrollbar{ height:8px }
  .hcard{ scroll-snap-align: start }
  @media (min-width:576px){ .hrow{ grid-auto-columns: 60% } }
  @media (min-width:768px){ .hrow{ grid-auto-columns: 42% } }
  @media (min-width:992px){ .hrow{ grid-auto-columns: 32% } }

  /* كرت العنصر (نعتمد ستايلك الأساسي) */
  .card.spot.hcard{ border-radius:18px; overflow:hidden }
  .spot-media{ position:relative; aspect-ratio:16/10; overflow:hidden }
</style>
{% endblock %}

{% block content %}

<!-- == سلايدر “شائع بالقرب منك” إن وُجدت بيانات == -->
{% if popular_items and popular_items|length %}
  <div class="section-head">
    <div class="section-title">شائع بالقرب منك</div>
    <div class="d-flex gap-2">
      <button class="arrow-btn" data-snap-prev="#row-pop"><i class="bi bi-chevron-right"></i></button>
      <button class="arrow-btn" data-snap-next="#row-pop"><i class="bi bi-chevron-left"></i></button>
    </div>
  </div>
  <div id="row-pop" class="hrow">
    {% for it in popular_items %}
      <a href="/items/{{ it.id }}" class="card spot hcard text-decoration-none">
        <div class="spot-media">
          <img src="{{ it.image_path or '/static/placeholder.jpg' }}" alt="">
          <div class="spot-overlay"></div>
          <span class="price-badge">{{ it.price_per_day|default(0) }}$ /يوم</span>
          <span class="category-chip">{{ category_label(it.category) }}</span>
        </div>
        <div class="card-body spot-body">
          <div class="spot-title">{{ it.title }}</div>
          <div class="owner-line">
            <div class="owner-avatar--placeholder">🏷️</div>
            <span class="city-chip">{{ it.city or '—' }}</span>
          </div>
          <div class="spot-footer">
            <small class="text-muted">تقييم {{ it.rating|default(4.8) }}</small>
            <i class="bi bi-arrow-left-short"></i>
          </div>
        </div>
      </a>
    {% endfor %}
  </div>
{% endif %}

<!-- == سلايدر لكل تصنيف موجود == -->
{% for cat in categories %}
  {% set code = cat.code or cat['code'] %}
  {% set list = items_by_category.get(code, []) %}
  {% if list and list|length %}
    <div class="section-head mt-2">
      <div class="section-title">{{ category_label(code) }}</div>
      <div class="d-flex gap-2">
        <button class="arrow-btn" data-snap-prev="#row-{{ code }}"><i class="bi bi-chevron-right"></i></button>
        <button class="arrow-btn" data-snap-next="#row-{{ code }}"><i class="bi bi-chevron-left"></i></button>
      </div>
    </div>

    <div id="row-{{ code }}" class="hrow">
      {% for it in list %}
        <a href="/items/{{ it.id }}" class="card spot hcard text-decoration-none">
          <div class="spot-media">
            <img src="{{ it.image_path or '/static/placeholder.jpg' }}" alt="">
            <div class="spot-overlay"></div>
            <span class="price-badge">{{ it.price_per_day|default(0) }}$ /يوم</span>
            <span class="category-chip">{{ category_label(it.category) }}</span>
          </div>
          <div class="card-body spot-body">
            <div class="spot-title">{{ it.title }}</div>
            <div class="owner-line">
              <div class="owner-avatar--placeholder">🏷️</div>
              <span class="city-chip">{{ it.city or '—' }}</span>
            </div>
            <div class="spot-footer">
              <small class="text-muted">تقييم {{ it.rating|default(4.8) }}</small>
              <i class="bi bi-arrow-left-short"></i>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}
{% endfor %}

<!-- == شبكة “كل العناصر” في الأسفل == -->
<div class="section-head mt-3">
  <div class="section-title">كل العناصر</div>
</div>

{% set all = all_items or [] %}
{% if all|length %}
  <div class="home-grid">
    {% for it in all %}
      <a href="/items/{{ it.id }}" class="card spot text-decoration-none">
        <div class="spot-media">
          <img src="{{ it.image_path or '/static/placeholder.jpg' }}" alt="">
          <div class="spot-overlay"></div>
          <span class="category-chip">{{ category_label(it.category) }}</span>
        </div>
        <div class="card-body spot-body">
          <div class="spot-title">{{ it.title }}</div>
          <div class="owner-line">
            <div class="owner-avatar--placeholder">🏷️</div>
            <span class="city-chip">{{ it.city or '—' }}</span>
          </div>
          <div class="spot-footer">
            <small class="text-muted">{{ it.price_per_day|default(0) }}$ /يوم</small>
            <i class="bi bi-arrow-left-short"></i>
          </div>
        </div>
      </a>
    {% endfor %}
  </div>
{% else %}
  <div class="card glass p-4 text-center text-muted">لا توجد عناصر حتى الآن.</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
  // تمرير أفقي للسلايدرات
  function snap(sel, dir){
    const node = document.querySelector(sel);
    if(!node) return;
    const amount = Math.round(node.clientWidth * 0.92);
    node.scrollBy({ left: dir * amount, behavior: 'smooth' });
  }
  document.querySelectorAll('[data-snap-prev]').forEach(btn=>{
    btn.addEventListener('click', ()=> snap(btn.dataset.snapPrev, -1));
  });
  document.querySelectorAll('[data-snap-next]').forEach(btn=>{
    btn.addEventListener('click', ()=> snap(btn.dataset.snapNext, +1));
  });
</script>
{% endblock %}