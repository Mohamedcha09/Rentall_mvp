{% extends "base.html" %}
{% block content %}

<!-- ===== Ø´Ø±ÙŠØ· Ø£Ø¹Ù„Ù‰: ÙÙ„Ø§ØªØ± + ÙØ±Ø² ===== -->
<section class="mb-3">
  <div class="card card-search p-2 p-md-3">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <!-- ØªØµÙ†ÙŠÙØ§Øª Ø³Ø±ÙŠØ¹Ø© ÙƒÙ€ Chips -->
      <div class="home-cats d-flex flex-wrap gap-2">
        {% set cats = [
          ('all','Ø§Ù„ÙƒÙ„'), ('tech','Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª'), ('games','Ø£Ù„Ø¹Ø§Ø¨'),
          ('tools','Ø£Ø¯ÙˆØ§Øª'), ('vehicles','Ù…Ø±ÙƒØ¨Ø§Øª'), ('home','Ù…Ù†Ø²Ù„ÙŠ')
        ] %}
        {% for key,label in cats %}
          <a class="btn btn-sm btn-outline-light {% if request.query_params.get('cat','all') == key %}active{% endif %}"
             href="/?cat={{ key }}">{{ label }}</a>
        {% endfor %}
      </div>

      <div class="vr d-none d-md-block mx-2 opacity-25"></div>

      <!-- Ø­Ù‚Ù„ Ø¨Ø­Ø« Ù…Ø­Ù„ÙŠ (ÙŠØµÙÙ‘ÙŠ Ø¶Ù…Ù† Ø§Ù„ØµÙØ­Ø©) -->
      <div class="flex-grow-1" style="min-width:220px;">
        <input id="qLocal" type="search" class="form-control"
               placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©â€¦">
      </div>

      <!-- ÙØ±Ø² -->
      <div class="ms-auto d-flex align-items-center gap-2">
        <select id="sortSelect" class="form-select form-select-sm" style="min-width:160px;">
          <option value="new">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
          <option value="price_asc">Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ù‚Ù„</option>
          <option value="price_desc">Ø§Ù„Ø³Ø¹Ø±: Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</option>
          <option value="popular">Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- ===== Ø§Ù„Ø´Ø¨ÙƒØ© ===== -->
<section>
  <!-- Placeholder skeletons Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div id="grid" class="home-grid">
    {% if items and items|length %}
      {% for it in items %}
        <article class="card spot item-card"
                 data-title="{{ (it.title or '')|lower }}"
                 data-price="{{ it.price_per_day or 0 }}"
                 data-pop="{{ it.views or 0 }}">
          <div class="spot-media">
            <!-- Lazy image -->
            <img class="lazy" data-src="{{ it.cover_url or '/static/img/placeholder.jpg' }}"
                 alt="{{ it.title or 'item' }}" loading="lazy">
            <div class="spot-overlay"></div>

            {% if it.price_per_day %}
              <div class="price-badge">{{ it.price_per_day }} Ø¯/ÙŠÙˆÙ…</div>
            {% endif %}
            {% if it.category_name %}
              <div class="category-chip">{{ it.category_name }}</div>
            {% endif %}
          </div>

          <div class="card-body">
            <h6 class="card-title mb-2">{{ it.title }}</h6>

            <div class="d-flex align-items-center justify-content-between owner-line mb-2">
              <div class="d-flex align-items-center gap-2">
                {% if it.owner_avatar %}
                  <img class="owner-avatar" src="{{ it.owner_avatar }}" alt="{{ it.owner_name }}">
                {% else %}
                  <div class="owner-avatar--placeholder">ğŸ‘¤</div>
                {% endif %}
                <small class="text-muted">{{ it.owner_name or 'Ù…Ø³ØªØ®Ø¯Ù…' }}</small>
                {% if it.owner %}
                  {{ render_badges(it.owner, 16) }}
                {% endif %}
              </div>
              {% if it.city %}
                <span class="city-chip">{{ it.city }}</span>
              {% endif %}
            </div>

            <div class="d-flex align-items-center justify-content-between">
              <a href="/items/{{ it.id }}" class="btn btn-sm btn-primary">ØªÙØ§ØµÙŠÙ„</a>
              <button class="btn btn-sm btn-outline-light btn-fav" data-id="{{ it.id }}" title="Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©">â™¡</button>
            </div>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <!-- Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© Ø£Ù†ÙŠÙ‚Ø© -->
      <div class="card p-4 text-center" style="grid-column:1/-1;">
        <h5 class="mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯</h5>
        <p class="text-muted mb-3">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ù„Ùƒ Ù„ÙŠØ³ØªÙÙŠØ¯ Ù…Ù†Ù‡ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ† âœ¨</p>
        {% if session_user and session_user.status == 'approved' %}
          <a href="/owner/items/new" class="btn btn-primary">+ Ø£Ø¶Ù Ø¹Ù†ØµØ±</a>
        {% else %}
          <a href="/login" class="btn btn-outline-light">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</a>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {% if next_page_token %}
    <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Pagination Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±) -->
    <div class="text-center mt-3">
      <a href="/?page_token={{ next_page_token }}" class="btn btn-outline-light">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯</a>
    </div>
  {% endif %}
</section>

<!-- ===== Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© ØµØºÙŠØ±Ø© (ØªØ­Ø³ÙŠÙ†Ø§Øª Ù…Ø±Ø¦ÙŠØ©) ===== -->
<style>
  /* Ø¸Ù„ Ø¯Ø§Ø®Ù„ÙŠ Ø®ÙÙŠÙ Ù„Ù„ÙƒØ±ÙˆØª */
  .item-card{ box-shadow: var(--shadow); }
  .item-card .btn-fav.active{ background: rgba(255,255,255,.1)!important; }
  /* Ø³ÙƒÙŠÙ„ÙŠØªÙˆÙ† (ÙÙŠ Ø­Ø§Ù„ Ø£Ø±Ø¯Øª Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ) */
  .skeleton{ position:relative; overflow:hidden; background:rgba(255,255,255,.06); }
  .skeleton::after{
    content:""; position:absolute; inset:0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent);
    animation: shimmer 1.2s infinite;
  }
  @keyframes shimmer{ 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
</style>

<!-- ===== Ø³ÙƒØ±ÙŠØ¨Øª: Lazy images + Ø¨Ø­Ø« Ù…Ø­Ù„ÙŠ + ÙØ±Ø² + Ù…ÙØ¶Ù„Ø© ===== -->
<script>
(() => {
  // --- Lazy load
  const lazyImgs = document.querySelectorAll('img.lazy');
  if ('IntersectionObserver' in window) {
    const obs = new IntersectionObserver((entries, io) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const img = e.target;
          const src = img.getAttribute('data-src');
          if (src) { img.src = src; img.removeAttribute('data-src'); }
          img.classList.remove('lazy');
          io.unobserve(img);
        }
      });
    }, { rootMargin: '200px' });
    lazyImgs.forEach(img => obs.observe(img));
  } else {
    lazyImgs.forEach(img => img.src = img.getAttribute('data-src'));
  }

  // --- Local search
  const q = document.getElementById('qLocal');
  const grid = document.getElementById('grid');
  function filterGrid(){
    const term = (q.value || '').trim().toLowerCase();
    const cards = grid.querySelectorAll('.item-card');
    cards.forEach(c => {
      const title = c.dataset.title || '';
      c.style.display = title.includes(term) ? '' : 'none';
    });
  }
  q && q.addEventListener('input', filterGrid);

  // --- Sort
  const sortSelect = document.getElementById('sortSelect');
  function sortGrid(){
    const val = sortSelect.value;
    const cards = Array.from(grid.querySelectorAll('.item-card'));
    const byPrice = (a,b) => (+a.dataset.price||0) - (+b.dataset.price||0);
    const byPop   = (a,b) => (+b.dataset.pop||0) - (+a.dataset.pop||0);
    const byNew   = () => 0; // Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø§Ù„ÙØ¹Ù„ ÙŠØ¹Ø·ÙŠ Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø§Ø¯Ø©Ù‹

    let cmp = byNew;
    if (val === 'price_asc') cmp = byPrice;
    if (val === 'price_desc') cmp = (a,b)=>byPrice(b,a);
    if (val === 'popular') cmp = byPop;

    cards.sort(cmp).forEach(c => grid.appendChild(c));
  }
  sortSelect && sortSelect.addEventListener('change', sortGrid);

  // --- Favorite toggle (ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·ØŒ Ø§Ø±Ø¨Ø·Ù‡ Ø¨ API Ù„Ùˆ Ù…ØªØ§Ø­)
  grid.addEventListener('click', async (e) => {
    const btn = e.target.closest('.btn-fav');
    if (!btn) return;
    btn.classList.toggle('active');
    btn.textContent = btn.classList.contains('active') ? 'â™¥' : 'â™¡';
    // TODO: fetch('/api/fav/toggle', {method:'POST', body: JSON.stringify({id: btn.dataset.id})})
  });
})();
</script>

{% endblock %}
