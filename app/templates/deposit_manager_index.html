{% extends "base.html" %}
{% block head %}
<style>
  .dm-wrap{max-width:1100px;margin:auto}
  .dm-tabs a{padding:8px 12px;border:1px solid var(--border);border-radius:10px;text-decoration:none}
  .dm-tabs a.active{background:var(--surface-2,#222);color:#fff;border-color:transparent}
  .dm-card{border:1px solid var(--border);border-radius:14px;padding:14px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .k{opacity:.7}
  .row-gap{display:grid;gap:12px}
  .badge-soft{border:1px solid var(--border);border-radius:999px;padding:2px 8px}
  .acts .btn{margin-inline-end:6px;margin-block-end:6px}
  .dm-empty{border:1px dashed var(--border);border-radius:14px;padding:24px;text-align:center;color:#888}
</style>
{% endblock %}

{% block content %}
<div class="dm-wrap">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Deposit Manager Dashboard</h4>
    <div class="dm-tabs d-flex gap-2">
      <a href="/deposit-manager?view=pending" class="{% if view=='pending' %}active{% endif %}">Pending</a>
      <a href="/deposit-manager?view=in_review" class="{% if view=='in_review' %}active{% endif %}">In Review</a>
      <a href="/deposit-manager?view=resolved" class="{% if view=='resolved' %}active{% endif %}">Resolved</a>
    </div>
  </div>

  {% if not rows or rows|length == 0 %}
    <div class="dm-empty">No cases in this tab.</div>
  {% else %}
    <div class="row-gap">
      {% for bk in rows %}
      <div class="dm-card">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="d-flex align-items-center gap-2">
              <strong>Booking #{{ bk.id }}</strong>
              <span class="badge-soft mono k">{{ bk.status or '—' }}</span>
              <span class="badge-soft mono k">Deposit: {{ bk.deposit_status or '—' }}</span>
            </div>
            <div class="k">
              Item: <a href="/items/{{ bk.item_id }}">#{{ bk.item_id }}</a> ·
              Owner: <a href="/users/{{ bk.owner_id }}">#{{ bk.owner_id }}</a> ·
              Renter: <a href="/users/{{ bk.renter_id }}">#{{ bk.renter_id }}</a>
            </div>
            <div class="k mono small mt-1">
              From {{ bk.start_date }} to {{ bk.end_date }} · Days: {{ bk.days }} · Rent total: {{ bk.total_amount }}$
            </div>
            <div class="k mono small">
              Payments: {{ bk.payment_method or '—' }} · Online status: {{ bk.online_status or '—' }}
            </div>
            <div class="k mono small">
              Requested/Held deposit: {{ bk.deposit_amount or bk.hold_deposit_amount or 0 }}$ · Charged: {{ bk.deposit_charged_amount or 0 }}$
            </div>
          </div>
          <div>
            <a class="btn btn-outline-light btn-sm" href="/bookings/flow/{{ bk.id }}">Open booking page</a>
          </div>
        </div>

        <hr class="my-3">

        <div class="acts">
          {% if view == 'pending' %}
            <!-- Claiming moves the case to in_review -->
            <form method="post" action="/deposit-manager/{{ bk.id }}/claim" class="d-inline">
              <button class="btn btn-primary btn-sm">
                <i class="bi bi-clipboard-check"></i> Claim case
              </button>
            </form>
          {% endif %}

          {% if view in ['in_review','pending'] %}
            <!-- Request additional information -->
            <form method="post" action="/deposit-manager/{{ bk.id }}/need-info" class="d-inline">
              <input type="hidden" name="target" value="owner">
              <input type="hidden" name="message" value="Please upload photos/video showing the condition before and after.">
              <button class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-image"></i> Request info from owner
              </button>
            </form>

            <form method="post" action="/deposit-manager/{{ bk.id }}/need-info" class="d-inline">
              <input type="hidden" name="target" value="renter">
              <input type="hidden" name="message" value="Please provide clarifications and counter-photos against the owner's claim.">
              <button class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-question-circle"></i> Request info from renter
              </button>
            </form>

            <!-- Final decision: direct to the unified decision form (/deposits/{id}/decision) via dm_decide -->
            <div class="mt-2 p-2" style="border:1px solid var(--border);border-radius:10px">
              <form method="post" action="/deposit-manager/{{ bk.id }}/decide" class="row g-2">
                <div class="col-md-4">
                  <label class="form-label small k">Decision type</label>
                  <select class="form-select form-select-sm" name="decision" required>
                    <option value="refund_all">Refund full deposit</option>
                    <option value="refund_partial">Partial refund (enter amount)</option>
                    <option value="withhold_all">Withhold full deposit</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label small k">Partial amount (if any)</label>
                  <input class="form-control form-control-sm" type="number" min="0" name="amount" placeholder="0">
                </div>
                <div class="col-md-5">
                  <label class="form-label small k">Decision reason</label>
                  <input class="form-control form-control-sm" type="text" name="reason" placeholder="e.g., Moderate scratches + 1-day delay">
                </div>
                <div class="col-12 mt-1">
                  <button class="btn btn-success btn-sm">
                    <i class="bi bi-shield-check"></i> Execute decision
                  </button>
                  <span class="small k ms-2">The operation will be executed via the unified decision route, then return.</span>
                </div>
              </form>
            </div>
          {% endif %}

          {% if view == 'resolved' %}
            <span class="k">This case is closed/resolved.</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}
