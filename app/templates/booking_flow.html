{% extends "base.html" %}
{% set immersive = true %}

{% block head %}
<style>
  /* ===== Mobile luxe style like Uber/Airbnb ===== */
  :root{
    --mobile-radius:18px;
    --glass: color-mix(in oklab, var(--surface) 85%, transparent);
    --shadow: 0 10px 24px rgba(16,24,40,.08), 0 4px 8px rgba(16,24,40,.06);
    --accent-grad: linear-gradient(135deg,#8b5cf6, #5b9df9);
  }

  .flow-card{max-width:900px;margin:auto}
  .state-badge{
    display:inline-flex;gap:8px;align-items:center;padding:6px 12px;
    border-radius:999px;font-weight:700;
    background:var(--glass); border:1px solid var(--border);
    box-shadow:var(--shadow);
  }
  .k{opacity:.7}
  .acts{display:flex;flex-wrap:wrap;gap:10px}
  .acts form{display:inline}

  /* Soft glass cards */
  .box{
    border:1px solid var(--border);
    border-radius:var(--mobile-radius);
    padding:14px;
    background:var(--glass);
    box-shadow:var(--shadow);
  }
  .hint{
    background: color-mix(in oklab,var(--surface) 92%, transparent);
    border:1px dashed var(--border);
    border-radius:var(--mobile-radius);
    padding:12px 14px;
  }

  /* Large clear mobile buttons */
  .btn-wide{min-width:220px}
  @media (max-width: 576px){
    .btn-wide{min-width:unset;width:100%}
    .flow-card{padding:8px}
  }

  /* Highlighted camera button */
  .btn-camera{
    border:none;
    background:var(--accent-grad);
    color:#fff;
    font-weight:700;
    border-radius:14px;
    padding:14px 16px;
    box-shadow:var(--shadow);
  }

  /* 1/6 counter */
  .progress-dots{display:flex;gap:6px;align-items:center}
  .dot{
    width:8px;height:8px;border-radius:50%;
    background:color-mix(in oklab,var(--muted) 50%, transparent);
    opacity:.5
  }
  .dot.on{background:color-mix(in oklab,#8b5cf6 70%, #5b9df9 30%); opacity:1}

  /* Nice timeline */
  .timeline{display:flex;flex-direction:column;gap:10px}
  .tl-item{
    display:flex;gap:10px;align-items:flex-start;
    padding:10px;border-radius:12px;
    border:1px solid var(--border); background:var(--surface);
  }
  .tl-icon{
    width:36px;height:36px;flex:0 0 36px;border-radius:10px;
    display:grid;place-items:center;color:#fff;
    background:var(--accent-grad); box-shadow:var(--shadow);
  }
  .tl-body{font-size:.95rem}
  .tl-title{font-weight:700}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .muted{opacity:.6}
  .badge-dot{display:inline-flex;gap:6px;align-items:center}
  .badge-dot i{font-size:10px}

  .alert-mini{padding:.6rem .8rem}

  /* Fix tremble modal (iOS/Safari/Bootstrap) */
  .modal, .modal-backdrop{
    will-change: opacity, transform;
    -webkit-transform: translateZ(0); transform: translateZ(0);
    -webkit-backface-visibility: hidden; backface-visibility: hidden;
  }
  .modal.fade .modal-dialog{ transition: none !important; }
  body.modal-open{ padding-right:0 !important; }
  body.modal-open *{ animation:none !important; transition:none !important; }

  /* üîí After submitting rating */
  .star-btn.disabled{ pointer-events:none; opacity:.6; cursor:default; }
  textarea.disabled{ pointer-events:none; opacity:.6; }
  button[disabled]{ pointer-events:none; }
  .num-ltr{ direction:ltr; unicode-bidi:isolate; white-space:nowrap; font-variant-numeric:tabular-nums; }

  /* ===== Mobile Hero (image header) ===== */
  @media (max-width:576px){
    .m-hero-wrap{margin:-8px -8px 8px -8px}
    .m-hero{position:relative}
    .m-hero img{width:100%;height:240px;object-fit:cover;border-radius:0 0 14px 14px}
    .m-hero .overlay{
      position:absolute;inset:0;
      background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.0) 60%);
      border-radius:0 0 14px 14px;
    }
    .m-hero .inside{
      position:absolute;left:12px;right:12px;bottom:12px;
      display:flex;justify-content:space-between;align-items:end;gap:8px;
      color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.45)
    }
    .m-hero .title{font-size:18px;font-weight:700}
    .m-hero .meta{opacity:.9}
    .m-hero .state-badge{
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,.35);
      color:#fff;border-color: rgba(255,255,255,.3);
    }
  }

  /* ===== Sticky Action Bar (mobile) ===== */
  @media (max-width: 576px){
    .sticky-actions{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 12px; z-index: 1040;
      background: color-mix(in oklab, var(--surface) 92%, transparent);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .sticky-actions .btn{ height: 48px; font-weight: 700; border-radius: 14px; }
    .page-bottom-spacer{ height: 74px; }
  }
</style>

{% if dispute_deadline_iso %}
  <script defer src="/static/js/countdown.js"></script>
{% endif %}

<!-- üîí Guard to pause poller during capture/upload -->
<script> window.__CAPTURE_ACTIVE__ = false; </script>
{% endblock %}

{% block content %}
<div class="flow-card card p-3 p-md-4">

  {# ===== Mobile HERO (image header) ===== #}
  {% if item %}
  <div class="m-hero-wrap d-sm-none">
    <div class="m-hero">
      <img src="{{ (item and item.image_path) and (item.image_path.startswith('http://') or item.image_path.startswith('https://')) and item.image_path or ('/' ~ (item.image_path or '').lstrip('/')) if item else '/static/placeholder.jpg' }}" alt="">
      <div class="overlay"></div>
      <div class="inside">
        <div>
          <div class="title">{{ item.title }}</div>
          <div class="meta">{{ category_label(item.category) }} ‚Ä¢ {{ item.price_per_day }}$/day</div>
        </div>
        <span class="state-badge">
          <i class="bi bi-flag"></i><span>{{ booking.status }}</span>
        </span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Header (desktop + tablet view) -->
  <div class="d-none d-sm-flex justify-content-between align-items-start flex-wrap">
    <div class="mb-2">
      <h4 class="mb-1">Booking #{{ booking.id }}</h4>
      <div class="k">
        Item: <strong>{{ item_title }}</strong>
        {% if item %} ‚Äî <a href="/items/{{ item.id }}">Open item page</a>{% endif %}
      </div>
      <div class="k">Period: {{ booking.start_date }} ‚Üí {{ booking.end_date }} ({{ booking.days }} days)</div>
    </div>
    <span class="state-badge mt-1">
      <i class="bi bi-flag"></i>
      <span>Status: {{ booking.status }}</span>
    </span>
  </div>

  <hr class="d-none d-sm-block">

  <div class="row g-3">
    <!-- Left column -->
    <div class="col-12 col-lg-7">

      {# ======= requested ======= #}
      {% if booking.status in ['requested'] %}
        {% if is_owner %}
          <h5 class="mb-2 d-none d-sm-block">New request awaiting your approval</h5>

          <div class="box mb-2">
            <div class="mb-2">Enter the required <strong>deposit</strong> (default = daily price √ó 5)</div>
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision" class="row g-2 align-items-end">
              <input type="hidden" name="decision" value="accepted">
              <div class="col-12 col-md-6">
                <label class="form-label">Deposit amount</label>
                <input id="depositInput" name="deposit_amount" type="number" min="0" step="0.01" class="form-control"
                       value="{{ booking.deposit_amount or 0 }}">
                <div class="form-text k">You can change it before accepting.</div>
              </div>
              <div class="col-12 col-md-6 d-none d-sm-block">
                <button class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> Accept with deposit</button>
              </div>
            </form>
          </div>

          <div class="acts d-none d-sm-flex">
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
              <input type="hidden" name="decision" value="rejected">
              <button class="btn btn-outline-danger"><i class="bi bi-x-lg"></i> Reject</button>
            </form>
          </div>

          <script>
            (function () {
              try {
                var inp = document.getElementById('depositInput');
                if (!inp) return;
                var current = parseFloat(inp.value || '0');
                if (!current || current <= 0) {
                  var pricePerDay = parseFloat('{{ (item.price_per_day or 0)|float }}') || 0;
                  var defVal = Math.max(0, +(pricePerDay * 5).toFixed(2));
                  inp.value = defVal;
                }
              } catch (e) {}
            })();
          </script>

        {% elif is_renter %}
          <div class="hint">Your request has been sent. Waiting for the owner‚Äôs approval‚Ä¶</div>
        {% endif %}
      {% endif %}

      {# ======= accepted ======= #}
      {% if booking.status in ['accepted'] %}
        {% if is_renter %}
          <h5 class="mb-2">Choose a payment method</h5>

          <!-- Cash -->
          <div class="box mb-2">
            <div class="mb-2"><strong>Cash on pickup</strong></div>
            <form method="post" action="/bookings/{{ booking.id }}/pay-cash">
              <button class="btn btn-secondary btn-wide"><i class="bi bi-cash-stack"></i> I will pay cash</button>
            </form>
          </div>

          <!-- Online -->
          <div class="box" id="onlineBox"
               data-rent-authorized="{{ '1' if booking.online_status in ['authorized','captured','succeeded','paid'] else '0' }}"
               data-deposit-held="{{ '1' if booking.deposit_status in ['held','authorized'] else '0' }}">

            <div class="mb-2"><strong>Online payment (Stripe Checkout)</strong></div>

            {% if not owner_pe %}
              <div class="alert alert-warning alert-mini">
                Online payment is not available because the <strong>owner</strong> hasn‚Äôt completed payout onboarding yet.
                {% if owner and owner.id == session_user.id %}
                  <div class="mt-2">
                    <a class="btn btn-primary btn-sm" href="/connect/onboard">
                      <i class="bi bi-person-badge"></i> Complete verification now
                    </a>
                    <small class="d-block k mt-1">After bank & ID verification, online payment will be enabled.</small>
                  </div>
                {% else %}
                  <small class="d-block k mt-1">Please ask the owner to complete bank & ID verification to enable online payment.</small>
                {% endif %}
              </div>
            {% endif %}

            {% set rent_paid = (booking.online_status in ['authorized','captured','succeeded','paid']) %}
            {% set deposit_ok = (booking.deposit_status in ['held','authorized']) %}

            <div id="rentActionWrap" class="d-inline">
              {% if rent_paid %}
                <button id="rentPaidBadge" class="btn btn-success btn-wide me-1" disabled>
                  <i class="bi bi-check2-circle"></i> Rent paid ‚úÖ
                </button>
              {% else %}
                <form id="stripePayRentForm" method="post" action="/api/stripe/checkout/rent/{{ booking.id }}" class="d-inline">
                  <button id="stripePayRentBtn" class="btn btn-outline-primary btn-wide me-1"
                          {% if not owner_pe %}disabled aria-disabled="true"{% endif %}>
                    <i class="bi bi-credit-card-2-front"></i> Pay rent only
                  </button>
                </form>
              {% endif %}
            </div>

            {% if (booking.deposit_amount or booking.hold_deposit_amount) and (booking.deposit_amount or booking.hold_deposit_amount) > 0 %}
            <div id="depositActionWrap" class="d-inline">
              {% if deposit_ok %}
                <button id="depositHeldBadge" class="btn btn-success btn-wide" disabled>
                  <i class="bi bi-shield-check"></i> Deposit held ‚úÖ
                </button>
              {% else %}
                <form id="stripeDepositForm" class="d-inline" method="post" action="/api/stripe/checkout/deposit/{{ booking.id }}">
                  <button id="stripeDepositBtn" class="btn btn-outline-secondary btn-wide"
                          {% if not owner_pe %}disabled aria-disabled="true"{% endif %}>
                    <i class="bi bi-shield-lock"></i> Hold deposit only
                  </button>
                </form>
              {% endif %}
            </div>
            {% endif %}

            <div class="k mt-2">
              You‚Äôll be redirected to Stripe‚Äôs secure checkout to enter your card details. After success you‚Äôll return here and the status will update.
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">Request accepted. Waiting for the renter to choose a payment method‚Ä¶</div>

          {% if not owner_pe %}
            <div class="alert alert-warning mt-2 alert-mini">
              To allow the renter to pay online and transfer funds to you, complete your payout onboarding:
              <div class="mt-2">
                <a class="btn btn-primary btn-sm" href="/connect/onboard">
                  <i class="bi bi-person-badge"></i> Complete verification now
                </a>
              </div>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}

      {# ======= paid ======= #}
      {% if booking.status in ['paid'] %}
        {% if is_renter %}
          <h5 class="d-none d-sm-block">Ready for pickup</h5>
          <div class="hint d-none d-sm-block">Capture pickup photos before confirming.</div>

          <!-- üì∑ Pickup ‚Äî single button (desktop/tablet area) -->
          <div class="box mb-2 d-none d-sm-block">
            <div class="mb-2">Capture pickup photos before confirming.</div>
            <div class="d-grid gap-2">
              <textarea id="pickupComment" class="form-control" rows="2" placeholder="Note (optional)"></textarea>

              <button type="button" id="pickupCaptureBtn" class="btn-camera">
                <i class="bi bi-camera"></i> Capture 6 photos with camera, then upload & continue
              </button>

              <div id="pickupCaptureStatus" class="k small d-flex align-items-center justify-content-between">
                <span class="num-ltr" id="pickupCount">0/6</span>
                <div class="progress-dots">
                  <span class="dot" id="p1"></span><span class="dot" id="p2"></span><span class="dot" id="p3"></span>
                  <span class="dot" id="p4"></span><span class="dot" id="p5"></span><span class="dot" id="p6"></span>
                </div>
              </div>
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">Payment received. Waiting for the renter to confirm pickup.</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/owner/confirm_delivered"></form>
        {% endif %}
      {% endif %}

      {# ======= picked_up ======= #}
      {% if booking.status in ['picked_up'] %}
        {% if is_renter %}
          <h5 class="d-none d-sm-block">You have the item now</h5>
          <div class="hint d-none d-sm-block">On return, capture 6 photos; you‚Äôll be taken to rating afterwards.</div>

          <!-- üì∑ Return ‚Äî single button (desktop/tablet area) -->
          <div class="box mb-2 d-none d-sm-block">
            <div class="mb-2">On return, capture 6 photos and you‚Äôll be sent to the rating step.</div>
            <div class="d-grid gap-2">
              <textarea id="returnComment" class="form-control" rows="2" placeholder="Note (optional)"></textarea>

              <button type="button" id="returnCaptureBtn" class="btn-camera">
                <i class="bi bi-camera"></i> Capture 6 photos with camera, then upload & go to rating
              </button>

              <div id="returnCaptureStatus" class="k small d-flex align-items-center justify-content-between">
                <span class="num-ltr" id="returnCount">0/6</span>
                <div class="progress-dots">
                  <span class="dot" id="r1"></span><span class="dot" id="r2"></span><span class="dot" id="r3"></span>
                  <span class="dot" id="r4"></span><span class="dot" id="r5"></span><span class="dot" id="r6"></span>
                </div>
              </div>
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">Renter picked up the item. Upon return you‚Äôll see steps for confirming return & deposit.</div>
        {% endif %}
      {% endif %}

      {# ======= returned / in_review ======= #}
      {% if booking.status in ['returned', 'in_review'] %}
        {% if is_owner %}
          <h5 class="mb-2">Return marked ‚Äî review</h5>
          <div class="hint mb-2">
            You have a window to file a deposit dispute if there‚Äôs an issue:
            {% if dispute_deadline_iso %}
              <div class="mt-2">
                <span class="badge-dot"><i class="bi bi-circle-fill"></i> Countdown until dispute window ends:</span>
                <div id="deadlineCountdown" class="mono fw-bold">
                  <span class="countdown" data-deadline="{{ dispute_deadline_iso }}"></span>
                </div>
              </div>
            {% endif %}
          </div>
          <form method="get" action="/deposits/{{ booking.id }}/report">
            <button class="btn btn-outline-danger btn-wide">
              <i class="bi bi-exclamation-octagon"></i> Open deposit dispute (damage/issue/delay)
            </button>
          </form>

          <!-- Owner rates renter -->
          <div class="box mt-3" id="ownerRateBox">
            <h6 class="mb-2">Rate the renter</h6>

            {% if owner_already_rated and owner_prev_review %}
              <div class="d-flex align-items-center gap-2 mb-2">
                <div class="text-warning">
                  {% for _ in range(owner_prev_review.stars) %}‚≠ê{% endfor %}
                  {% for _ in range(5 - owner_prev_review.stars) %}‚òÜ{% endfor %}
                </div>
                <span class="small text-muted">Your rating for this booking has been saved.</span>
              </div>
              {% if owner_prev_review.comment %}
                <div class="p-2 rounded" style="border:1px solid var(--border);background:rgba(255,255,255,.04)">
                  {{ owner_prev_review.comment }}
                </div>
              {% endif %}
              <div class="mt-2">
                <a class="btn btn-outline-primary btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">
                  View all renter reviews
                </a>
              </div>
            {% else %}
              <form method="post" action="/reviews/owner/{{ booking.id }}" class="d-flex flex-column gap-2" id="ownerRateForm">
                <input type="hidden" name="rating" id="ownerRatingVal" value="5">
                <div class="d-flex gap-1" id="starsO" role="radiogroup" aria-label="Rate renter">
                  {% for n in [1,2,3,4,5] %}
                    <input class="d-none" type="radio" id="o{{n}}" value="{{n}}" {% if n==5 %}checked{% endif %}>
                    <label for="o{{n}}" class="btn btn-outline-warning btn-sm star-btn" data-val="{{n}}">
                      <i class="bi bi-star-fill"></i> {{n}}
                    </label>
                  {% endfor %}
                </div>
                <textarea name="comment" class="form-control" rows="2" placeholder="Note about renter‚Äôs conduct (optional)"></textarea>
                <div>
                  <button class="btn btn-primary btn-sm" id="ownerRateSubmit">
                    <i class="bi bi-send"></i> Save rating
                  </button>
                </div>
              </form>
            {% endif %}
          </div>

          <div class="hint mt-2">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="small">Renter rating: ‚≠ê {{ renter_reviews_avg }}/5 ‚Äî {{ renter_reviews_count }} reviews</div>
              <a class="btn btn-ghost btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">Open reviews page</a>
            </div>
          </div>

          <div class="k small mt-2">If you don‚Äôt file within the window, the deposit is released automatically to the renter per policy.</div>

        {% elif is_renter %}
          <div class="hint">Return marked. Waiting for Admin/Deposit Manager to decide the deposit.</div>
          {% if dispute_deadline_iso %}
            <div class="k small mt-2">Owner‚Äôs dispute window still active ‚Äî if no disputes, deposit will auto-release after it ends.</div>
          {% endif %}
        {% elif session_user and session_user.role == 'admin' %}
          <div class="hint">This booking is awaiting a deposit decision from Admin/Deposit Manager.</div>
        {% endif %}
      {% endif %}

      {# ======= finished states ======= #}
      {% if booking.status in ['closed','rejected','completed'] %}
        <div class="alert alert-info">
          {% if booking.status in ['closed','completed'] %}
            Process completed ‚úÖ
          {% else %}
            Booking rejected ‚ùå
          {% endif %}
        </div>
      {% endif %}

    </div>

    <!-- Right column: summary -->
    <div class="col-12 col-lg-5">
      <div class="box">
        <h6 class="mb-2">Payment summary</h6>
        <div class="d-flex justify-content-between"><span>Payment method</span><strong>{{ booking.payment_method or '‚Äî' }}</strong></div>
        <div class="d-flex justify-content-between"><span>Rent amount</span><strong>{{ booking.rent_amount or booking.total_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>Deposit on hold</span><strong>{{ booking.hold_deposit_amount or booking.deposit_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>Online charge status</span><strong>{{ booking.online_status or '‚Äî' }}</strong></div>
        <div class="d-flex justify-content-between"><span>Deposit status</span><strong>{{ booking.deposit_status or '‚Äî' }}</strong></div>
        <hr>

        {# üîÅ Replaced raw fields with a readable timeline #}
        <div class="timeline">
          {% if booking.accepted_at %}
          <div class="tl-item">
            <div class="tl-icon">‚úÖ</div>
            <div class="tl-body">
              <div class="tl-title">Request accepted ‚úÖ</div>
              <div class="muted mono num-ltr">{{ booking.accepted_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.picked_up_at %}
          <div class="tl-item">
            <div class="tl-icon">üì¶</div>
            <div class="tl-body">
              <div class="tl-title">Picked up üì¶</div>
              <div class="muted mono num-ltr">{{ booking.picked_up_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.returned_at %}
          <div class="tl-item">
            <div class="tl-icon">üîÑ</div>
            <div class="tl-body">
              <div class="tl-title">Returned üîÑ</div>
              <div class="muted mono num-ltr">{{ booking.returned_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.return_confirmed_by_owner_at %}
          <div class="tl-item">
            <div class="tl-icon">üßæ</div>
            <div class="tl-body">
              <div class="tl-title">Return confirmed by owner üßæ</div>
              <div class="muted mono num-ltr">{{ booking.return_confirmed_by_owner_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.rent_released_at %}
          <div class="tl-item">
            <div class="tl-icon">üí∏</div>
            <div class="tl-body">
              <div class="tl-title">Rent released üí∏</div>
              <div class="muted mono num-ltr">{{ booking.rent_released_at }}</div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      {% if item %}
      <div class="box mt-3">
        <h6 class="mb-2">Item</h6>
        <div class="d-flex gap-3">
          <img src="{{ (item and item.image_path) and (item.image_path.startswith('http://') or item.image_path.startswith('https://')) and item.image_path or ('/' ~ (item.image_path or '').lstrip('/')) if item else '/static/placeholder.jpg' }}"
               style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
          <div>
            <div class="fw-bold">{{ item.title }}</div>
            <div class="k">{{ category_label(item.category) }}</div>
            <div class="k">Daily price: {{ item.price_per_day }}$</div>
            <a class="small" href="/items/{{ item.id }}">Open item page</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Spacer so content doesn't hide behind sticky bar on mobile -->
  <div class="page-bottom-spacer d-sm-none"></div>
</div>

<!-- ===== JS (general) ===== -->
<script>
  function wireDisableOnSubmit(formId, btnId, text){
    var f = document.getElementById(formId);
    if(!f) return;
    f.addEventListener('submit', function(){
      var btn = document.getElementById(btnId);
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ' + (text || 'Redirecting‚Ä¶');
      }
    });
  }

  function markRentPaidUI(){
    var wrap = document.getElementById('rentActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#rentPaidBadge')){
      wrap.innerHTML = '<button id="rentPaidBadge" class="btn btn-success btn-wide me-1" disabled><i class="bi bi-check2-circle"></i> Rent paid ‚úÖ</button>';
    }
  }

  function markDepositHeldUI(){
    var wrap = document.getElementById('depositActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#depositHeldBadge')){
      wrap.innerHTML = '<button id="depositHeldBadge" class="btn btn-success btn-wide" disabled><i class="bi bi-shield-check"></i> Deposit held ‚úÖ</button>';
    }
  }

  wireDisableOnSubmit('stripePayRentForm','stripePayRentBtn','Taking you to payment‚Ä¶');
  wireDisableOnSubmit('stripeDepositForm','stripeDepositBtn','Taking you to payment‚Ä¶');

  (function(){
    try{
      var box = document.getElementById('onlineBox');
      if(!box) return;
      var rentAuth = box.getAttribute('data-rent-authorized') === '1';
      var depHeld  = box.getAttribute('data-deposit-held') === '1';
      if(rentAuth){ markRentPaidUI(); }
      if(depHeld){  markDepositHeldUI(); }
    }catch(e){}
  })();

  (function(){
    if (window.__FLOW_POLLER__ && window.__FLOW_POLLER__.started) return;
    window.__FLOW_POLLER__ = { started:true };

    var bookingId = {{ booking.id }};
    var params = new URLSearchParams(location.search);
    if (params.has('ready')) return;

    var tries = 0, maxTries = 30, redirected = false;
    function modalOpen(){ return !!document.querySelector('.modal.show'); }

    function checkOnce(){
      if (window.__CAPTURE_ACTIVE__) { setTimeout(checkOnce, 1200); return; }
      if (modalOpen()){ setTimeout(checkOnce, 1500); return; }

      fetch('/api/stripe/checkout/state/' + bookingId, {credentials:'same-origin', cache: 'no-store'})
        .then(r => r.ok ? r.json() : {})
        .then(state => {
          try{
            if(state.rent_authorized){ markRentPaidUI(); }
            if(state.deposit_held){   markDepositHeldUI(); }
            if(state.ready_for_pickup && !redirected){
              redirected = true;
              location.assign("/bookings/flow/{{ booking.id }}/next");
              return;
            }
          }catch(e){}
          retry();
        })
        .catch(retry);
    }

    function retry(){
      tries++;
      if(tries > maxTries || redirected) return;
      var delay = (tries < 8) ? 1000 : Math.min(8000, 1000 + tries*700);
      setTimeout(checkOnce, delay);
    }

    checkOnce();

    document.addEventListener('hidden.bs.modal', function(){ tries = 0; checkOnce(); });
    document.addEventListener('visibilitychange', function(){
      if (!document.hidden && !redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
    window.addEventListener('pageshow', function(){
      if(!redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
    window.addEventListener('focus', function(){
      if(!redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
  })();

  {% if dispute_deadline_iso %}
  try{
    if(window.initCountdown){
      initCountdown('deadlineCountdown','{{ dispute_deadline_iso }}');
    }else{
      var el = document.getElementById('deadlineCountdown');
      if(el){ el.textContent = new Date('{{ dispute_deadline_iso }}').toLocaleString(); }
    }
  }catch(e){}
  {% endif %}
</script>

<!-- ===== Owner rating script (lock + localStorage) ===== -->
<script>
(function () {
  try {
    var wrap    = document.getElementById('starsO');
    var frm     = document.getElementById('ownerRateForm');
    var btn     = document.getElementById('ownerRateSubmit');
    var hidden  = document.getElementById('ownerRatingVal');
    var txt     = frm ? frm.querySelector('textarea') : null;
    var box     = document.getElementById('ownerRateBox');

    var KEY = 'ownerRated:' + {{ booking.id }} + ':' + ({{ session_user.id if session_user else 0 }});

    function syncActive(val){
      if(hidden) hidden.value = val;
      if(!wrap) return;
      wrap.querySelectorAll('.star-btn').forEach(function(b){
        b.classList.toggle('btn-warning', b.dataset.val === val);
        b.classList.toggle('btn-outline-warning', b.dataset.val !== val);
      });
    }

    function lockUI(){
      if (btn){ btn.disabled = true; }
      if (wrap){
        wrap.style.pointerEvents = 'none';
        wrap.querySelectorAll('.star-btn').forEach(function(b){
          b.classList.add('disabled');
          b.setAttribute('disabled','disabled');
        });
        wrap.querySelectorAll('input[type=radio]').forEach(function(r){ r.disabled = true; });
      }
      if (txt){
        txt.setAttribute('readonly','readonly');
        txt.classList.add('disabled');
      }
    }

    function replaceWithDoneView(stars, comment){
      if (!box) return;
      var s = parseInt(stars || '5', 10);
      var starsText = '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0,s) + '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'.slice(0,5-s);
      var safeC = (comment || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      box.innerHTML = ''
        + '<h6 class="mb-2">Rate the renter</h6>'
        + '<div class="d-flex align-items-center gap-2 mb-2">'
        + '  <div class="text-warning">'+ starsText +'</div>'
        + '  <span class="small text-muted">Your rating for this booking has been saved.</span>'
        + '</div>'
        + (safeC ? ('<div class="p-2 rounded" style="border:1px solid var(--border);background:rgba(255,255,255,.04)">' + safeC + '</div>') : '')
        + '<div class="mt-2"><a class="btn btn-outline-primary btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">View all renter reviews</a></div>';
    }

    if (wrap){
      var checked = wrap.querySelector('input[type=radio]:checked');
      syncActive(checked ? checked.value : '5');
    }

    if (localStorage.getItem(KEY)){
      if (frm){
        var chosen = (wrap && wrap.querySelector('input[type=radio]:checked'))
                      ? wrap.querySelector('input[type=radio]:checked').value
                      : (hidden && hidden.value) || '5';
        var comment = txt ? txt.value : '';
        replaceWithDoneView(chosen, comment);
      }
    }

    if (wrap){
      wrap.addEventListener('click', function(e){
        var b = e.target.closest('.star-btn');
        if(!b || b.classList.contains('disabled')) return;
        var val = b.dataset.val;
        var inp = document.getElementById('o' + val);
        if(inp) inp.checked = true;
        syncActive(val);
      });
    }

    if (frm && btn){
      frm.addEventListener('submit', function(e){
        if (frm.dataset.locked === '1'){ e.preventDefault(); return; }
        frm.dataset.locked = '1';

        var chosen = (wrap && wrap.querySelector('input[type=radio]:checked'))
                      ? wrap.querySelector('input[type=radio]:checked').value
                      : (hidden && hidden.value) || '5';
        if (hidden) hidden.value = chosen;

        try{ localStorage.setItem(KEY, '1'); }catch(_){}

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving‚Ä¶';
        lockUI();
      }, {capture:true});
    }
  } catch(e){}
})();
</script>

<!-- ===== Single button to capture up to 6 photos + progress dots ===== -->
<script>
(function(){
  function setupAutoCapture(opts){
    var btn      = document.getElementById(opts.buttonId);
    var noteEl   = document.getElementById(opts.commentId);
    var statusEl = document.getElementById(opts.statusId);
    var countEl  = document.getElementById(opts.countId);
    if(!btn) return;

    var MAX = 6;
    var collected = [];
    var uploading = false;
    var started   = false;

    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.setAttribute('capture','environment');

    function setCount(n){
      if(countEl) countEl.textContent = n + '/' + MAX;
      for(var i=1;i<=MAX;i++){
        var d = document.getElementById((opts.prefix||'') + i);
        if(d){ d.classList.toggle('on', i<=n); }
      }
    }
    function setMsg(msg){
      if(!statusEl) return;
      var after = statusEl.querySelector('.msg');
      if(!after){
        after = document.createElement('span');
        after.className = 'msg';
        after.style.marginInlineStart = '6px';
        statusEl.appendChild(after);
      }
      after.textContent = msg || '';
    }
    function label(next){
      if(uploading) return '<span class="spinner-border spinner-border-sm me-1"></span> Uploading‚Ä¶';
      if(!started || collected.length===0) return '<i class="bi bi-camera"></i> Capture first photo';
      if(next < MAX) return '<i class="bi bi-camera"></i> Capture next photo';
      return '<i class="bi bi-upload"></i> Upload photos';
    }
    function refreshUI(){
      btn.disabled = uploading ? true : false;
      btn.innerHTML = label(collected.length+1);
      setCount(collected.length);
    }

    input.addEventListener('change', function(){
      var f = input.files && input.files[0];
      if(f){
        collected.push(f);
        setMsg('Photo added');
        refreshUI();
      }else{
        if(!started){
          collected = [];
          setMsg('Cancelled.');
          refreshUI();
        }else{
          setMsg('You can continue or upload.');
          refreshUI();
        }
      }
      try{ input.value=''; }catch(_){}
    });

    function uploadNow(){
      if(!collected.length || uploading) return;
      uploading = true;
      window.__CAPTURE_ACTIVE__ = true;
      refreshUI();
      setMsg('Uploading‚Ä¶');

      var fd = new FormData();
      for(var i=0;i<collected.length && i<MAX;i++){
        fd.append('files', collected[i], collected[i].name || ('photo'+(i+1)+'.jpg'));
      }
      if(noteEl && noteEl.value){ fd.append('comment', noteEl.value); }

      fetch(opts.postUrl, { method:'POST', body: fd, credentials:'same-origin' })
        .then(function(r){ if(!r.ok) throw new Error('upload failed'); return r.text(); })
        .then(function(){ window.location.assign(opts.nextUrl || window.location.href); })
        .catch(function(){
          uploading = false;
          window.__CAPTURE_ACTIVE__ = false;
          setMsg('Upload failed. Please try again.');
          refreshUI();
        });
    }

    btn.addEventListener('click', function(){
      if(uploading) return;
      started = true;

      if(collected.length >= MAX){
        uploadNow();
        return;
      }
      try{ input.value=''; }catch(_){}
      input.click();
      refreshUI();
    });

    setMsg('‚Ä¶');
    refreshUI();
  }

  // Desktop/tablet buttons (existing)
  setupAutoCapture({
    buttonId: 'pickupCaptureBtn',
    commentId:'pickupComment',
    statusId: 'pickupCaptureStatus',
    countId:  'pickupCount',
    postUrl:  '/bookings/{{ booking.id }}/pickup-proof-upload?next=/bookings/flow/{{ booking.id }}/next',
    nextUrl:  '/bookings/flow/{{ booking.id }}/next',
    prefix:   'p'
  });

  setupAutoCapture({
    buttonId: 'returnCaptureBtn',
    commentId:'returnComment',
    statusId: 'returnCaptureStatus',
    countId:  'returnCount',
    postUrl:  '/bookings/{{ booking.id }}/return-proof-upload?next=/reviews/renter/{{ booking.id }}',
    nextUrl:  '/reviews/renter/{{ booking.id }}',
    prefix:   'r'
  });
})();
</script>

<!-- ===== Sticky Action Bar (mobile) ===== -->
{% if booking.status in ['requested'] and is_owner %}
  <div class="sticky-actions d-sm-none">
    <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
      <input type="hidden" name="decision" value="rejected">
      <button class="btn btn-outline-danger w-100"><i class="bi bi-x-lg"></i> ÿ±ŸÅÿ∂</button>
    </form>
    <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
      <input type="hidden" name="decision" value="accepted">
      <button class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> ŸÇÿ®ŸàŸÑ + ŸàÿØŸäÿπÿ©</button>
    </form>
  </div>
{% endif %}

{% if booking.status in ['paid'] and is_renter %}
  <div class="sticky-actions d-sm-none">
    <button type="button" id="pickupCaptureBtnSticky" class="btn btn-camera w-100" style="grid-column:1/-1">
      <i class="bi bi-camera"></i> ÿßŸÑÿ™ŸÇÿ∑ 6 ÿµŸàÿ± ŸÑŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ
    </button>
  </div>
{% endif %}

{% if booking.status in ['picked_up'] and is_renter %}
  <div class="sticky-actions d-sm-none">
    <button type="button" id="returnCaptureBtnSticky" class="btn btn-camera w-100" style="grid-column:1/-1">
      <i class="bi bi-camera"></i> ÿßŸÑÿ™ŸÇÿ∑ 6 ÿµŸàÿ± ŸÑŸÑÿ•ÿ±ÿ¨ÿßÿπ
    </button>
  </div>
{% endif %}

<script>
  /* Proxy sticky buttons to original capture buttons (single logic source) */
  (function(){
    function proxy(srcId, targetId){
      var s=document.getElementById(srcId), t=document.getElementById(targetId);
      if(s&&t) s.addEventListener('click', ()=>t.click());
    }
    proxy('pickupCaptureBtnSticky','pickupCaptureBtn');
    proxy('returnCaptureBtnSticky','returnCaptureBtn');
  })();
</script>

{% endblock %}
