{% extends "base.html" %}
{% set immersive = true %}

{% block head %}
<style>
  /* ===== Mobile luxe style like Uber/Airbnb ===== */
  :root{
    --mobile-radius:18px;
    --glass: color-mix(in oklab, var(--surface) 85%, transparent);
    --shadow: 0 10px 24px rgba(16,24,40,.08), 0 4px 8px rgba(16,24,40,.06);
    --accent-grad: linear-gradient(135deg,#8b5cf6, #5b9df9);
  }

  .flow-card{max-width:900px;margin:auto}
  .state-badge{
    display:inline-flex;gap:8px;align-items:center;padding:6px 12px;
    border-radius:999px;font-weight:700;
    background:var(--glass); border:1px solid var(--border);
    box-shadow:var(--shadow);
  }
  .k{opacity:.7}
  .acts{display:flex;flex-wrap:wrap;gap:10px}
  .acts form{display:inline}

  /* Soft glass cards */
  .box{
    border:1px solid var(--border);
    border-radius:var(--mobile-radius);
    padding:14px;
    background:var(--glass);
    box-shadow:var(--shadow);
  }
  .hint{
    background: color-mix(in oklab,var(--surface) 92%, transparent);
    border:1px dashed var(--border);
    border-radius:var(--mobile-radius);
    padding:12px 14px;
  }

  /* Large clear mobile buttons */
  .btn-wide{min-width:220px}
  @media (max-width: 576px){
    .btn-wide{min-width:unset;width:100%}
    .flow-card{padding:8px}
  }

  /* Highlighted camera button */
  .btn-camera{
    border:none;
    background:var(--accent-grad);
    color:#fff;
    font-weight:700;
    border-radius:14px;
    padding:14px 16px;
    box-shadow:var(--shadow);
  }

  /* 1/6 counter */
  .progress-dots{display:flex;gap:6px;align-items:center}
  .dot{
    width:8px;height:8px;border-radius:50%;
    background:color-mix(in oklab,var(--muted) 50%, transparent);
    opacity:.5
  }
  .dot.on{background:color-mix(in oklab,#8b5cf6 70%, #5b9df9 30%); opacity:1}

  /* Nice timeline */
  .timeline{display:flex;flex-direction:column;gap:10px}
  .tl-item{
    display:flex;gap:10px;align-items:flex-start;
    padding:10px;border-radius:12px;
    border:1px solid var(--border); background:var(--surface);
  }
  .tl-icon{
    width:36px;height:36px;flex:0 0 36px;border-radius:10px;
    display:grid;place-items:center;color:#fff;
    background:var(--accent-grad); box-shadow:var(--shadow);
  }
  .tl-body{font-size:.95rem}
  .tl-title{font-weight:700}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .muted{opacity:.6}
  .badge-dot{display:inline-flex;gap:6px;align-items:center}
  .badge-dot i{font-size:10px}

  .alert-mini{padding:.6rem .8rem}

  /* Fix tremble modal (iOS/Safari/Bootstrap) */
  .modal, .modal-backdrop{
    will-change: opacity, transform;
    -webkit-transform: translateZ(0); transform: translateZ(0);
    -webkit-backface-visibility: hidden; backface-visibility: hidden;
  }
  .modal.fade .modal-dialog{ transition: none !important; }
  body.modal-open{ padding-right:0 !important; }
  body.modal-open *{ animation:none !important; transition:none !important; }

  /* ğŸ”’ After submitting rating */
  .star-btn.disabled{ pointer-events:none; opacity:.6; cursor:default; }
  textarea.disabled{ pointer-events:none; opacity:.6; }
  button[disabled]{ pointer-events:none; }
  .num-ltr{ direction:ltr; unicode-bidi:isolate; white-space:nowrap; font-variant-numeric:tabular-nums; }

  /* ===== Mobile Hero (image header) ===== */
  @media (max-width:576px){
    .m-hero-wrap{margin:-8px -8px 8px -8px}
    .m-hero{position:relative}
    .m-hero img{width:100%;height:240px;object-fit:cover;border-radius:0 0 14px 14px}
    .m-hero .overlay{
      position:absolute;inset:0;
      background: linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,.0) 60%);
      border-radius:0 0 14px 14px;
    }
    .m-hero .inside{
      position:absolute;left:12px;right:12px;bottom:12px;
      display:flex;justify-content:space-between;align-items:end;gap:8px;
      color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.45)
    }
    .m-hero .title{font-size:18px;font-weight:700}
    .m-hero .meta{opacity:.9}
    .m-hero .state-badge{
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,.35);
      color:#fff;border-color: rgba(255,255,255,.3);
    }
  }

  /* ===== Sticky Action Bar (mobile) ===== */
  @media (max-width: 576px){
    .sticky-actions{
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px 12px; z-index: 1040;
      background: color-mix(in oklab, var(--surface) 92%, transparent);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .sticky-actions .btn{ height: 48px; font-weight: 700; border-radius: 14px; }
    .page-bottom-spacer{ height: 74px; }
  }

  /* ==== flow-only (booking pages) ==== */
.flow-only-fab{
  position:fixed; left:12px; top:calc(12px + env(safe-area-inset-top,0px));
  z-index:10020;
}
.flow-only-btn{
  appearance:none; border:0; width:44px; height:44px; border-radius:50%;
  display:grid; place-items:center; cursor:pointer;
  background:#2f2f33;            /* Ø¯Ø§Ø¦Ø±Ø© Ø¯Ø§ÙƒÙ†Ø© */
  box-shadow:0 8px 20px rgba(0,0,0,.25);
  color:#fff;                     /* Ø§Ù„Ø³Ù‡Ù… Ø£Ø¨ÙŠØ¶ Ø¯Ø§Ø®Ù„Ù‡Ø§ */
  font-size:18px; line-height:1;
}
/* ÙØ±Ø§Øº Ø¹Ù„ÙˆÙŠ ØµØºÙŠØ± Ù„Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
@media (max-width:576px){
  #flowTopSpace{ height: env(safe-area-inset-top, 0px); }
}


/* === Owner (requested) sticky bar â€” mobile glass === */
@media (max-width:576px){
  /* Ø§Ø±ÙØ¹ Ø§Ù„Ø´Ø±ÙŠØ· Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙˆÙÙˆÙ‚ Ø®Ø· Ø§Ù„Ø¢ÙŠÙÙˆÙ† */
  .sticky-actions.owner-actions{
    position: fixed;
    left: 0; right: 0; bottom: 0;
    transform: translate3d(0,-14px,0);
    padding: 12px 12px calc(18px + env(safe-area-inset-bottom,0px));
    background: color-mix(in oklab, var(--surface) 86%, transparent);
    -webkit-backdrop-filter: blur(14px) saturate(120%);
            backdrop-filter: blur(14px) saturate(120%);
    border-top: 1px solid color-mix(in oklab, var(--border) 70%, transparent);
    box-shadow: 0 -12px 30px rgba(0,0,0,.28);
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    z-index: 1060;
  }

  /* ÙØ±Ø§Øº Ø£Ø³ÙÙ„ Ù„Ù…Ù†Ø¹ ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  .page-bottom-spacer{ height: calc(98px + env(safe-area-inset-bottom,0px)) !important; }

  /* Ø£Ø³Ø§Ø³ Ø²Ø± Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (ÙŠØªØºÙ„Ø¨ Ø¹Ù„Ù‰ Bootstrap) */
  .sticky-actions.owner-actions .btn{
    -webkit-appearance: none;
    appearance: none;
    height: 52px;
    border-radius: 16px !important;
    font-weight: 800;
    letter-spacing: .2px;
    border: 1px solid rgba(255,255,255,.22) !important;
    color:#fff !important;
    background-color: transparent !important;
    box-shadow: 0 8px 24px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.18) !important;
  }

  /* Ø£Ø®Ø¶Ø± Ø²Ø¬Ø§Ø¬ÙŠ */
  .sticky-actions.owner-actions .btn.btn-glass-green{
    background-image: linear-gradient(180deg, rgba(34,197,94,.90), rgba(16,185,129,.78)) !important;
    -webkit-backdrop-filter: blur(12px) saturate(130%);
            backdrop-filter: blur(12px) saturate(130%);
    box-shadow: 0 8px 24px rgba(16,185,129,.30), inset 0 1px 0 rgba(255,255,255,.18) !important;
  }

  /* Ø£Ø­Ù…Ø± Ø²Ø¬Ø§Ø¬ÙŠ */
  .sticky-actions.owner-actions .btn.btn-glass-red{
    background-image: linear-gradient(180deg, rgba(244,63,94,.92), rgba(239,68,68,.80)) !important;
    -webkit-backdrop-filter: blur(12px) saturate(130%);
            backdrop-filter: blur(12px) saturate(130%);
    box-shadow: 0 8px 24px rgba(239,68,68,.30), inset 0 1px 0 rgba(255,255,255,.18) !important;
  }

  /* ØªÙØ§Ø¹Ù„ */
  .sticky-actions.owner-actions .btn:hover{ filter: brightness(1.05); }
  .sticky-actions.owner-actions .btn:active{ transform: translateY(1px); }
  .sticky-actions.owner-actions .btn:focus{
    outline: none;
    box-shadow: 0 0 0 3px rgba(255,255,255,.14), 0 8px 24px rgba(0,0,0,.25) !important;
  }
}

/* Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù„Ùˆ Ù†ÙØ³ÙŠØª Ø§Ù„ÙƒÙ„Ø§Ø³Ø§ØªØŒ Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ */
@media (max-width:576px){
  .sticky-actions.owner-actions form:first-child .btn{
    background-image: linear-gradient(180deg, rgba(244,63,94,.92), rgba(239,68,68,.80)) !important;
    color:#fff !important;
  }
  .sticky-actions.owner-actions form:last-child .btn{
    background-image: linear-gradient(180deg, rgba(34,197,94,.90), rgba(16,185,129,.78)) !important;
    color:#fff !important;
  }
}

/* ======= Renter Pay Section (polished) ======= */
.pay-card{
  border:1px solid var(--border);
  border-radius:18px;
  background:var(--glass);
  box-shadow:var(--shadow);
  padding:14px;
  overflow: visible; /* âœ… */
}

.pay-head{
  display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px
}
.pay-title{ font-weight:800; letter-spacing:.2px }
.secure-badge{
  display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
  border:1px solid color-mix(in oklab, var(--border) 70%, transparent);
  background: color-mix(in oklab, var(--surface) 88%, transparent);
  font-weight:700; font-size:.85rem
}
.secure-badge i{ font-size:1rem }

.pay-option{
  border:1px solid var(--border); border-radius:14px; padding:12px;
  background:color-mix(in oklab,var(--surface) 92%, transparent);
}
.pay-option + .pay-option{ margin-top:10px }


.action-row{ display:flex; gap:10px; flex-wrap:wrap }
.action-row .btn{ border-radius:12px; font-weight:800 }

.pay-note{ opacity:.7; font-size:.9rem }

.hr-or{
  display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:10px; margin:12px 0
}
.hr-or::before, .hr-or::after{ content:""; height:1px; background:var(--border) }
.hr-or span{
  font-weight:800; opacity:.65; font-size:.8rem; letter-spacing:.15em; text-transform:uppercase
}

/* Buttons look */
.btn-solid-primary{
  color:#fff !important; border:1px solid rgba(255,255,255,.22) !important;
  background: linear-gradient(180deg,#5b9df9,#3b82f6) !important;
  -webkit-backdrop-filter: blur(10px) saturate(120%); backdrop-filter: blur(10px) saturate(120%);
  box-shadow: 0 8px 20px rgba(59,130,246,.28), inset 0 1px 0 rgba(255,255,255,.18) !important;
}
.btn-outline-soft{
  border:1px solid var(--border) !important; background:transparent !important;
}

/* Mobile paddings */
@media (max-width:576px){
  .pay-card{ padding:12px }
  .action-row .btn{ width:100% }
}

a.btn.disabled{
  pointer-events:none !important;
  opacity:.6 !important;
  cursor:default !important;
}


</style>

{% if dispute_deadline_iso %}
  <script defer src="/static/js/countdown.js"></script>
{% endif %}

<!-- ğŸ”’ Guard to pause poller during capture/upload -->
<script> window.__CAPTURE_ACTIVE__ = false; </script>
{% endblock %}

{% block content %}
<div class="flow-card card p-3 p-md-4">

{% if booking.status == 'paid' and is_renter %}
<form id="pickupConfirmForm"
      method="post"
      action="/bookings/{{ booking.id }}/renter/confirm_received"></form>
{% endif %}


  {# ===== Mobile HERO (image header) ===== #}
  {% if item %}
  <div class="m-hero-wrap d-sm-none">
    <div class="m-hero">
      <img src="{{ (item and item.image_path) and (item.image_path.startswith('http://') or item.image_path.startswith('https://')) and item.image_path or ('/' ~ (item.image_path or '').lstrip('/')) if item else '/static/placeholder.jpg' }}" alt="">
      <div class="overlay"></div>
      <div class="inside">
        <div>
          <div class="title">{{ item.title }}</div>

{% set currency = display_currency(request)|upper %}
{% set native_cur = item.currency or 'CAD' %}
{% set fx = fx_rate(native_cur, currency) %}
{% set disp_price = (item.price_per_day * fx)|round(2) %}



<div class="meta">
  {{ category_label(item.category) }} â€¢ {{ disp_price }} {{ currency }}/day
</div>
        </div>
        <span class="state-badge">
          <i class="bi bi-flag"></i><span>{{ booking.status }}</span>
        </span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Header (desktop + tablet view) -->
  <div class="d-none d-sm-flex justify-content-between align-items-start flex-wrap">
    <div class="mb-2">
      <h4 class="mb-1">Booking #{{ booking.id }}</h4>
      <div class="k">
        Item: <strong>{{ item_title }}</strong>
        {% if item %} â€” <a href="/items/{{ item.id }}">Open item page</a>{% endif %}
      </div>
      <div class="k">Period: {{ booking.start_date }} â†’ {{ booking.end_date }} ({{ booking.days }} days)</div>
    </div>
    <span class="state-badge mt-1">
      <i class="bi bi-flag"></i>
      <span>Status: {{ booking.status }}</span>
    </span>
  </div>

  <hr class="d-none d-sm-block">

  <div class="row g-3">
    <!-- Left column -->
    <div class="col-12 col-lg-7">

      {# ======= requested ======= #}
      {% if booking.status in ['requested'] %}
        {% if is_owner %}
          <h5 class="mb-2 d-none d-sm-block">New request awaiting your approval</h5>
                    {% if err_code == 'deposit_too_high' %}
          <div class="alert alert-danger mb-2"
     style="
        border-radius:12px;
        padding:12px 16px;
        font-size:14px;
        font-weight:500;
        background:#fee2e2;      /* Ø£Ø­Ù…Ø± Ù†Ø§Ø¹Ù… */
        color:#b91c1c;            /* Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† */
        border:1px solid #fecaca; /* Ø®Ø· Ø£Ø­Ù…Ø± Ø®ÙÙŠÙ */
     ">
  <i class="bi bi-exclamation-triangle-fill" style="margin-right:6px;"></i>
  Deposit too high. It must be â‰¤ 10Ã— daily price (max {{ (item.price_per_day or 0) * 20 }} CAD).
</div>

          {% endif %}

          <div class="box mb-2">
            <div class="mb-2">Enter the required <strong>deposit</strong> (default = daily price Ã— 20)</div>
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision" class="row g-2 align-items-end">
              <input type="hidden" name="decision" value="accepted">
              <div class="col-12 col-md-6">
                <label class="form-label">Deposit amount</label>
                <input id="depositInput" name="deposit_amount" type="number" min="0" step="0.01" class="form-control"
                       value="{{ booking.deposit_amount or 0 }}">
                <div class="form-text k">You can change it before accepting.</div>
              </div>
              <div class="col-12 col-md-6 d-none d-sm-block">
                <button class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> Accept with deposit</button>
              </div>
            </form>
          </div>

          <div class="acts d-none d-sm-flex">
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
              <input type="hidden" name="decision" value="rejected">
              <button class="btn btn-outline-danger"><i class="bi bi-x-lg"></i> Reject</button>
            </form>
          </div>

          <script>
            (function () {
              try {
                var inp = document.getElementById('depositInput');
                if (!inp) return;
                var current = parseFloat(inp.value || '0');
                if (!current || current <= 0) {
                  var pricePerDay = parseFloat('{{ (item.price_per_day or 0)|float }}') || 0;
                  var defVal = Math.max(0, +(pricePerDay * 5).toFixed(2));
                  inp.value = defVal;
                }
              } catch (e) {}
            })();
          </script>

        {% elif is_renter %}
          <div class="hint">Your request has been sent. Waiting for the ownerâ€™s approvalâ€¦</div>
        {% endif %}
      {% endif %}

      {# ======= accepted ======= #}
      {% if booking.status in ['accepted'] %}
  {% if is_renter %}
    <!-- Polished Pay Card -->
    <div class="pay-card mb-2">
      <div class="pay-head">
        <div class="pay-title">Choose a payment method</div>
        <span class="secure-badge"><i class="bi bi-shield-lock"></i> Secure</span>
      </div>

      <!-- Cash option -->
      <div class="pay-option">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong>Cash on pickup</strong>
          <span class="k">Simple & direct</span>
        </div>
        <form method="post" action="/bookings/{{ booking.id }}/pay-cash">
          <button class="btn btn-outline-soft w-100">
            <i class="bi bi-cash-stack me-1"></i> I will pay cash
          </button>
        </form>
      </div>

      <div class="hr-or"><span>or</span></div>

      <div class="pay-card mb-2">
  <div class="pay-head">
    <div class="pay-title">Pay with PayPal</div>
    <span class="secure-badge">
      <i class="bi bi-shield-lock"></i> PayPal
    </span>
  </div>

  <div class="pay-option">
    <p class="k">
      You will be redirected to PayPal to complete the payment.
      After payment, return here and confirm.
    </p>

    <!-- PayPal external link -->
    <div id="rentActionWrap">
  <a href="/paypal/start/{{ booking.id }}?type=rent"
     class="btn btn-solid-primary {% if booking.rent_paid %}disabled{% endif %}"
     {% if booking.rent_paid %}aria-disabled="true" tabindex="-1"{% endif %}>
     Pay Rent with PayPal
  </a>
</div>

<div class="pay-option">
  <p class="k">
    You will be redirected to PayPal to complete the payment.
    After payment, return here and confirm.
  </p>

  <!-- ===== RENT BUTTON ===== -->
  <div id="rentActionWrap" class="mb-2">
    <a href="/paypal/start/{{ booking.id }}?type=rent"
       class="btn btn-solid-primary w-100 {% if booking.rent_paid %}disabled{% endif %}"
       {% if booking.rent_paid %}aria-disabled="true" tabindex="-1"{% endif %}>
      {% if booking.rent_paid %}
        âœ” Rent paid
      {% else %}
        Pay Rent with PayPal
      {% endif %}
    </a>
  </div>

  <!-- ===== SECURITY FUND BUTTON ===== -->
  {% if booking.security_amount > 0 %}
  <div id="depositActionWrap">
    <a href="/paypal/start/{{ booking.id }}?type=security"
       class="btn btn-outline-soft w-100 {% if booking.security_paid %}disabled{% endif %}"
       {% if booking.security_paid %}aria-disabled="true" tabindex="-1"{% endif %}>
      {% if booking.security_paid %}
        âœ” Security fund paid
      {% else %}
        Pay Security Fund with PayPal
      {% endif %}
    </a>
  </div>
  {% endif %}
</div>




  </div>
</div>




{# === Order summary (Ø°ÙƒÙŠ Ù…Ø¹ utili_tax) === #}
<div class="card mb-2">
  <div class="card-body">
    <h6 class="mb-2">Order summary</h6>

{% set currency = display_currency(request)|upper %}

{% set native_cur = booking.currency_native or booking.currency or 'CAD' %}
{% set fx         = fx_rate(native_cur, currency) %}

{# Ù†Ø£Ø®Ø° Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ (native) Ø«Ù… Ù†Ø­ÙˆÙ„Ù‡ Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ #}
{% set rent_native = (booking.amount_native or booking.total_amount or 0.0)|float %}
{% set disp_rent   = (rent_native * (fx or 1.0))|round(2) %}

{# processing fee Ù†Ø­Ø³Ø¨Ù‡ Ø¹Ù„Ù‰ Ù†ÙØ³ base Ø«Ù… Ù†Ø­ÙˆÙ„Ù‡ #}
{% set fee_native = (processing_fee is defined) and processing_fee or
                    ((rent_native * (STRIPE_PROCESSING_PCT or 0.029)) + ((STRIPE_PROCESSING_FIXED_CENTS or 30) / 100.0)) %}
{% set disp_fee   = (fee_native * (fx or 1.0))|round(2) %}

{% set disp_sub_before_tax = (disp_rent + disp_fee)|round(2) %}

    <div class="d-flex justify-content-between">
      <span>Rent</span>
      <strong>{{ "%.2f"|format(disp_rent) }} {{ currency }}</strong>
    </div>

    <div class="d-flex justify-content-between">
      <span>Processing fee</span>
      <strong>{{ "%.2f"|format(disp_fee) }} {{ currency }}</strong>
    </div>

    {% if taxes and taxes.tax_lines and (taxes.tax_lines|length > 0) %}
        <hr class="my-2">

  {# Ù†Ø³ØªØ®Ø¯Ù… namespace Ø­ØªÙ‰ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¬Ù…Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ¨ #}
  {% set ns = namespace(total=0.0) %}
  {% for t in taxes.tax_lines %}
    {% set disp_tax = (t.amount * (fx or 1.0))|round(2) %}
    {% set ns.total = ns.total + disp_tax %}
    <div class="d-flex justify-content-between">
      <span>{{ t.name }} {{ (t.rate * 100)|round(3) }}%</span>
      <strong>{{ "%.2f"|format(disp_tax) }} {{ currency }}</strong>
    </div>
  {% endfor %}

{% else %}
  <div class="d-flex justify-content-between text-muted mt-1">
    <span>Taxes</span><span>Calculated at Stripe</span>
  </div>
  <hr class="my-2">

  {% set disp_grand = disp_sub_before_tax %}
  <div class="d-flex justify-content-between">
    <span>Total (before tax)</span>
    <strong>{{ "%.2f"|format(disp_grand) }} {{ currency }}</strong>
  </div>
{% endif %}


    <div class="small text-muted mt-2">
      â€¢ Sevor ÙŠØ£Ø®Ø° 1% Ù…Ù† Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø¶Ù…Ù† Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø§Ù„Ùƒ.<br>
      â€¢ Processing fee ØªÙØ¯ÙØ¹ ÙƒØ³Ø·Ø± Ù…Ù†ÙØµÙ„ ÙˆØªÙØ­ØªØ³Ø¨ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ Ø¯Ø§Ø®Ù„ Stripe (Ø¥Ù† ÙƒØ§Ù† fallback).
    </div>
  </div>
</div>


</div>

      </div>
    </div>
  {% elif is_owner %}
    <div class="hint">Request accepted. Waiting for the renter to choose a payment methodâ€¦</div>
    {% if not owner_pe %}
      <div class="alert alert-warning mt-2 alert-mini">
        To receive online payments, please complete payout onboarding:
        <div class="mt-2">
          <a class="btn btn-primary btn-sm" href="/connect/onboard">
            <i class="bi bi-person-badge"></i> Complete verification now
          </a>
        </div>
      </div>
    {% endif %}
  {% endif %}
{% endif %}


      {# ======= paid ======= #}
      {% if booking.status in ['paid'] %}
        {% if is_renter %}
          <h5 class="d-none d-sm-block">Ready for pickup</h5>
          <div class="hint d-none d-sm-block">Capture pickup photos before confirming.</div>

          <!-- ğŸ“· Pickup â€” single button (desktop/tablet area) -->
          <div class="box mb-2">
            <div class="mb-2">Capture pickup photos before confirming.</div>
            <div class="d-grid gap-2">
              <textarea id="pickupComment" class="form-control" rows="2" placeholder="Note (optional)"></textarea>

              <form id="pickupConfirmForm"
      method="post"
      action="/bookings/{{ booking.id }}/renter/confirm_received">
</form>

              <button type="button" id="pickupCaptureBtn" class="btn-camera">
                <i class="bi bi-camera"></i> Capture 6 photos with camera, then upload & continue
              </button>
              <button type="button"
        id="confirmPickupBtn"
        class="btn btn-success w-100 mt-2"
        style="display:none;"
        onclick="document.getElementById('pickupConfirmForm').submit();">
    âœ” Confirm Pickup
</button>


              <div id="pickupCaptureStatus" class="k small d-flex align-items-center justify-content-between">
                <span class="num-ltr" id="pickupCount">0/6</span>
                <div class="progress-dots">
                  <span class="dot" id="p1"></span><span class="dot" id="p2"></span><span class="dot" id="p3"></span>
                  <span class="dot" id="p4"></span><span class="dot" id="p5"></span><span class="dot" id="p6"></span>
                </div>
              </div>
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">Payment received. Waiting for the renter to confirm pickup.</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/owner/confirm_delivered"></form>
        {% endif %}
      {% endif %}

      {# ======= picked_up ======= #}
      {% if booking.status in ['picked_up'] %}
        {% if is_renter %}
          <h5 class="d-none d-sm-block">You have the item now</h5>
          <div class="hint d-none d-sm-block">On return, capture 6 photos; youâ€™ll be taken to rating afterwards.</div>

          <!-- ğŸ“· Return â€” single button (desktop/tablet area) -->
          <div class="box mb-2">
            <div class="mb-2">On return, capture 6 photos and youâ€™ll be sent to the rating step.</div>
            <div class="d-grid gap-2">
              <textarea id="returnComment" class="form-control" rows="2" placeholder="Note (optional)"></textarea>

              <button type="button" id="returnCaptureBtn" class="btn-camera">
                <i class="bi bi-camera"></i> Capture 6 photos with camera, then upload & go to rating
              </button>

              <div id="returnCaptureStatus" class="k small d-flex align-items-center justify-content-between">
                <span class="num-ltr" id="returnCount">0/6</span>
                <div class="progress-dots">
                  <span class="dot" id="r1"></span><span class="dot" id="r2"></span><span class="dot" id="r3"></span>
                  <span class="dot" id="r4"></span><span class="dot" id="r5"></span><span class="dot" id="r6"></span>
                </div>
              </div>
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">Renter picked up the item. Upon return youâ€™ll see steps for confirming return & deposit.</div>
        {% endif %}
      {% endif %}

      {# ======= returned / in_review ======= #}
      {% if booking.status in ['returned', 'in_review'] %}
        {% if is_owner %}
          <h5 class="mb-2">Return marked â€” review</h5>
          <div class="hint mb-2">
            You have a window to file a deposit dispute if thereâ€™s an issue:
            {% if dispute_deadline_iso %}
              <div class="mt-2">
                <span class="badge-dot"><i class="bi bi-circle-fill"></i> Countdown until dispute window ends:</span>
                <div id="deadlineCountdown" class="mono fw-bold">
                  <span class="countdown" data-deadline="{{ dispute_deadline_iso }}"></span>
                </div>
              </div>
            {% endif %}
          </div>
          <form method="get" action="/deposits/{{ booking.id }}/report">
            <button class="btn btn-outline-danger btn-wide">
              <i class="bi bi-exclamation-octagon"></i> Open deposit dispute (damage/issue/delay)
            </button>
          </form>

          <!-- Owner rates renter -->
          <div class="box mt-3" id="ownerRateBox">
            <h6 class="mb-2">Rate the renter</h6>

            {% if owner_already_rated and owner_prev_review %}
              <div class="d-flex align-items-center gap-2 mb-2">
                <div class="text-warning">
                  {% for _ in range(owner_prev_review.stars) %}â­{% endfor %}
                  {% for _ in range(5 - owner_prev_review.stars) %}â˜†{% endfor %}
                </div>
                <span class="small text-muted">Your rating for this booking has been saved.</span>
              </div>
              {% if owner_prev_review.comment %}
                <div class="p-2 rounded" style="border:1px solid var(--border);background:rgba(255,255,255,.04)">
                  {{ owner_prev_review.comment }}
                </div>
              {% endif %}
              <div class="mt-2">
                <a class="btn btn-outline-primary btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">
                  View all renter reviews
                </a>
              </div>
            {% else %}
              <form method="post" action="/reviews/owner/{{ booking.id }}" class="d-flex flex-column gap-2" id="ownerRateForm">
                <input type="hidden" name="rating" id="ownerRatingVal" value="5">
                <div class="d-flex gap-1" id="starsO" role="radiogroup" aria-label="Rate renter">
                  {% for n in [1,2,3,4,5] %}
                    <input class="d-none" type="radio" id="o{{n}}" value="{{n}}" {% if n==5 %}checked{% endif %}>
                    <label for="o{{n}}" class="btn btn-outline-warning btn-sm star-btn" data-val="{{n}}">
                      <i class="bi bi-star-fill"></i> {{n}}
                    </label>
                  {% endfor %}
                </div>
                <textarea name="comment" class="form-control" rows="2" placeholder="Note about renterâ€™s conduct (optional)"></textarea>
                <div>
                  <button class="btn btn-primary btn-sm" id="ownerRateSubmit">
                    <i class="bi bi-send"></i> Save rating
                  </button>
                </div>
              </form>
            {% endif %}
          </div>

          <div class="hint mt-2">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="small">
  {% if renter_reviews_count and renter_reviews_count > 0 %}
    â­ {{ renter_reviews_avg }}/5 â€” {{ renter_reviews_count }} reviews
  {% else %}
    No reviews yet
  {% endif %}
</div>

              <a class="btn btn-ghost btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">Open reviews page</a>
            </div>
          </div>

          <div class="k small mt-2">If you donâ€™t file within the window, the deposit is released automatically to the renter per policy.</div>

        {% elif is_renter %}
          <div class="hint">Return marked. Waiting for Admin/Deposit Manager to decide the deposit.</div>
          {% if dispute_deadline_iso %}
            <div class="k small mt-2">Ownerâ€™s dispute window still active â€” if no disputes, deposit will auto-release after it ends.</div>
          {% endif %}
        {% elif session_user and session_user.role == 'admin' %}
          <div class="hint">This booking is awaiting a deposit decision from Admin/Deposit Manager.</div>
        {% endif %}
      {% endif %}

      {# ======= finished states ======= #}
      {% if booking.status in ['closed','rejected','completed'] %}
        <div class="alert alert-info">
          {% if booking.status in ['closed','completed'] %}
            Process completed âœ…
          {% else %}
            Booking rejected âŒ
          {% endif %}
        </div>
      {% endif %}

    </div>

    <!-- Right column: summary -->
        <!-- Right column: summary -->
    <div class="col-12 col-lg-5">
{% if renter and is_owner %}
<div class="box mb-3" style="padding:16px;">

  <!-- HEADER -->
  <div class="mb-2" style="font-weight:700;font-size:15px;">
    Renter information
  </div>

  <div class="d-flex align-items-center gap-3">

    <!-- AVATAR -->
    {% if renter_avatar %}
      <img src="{{ renter_avatar }}"
           style="width:58px;height:58px;border-radius:50%;object-fit:cover;box-shadow:0 4px 10px rgba(0,0,0,.15)">
    {% else %}
      <div style="
          width:58px;height:58px;border-radius:50%;
          background:rgba(0,0,0,.08);
          display:flex;align-items:center;justify-content:center;
          font-weight:700;font-size:1.2rem;
          box-shadow:0 4px 10px rgba(0,0,0,.10);
      ">
        {{ (renter.first_name or renter.last_name or renter.email or '?')[:1]|upper }}
      </div>
    {% endif %}

    <!-- TEXT INFO -->
    <div>
      <div style="font-weight:700;font-size:1rem;">
        {{ renter_full_name or renter_fullname }}
      </div>

      {% if renter_phone %}
      <div class="small num-ltr" style="opacity:.8;">
        {{ renter_phone }}
      </div>
      {% endif %}

      {% if renter_reviews_count > 0 %}
      <div class="small" style="color:#f59e0b;font-weight:600;">
        â­ {{ renter_reviews_avg }}/5
        <span style="opacity:.6;">({{ renter_reviews_count }} reviews)</span>
      </div>
      {% else %}
      <div class="small text-muted">No reviews yet</div>
      {% endif %}

      <a href="/users/{{ renter.id }}?tab=reviews"
         class="btn btn-ghost btn-sm mt-1"
         style="padding:3px 10px;border-radius:8px;">
         View profile â†’
      </a>
    </div>

  </div>

</div>
{% endif %}



      <div class="box">
        <h6 class="mb-2">Payment summary</h6>

        {# NEW: Ù†ÙØ³ Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ #}
{% set currency = display_currency(request)|upper %}


    {% set native_cur = booking.currency_native or booking.currency or 'CAD' %}
    {% set fx = fx_rate(native_cur, currency) %}

    {% set base_rent = (booking.total_amount or rent_amount or 0.0)|float %}
    {% set base_dep  = (booking.hold_deposit_amount or booking.deposit_amount or 0.0)|float %}

    {% set disp_rent = (base_rent * (fx or 1.0))|round(2) %}
    {% set disp_dep  = (base_dep  * (fx or 1.0))|round(2) %}


        <div class="d-flex justify-content-between">
          <span>Payment method</span>
          <strong>{{ booking.payment_method or 'â€”' }}</strong>
        </div>

        <div class="d-flex justify-content-between">
          <span>Rent amount</span>
<strong>{{ "%.2f"|format(disp_rent) }} {{ currency }}</strong>
        </div>

        <div class="d-flex justify-content-between">
          <span>Deposit on hold</span>
<strong>{{ "%.2f"|format(disp_dep) }} {{ currency }}</strong>
        </div>

        <div class="d-flex justify-content-between">
          <span>Online charge status</span>
          <strong>
  {% if booking.rent_paid %}
    PayPal
  {% else %}
    â€”
  {% endif %}
</strong>

        </div>

        <div class="d-flex justify-content-between">
          <span>Deposit status</span>
          <strong>{{ booking.deposit_status or 'â€”' }}</strong>
        </div>
        <hr>


        {# ğŸ” Replaced raw fields with a readable timeline #}
        <div class="timeline">
          {% if booking.accepted_at %}
          <div class="tl-item">
            <div class="tl-icon">âœ…</div>
            <div class="tl-body">
              <div class="tl-title">Request accepted âœ…</div>
              <div class="muted mono num-ltr">{{ booking.accepted_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.picked_up_at %}
          <div class="tl-item">
            <div class="tl-icon">ğŸ“¦</div>
            <div class="tl-body">
              <div class="tl-title">Picked up ğŸ“¦</div>
              <div class="muted mono num-ltr">{{ booking.picked_up_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.returned_at %}
          <div class="tl-item">
            <div class="tl-icon">ğŸ”„</div>
            <div class="tl-body">
              <div class="tl-title">Returned ğŸ”„</div>
              <div class="muted mono num-ltr">{{ booking.returned_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.return_confirmed_by_owner_at %}
          <div class="tl-item">
            <div class="tl-icon">ğŸ§¾</div>
            <div class="tl-body">
              <div class="tl-title">Return confirmed by owner ğŸ§¾</div>
              <div class="muted mono num-ltr">{{ booking.return_confirmed_by_owner_at }}</div>
            </div>
          </div>
          {% endif %}

          {% if booking.rent_released_at %}
          <div class="tl-item">
            <div class="tl-icon">ğŸ’¸</div>
            <div class="tl-body">
              <div class="tl-title">Rent released ğŸ’¸</div>
              <div class="muted mono num-ltr">{{ booking.rent_released_at }}</div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      {% if item %}
<div class="box mt-3 d-none d-md-block">   {# Ø§Ø®ÙÙ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙØŒ ÙˆØ£Ø¸Ù‡Ø± Ù…Ù† md (>=768px) ÙÙ…Ø§ ÙÙˆÙ‚ #}
  <h6 class="mb-2">Item</h6>
  <div class="d-flex gap-3">
    <img src="{{ (item and item.image_path) and (item.image_path.startswith('http://') or item.image_path.startswith('https://')) and item.image_path or ('/' ~ (item.image_path or '').lstrip('/')) if item else '/static/placeholder.jpg' }}"
         style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
    <div>
      <div class="fw-bold">{{ item.title }}</div>
      <div class="k">{{ category_label(item.category) }}</div>

{% set currency = display_currency(request)|upper %}


      {% set native_cur = item.currency or booking.currency_native or "CAD" %}
      {% set fx = fx_rate(native_cur, currency) %}

      {% set disp_item_price = (item.price_per_day * (fx or 1.0))|round(2) %}
      {% set item_currency = currency %}

      <div class="k">Daily price: {{ "%.2f"|format(disp_item_price) }} {{ item_currency }}</div>
      <a class="small" href="/items/{{ item.id }}">Open item page</a>
    </div>
  </div>
</div>
{% endif %}

    </div>
  </div>

  <!-- Spacer so content doesn't hide behind sticky bar on mobile -->
  <div class="page-bottom-spacer d-sm-none"></div>
</div>

<!-- ==== flow-only UI (booking pages only) ==== -->
<div id="flowBack" class="flow-only-fab js-flow-only" hidden>
  <button class="flow-only-btn" type="button"
          onclick="history.length>1 ? history.back() : location.assign('/')"
          aria-label="Back">
    <!-- Ø³Ù‡Ù… Ø£Ø¨ÙŠØ¶ -->
    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
      <path d="M5.854 3.146a.5.5 0 0 1 0 .708L3.707 6H14.5a.5.5 0 0 1 0 1H3.707l2.147 2.146a.5.5 0 1 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0z"/>
    </svg>
  </button>
</div>
<div id="flowTopSpace" class="js-flow-only" hidden></div>


<!-- ===== JS (general) ===== -->
<script>
  function wireDisableOnSubmit(formId, btnId, text){
    var f = document.getElementById(formId);
    if(!f) return;
    f.addEventListener('submit', function(){
      var btn = document.getElementById(btnId);
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ' + (text || 'Redirectingâ€¦');
      }
    });
  }

  function markRentPaidUI(){
    var wrap = document.getElementById('rentActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#rentPaidBadge')){
      wrap.innerHTML = '<button id="rentPaidBadge" class="btn btn-success btn-wide me-1" disabled><i class="bi bi-check2-circle"></i> Rent paid âœ…</button>';
    }
  }

  function markDepositHeldUI(){
    var wrap = document.getElementById('depositActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#depositHeldBadge')){
      wrap.innerHTML = '<button id="depositHeldBadge" class="btn btn-success btn-wide" disabled><i class="bi bi-shield-check"></i> Deposit held âœ…</button>';
    }
  }

  (function(){
    try{
      var box = document.getElementById('onlineBox');
      if(!box) return;
      var rentAuth = box.getAttribute('data-rent-authorized') === '1';
      var depHeld  = box.getAttribute('data-deposit-held') === '1';
      if(rentAuth){ markRentPaidUI(); }
      if(depHeld){  markDepositHeldUI(); }
    }catch(e){}
  })();

  (function(){
    if (window.__FLOW_POLLER__ && window.__FLOW_POLLER__.started) return;
    window.__FLOW_POLLER__ = { started:true };

    var bookingId = {{ booking.id }};
    var params = new URLSearchParams(location.search);
    if (params.has('ready')) return;

    var tries = 0, maxTries = 30, redirected = false;
    function modalOpen(){ return !!document.querySelector('.modal.show'); }


  {% if dispute_deadline_iso %}
  try{
    if(window.initCountdown){
      initCountdown('deadlineCountdown','{{ dispute_deadline_iso }}');
    }else{
      var el = document.getElementById('deadlineCountdown');
      if(el){ el.textContent = new Date('{{ dispute_deadline_iso }}').toLocaleString(); }
    }
  }catch(e){}
  {% endif %}
</script>

<!-- ===== Owner rating script (lock + localStorage) ===== -->
<script>
(function () {
  try {
    var wrap    = document.getElementById('starsO');
    var frm     = document.getElementById('ownerRateForm');
    var btn     = document.getElementById('ownerRateSubmit');
    var hidden  = document.getElementById('ownerRatingVal');
    var txt     = frm ? frm.querySelector('textarea') : null;
    var box     = document.getElementById('ownerRateBox');

    var KEY = 'ownerRated:' + {{ booking.id }} + ':' + ({{ session_user.id if session_user else 0 }});

    function syncActive(val){
      if(hidden) hidden.value = val;
      if(!wrap) return;
      wrap.querySelectorAll('.star-btn').forEach(function(b){
        b.classList.toggle('btn-warning', b.dataset.val === val);
        b.classList.toggle('btn-outline-warning', b.dataset.val !== val);
      });
    }

    function lockUI(){
      if (btn){ btn.disabled = true; }
      if (wrap){
        wrap.style.pointerEvents = 'none';
        wrap.querySelectorAll('.star-btn').forEach(function(b){
          b.classList.add('disabled');
          b.setAttribute('disabled','disabled');
        });
        wrap.querySelectorAll('input[type=radio]').forEach(function(r){ r.disabled = true; });
      }
      if (txt){
        txt.setAttribute('readonly','readonly');
        txt.classList.add('disabled');
      }
    }

    function replaceWithDoneView(stars, comment){
      if (!box) return;
      var s = parseInt(stars || '5', 10);
      var starsText = 'â˜…â˜…â˜…â˜…â˜…'.slice(0,s) + 'â˜†â˜†â˜†â˜†â˜†'.slice(0,5-s);
      var safeC = (comment || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      box.innerHTML = ''
        + '<h6 class="mb-2">Rate the renter</h6>'
        + '<div class="d-flex align-items-center gap-2 mb-2">'
        + '  <div class="text-warning">'+ starsText +'</div>'
        + '  <span class="small text-muted">Your rating for this booking has been saved.</span>'
        + '</div>'
        + (safeC ? ('<div class="p-2 rounded" style="border:1px solid var(--border);background:rgba(255,255,255,.04)">' + safeC + '</div>') : '')
        + '<div class="mt-2"><a class="btn btn-outline-primary btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">View all renter reviews</a></div>';
    }

    if (wrap){
      var checked = wrap.querySelector('input[type=radio]:checked');
      syncActive(checked ? checked.value : '5');
    }

    if (localStorage.getItem(KEY)){
      if (frm){
        var chosen = (wrap && wrap.querySelector('input[type=radio]:checked'))
                      ? wrap.querySelector('input[type=radio]:checked').value
                      : (hidden && hidden.value) || '5';
        var comment = txt ? txt.value : '';
        replaceWithDoneView(chosen, comment);
      }
    }

    if (wrap){
      wrap.addEventListener('click', function(e){
        var b = e.target.closest('.star-btn');
        if(!b || b.classList.contains('disabled')) return;
        var val = b.dataset.val;
        var inp = document.getElementById('o' + val);
        if(inp) inp.checked = true;
        syncActive(val);
      });
    }

    if (frm && btn){
      frm.addEventListener('submit', function(e){
        if (frm.dataset.locked === '1'){ e.preventDefault(); return; }
        frm.dataset.locked = '1';

        var chosen = (wrap && wrap.querySelector('input[type=radio]:checked'))
                      ? wrap.querySelector('input[type=radio]:checked').value
                      : (hidden && hidden.value) || '5';
        if (hidden) hidden.value = chosen;

        try{ localStorage.setItem(KEY, '1'); }catch(_){}

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Savingâ€¦';
        lockUI();
      }, {capture:true});
    }
  } catch(e){}
})();
</script>

<!-- ===== Single button to capture up to 6 photos + progress dots ===== -->
<script>
(function(){
  function setupAutoCapture(opts){
    var btn      = document.getElementById(opts.buttonId);
    var noteEl   = document.getElementById(opts.commentId);
    var statusEl = document.getElementById(opts.statusId);
    var countEl  = document.getElementById(opts.countId);
    if(!btn) return;

    var MAX = 6;
    var collected = [];
    var uploading = false;
    var started   = false;

    var input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.setAttribute('capture','environment');

    function setCount(n){
      if(countEl) countEl.textContent = n + '/' + MAX;
      for(var i=1;i<=MAX;i++){
        var d = document.getElementById((opts.prefix||'') + i);
        if(d){ d.classList.toggle('on', i<=n); }
      }
    }
    function setMsg(msg){
      if(!statusEl) return;
      var after = statusEl.querySelector('.msg');
      if(!after){
        after = document.createElement('span');
        after.className = 'msg';
        after.style.marginInlineStart = '6px';
        statusEl.appendChild(after);
      }
      after.textContent = msg || '';
    }
    function label(next){
      if(uploading) return '<span class="spinner-border spinner-border-sm me-1"></span> Uploadingâ€¦';
      if(!started || collected.length===0) return '<i class="bi bi-camera"></i> Capture first photo';
      if(next < MAX) return '<i class="bi bi-camera"></i> Capture next photo';
      return '<i class="bi bi-upload"></i> Upload photos';
    }
    function refreshUI(){
      btn.disabled = uploading ? true : false;
      btn.innerHTML = label(collected.length+1);
      setCount(collected.length);
    }

    input.addEventListener('change', function(){
      var f = input.files && input.files[0];
      if(f){
        collected.push(f);
        setMsg('Photo added');
        refreshUI();
      }else{
        if(!started){
          collected = [];
          setMsg('Cancelled.');
          refreshUI();
        }else{
          setMsg('You can continue or upload.');
          refreshUI();
        }
      }
      try{ input.value=''; }catch(_){}
    });
function uploadNow(){
    if(!collected.length || uploading) return;
    uploading = true;
    window.__CAPTURE_ACTIVE__ = true;
    refreshUI();
    setMsg('Uploadingâ€¦');

    var fd = new FormData();
    for(var i = 0; i < collected.length && i < MAX; i++){
      fd.append('files', collected[i], collected[i].name || ('photo' + (i+1) + '.jpg'));
    }
    if (noteEl && noteEl.value){
      fd.append('comment', noteEl.value);
    }

    fetch(opts.postUrl, { method:'POST', body: fd, credentials:'same-origin' })
      .then(function(r){
        if (!r.ok) throw new Error('upload failed');
        return r.text();
      })
      .then(function(){
        // ğŸŸ£ Ù‡Ù†Ø§ Ù†ÙØ±Ù‘Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„Ø¥Ø±Ø¬Ø§Ø¹

        // 1ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Pickup) â†’ Ù†ÙØ³ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        if (opts.buttonId === "pickupCaptureBtn") {
          btn.disabled = true;
          btn.innerHTML = "âœ” ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±";

          var confirmBtn = document.getElementById("confirmPickupBtn");
          if (confirmBtn) {
            confirmBtn.style.display = "block";
          }
          return;
        }

        // 2ï¸âƒ£ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ (Return) â†’ Ø±ÙØ¹ Ø«Ù… Ù…Ø¨Ø§Ø´Ø±Ø© ØªÙ‚ÙŠÙŠÙ…Ø§Øª
        if (opts.buttonId === "returnCaptureBtn") {
          // Ù†Ø³ØªØ®Ø¯Ù… nextUrl Ø§Ù„Ù…Ù…Ø±Ø± ÙÙŠ setupAutoCapture
          if (opts.nextUrl) {
            window.location.assign(opts.nextUrl);
          } else {
            // Ø§Ø­ØªÙŠØ§Ø· Ù„Ùˆ Ù…Ø§ ÙƒØ§Ù† ÙÙŠÙ‡ nextUrl
            window.location.assign("/reviews/renter/{{ booking.id }}");
          }
          return;
        }

        // 3ï¸âƒ£ Ø£ÙŠ Ø£Ø²Ø±Ø§Ø± Ø£Ø®Ø±Ù‰ (Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹ ÙÙ‚Ø·)
        btn.disabled = true;
        btn.innerHTML = "âœ”";
      })
      .catch(function(){
        uploading = false;
        window.__CAPTURE_ACTIVE__ = false;
        setMsg('Upload failed. Please try again.');
        refreshUI();
      });
}

    btn.addEventListener('click', function(){
      if(uploading) return;
      started = true;

      if(collected.length >= MAX){
        uploadNow();
        return;
      }
      try{ input.value=''; }catch(_){}
      input.click();
      refreshUI();
    });

    setMsg('â€¦');
    refreshUI();
  }

  // Desktop/tablet buttons (existing)
  setupAutoCapture({
    buttonId: 'pickupCaptureBtn',
    commentId:'pickupComment',
    statusId: 'pickupCaptureStatus',
    countId:  'pickupCount',

    // Ø£ÙˆÙ„Ø§Ù‹: Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
    postUrl:  '/bookings/{{ booking.id }}/pickup-proof-upload',


    // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹ Ù…Ø¨Ø§Ø´Ø±Ø©: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ù„Ù„Ù…Ø§Ù„Ùƒ
    nextUrl:  '/bookings/{{ booking.id }}/renter/confirm_received',

    prefix:   'p'
});


  setupAutoCapture({
    buttonId: 'returnCaptureBtn',
    commentId:'returnComment',
    statusId: 'returnCaptureStatus',
    countId:  'returnCount',
    postUrl:  '/bookings/{{ booking.id }}/return-proof-upload?next=/reviews/renter/{{ booking.id }}',
    nextUrl:  '/reviews/renter/{{ booking.id }}',
    prefix:   'r'
  });

})();
</script>



<!-- ===== Sticky Action Bar (mobile) ===== -->
{% if booking.status in ['requested'] and is_owner %}
  <div class="sticky-actions owner-actions d-sm-none">
    <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
      <input type="hidden" name="decision" value="rejected">
      <button class="btn btn-glass-red w-100"><i class="bi bi-x-lg"></i>Reject</button>
    </form>
        <form method="post"
          action="/bookings/{{ booking.id }}/owner/decision"
          id="mobileAcceptForm">
      <input type="hidden" name="decision" value="accepted">

      {# Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø°ÙŠ Ø³ÙŠØ±Ø³Ù„ Ù†ÙØ³ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠØ¨Ùˆ #}
      <input type="hidden" id="depositMobile"
             name="deposit_amount"
             value="{{ booking.deposit_amount or 0 }}">

      <button class="btn btn-glass-green w-100">
        <i class="bi bi-check2-circle"></i>Accept + Deposit
      </button>
    </form>
  </div>
{% endif %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  var mainInput   = document.getElementById("depositInput");   // Ø­Ù‚Ù„ Ø§Ù„Ø¯ÙŠØ¨Ùˆ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø§Ù„Ø¯ÙŠØ³ØªÙˆØ¨)
  var mobileInput = document.getElementById("depositMobile");  // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„

  if (!mainInput || !mobileInput) return;

  // Ø£ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ø§Ù„ØµÙØ­Ø©: Ø§Ù†Ø³Ø® Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  mobileInput.value = mainInput.value;

  // ÙƒÙ„ Ù…Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠØ¨Ùˆ ÙÙŠ Ø§Ù„Ù€ input Ø§Ù„Ø¹Ø§Ø¯ÙŠ
  mainInput.addEventListener("input", function () {
    mobileInput.value = mainInput.value;
  });
});
</script>



{% if booking.status in ['paid'] and is_renter %}
  <div class="sticky-actions d-sm-none">
  </div>

  <!-- Mobile pickup UI -->
  <div class="k small d-sm-none mt-2 d-flex align-items-center justify-content-between px-3">
    <span class="num-ltr" id="pickupCount">0/6</span>
    <div class="progress-dots">
      <span class="dot" id="p1"></span>
<span class="dot" id="p2"></span>
<span class="dot" id="p3"></span>
<span class="dot" id="p4"></span>
<span class="dot" id="p5"></span>
<span class="dot" id="p6"></span>

    </div>
    <span id="pickupStatusMobile" class="msg"></span>
  </div>
{% endif %}



{% if booking.status in ['picked_up'] and is_renter %}
  <div class="sticky-actions d-sm-none">
  </div>

  <!-- Mobile return UI -->
  <div class="k small d-sm-none mt-2 d-flex align-items-center justify-content-between px-3">
    <span class="num-ltr" id="returnCount">0/6</span>
    <div class="progress-dots">
      <span class="dot" id="r1m"></span><span class="dot" id="r2m"></span><span class="dot" id="r3m"></span>
      <span class="dot" id="r4m"></span><span class="dot" id="r5m"></span><span class="dot" id="r6m"></span>
    </div>
    <span id="returnStatusMobile" class="msg"></span>
  </div>
{% endif %}


<script>
  /* Proxy sticky buttons to original capture buttons (single logic source) */
  (function(){
    function proxy(srcId, targetId){
      var s=document.getElementById(srcId), t=document.getElementById(targetId);
      if(s&&t) s.addEventListener('click', ()=>t.click());
    }
    proxy('pickupCaptureBtnSticky','pickupCaptureBtn');
    proxy('returnCaptureBtnSticky','returnCaptureBtn');
  })();
</script>

<script>
(function(){
  // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ù€ /bookings
  var onBooking = /^\/bookings(\/|$)/.test(location.pathname);

  var back  = document.getElementById('flowBack');
  var space = document.getElementById('flowTopSpace');

  if (onBooking){
    if (back)  back.hidden  = false;
    if (space) space.hidden = false;
  } else {
    // Ø£Ù…Ø§Ù†: Ù„Ø§ ØªØªØ±Ùƒ Ø£ÙŠ Ø£Ø«Ø± Ø®Ø§Ø±Ø¬ ØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¬Ø²
    document.querySelectorAll('.js-flow-only').forEach(function(el){ el.remove(); });
  }

  // Ù„Ùˆ Ø¬Ø§Ø¡ Ù…Ù† ØªÙ†Ù‚Ù„ ØªØ§Ø±ÙŠØ®ÙŠ/Ø¹ÙˆØ¯Ø©ØŒ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚
  window.addEventListener('pageshow', function(){
    var stillBooking = /^\/bookings(\/|$)/.test(location.pathname);
    if (!stillBooking){
      document.querySelectorAll('.js-flow-only').forEach(function(el){ el.remove(); });
    }
  });
})();
</script>
<script>
(function(){
  var params = new URLSearchParams(location.search);

  // Rent OK
  if (params.has("rent_ok")) {
    markRentPaidUI();
  }

  // Deposit only OK
  if (params.has("deposit_ok")) {
    markDepositHeldUI();
    setTimeout(function(){
        window.location.assign("/bookings/flow/{{ booking.id }}/next");
    }, 600);
  }

  // FULL PAYMENT: rent + deposit
  if (params.has("all_ok")) {
    markRentPaidUI();
    markDepositHeldUI();
    setTimeout(function(){
        window.location.assign("/bookings/flow/{{ booking.id }}/next");
    }, 600);
  }

})();
</script>

<script>
(function(){
  function mirrorDesktopToMobile(prefix){
    for(let i=1;i<=6;i++){
      let d = document.getElementById(prefix + i);
      let m = document.getElementById(prefix + i + 'm');
      if(d && m){
        // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ´ØªØ¹Ù„ Ø§Ù„Ø¯ÙˆØª Desktop â†’ ÙŠØ´Ø¹Ù„ Mobile
        let observer = new MutationObserver(()=>{
          m.classList.toggle('on', d.classList.contains('on'));
        });
        observer.observe(d, {attributes:true});
      }
    }
  }

  // Pickup
  mirrorDesktopToMobile('p');

  // Return
  mirrorDesktopToMobile('r');

})();
</script>


{% endblock %}
