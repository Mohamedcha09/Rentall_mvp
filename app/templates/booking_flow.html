{% extends "base.html" %}

{% block head %}
<style>
  .flow-card{max-width:1000px;margin:auto}
  .state-badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-weight:700}
  .k{opacity:.7}
  .acts{display:flex;flex-wrap:wrap;gap:10px}
  .acts form{display:inline}
  .hint{background:color-mix(in oklab,var(--surface) 92%,transparent);border:1px dashed var(--border);border-radius:12px;padding:10px 12px}
  .box{border:1px solid var(--border);border-radius:12px;padding:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .btn-wide{min-width:220px}
  .badge-dot{display:inline-flex;gap:6px;align-items:center}
  .badge-dot i{font-size:10px}
  .muted{opacity:.6}
  .alert-mini{padding:.6rem .8rem}
</style>
{% if dispute_deadline_iso %}
  <script defer src="/static/js/countdown.js"></script>
{% endif %}
{% endblock %}

{% block content %}
<div class="flow-card card p-3 p-md-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-start flex-wrap">
    <div class="mb-2">
      <h4 class="mb-1">الحجز #{{ booking.id }}</h4>
      <div class="k">
        العنصر: <strong>{{ item_title }}</strong>
        {% if item %} — <a href="/items/{{ item.id }}">فتح صفحة العنصر</a>{% endif %}
      </div>
      <div class="k">الفترة: {{ booking.start_date }} → {{ booking.end_date }} ({{ booking.days }} يوم)</div>
    </div>
    <span class="state-badge mt-1">
      <i class="bi bi-flag"></i>
      <span>الحالة: {{ booking.status }}</span>
    </span>
  </div>

  <hr>

  <div class="row g-3">
    <!-- Left column: actions / flow -->
    <div class="col-12 col-lg-7">

      {# ======= المرحلة: طلب جديد ======= #}
      {% if booking.status in ['requested'] %}
        {% if is_owner %}
          <h5 class="mb-2">طلب جديد ينتظر موافقتك</h5>

          <div class="box mb-2">
            <div class="mb-2">أدخل <strong>الوديعة (ديبو)</strong> المطلوبة (الافتراضي = سعر اليوم × 5)</div>
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision" class="row g-2 align-items-end">
              <input type="hidden" name="decision" value="accepted">
              <div class="col-12 col-md-6">
                <label class="form-label">قيمة الوديعة</label>
                <input id="depositInput" name="deposit_amount" type="number" min="0" step="1" class="form-control"
                       value="{{ booking.deposit_amount or 0 }}">
                <div class="form-text k">يمكنك تغيير القيمة قبل القبول.</div>
              </div>
              <div class="col-12 col-md-6">
                <button class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> قبول بالوديعة</button>
              </div>
            </form>
          </div>

          <div class="acts">
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
              <input type="hidden" name="decision" value="rejected">
              <button class="btn btn-outline-danger"><i class="bi bi-x-lg"></i> رفض</button>
            </form>
          </div>

          <script>
            (function () {
              try {
                var inp = document.getElementById('depositInput');
                if (!inp) return;
                var current = parseInt(inp.value || '0', 10);
                if (!current || current <= 0) {
                  var pricePerDay = parseInt('{{ (item.price_per_day or 0)|int }}', 10) || 0;
                  var defVal = pricePerDay * 5;
                  inp.value = defVal;
                }
              } catch (e) {}
            })();
          </script>

        {% elif is_renter %}
          <div class="hint">تم إرسال طلبك. بانتظار موافقة المالك…</div>
        {% endif %}
      {% endif %}

      {# ======= المرحلة: مقبول – الدفع أونلاين بأزرار منفصلة ======= #}
      {% if booking.status in ['accepted'] %}
        {% if is_renter %}
          <h5 class="mb-2">اختر طريقة الدفع</h5>

          <!-- الدفع كاش -->
          <div class="box mb-2">
            <div class="mb-2">الدفع <strong>كاش عند الاستلام</strong></div>
            <form method="post" action="/bookings/{{ booking.id }}/pay-cash">
              <button class="btn btn-secondary btn-wide"><i class="bi bi-cash-stack"></i> سأدفع كاش</button>
            </form>
          </div>

          <!-- الدفع أونلاين بأزرار منفصلة -->
          <div class="box" id="onlineBox"
     data-rent-authorized="{{ '1' if booking.online_status in ['authorized','captured','succeeded','paid'] else '0' }}"
     data-deposit-held="{{ '1' if booking.deposit_status in ['held','authorized'] else '0' }}">

            <div class="mb-2">الدفع <strong>أونلاين (Stripe Checkout)</strong></div>

            {% if not owner_pe %}
              <div class="alert alert-warning alert-mini">
                لا يمكن الدفع أونلاين الآن لأن <strong>المالك</strong> لم يُكمل تفعيل حساب الاستلام بعد.
                {% if owner and owner.id == session_user.id %}
                  <div class="mt-2">
                    <a class="btn btn-primary btn-sm" href="/connect/onboard">
                      <i class="bi bi-person-badge"></i> أكمل التحقق الآن
                    </a>
                    <small class="d-block k mt-1">بعد إكمال التحقق البنكي والهوية سيصبح الدفع أونلاين متاحًا.</small>
                  </div>
                {% else %}
                  <small class="d-block k mt-1">رجاءً اطلب من المالك إكمال التحقق البنكي والهوية ليتاح الدفع أونلاين.</small>
                {% endif %}
              </div>
            {% endif %}

{% set rent_paid = (booking.online_status in ['authorized','captured','succeeded','paid']) %}
{% set deposit_ok = (booking.deposit_status in ['held','authorized']) %}

            <!-- زر: دفع الإيجار فقط (يتحوّل لعبارة تم الدفع) -->
            <div id="rentActionWrap" class="d-inline">
              {% if rent_paid %}
                <button id="rentPaidBadge" class="btn btn-success btn-wide me-1" disabled>
                  <i class="bi bi-check2-circle"></i> تم دفع الإيجار ✅
                </button>
              {% else %}
                <form id="stripePayRentForm" method="post" action="/api/stripe/checkout/rent/{{ booking.id }}" class="d-inline">
                  <button id="stripePayRentBtn" class="btn btn-outline-primary btn-wide me-1"
                          {% if not owner_pe %}disabled aria-disabled="true"{% endif %}>
                    <i class="bi bi-credit-card-2-front"></i> دفع الإيجار فقط
                  </button>
                </form>
              {% endif %}
            </div>

            <!-- زر: حجز الوديعة فقط (يختفي عند الحجز) -->
            {% if (booking.deposit_amount or booking.hold_deposit_amount) and (booking.deposit_amount or booking.hold_deposit_amount) > 0 %}
            <div id="depositActionWrap" class="d-inline">
              {% if deposit_ok %}
                <button id="depositHeldBadge" class="btn btn-success btn-wide" disabled>
                  <i class="bi bi-shield-check"></i> تم حجز الوديعة ✅
                </button>
              {% else %}
                <form id="stripeDepositForm" class="d-inline" method="post" action="/api/stripe/checkout/deposit/{{ booking.id }}">
                  <button id="stripeDepositBtn" class="btn btn-outline-secondary btn-wide"
                          {% if not owner_pe %}disabled aria-disabled="true"{% endif %}>
                    <i class="bi bi-shield-lock"></i> حجز الوديعة فقط
                  </button>
                </form>
              {% endif %}
            </div>
            {% endif %}

            <div class="k mt-2">
              سيتم تحويلك إلى صفحة دفع آمنة من Stripe لإدخال بيانات بطاقتك. بعد النجاح ستعود تلقائيًا لصفحة الحجز وسنحدّث الحالة.
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">تم قبول الطلب. بانتظار أن يختار المستأجر طريقة الدفع…</div>

          {% if not owner_pe %}
            <div class="alert alert-warning mt-2 alert-mini">
              لكي يتمكّن المستأجر من الدفع أونلاين وتحويل المبلغ لك، أكمل تفعيل حسابك البنكي:
              <div class="mt-2">
                <a class="btn btn-primary btn-sm" href="/connect/onboard">
                  <i class="bi bi-person-badge"></i> أكمل التحقق الآن
                </a>
              </div>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}

      {# ======= المرحلة: تم الدفع (جاهز للاستلام) ======= #}
      {% if booking.status in ['paid'] %}
        {% if is_renter %}
          <h5>جاهز للاستلام</h5>
          <div class="hint">عند استلامك الغرض من المالك، اضغط الزر أدناه.</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/picked-up">
            <button class="btn btn-success btn-wide"><i class="bi bi-bag-check"></i> تم استلام الغرض</button>
          </form>
        {% elif is_owner %}
          <div class="hint">تم الدفع. بانتظار أن يؤكد المستأجر أنه استلم الغرض.</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/owner/confirm_delivered">
            <button class="btn btn-outline-success btn-sm"><i class="bi bi-hand-thumbs-up"></i> علِّم تمّ التسليم</button>
          </form>
        {% endif %}
      {% endif %}

      {# ======= المرحلة: تم الاستلام ======= #}
      {% if booking.status in ['picked_up'] %}
        {% if is_renter %}
          <h5>الغرض لديك الآن</h5>
          <div class="hint">عند إرجاع الغرض للمالك، اضغط الزر ثم قيّم تجربتك.</div>

          <!-- زر يفتح مودال التقييم + الإرجاع -->
          <button class="btn btn-warning btn-wide" data-bs-toggle="modal" data-bs-target="#rateRenterModal">
            <i class="bi bi-stars"></i> تم إرجاع الغرض + تقييم
          </button>

          <!-- Modal: تقييم المستأجر للعنصر (يرسل تقييم + يعلّم الإرجاع) -->
          <div class="modal fade" id="rateRenterModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <form class="modal-content" method="post" action="/reviews/renter/{{ booking.id }}">
                <div class="modal-header">
                  <h5 class="modal-title">قيّم العنصر</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-2">
                    <div class="form-label">تقييمك</div>
                    <div class="d-flex gap-1" id="starsR">
                      {% for n in [1,2,3,4,5] %}
                        <input class="d-none" type="radio" name="rating" id="r{{n}}" value="{{n}}" {% if n==5 %}checked{% endif %}>
                        <label for="r{{n}}" class="btn btn-outline-warning"><i class="bi bi-star-fill"></i> {{n}}</label>
                      {% endfor %}
                    </div>
                  </div>
                  <div>
                    <label class="form-label">تعليق (اختياري)</label>
                    <textarea name="comment" class="form-control" rows="3" placeholder="كيف كانت تجربتك؟"></textarea>
                  </div>
                  <small class="text-muted">بالإرسال سيتم تعليم الحجز “تم الإرجاع”.</small>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">إلغاء</button>
                  <button class="btn btn-warning" type="submit"><i class="bi bi-check2-circle"></i> إرسال التقييم</button>
                </div>
              </form>
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">المستأجر استلم الغرض. عند إرجاعه ستظهر لك خطوات تأكيد الإرجاع والوديعة.</div>
        {% endif %}
      {% endif %}

      {# ======= المرحلة: تم الإرجاع / قيد مراجعة الوديعة ======= #}
      {% if booking.status in ['returned', 'in_review'] %}
        {% if is_owner %}
          <h5 class="mb-2">الإرجاع معلَّم — المراجعة</h5>
          <div class="hint mb-2">
            لديك مهلة للاعتراض عبر فتح بلاغ وديعة إذا كانت هناك مشكلة:
            {% if dispute_deadline_iso %}
              <div class="mt-2">
                <span class="badge-dot"><i class="bi bi-circle-fill"></i> العدّاد حتى نهاية مهلة الاعتراض:</span>
                <div id="deadlineCountdown" class="mono fw-bold"></div>
              </div>
            {% endif %}
          </div>
          <form method="get" action="/deposits/{{ booking.id }}/report">
            <button class="btn btn-outline-danger btn-wide">
              <i class="bi bi-exclamation-octagon"></i> فتح بلاغ وديعة (مشكلة/ضرر/تأخير)
            </button>
          </form>

          <!-- تقييم المالك للمستأجر يظهر هنا -->
          <div class="box mt-3">
            <h6 class="mb-2">قيّم المستأجر</h6>
            <form method="post" action="/reviews/owner/{{ booking.id }}" class="d-flex flex-column gap-2">
              <div class="d-flex gap-1" id="starsO">
                {% for n in [1,2,3,4,5] %}
                  <input class="d-none" type="radio" name="rating" id="o{{n}}" value="{{n}}" {% if n==5 %}checked{% endif %}>
                  <label for="o{{n}}" class="btn btn-outline-warning btn-sm"><i class="bi bi-star-fill"></i> {{n}}</label>
                {% endfor %}
              </div>
              <textarea name="comment" class="form-control" rows="2" placeholder="ملاحظة عن التزام المستأجر (اختياري)"></textarea>
              <div>
                <button class="btn btn-primary btn-sm"><i class="bi bi-send"></i> حفظ التقييم</button>
              </div>
            </form>
          </div>

          <div class="k small mt-2">إن لم تفتح بلاغًا ضمن المهلة، تُفرج الوديعة تلقائيًا للمستأجر حسب السياسة.</div>

        {% elif is_renter %}
          <div class="hint">تم تعليم الإرجاع. بانتظار الإدارة/متحكّم الوديعة لاتخاذ قرار الوديعة.</div>
          {% if dispute_deadline_iso %}
            <div class="k small mt-2">مهلة اعتراض المالك مازالت سارية — سيتم الإفراج تلقائيًا بعد انتهائها إذا لا توجد بلاغات.</div>
          {% endif %}
        {% elif session_user and session_user.role == 'admin' %}
          <div class="hint">هذا الحجز بانتظار قرار الوديعة من الإدارة/متحكّم الوديعة.</div>
        {% endif %}
      {% endif %}

      {# ======= حالات منتهية ======= #}
      {% if booking.status in ['closed','rejected','completed'] %}
        <div class="alert alert-info">
          {% if booking.status in ['closed','completed'] %}
            العملية مكتملة ✅
          {% else %}
            تم رفض الحجز ❌
          {% endif %}
        </div>
      {% endif %}

    </div>

    <!-- Right column: summary -->
    <div class="col-12 col-lg-5">
      <div class="box">
        <h6 class="mb-2">ملخص الدفع</h6>
        <div class="d-flex justify-content-between"><span>طريقة الدفع</span><strong>{{ booking.payment_method or '—' }}</strong></div>
        <div class="d-flex justify-content-between"><span>مبلغ الإيجار</span><strong>{{ booking.rent_amount or booking.total_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>الوديعة المحتجزة</span><strong>{{ booking.hold_deposit_amount or booking.deposit_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>حالة التحصيل الأونلاين</span><strong>{{ booking.online_status or '—' }}</strong></div>
        <div class="d-flex justify-content-between"><span>حالة الوديعة</span><strong>{{ booking.deposit_status or '—' }}</strong></div>
        <hr>
        <div class="k mono small">
          {% if booking.accepted_at %}accepted_at: {{ booking.accepted_at }}<br>{% endif %}
          {% if booking.picked_up_at %}picked_up_at: {{ booking.picked_up_at }}<br>{% endif %}
          {% if booking.returned_at %}returned_at: {{ booking.returned_at }}<br>{% endif %}
          {% if booking.return_confirmed_by_owner_at %}owner_confirmed_at: {{ booking.return_confirmed_by_owner_at }}<br>{% endif %}
          {% if booking.rent_released_at %}rent_released_at: {{ booking.rent_released_at }}<br>{% endif %}
        </div>
      </div>

      {% if item %}
      <div class="box mt-3">
        <h6 class="mb-2">العنصر</h6>
        <div class="d-flex gap-3">
          <img src="{{ (('/' ~ item.image_path) if item.image_path and item.image_path[0] != '/' else (item.image_path or '/static/placeholder.jpg')) }}"
               style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
          <div>
            <div class="fw-bold">{{ item.title }}</div>
            <div class="k">{{ category_label(item.category) }}</div>
            <div class="k">السعر اليومي: {{ item.price_per_day }}$</div>
            <a class="small" href="/items/{{ item.id }}">فتح صفحة العنصر</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ===== JS (مرتب، دوال قبل الاستخدام) ===== -->
<script>
  // تعطيل الأزرار أثناء الإرسال
  function wireDisableOnSubmit(formId, btnId, text){
    var f = document.getElementById(formId);
    if(!f) return;
    f.addEventListener('submit', function(){
      var btn = document.getElementById(btnId);
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ' + (text || 'جاري تحويلك...');
      }
    });
  }

  // تحديث "الإيجار مدفوع"
  function markRentPaidUI(){
    var wrap = document.getElementById('rentActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#rentPaidBadge')){
      wrap.innerHTML = '<button id="rentPaidBadge" class="btn btn-success btn-wide me-1" disabled><i class="bi bi-check2-circle"></i> تم دفع الإيجار ✅</button>';
    }
  }

  // تحديث "الوديعة محجوزة" (بدون أي redirect)
  function markDepositHeldUI(){
    var wrap = document.getElementById('depositActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#depositHeldBadge')){
      wrap.innerHTML = '<button id="depositHeldBadge" class="btn btn-success btn-wide" disabled><i class="bi bi-shield-check"></i> تم حجز الوديعة ✅</button>';
    }
  }

  // اربط الأزرار (لو موجودة)
  wireDisableOnSubmit('stripePayRentForm','stripePayRentBtn','جاري تحويلك إلى الدفع…');
  wireDisableOnSubmit('stripeDepositForm','stripeDepositBtn','جاري تحويلك إلى الدفع…');

  // أولاً: اقرأ الحالة من خصائص الـDOM (حقن السيرفر)
  (function(){
    try{
      var box = document.getElementById('onlineBox');
      if(!box) return;
      var rentAuth = box.getAttribute('data-rent-authorized') === '1';
      var depHeld  = box.getAttribute('data-deposit-held') === '1';
      if(rentAuth){ markRentPaidUI(); }
      if(depHeld){  markDepositHeldUI(); }
    }catch(e){}
  })();

  /* ===== Polling Stripe state (محمي من التشغيل المزدوج وموقوف أثناء المودال) ===== */
  (function(){
    // حماية من التشغيل مرتين
    if (window.__FLOW_POLLER__ && window.__FLOW_POLLER__.started) {
      console.debug('flow poller already running — skip');
      return;
    }
    window.__FLOW_POLLER__ = { started:true };

    var bookingId = {{ booking.id }};
    var params = new URLSearchParams(location.search);

    // لو رجعنا من /next (?ready=1) لا نعمل polling
    if (params.has('ready')) return;

    var tries = 0, maxTries = 30, redirected = false;

    function modalOpen(){
      return !!document.querySelector('.modal.show');
    }

    function checkOnce(){
      // أوقف الاستعلام مؤقتًا إذا فيه مودال مفتوح (منع اهتزاز)
      if (modalOpen()){
        setTimeout(checkOnce, 1500);
        return;
      }

      fetch('/api/stripe/checkout/state/' + bookingId, {credentials:'same-origin', cache: 'no-store'})
        .then(r => r.ok ? r.json() : {})
        .then(state => {
          try{
            if(state.rent_authorized){ markRentPaidUI(); }
            if(state.deposit_held){   markDepositHeldUI(); }

            if(state.ready_for_pickup && !redirected){
              redirected = true; // امنع أي تحويل لاحق
              location.assign("/bookings/flow/{{ booking.id }}/next");
              return;
            }
          }catch(e){}
          retry();
        })
        .catch(retry);
    }

    function retry(){
      tries++;
      if(tries > maxTries || redirected) return;
      var delay = (tries < 8) ? 1000 : Math.min(8000, 1000 + tries*700);
      setTimeout(checkOnce, delay);
    }

    checkOnce();

    // إعادة تنشيط ذكي عند العودة للصفحة
    document.addEventListener('visibilitychange', function(){
      if (!document.hidden && !redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
    window.addEventListener('pageshow', function(){
      if(!redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
    window.addEventListener('focus', function(){
      if(!redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
  })();

  // عدّاد المهلة (إن وُجد)
  {% if dispute_deadline_iso %}
  try{
    if(window.initCountdown){
      initCountdown('deadlineCountdown','{{ dispute_deadline_iso }}');
    }else{
      var el = document.getElementById('deadlineCountdown');
      if(el){ el.textContent = new Date('{{ dispute_deadline_iso }}').toLocaleString(); }
    }
  }catch(e){}
  {% endif %}
</script>

{% endblock %}
