{% extends "base.html" %}

{% block head %}
<style>
  .flow-card{max-width:980px;margin:auto}
  .state-badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-weight:700}
  .k{opacity:.65}
  .acts{display:flex;flex-wrap:wrap;gap:10px}
  .acts form{display:inline}
  .hint{background:color-mix(in oklab,var(--surface) 95%,transparent);border:1px dashed var(--border);border-radius:12px;padding:10px 12px}
  .box{border:1px solid var(--border);border-radius:12px;padding:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
</style>
{% endblock %}

{% block content %}
<div class="flow-card card p-3 p-md-4">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h4 class="mb-1">الحجز #{{ booking.id }}</h4>
      <div class="k">العنصر: <strong>{{ item_title }}</strong>{% if item %} — <a href="/items/{{ item.id }}">عرض</a>{% endif %}</div>
      <div class="k">الفترة: {{ booking.start_date }} → {{ booking.end_date }} ({{ booking.days }} يوم)</div>
    </div>
    <span class="state-badge">
      <i class="bi bi-flag"></i> الحالة: {{ booking.status }}
    </span>
  </div>

  <hr>

  <div class="row g-3">
    <div class="col-12 col-lg-7">

      {# ======= المرحلة: طلب جديد ======= #}
      {% if booking.status in ['requested'] %}
        {% if is_owner %}
          <h5 class="mb-2">طلب جديد ينتظر موافقتك</h5>

          <div class="box mb-2">
            <div class="mb-2">أدخل <strong>الديبو</strong> المطلوب (الافتراضي = سعر اليوم × 5)</div>
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision" class="row g-2 align-items-end">
              <input type="hidden" name="decision" value="accepted">
              <div class="col-12 col-md-6">
                <label class="form-label">قيمة الديبو</label>
                <input id="depositInput" name="deposit_amount" type="number" min="0" step="1" class="form-control"
                       value="{{ booking.deposit_amount or 0 }}">
                <div class="form-text k">يمكنك تغيير القيمة قبل القبول.</div>
              </div>
              <div class="col-12 col-md-6">
                <button class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> قبول بالديبو</button>
              </div>
            </form>
          </div>

          <div class="acts">
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
              <input type="hidden" name="decision" value="rejected">
              <button class="btn btn-outline-danger"><i class="bi bi-x-lg"></i> رفض</button>
            </form>
          </div>

          <script>
  // الافتراضي = سعر اليوم × 5 (مرة واحدة فقط لو الحقل فارغ/صفر)
  (function () {
    try {
      var inp = document.getElementById('depositInput');
      if (!inp) return;

      var current = parseInt(inp.value || '0', 10);
      if (!current || current <= 0) {
        // نجعل إدراج Jinja كسلسلة ثم نحولها لرقم ليتفادى المحرر أي أخطاء نحوية
        var pricePerDay = parseInt('{{ (item.price_per_day or 0)|int }}', 10) || 0;
        var defVal = pricePerDay * 5;
        inp.value = defVal;
      }
    } catch (e) {}
  })();
</script>

        {% elif is_renter %}
          <div class="hint">تم إرسال طلبك. بانتظار موافقة المالك…</div>
        {% endif %}
      {% endif %}

      {# ======= المرحلة: مقبول – اختيار الدفع ======= #}
      {% if booking.status in ['accepted'] %}
        {% if is_renter %}
          <h5>اختر طريقة الدفع</h5>

          <div class="box mb-2">
            <div class="mb-2">الدفع <strong>كاش عند الاستلام</strong></div>
            <form method="post" action="/bookings/{{ booking.id }}/pay-cash">
              <button class="btn btn-secondary"><i class="bi bi-cash-stack"></i> سأدفع كاش</button>
            </form>
          </div>

          <div class="box">
            <div class="mb-2">الدفع <strong>أونلاين (Stripe Checkout)</strong></div>

            {% if not owner_pe %}
              <div class="alert alert-warning">
                لا يمكن الدفع أونلاين الآن لأن <strong>المالك</strong> لم يُكمل تفعيل حساب الاستلام بعد.
                {% if owner and owner.id == session_user.id %}
                  <div class="mt-2">
                    <a class="btn btn-primary btn-sm" href="/connect/onboard">
                      <i class="bi bi-person-badge"></i> أكمل التحقق الآن
                    </a>
                    <small class="d-block k mt-1">بعد إكمال التحقق البنكي والهوية سيصبح الدفع أونلاين متاحًا.</small>
                  </div>
                {% else %}
                  <small class="d-block k mt-1">رجاءً اطلب من المالك إكمال التحقق البنكي والهوية ليتاح الدفع أونلاين.</small>
                {% endif %}
              </div>
            {% endif %}

            <form id="stripePayForm" method="post" action="/api/stripe/checkout/rent/{{ booking.id }}">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">مبلغ الإيجار</label>
                  <input class="form-control" type="number" value="{{ booking.total_amount or 0 }}" disabled>
                </div>
                <div class="col-6">
                  <label class="form-label">الديبو</label>
                  <input class="form-control" type="number" value="{{ booking.deposit_amount or booking.hold_deposit_amount or 0 }}" disabled>
                </div>
                <div class="col-12 mt-2">
                  <button id="stripePayBtn" class="btn btn-primary"
                          {% if not owner_pe %}disabled aria-disabled="true" title="المالك لم يفعل الاستلام بعد"{% endif %}>
                    <i class="bi bi-credit-card"></i> ادفع الإيجار أونلاين
                  </button>
                </div>
              </div>
            </form>

            {% if (booking.deposit_amount or booking.hold_deposit_amount) and (booking.deposit_amount or booking.hold_deposit_amount) > 0 %}
            <form class="mt-2" method="post" action="/api/stripe/checkout/deposit/{{ booking.id }}">
              <button class="btn btn-outline-primary"
                      {% if not owner_pe %}disabled aria-disabled="true" title="المالك لم يفعل الاستلام بعد"{% endif %}>
                <i class="bi bi-shield-lock"></i> حجز الوديعة (ديبو) أونلاين
              </button>
            </form>
            {% endif %}

            <div class="k mt-2">
              سيتم تحويلك إلى صفحة دفع آمنة من Stripe لإدخال بيانات بطاقتك.
              بعد النجاح ستعود تلقائيًا لصفحة الحجز، وسنحدّث الحالة.
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">تم قبول الطلب. بانتظار أن يختار المستأجر طريقة الدفع…</div>

          {% if not owner_pe %}
            <div class="alert alert-warning mt-2">
              لكي يتمكّن المستأجر من الدفع أونلاين وتحويل المبلغ لك، أكمل تفعيل حسابك البنكي:
              <div class="mt-2">
                <a class="btn btn-primary btn-sm" href="/connect/onboard">
                  <i class="bi bi-person-badge"></i> أكمل التحقق الآن
                </a>
              </div>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}

      {# ======= المرحلة: تم الدفع ======= #}
      {% if booking.status in ['paid'] %}
        {% if is_renter %}
          <h5>جاهز للاستلام</h5>
          <div class="hint">عند استلامك الغرض من المالك، اضغط الزر أدناه.</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/picked-up">
            <button class="btn btn-success"><i class="bi bi-bag-check"></i> تم استلام الغرض</button>
          </form>
        {% elif is_owner %}
          <div class="hint">تم الدفع. بانتظار أن يؤكد المستأجر أنه استلم الغرض.</div>
        {% endif %}
      {% endif %}

      {# ======= المرحلة: تم الاستلام ======= #}
      {% if booking.status in ['picked_up'] %}
        {% if is_renter %}
          <h5>الغرض لديك الآن</h5>
          <div class="hint">عند إرجاع الغرض للمالك، اضغط:</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/mark-returned">
            <button class="btn btn-warning"><i class="bi bi-arrow-return-left"></i> تم إرجاع الغرض</button>
          </form>
        {% elif is_owner %}
          <div class="hint">المستأجر استلم الغرض. عند إرجاعه ستظهر لك خطوات تأكيد الإرجاع والوديعة.</div>
        {% endif %}
      {% endif %}

      {# ======= المرحلة: بانتظار مراجعة الوديعة ======= #}
      {% if booking.status in ['returned', 'in_review'] %}
        {% if session_user and session_user.role == 'admin' %}
          <div class="hint">هذا الحجز بانتظار قرار الوديعة من الإدارة/متحكّم الوديعة.</div>
        {% elif is_owner %}
          <div class="hint">تم تعليم الإرجاع. بانتظار مراجعة <strong>الإدارة/متحكّم الوديعة</strong> لاتخاذ قرار الوديعة.</div>
        {% elif is_renter %}
          <div class="hint">تم تعليم الإرجاع. بانتظار الإدارة/متحكّم الوديعة لتأكيد الحالة وتحرير الوديعة.</div>
        {% endif %}
      {% endif %}

      {% if booking.status in ['closed','rejected','completed'] %}
        <div class="alert alert-info">
          {% if booking.status in ['closed','completed'] %}
            العملية مكتملة ✅
          {% else %}
            تم رفض الحجز ❌
          {% endif %}
        </div>
      {% endif %}
    </div>

    <div class="col-12 col-lg-5">
      <div class="box">
        <h6 class="mb-2">ملخص الدفع</h6>
        <div class="d-flex justify-content-between">
          <span>طريقة الدفع</span>
          <strong>{{ booking.payment_method or '—' }}</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>مبلغ الإيجار</span>
          <strong>{{ booking.rent_amount or booking.total_amount or 0 }}$</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>الوديعة المحتجزة</span>
          <strong>{{ booking.hold_deposit_amount or booking.deposit_amount or 0 }}$</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>حالة التحصيل الأونلاين</span>
          <strong>{{ booking.online_status or '—' }}</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>حالة الوديعة</span>
          <strong>{{ booking.deposit_status or '—' }}</strong>
        </div>
        <hr>
        <div class="k mono small">
          {% if booking.accepted_at %}accepted_at: {{ booking.accepted_at }}<br>{% endif %}
          {% if booking.picked_up_at %}picked_up_at: {{ booking.picked_up_at }}<br>{% endif %}
          {% if booking.returned_at %}returned_at: {{ booking.returned_at }}<br>{% endif %}
          {% if booking.return_confirmed_by_owner_at %}owner_confirmed_at: {{ booking.return_confirmed_by_owner_at }}<br>{% endif %}
          {% if booking.rent_released_at %}rent_released_at: {{ booking.rent_released_at }}<br>{% endif %}
        </div>
      </div>

      {% if item %}
      <div class="box mt-3">
        <h6 class="mb-2">العنصر</h6>
        <div class="d-flex gap-3">
          <img src="{{ (('/' ~ item.image_path) if item.image_path and item.image_path[0] != '/' else (item.image_path or '/static/placeholder.jpg')) }}"
               style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
          <div>
            <div class="fw-bold">{{ item.title }}</div>
            <div class="k">{{ category_label(item.category) }}</div>
            <div class="k">السعر اليومي: {{ item.price_per_day }}$</div>
            <a class="small" href="/items/{{ item.id }}">فتح صفحة العنصر</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // زر الانتقال لـ Stripe
  const f = document.getElementById('stripePayForm');
  if (f) {
    f.addEventListener('submit', function() {
      const btn = document.getElementById('stripePayBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> جاري تحويلك إلى الدفع...';
      }
    });
  }
</script>
{% endblock %}