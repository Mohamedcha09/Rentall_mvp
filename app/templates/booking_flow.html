{% extends "base.html" %}

{% block head %}
<style>
  .flow-card{max-width:1000px;margin:auto}
  .state-badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-weight:700}
  .k{opacity:.7}
  .acts{display:flex;flex-wrap:wrap;gap:10px}
  .acts form{display:inline}
  .hint{background:color-mix(in oklab,var(--surface) 92%,transparent);border:1px dashed var(--border);border-radius:12px;padding:10px 12px}
  .box{border:1px solid var(--border);border-radius:12px;padding:12px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .btn-wide{min-width:220px}
  .badge-dot{display:inline-flex;gap:6px;align-items:center}
  .badge-dot i{font-size:10px}
  .muted{opacity:.6}
  .alert-mini{padding:.6rem .8rem}

  /* ===== Ø¥ØµÙ„Ø§Ø­ Ø±Ø¬ÙØ© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (iOS/Safari/Bootstrap) ===== */
  .modal, .modal-backdrop{
    will-change: opacity, transform;
    -webkit-transform: translateZ(0);
            transform: translateZ(0);
    -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
  }
  .modal.fade .modal-dialog{ transition: none !important; }
  body.modal-open{ padding-right:0 !important; }
  body.modal-open *{ animation:none !important; transition:none !important; }
</style>

{% if dispute_deadline_iso %}
  <script defer src="/static/js/countdown.js"></script>
{% endif %}
{% endblock %}

{% block content %}
<div class="flow-card card p-3 p-md-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-start flex-wrap">
    <div class="mb-2">
      <h4 class="mb-1">Ø§Ù„Ø­Ø¬Ø² #{{ booking.id }}</h4>
      <div class="k">
        Ø§Ù„Ø¹Ù†ØµØ±: <strong>{{ item_title }}</strong>
        {% if item %} â€” <a href="/items/{{ item.id }}">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ù†ØµØ±</a>{% endif %}
      </div>
      <div class="k">Ø§Ù„ÙØªØ±Ø©: {{ booking.start_date }} â†’ {{ booking.end_date }} ({{ booking.days }} ÙŠÙˆÙ…)</div>
    </div>
    <span class="state-badge mt-1">
      <i class="bi bi-flag"></i>
      <span>Ø§Ù„Ø­Ø§Ù„Ø©: {{ booking.status }}</span>
    </span>
  </div>

  <hr>

  <div class="row g-3">
    <!-- Left column: actions / flow -->
    <div class="col-12 col-lg-7">

      {# ======= Ø§Ù„Ù…Ø±Ø­Ù„Ø©: Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ======= #}
      {% if booking.status in ['requested'] %}
        {% if is_owner %}
          <h5 class="mb-2">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙŠÙ†ØªØ¸Ø± Ù…ÙˆØ§ÙÙ‚ØªÙƒ</h5>

          <div class="box mb-2">
            <div class="mb-2">Ø£Ø¯Ø®Ù„ <strong>Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© (Ø¯ÙŠØ¨Ùˆ)</strong> Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ = Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ… Ã— 5)</div>
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision" class="row g-2 align-items-end">
              <input type="hidden" name="decision" value="accepted">
              <div class="col-12 col-md-6">
                <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„ÙˆØ¯ÙŠØ¹Ø©</label>
                <input id="depositInput" name="deposit_amount" type="number" min="0" step="1" class="form-control"
                       value="{{ booking.deposit_amount or 0 }}">
                <div class="form-text k">ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„.</div>
              </div>
              <div class="col-12 col-md-6">
                <button class="btn btn-success w-100"><i class="bi bi-check2-circle"></i> Ù‚Ø¨ÙˆÙ„ Ø¨Ø§Ù„ÙˆØ¯ÙŠØ¹Ø©</button>
              </div>
            </form>
          </div>

          <div class="acts">
            <form method="post" action="/bookings/{{ booking.id }}/owner/decision">
              <input type="hidden" name="decision" value="rejected">
              <button class="btn btn-outline-danger"><i class="bi bi-x-lg"></i> Ø±ÙØ¶</button>
            </form>
          </div>

          <script>
            (function () {
              try {
                var inp = document.getElementById('depositInput');
                if (!inp) return;
                var current = parseInt(inp.value || '0', 10);
                if (!current || current <= 0) {
                  var pricePerDay = parseInt('{{ (item.price_per_day or 0)|int }}', 10) || 0;
                  var defVal = pricePerDay * 5;
                  inp.value = defVal;
                }
              } catch (e) {}
            })();
          </script>

        {% elif is_renter %}
          <div class="hint">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø§Ù„Ùƒâ€¦</div>
        {% endif %}
      {% endif %}

      {# ======= Ø§Ù„Ù…Ø±Ø­Ù„Ø©: Ù…Ù‚Ø¨ÙˆÙ„ â€“ Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¨Ø£Ø²Ø±Ø§Ø± Ù…Ù†ÙØµÙ„Ø© ======= #}
      {% if booking.status in ['accepted'] %}
        {% if is_renter %}
          <h5 class="mb-2">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h5>

          <!-- Ø§Ù„Ø¯ÙØ¹ ÙƒØ§Ø´ -->
          <div class="box mb-2">
            <div class="mb-2">Ø§Ù„Ø¯ÙØ¹ <strong>ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</strong></div>
            <form method="post" action="/bookings/{{ booking.id }}/pay-cash">
              <button class="btn btn-secondary btn-wide"><i class="bi bi-cash-stack"></i> Ø³Ø£Ø¯ÙØ¹ ÙƒØ§Ø´</button>
            </form>
          </div>

          <!-- Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¨Ø£Ø²Ø±Ø§Ø± Ù…Ù†ÙØµÙ„Ø© -->
          <div class="box" id="onlineBox"
               data-rent-authorized="{{ '1' if booking.online_status in ['authorized','captured','succeeded','paid'] else '0' }}"
               data-deposit-held="{{ '1' if booking.deposit_status in ['held','authorized'] else '0' }}">

            <div class="mb-2">Ø§Ù„Ø¯ÙØ¹ <strong>Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Stripe Checkout)</strong></div>

            {% if not owner_pe %}
              <div class="alert alert-warning alert-mini">
                Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø§Ù„Ø¢Ù† Ù„Ø£Ù† <strong>Ø§Ù„Ù…Ø§Ù„Ùƒ</strong> Ù„Ù… ÙŠÙÙƒÙ…Ù„ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø¹Ø¯.
                {% if owner and owner.id == session_user.id %}
                  <div class="mt-2">
                    <a class="btn btn-primary btn-sm" href="/connect/onboard">
                      <i class="bi bi-person-badge"></i> Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù†
                    </a>
                    <small class="d-block k mt-1">Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ù†ÙƒÙŠ ÙˆØ§Ù„Ù‡ÙˆÙŠØ© Ø³ÙŠØµØ¨Ø­ Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù…ØªØ§Ø­Ù‹Ø§.</small>
                  </div>
                {% else %}
                  <small class="d-block k mt-1">Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ù†ÙƒÙŠ ÙˆØ§Ù„Ù‡ÙˆÙŠØ© Ù„ÙŠØªØ§Ø­ Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†.</small>
                {% endif %}
              </div>
            {% endif %}

            {% set rent_paid = (booking.online_status in ['authorized','captured','succeeded','paid']) %}
            {% set deposit_ok = (booking.deposit_status in ['held','authorized']) %}

            <!-- Ø²Ø±: Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙ‚Ø· (ÙŠØªØ­ÙˆÙ‘Ù„ Ù„Ø¹Ø¨Ø§Ø±Ø© ØªÙ… Ø§Ù„Ø¯ÙØ¹) -->
            <div id="rentActionWrap" class="d-inline">
              {% if rent_paid %}
                <button id="rentPaidBadge" class="btn btn-success btn-wide me-1" disabled>
                  <i class="bi bi-check2-circle"></i> ØªÙ… Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± âœ…
                </button>
              {% else %}
                <form id="stripePayRentForm" method="post" action="/api/stripe/checkout/rent/{{ booking.id }}" class="d-inline">
                  <button id="stripePayRentBtn" class="btn btn-outline-primary btn-wide me-1"
                          {% if not owner_pe %}disabled aria-disabled="true"{% endif %}>
                    <i class="bi bi-credit-card-2-front"></i> Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙ‚Ø·
                  </button>
                </form>
              {% endif %}
            </div>

            <!-- Ø²Ø±: Ø­Ø¬Ø² Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© ÙÙ‚Ø· (ÙŠØ®ØªÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø¬Ø²) -->
            {% if (booking.deposit_amount or booking.hold_deposit_amount) and (booking.deposit_amount or booking.hold_deposit_amount) > 0 %}
            <div id="depositActionWrap" class="d-inline">
              {% if deposit_ok %}
                <button id="depositHeldBadge" class="btn btn-success btn-wide" disabled>
                  <i class="bi bi-shield-check"></i> ØªÙ… Ø­Ø¬Ø² Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© âœ…
                </button>
              {% else %}
                <form id="stripeDepositForm" class="d-inline" method="post" action="/api/stripe/checkout/deposit/{{ booking.id }}">
                  <button id="stripeDepositBtn" class="btn btn-outline-secondary btn-wide"
                          {% if not owner_pe %}disabled aria-disabled="true"{% endif %}>
                    <i class="bi bi-shield-lock"></i> Ø­Ø¬Ø² Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© ÙÙ‚Ø·
                  </button>
                </form>
              {% endif %}
            </div>
            {% endif %}

            <div class="k mt-2">
              Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø¯ÙØ¹ Ø¢Ù…Ù†Ø© Ù…Ù† Stripe Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚ØªÙƒ. Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø³ØªØ¹ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø¬Ø² ÙˆØ³Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø§Ù„Ø©.
            </div>
          </div>
        {% elif is_owner %}
          <div class="hint">ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø£Ù† ÙŠØ®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹â€¦</div>

          {% if not owner_pe %}
            <div class="alert alert-warning mt-2 alert-mini">
              Ù„ÙƒÙŠ ÙŠØªÙ…ÙƒÙ‘Ù† Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ù† Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„ÙƒØŒ Ø£ÙƒÙ…Ù„ ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¨Ù†ÙƒÙŠ:
              <div class="mt-2">
                <a class="btn btn-primary btn-sm" href="/connect/onboard">
                  <i class="bi bi-person-badge"></i> Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù†
                </a>
              </div>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}

      {# ======= Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ØªÙ… Ø§Ù„Ø¯ÙØ¹ (Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…) ======= #}
      {% if booking.status in ['paid'] %}
        {% if is_renter %}
          <h5>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…</h5>
          <div class="hint">Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù…Ùƒ Ø§Ù„ØºØ±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø§Ù„ÙƒØŒ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡.</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/picked-up">
            <button class="btn btn-success btn-wide"><i class="bi bi-bag-check"></i> ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØºØ±Ø¶</button>
          </form>
        {% elif is_owner %}
          <div class="hint">ØªÙ… Ø§Ù„Ø¯ÙØ¹. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø£Ù† ÙŠØ¤ÙƒØ¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£Ù†Ù‡ Ø§Ø³ØªÙ„Ù… Ø§Ù„ØºØ±Ø¶.</div>
          <form class="mt-2" method="post" action="/bookings/{{ booking.id }}/owner/confirm_delivered">
            <button class="btn btn-outline-success btn-sm"><i class="bi bi-hand-thumbs-up"></i> Ø¹Ù„Ù‘ÙÙ… ØªÙ…Ù‘ Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
          </form>
        {% endif %}
      {% endif %}

      {# ======= Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ======= #}
      {% if booking.status in ['picked_up'] %}
  {% if is_renter %}
    <h5>Ø§Ù„ØºØ±Ø¶ Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¢Ù†</h5>
    <div class="hint">Ø¹Ù†Ø¯ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØºØ±Ø¶ Ù„Ù„Ù…Ø§Ù„ÙƒØŒ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡. Ø¨Ø¹Ø¯Ù‡Ø§ Ø³ØªÙ†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ….</div>

    <!-- Ø§Ù†ØªÙ‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ù„ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
    <a class="btn btn-warning btn-wide" href="/reviews/renter/{{ booking.id }}">
      <i class="bi bi-box-arrow-in-left"></i> ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØºØ±Ø¶ â€” ØªØ§Ø¨Ø¹ Ù„Ù„ØªÙ‚ÙŠÙŠÙ…
    </a>
  {% elif is_owner %}
    <div class="hint">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø§Ø³ØªÙ„Ù… Ø§Ù„ØºØ±Ø¶. Ø¹Ù†Ø¯ Ø¥Ø±Ø¬Ø§Ø¹Ù‡ Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø®Ø·ÙˆØ§Øª ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ§Ù„ÙˆØ¯ÙŠØ¹Ø©.</div>
  {% endif %}
{% endif %}


      {# ======= Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ØªÙ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ / Ù‚ÙŠØ¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© ======= #}
      {% if booking.status in ['returned', 'in_review'] %}
        {% if is_owner %}
          <h5 class="mb-2">Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¹Ù„Ù‘ÙÙ… â€” Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h5>
          <div class="hint mb-2">
            Ù„Ø¯ÙŠÙƒ Ù…Ù‡Ù„Ø© Ù„Ù„Ø§Ø¹ØªØ±Ø§Ø¶ Ø¹Ø¨Ø± ÙØªØ­ Ø¨Ù„Ø§Øº ÙˆØ¯ÙŠØ¹Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø©:
            {% if dispute_deadline_iso %}
              <div class="mt-2">
                <span class="badge-dot"><i class="bi bi-circle-fill"></i> Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶:</span>
                <div id="deadlineCountdown" class="mono fw-bold">
                  <span class="countdown" data-deadline="{{ dispute_deadline_iso }}"></span>
                </div>
              </div>
            {% endif %}
          </div>
          <form method="get" action="/deposits/{{ booking.id }}/report">
            <button class="btn btn-outline-danger btn-wide">
              <i class="bi bi-exclamation-octagon"></i> ÙØªØ­ Ø¨Ù„Ø§Øº ÙˆØ¯ÙŠØ¹Ø© (Ù…Ø´ÙƒÙ„Ø©/Ø¶Ø±Ø±/ØªØ£Ø®ÙŠØ±)
            </button>
          </form>

          <!-- ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø± -->
<div class="box mt-3">
  <h6 class="mb-2">Ù‚ÙŠÙ‘Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</h6>

  {% if owner_already_rated and owner_prev_review %}
    <!-- âœ… Ø³Ø¨Ù‚ ÙˆÙ‚ÙŠÙ‘Ù…Øª: Ø¹Ø±Ø¶ Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· -->
    <div class="d-flex align-items-center gap-2 mb-2">
      <div class="text-warning">
        {% for _ in range(owner_prev_review.stars) %}â­{% endfor %}
        {% for _ in range(5 - owner_prev_review.stars) %}â˜†{% endfor %}
      </div>
      <span class="small text-muted">ØªÙ… Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø².</span>
    </div>
    {% if owner_prev_review.comment %}
      <div class="p-2 rounded" style="border:1px solid var(--border);background:rgba(255,255,255,.04)">
        {{ owner_prev_review.comment }}
      </div>
    {% endif %}
    <div class="mt-2">
      <a class="btn btn-outline-primary btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">
        Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
      </a>
    </div>
  {% else %}
    <!-- âœï¸ Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙØ¹Ù‘Ø§Ù„ -->
    <form method="post" action="/reviews/owner/{{ booking.id }}" class="d-flex flex-column gap-2" id="ownerRateForm">
      <div class="d-flex gap-1" id="starsO" role="radiogroup" aria-label="ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
        {% for n in [1,2,3,4,5] %}
          <input class="d-none" type="radio" name="rating" id="o{{n}}" value="{{n}}" {% if n==5 %}checked{% endif %}>
          <label for="o{{n}}" class="btn btn-outline-warning btn-sm star-btn" data-val="{{n}}">
            <i class="bi bi-star-fill"></i> {{n}}
          </label>
        {% endfor %}
      </div>
      <textarea name="comment" class="form-control" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù† Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      <div>
        <button class="btn btn-primary btn-sm" id="ownerRateSubmit">
          <i class="bi bi-send"></i> Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        </button>
      </div>
    </form>
  {% endif %}
</div>

<!-- ğŸ” Ù…Ù„Ø®Øµ ØªÙ‚ÙŠÙŠÙ…Ù‡ ÙƒÙ…Ø³ØªØ£Ø¬Ø± + Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± -->
<div class="hint mt-2">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div class="small">ØªÙ‚ÙŠÙŠÙ…Ù‡ ÙƒÙ…Ø³ØªØ£Ø¬Ø±: â­ {{ renter_reviews_avg }}/5 â€” {{ renter_reviews_count }} Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
    <a class="btn btn-ghost btn-sm" href="/users/{{ booking.renter_id }}?tab=reviews">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</a>
  </div>
</div>



          <div class="k small mt-2">Ø¥Ù† Ù„Ù… ØªÙØªØ­ Ø¨Ù„Ø§ØºÙ‹Ø§ Ø¶Ù…Ù† Ø§Ù„Ù…Ù‡Ù„Ø©ØŒ ØªÙÙØ±Ø¬ Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø³Ø©.</div>

        {% elif is_renter %}
          <div class="hint">ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ù…ØªØ­ÙƒÙ‘Ù… Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ù„Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± Ø§Ù„ÙˆØ¯ÙŠØ¹Ø©.</div>
          {% if dispute_deadline_iso %}
            <div class="k small mt-2">Ù…Ù‡Ù„Ø© Ø§Ø¹ØªØ±Ø§Ø¶ Ø§Ù„Ù…Ø§Ù„Ùƒ Ù…Ø§Ø²Ø§Ù„Øª Ø³Ø§Ø±ÙŠØ© â€” Ø³ÙŠØªÙ… Ø§Ù„Ø¥ÙØ±Ø§Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡Ø§ Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª.</div>
          {% endif %}
        {% elif session_user and session_user.role == 'admin' %}
          <div class="hint">Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø± Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ù…ØªØ­ÙƒÙ‘Ù… Ø§Ù„ÙˆØ¯ÙŠØ¹Ø©.</div>
        {% endif %}
      {% endif %}

      {# ======= Ø­Ø§Ù„Ø§Øª Ù…Ù†ØªÙ‡ÙŠØ© ======= #}
      {% if booking.status in ['closed','rejected','completed'] %}
        <div class="alert alert-info">
          {% if booking.status in ['closed','completed'] %}
            Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø© âœ…
          {% else %}
            ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¬Ø² âŒ
          {% endif %}
        </div>
      {% endif %}

    </div>

    <!-- Right column: summary -->
    <div class="col-12 col-lg-5">
      <div class="box">
        <h6 class="mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙØ¹</h6>
        <div class="d-flex justify-content-between"><span>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><strong>{{ booking.payment_method or 'â€”' }}</strong></div>
        <div class="d-flex justify-content-between"><span>Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</span><strong>{{ booking.rent_amount or booking.total_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ø§Ù„Ù…Ø­ØªØ¬Ø²Ø©</span><strong>{{ booking.hold_deposit_amount or booking.deposit_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</span><strong>{{ booking.online_status or 'â€”' }}</strong></div>
        <div class="d-flex justify-content-between"><span>Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ¯ÙŠØ¹Ø©</span><strong>{{ booking.deposit_status or 'â€”' }}</strong></div>
        <hr>
        <div class="k mono small">
          {% if booking.accepted_at %}accepted_at: {{ booking.accepted_at }}<br>{% endif %}
          {% if booking.picked_up_at %}picked_up_at: {{ booking.picked_up_at }}<br>{% endif %}
          {% if booking.returned_at %}returned_at: {{ booking.returned_at }}<br>{% endif %}
          {% if booking.return_confirmed_by_owner_at %}owner_confirmed_at: {{ booking.return_confirmed_by_owner_at }}<br>{% endif %}
          {% if booking.rent_released_at %}rent_released_at: {{ booking.rent_released_at }}<br>{% endif %}
        </div>
      </div>

      {% if item %}
      <div class="box mt-3">
        <h6 class="mb-2">Ø§Ù„Ø¹Ù†ØµØ±</h6>
        <div class="d-flex gap-3">
          <img src="{{ (('/' ~ item.image_path) if item.image_path and item.image_path[0] != '/' else (item.image_path or '/static/placeholder.jpg')) }}"
               style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
          <div>
            <div class="fw-bold">{{ item.title }}</div>
            <div class="k">{{ category_label(item.category) }}</div>
            <div class="k">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ: {{ item.price_per_day }}$</div>
            <a class="small" href="/items/{{ item.id }}">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ù†ØµØ±</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ===== JS (Ù…Ø±ØªØ¨ØŒ Ø¯ÙˆØ§Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…) ===== -->
<script>
  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  function wireDisableOnSubmit(formId, btnId, text){
    var f = document.getElementById(formId);
    if(!f) return;
    f.addEventListener('submit', function(){
      var btn = document.getElementById(btnId);
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ' + (text || 'Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ...');
      }
    });
  }

  // ØªØ­Ø¯ÙŠØ« "Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù…Ø¯ÙÙˆØ¹"
  function markRentPaidUI(){
    var wrap = document.getElementById('rentActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#rentPaidBadge')){
      wrap.innerHTML = '<button id="rentPaidBadge" class="btn btn-success btn-wide me-1" disabled><i class="bi bi-check2-circle"></i> ØªÙ… Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± âœ…</button>';
    }
  }

  // ØªØ­Ø¯ÙŠØ« "Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ù…Ø­Ø¬ÙˆØ²Ø©"
  function markDepositHeldUI(){
    var wrap = document.getElementById('depositActionWrap');
    if(!wrap) return;
    if (!wrap.querySelector('#depositHeldBadge')){
      wrap.innerHTML = '<button id="depositHeldBadge" class="btn btn-success btn-wide" disabled><i class="bi bi-shield-check"></i> ØªÙ… Ø­Ø¬Ø² Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© âœ…</button>';
    }
  }

  // Ø§Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)
  wireDisableOnSubmit('stripePayRentForm','stripePayRentBtn','Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹â€¦');
  wireDisableOnSubmit('stripeDepositForm','stripeDepositBtn','Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹â€¦');

  // Ø§Ù‚Ø±Ø£ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù€DOM (Ø­Ù‚Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±)
  (function(){
    try{
      var box = document.getElementById('onlineBox');
      if(!box) return;
      var rentAuth = box.getAttribute('data-rent-authorized') === '1';
      var depHeld  = box.getAttribute('data-deposit-held') === '1';
      if(rentAuth){ markRentPaidUI(); }
      if(depHeld){  markDepositHeldUI(); }
    }catch(e){}
  })();

  /* ===== Polling Stripe state (Ù…Ø­Ù…ÙŠ Ù…Ù† Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ ÙˆÙ…ÙˆÙ‚ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„) ===== */
  (function(){
    if (window.__FLOW_POLLER__ && window.__FLOW_POLLER__.started) return;
    window.__FLOW_POLLER__ = { started:true };

    var bookingId = {{ booking.id }};
    var params = new URLSearchParams(location.search);

    // Ù„Ùˆ Ø±Ø¬Ø¹Ù†Ø§ Ù…Ù† /next (?ready=1) Ù„Ø§ Ù†Ø¹Ù…Ù„ polling
    if (params.has('ready')) return;

    var tries = 0, maxTries = 30, redirected = false;

    function modalOpen(){ return !!document.querySelector('.modal.show'); }

    function checkOnce(){
      // Ø£ÙˆÙ‚Ù Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¥Ø°Ø§ ÙÙŠÙ‡ Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ (Ù…Ù†Ø¹ Ø§Ù‡ØªØ²Ø§Ø²)
      if (modalOpen()){ setTimeout(checkOnce, 1500); return; }

      fetch('/api/stripe/checkout/state/' + bookingId, {credentials:'same-origin', cache: 'no-store'})
        .then(r => r.ok ? r.json() : {})
        .then(state => {
          try{
            if(state.rent_authorized){ markRentPaidUI(); }
            if(state.deposit_held){   markDepositHeldUI(); }

            if(state.ready_for_pickup && !redirected){
              redirected = true; // Ø§Ù…Ù†Ø¹ Ø£ÙŠ ØªØ­ÙˆÙŠÙ„ Ù„Ø§Ø­Ù‚
              location.assign("/bookings/flow/{{ booking.id }}/next");
              return;
            }
          }catch(e){}
          retry();
        })
        .catch(retry);
    }

    function retry(){
      tries++;
      if(tries > maxTries || redirected) return;
      var delay = (tries < 8) ? 1000 : Math.min(8000, 1000 + tries*700);
      setTimeout(checkOnce, delay);
    }

    checkOnce();

    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†Ø´ÙŠØ· Ø°ÙƒÙŠ Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('hidden.bs.modal', function(){ tries = 0; checkOnce(); });
    document.addEventListener('visibilitychange', function(){
      if (!document.hidden && !redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
    window.addEventListener('pageshow', function(){
      if(!redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
    window.addEventListener('focus', function(){
      if(!redirected && !params.has('ready')) { tries = 0; checkOnce(); }
    });
  })();

  // Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù„Ø© (Ø¥Ù† ÙˆÙØ¬Ø¯)
  {% if dispute_deadline_iso %}
  try{
    if(window.initCountdown){
      initCountdown('deadlineCountdown','{{ dispute_deadline_iso }}');
    }else{
      var el = document.getElementById('deadlineCountdown');
      if(el){ el.textContent = new Date('{{ dispute_deadline_iso }}').toLocaleString(); }
    }
  }catch(e){}
  {% endif %}
</script>

<script>
  // ØªÙØ¹ÙŠÙ„ Ø¨ØµØ±ÙŠ Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø¬ÙˆÙ… + Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø²Ø¯ÙˆØ¬
  (function () {
    try {
      var wrap = document.getElementById('starsO');
      if (wrap) {
        function syncActive(val) {
          wrap.querySelectorAll('.star-btn').forEach(function (b) {
            b.classList.toggle('btn-warning', b.dataset.val === val);
            b.classList.toggle('btn-outline-warning', b.dataset.val !== val);
          });
        }
        wrap.addEventListener('click', function (e) {
          var b = e.target.closest('.star-btn');
          if (!b) return;
          var val = b.dataset.val;
          var inp = document.getElementById('o' + val);
          if (inp) { inp.checked = true; }
          syncActive(val);
        });
        // Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ©
        var checked = wrap.querySelector('input[type=radio]:checked');
        syncActive(checked ? checked.value : '5');
      }

      var frm = document.getElementById('ownerRateForm');
      var btn = document.getElementById('ownerRateSubmit');
      if (frm && btn) {
        frm.addEventListener('submit', function () {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦';
        });
      }
    } catch (e) {}
  })();
</script>
<script>
  (function () {
    try {
      var wrap = document.getElementById('starsO');
      if (wrap) {
        function syncActive(val) {
          wrap.querySelectorAll('.star-btn').forEach(function (b) {
            b.classList.toggle('btn-warning', b.dataset.val === val);
            b.classList.toggle('btn-outline-warning', b.dataset.val !== val);
          });
        }
        wrap.addEventListener('click', function (e) {
          var b = e.target.closest('.star-btn');
          if (!b) return;
          var val = b.dataset.val;
          var inp = document.getElementById('o' + val);
          if (inp) { inp.checked = true; }
          syncActive(val);
        });
        var checked = wrap.querySelector('input[type=radio]:checked');
        syncActive(checked ? checked.value : '5');
      }

      var frm = document.getElementById('ownerRateForm');
      var btn = document.getElementById('ownerRateSubmit');
      if (frm && btn) {
        frm.addEventListener('submit', function () {
          // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦';

          // ğŸ”’ ØªØ¹Ø·ÙŠÙ„ ÙƒÙ„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙˆØ±Ù‹Ø§ (Ù†Ø¬ÙˆÙ… + ØªØ¹Ù„ÙŠÙ‚)
          frm.querySelectorAll('input, textarea, button, .star-btn').forEach(function(el){
            if (el.tagName === 'TEXTAREA') { el.setAttribute('readonly', 'readonly'); }
            el.classList.add('disabled');
            el.setAttribute('disabled', 'disabled');
          });

          // ğŸŸ¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø¬ÙˆÙ… Ø¨Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø· Ø¥Ù„Ù‰ Ø­ÙŠÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
          var chosen = (frm.querySelector('input[name=rating]:checked') || {}).value || '5';
          var comment = (frm.querySelector('textarea[name=comment]') || {}).value || '';
          var preview = document.createElement('div');
          preview.className = 'alert alert-success mt-2';
          preview.innerHTML =
            'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…â€¦ <span class="ms-1">â­ '.concat(chosen, '/5</span>') +
            (comment ? '<div class="mt-1 small text-muted">'+ comment.replace(/</g,'&lt;') +'</div>' : '');
          // Ø¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¨Ø§Ø´Ø±Ø©
          var title = frm.previousElementSibling; // <h6 class="mb-2">Ù‚ÙŠÙ‘Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</h6>
          if (title && title.tagName === 'H6') {
            title.insertAdjacentElement('afterend', preview);
          }
        });
      }
    } catch (e) {}
  })();
</script>


{% endblock %}
