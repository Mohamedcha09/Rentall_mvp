{% extends "base.html" %}
{% set u = session_user or {} %}
{% block content %}

<style>
  .ticket-wrap{max-width:980px;margin:auto}
  .chip{font-size:.8rem;padding:.25rem .55rem;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03)}
  .msg{border-radius:14px;padding:.6rem .8rem;white-space:pre-wrap}
  .msg-user{background:rgba(25,135,84,.08);border:1px solid rgba(25,135,84,.2)}
  .msg-agent{background:rgba(13,110,253,.08);border:1px solid rgba(13,110,253,.2)}
  .msg-system{background:rgba(108,117,125,.08);border:1px dashed rgba(108,117,125,.35);font-style:italic}
  .msg-meta{font-size:.78rem;color:#888}
  .card-chat{max-height:58vh;overflow:auto}
  .toolbar-sticky{position:sticky;bottom:0;z-index:2;background:linear-gradient(to top, rgba(0,0,0,.06), transparent 42%);padding-top:.4rem;border-top:1px solid rgba(255,255,255,.08)}
</style>

<div class="container py-3 ticket-wrap" dir="rtl">
  <div class="d-flex align-items-center justify-content-between">
    <h4 class="m-0">Ticket #{{ ticket.id }} (MD)</h4>
    <a href="/md/inbox" class="btn btn-outline-secondary btn-sm"><i class="bi bi-inbox"></i> Back to Inbox</a>
  </div>
  <hr class="my-3">

  {% set is_closed = (ticket.status == 'closed') %}

  <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
    <span class="chip"><i class="bi bi-tag"></i> Subject: {{ ticket.subject or "No subject" }}</span>
    <span class="chip"><i class="bi bi-person"></i> Customer: {{ ticket.user and (ticket.user.first_name or ticket.user.email) or "Customer" }}</span>
    {% if is_closed %}
      <span class="chip text-bg-success border-0"><i class="bi bi-lock-fill"></i> Closed</span>
    {% else %}
      <span class="chip text-bg-warning border-0 text-dark"><i class="bi bi-hourglass-split"></i> In Review</span>
    {% endif %}
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-header d-flex align-items-center gap-2">
      <i class="bi bi-chat-dots"></i> Conversation
      <span class="ms-auto small text-muted">Last update: {{ ticket.updated_at and (ticket.updated_at|string)[:16] }}</span>
    </div>
    <div class="card-body card-chat">
      {% for m in msgs %}
        {% set who = (m.sender_role or '').lower() %}
        <div class="mb-3 {% if who=='agent' %}text-end{% endif %}">
          <div class="msg-meta mb-1">
            {{ m.created_at and m.created_at.strftime("%Y-%m-%d %H:%M") }} â€”
            {% if who=='agent' %}Agent{% elif who=='system' %}System{% else %}Customer{% endif %}
          </div>
          <div class="msg {% if who=='agent' %}msg-agent{% elif who=='system' %}msg-system{% else %}msg-user{% endif %}">
            {{ m.body }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  {% if not is_closed %}
    <div class="toolbar-sticky">
      <form id="replyForm" method="post" action="/md/ticket/{{ ticket.id }}/reply" class="p-2">
        <textarea class="form-control mb-2" name="body" rows="3" placeholder="Write your reply here..." required></textarea>
        <button class="btn btn-primary me-2" type="submit"><i class="bi bi-send"></i> Send Reply</button>
      </form>

      <form method="post" action="/chatbot/ticket/{{ ticket.id }}/close"
            onsubmit="return confirm('Close this ticket permanently? This cannot be undone.');"
            class="d-inline">
        <button class="btn btn-danger mt-2" type="submit">
          <i class="bi bi-x-circle"></i> Close Ticket
        </button>
      </form>
    </div>
  {% else %}
    <div class="alert alert-secondary mt-3">
      ðŸ”’ This ticket is closed.
    </div>
  {% endif %}
</div>

{% endblock %}
