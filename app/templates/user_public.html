{% extends "base.html" %}
{% block content %}

<style>
  .card-blur{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px);border-radius:14px;}
  .star{font-size:1.05rem;line-height:1;margin-inline:1px;}
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="mb-0">
    {{ user.first_name }} {{ user.last_name }}
    {% if user.is_verified %}
    <img src="/static/verified.png" alt="موثّق" class="verified-badge">
    {% endif %}
  </h3>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-light" href="/messages/start?user_id={{ user.id }}">أرسل رسالة</a>
  </div>
</div>

<!-- معلومات عامة -->
<div class="card card-blur mb-3">
  <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div class="text-muted small">
      البريد: {{ user.email }} &nbsp;•&nbsp; الهاتف: {{ user.phone }}
      &nbsp;•&nbsp; عضو منذ {{ user.created_at.strftime("%Y-%m-%d") if user.created_at else "" }}
    </div>
    <div>
      <span class="badge {% if user.status=='approved' %}bg-success{% elif user.status=='pending' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
        {{ user.status }}
      </span>
      <span class="badge {% if user.role=='admin' %}bg-info text-dark{% else %}bg-secondary{% endif %}">
        {{ user.role }}
      </span>
      {% if user.is_verified %}
        <span class="badge bg-primary">موثّق ✔</span>
      {% endif %}
    </div>
  </div>
</div>

<!-- تقييمات -->
<div class="row g-3 mb-3">
  <div class="col-12 col-lg-4">
    <div class="card card-blur h-100">
      <div class="card-body">
        <div class="text-muted small">متوسط التقييم</div>
        <div class="d-flex align-items-end gap-2">
          <div class="fs-3 fw-bold">{{ "%.1f"|format(avg_stars) }}</div>
          <div>
            {% for i in range(1,6) %}
              {% if i <= avg_stars|round(0, 'floor') %}
                <span class="star text-warning">★</span>
              {% else %}
                <span class="star text-secondary">☆</span>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <div class="text-muted small mt-1">إجمالي: {{ ratings_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-8">
    <div class="card card-blur h-100">
      <div class="card-body">
        <h6 class="mb-3">آخر المراجعات</h6>
        {% if reviews and reviews|length %}
          <div class="list-group">
            {% for r in reviews %}
              <div class="list-group-item bg-transparent text-white border-secondary">
                <div class="d-flex justify-content-between">
                  <strong>{{ r.rater_name }}</strong>
                  <small class="text-muted">{{ r.created_at.strftime("%Y-%m-%d") }}</small>
                </div>
                <div class="mb-1">
                  {% for i in range(1,6) %}
                    {% if i <= r.stars %}
                      <span class="star text-warning">★</span>
                    {% else %}
                      <span class="star text-secondary">☆</span>
                    {% endif %}
                  {% endfor %}
                </div>
                {% if r.comment %}
                  <div class="text-body">{{ r.comment }}</div>
                {% else %}
                  <div class="text-muted">لا توجد ملاحظة.</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">لا توجد تقييمات بعد.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- عناصر المستخدم -->
<div class="card card-blur">
  <div class="card-body">
    <h5 class="mb-3">عناصر {{ user.first_name }}</h5>
    {% if items and items|length %}
      <div class="row g-3">
        {% for it in items %}
          <div class="col-12 col-md-4">
            <div class="card h-100">
              {% if it.image_path %}
                <img src="/{{ it.image_path }}" class="card-img-top" style="height:160px;object-fit:cover">
              {% endif %}
              <div class="card-body">
                <h6 class="card-title">{{ it.title }}</h6>
                <div class="d-flex justify-content-between align-items-center">
                  <a href="/items/{{ it.id }}" class="btn btn-sm btn-primary">تفاصيل</a>
                  <span class="small text-muted">{{ it.category }}</span>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">لا توجد عناصر منشورة لهذا المستخدم.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
