{% extends "base.html" %}
{% block content %}

<style>
  .card-blur{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px);border-radius:14px;}
  .star{font-size:1.05rem;line-height:1;margin-inline:1px;}
  .badge-icon{height:24px;width:24px;margin-inline-start:6px;vertical-align:middle;display:inline-block;}
</style>

{% set _created = user.created_at if user and user.created_at else None %}
{% set _created_iso = _created.isoformat() if _created else "" %}
{% set _role = user.role if user else '' %}
{% set _verified = 1 if (user and user.is_verified) else 0 %}
{% set _five_star_count = 0 %}
{% set _returns_success_count = 0 %}
{% set _ratings_count = 0 %}
{% set _avg_stars = 0 %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="mb-0">
    {{ user.first_name }} {{ user.last_name }}
    {% if user.is_verified %}
      <img src="/static/verified.png" alt="موثّق" class="verified-badge">
    {% endif %}
    <span id="badges-public"
          data-role="{{ _role }}"
          data-created="{{ _created_iso }}"
          data-verified="{{ _verified }}"
          data-stars-all="{{ _ratings_count }}"
          data-avg="{{ _avg_stars }}"
          data-stars5="{{ _five_star_count }}"
          data-returns="{{ _returns_success_count }}">
    </span>
  </h3>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-light" href="/messages/start?user_id={{ user.id }}">أرسل رسالة</a>
  </div>
</div>

<!-- معلومات عامة (كودك كما هو) -->
<div class="card card-blur mb-3">
  <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div class="text-muted small">
      البريد: {{ user.email }} &nbsp;•&nbsp; الهاتف: {{ user.phone }}
      &nbsp;•&nbsp; عضو منذ {{ user.created_at.strftime("%Y-%m-%d") if user.created_at else "" }}
    </div>
    <div>
      <span class="badge {% if user.status=='approved' %}bg-success{% elif user.status=='pending' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
        {{ user.status }}
      </span>
      <span class="badge {% if user.role=='admin' %}bg-info text-dark{% else %}bg-secondary{% endif %}">
        {{ user.role }}
      </span>
      {% if user.is_verified %}
        <span class="badge bg-primary">موثّق ✔</span>
      {% endif %}
    </div>
  </div>
</div>

<!-- تقييمات وباقي كودك كما هو ... -->

<script>
(function(){
  function daysFrom(iso){ if(!iso) return 99999; const d=new Date(iso); if(isNaN(d)) return 99999; return Math.floor((Date.now()-d.getTime())/86400000); }
  function add(src,alt){ const i=document.createElement('img'); i.src=src; i.alt=alt; i.className='badge-icon'; return i; }
  function render(box){
    if(!box) return;
    const role=(box.dataset.role||'').toLowerCase();
    const days=daysFrom(box.dataset.created||'');
    const verified=Number(box.dataset.verified||0)===1;
    const fiveStar=Number(box.dataset.stars5||0);
    const returnsOk=Number(box.dataset.returns||0);

    if(role==='admin'){ box.appendChild(add('/static/img/adm.png','Admin')); }
    const allowYellow=(role!=='admin'), allowGreen=(role!=='admin'), allowViolet=(role!=='admin');

    if(allowYellow && days<60){ box.appendChild(add('/static/img/jaune.png','New')); }
    else if(allowGreen && days>=60 && days<365){ box.appendChild(add('/static/img/ProVert.png','Pro Green')); }
    else if(days>=365){ box.appendChild(add('/static/img/ProGold.png','Pro Gold')); }

    if(allowViolet && (verified || fiveStar>=20)){ box.appendChild(add('/static/img/violet.png','Trust')); }
    if(returnsOk>=10){ box.appendChild(add('/static/img/Vert.png','Safe Renter')); }
    if(fiveStar>=10){ box.appendChild(add('/static/img/orange.png','Top Rated')); }
  }
  render(document.getElementById('badges-public'));
})();
</script>

{% endblock %}
