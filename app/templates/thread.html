{% extends "base.html" %}
{% block content %}

<!-- شريط علوي: اسم الطرف الآخر + شارة التوثيق -->
<h4 class="mb-0">
  {{ other.first_name }} {{ other.last_name }}
  {% if other.is_verified %}
    <img src="/static/verified.png" class="verified-badge" alt="verified">
  {% endif %}
</h4>

<!-- إن كان الحساب غير موافَق عليه والطرف الآخر ليس أدمِن → أعلن وامنَع الإرسال -->
{% if session_user and session_user.status != 'approved' and other.role != 'admin' %}
  <div class="alert alert-warning mt-3">
    حسابك ما زال <strong>قيد المراجعة</strong>، لا يمكنك إرسال رسائل لغير الأدمِن.
    إذا أردت إكمال التفعيل أو لديك استفسار، تواصل مع
    <a href="/messages/support" class="alert-link">الدعم</a>.
  </div>
{% endif %}

<div class="card mb-3 mt-3">
  <div class="card-body" style="max-height: 55vh; overflow-y:auto;">
    {% for m in messages %}
      {% if m.sender_id == session_user.id %}
        <!-- رسائل المستخدم الحالي -->
        <div class="mb-3 text-end">
          <div class="msg-bubble msg-out">{{ m.body }}</div>
          <div class="small text-muted">{{ m.created_at }}</div>
        </div>
      {% else %}
        <!-- رسائل الطرف الآخر -->
        <div class="mb-3 text-start">
          <div class="msg-bubble msg-in">{{ m.body }}</div>
          <div class="small text-muted">{{ m.created_at }}</div>
        </div>
      {% endif %}
    {% else %}
      <p class="text-muted">ابدأ المحادثة الآن.</p>
    {% endfor %}
  </div>
</div>

<!-- نموذج الإرسال:
     مسموح إذا الحساب approved أو الطرف الآخر admin -->
{% if session_user and (session_user.status == 'approved' or other.role == 'admin') %}
<form method="post" class="mt-2">
  <div class="input-group">
    <input type="text" class="form-control" name="body" placeholder="اكتب رسالة..." required>
    <button class="btn btn-primary">إرسال</button>
  </div>
</form>
{% else %}
  <!-- زر بديل للدعم -->
  <a href="/messages/support" class="btn btn-outline-light">مراسلة الدعم</a>
{% endif %}

{% endblock %}
