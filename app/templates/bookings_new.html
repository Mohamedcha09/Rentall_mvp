{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Booking: {{ item.title }}</h3>

<div class="card">
  <div class="card-body">

    <!-- ✅ IMPORTANT -->
    <form method="post" action="/bookings" id="booking-form">
      <input type="hidden" name="item_id" value="{{ item.id }}">

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Start date</label>
          <input type="date" name="start_date" id="start_date" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">End date</label>
          <input type="date" name="end_date" id="end_date" class="form-control" required>
        </div>

        <div class="col-12">
          <label class="form-label">Note (optional)</label>
          <textarea name="note" class="form-control" rows="2"></textarea>
        </div>

        <div class="col-12">
          <div id="availability_hint" class="alert alert-warning" style="display:none;"></div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-success" id="submit_btn">
          Submit booking request
        </button>
        <a href="/items/{{ item.id }}" class="btn btn-outline-light">Back</a>
      </div>
    </form>

  </div>
</div>

<script>
(function(){

  const form    = document.getElementById('booking-form');
  const startEl = document.getElementById('start_date');
  const endEl   = document.getElementById('end_date');
  const hint    = document.getElementById('availability_hint');
  const btn     = document.getElementById('submit_btn');

  const today = new Date().toISOString().slice(0,10);
  startEl.min = today;
  endEl.min   = today;

  let blocked = [];

  fetch(`/api/items/{{ item.id }}/booked`, { credentials: 'include' })
    .then(r => r.ok ? r.json() : { blocked: [] })
    .then(j => blocked = j.blocked || [])
    .catch(() => blocked = []);

  function parse(d){
    return new Date(d + "T00:00:00");
  }

  function overlaps(a1, a2, b1, b2){
    return a1 <= b2 && a2 >= b1;
  }

  function checkDates(){
    hint.style.display = 'none';
    btn.disabled = false;

    if(!startEl.value || !endEl.value) return true;

    const s = parse(startEl.value);
    const e = parse(endEl.value);

    if(e < s){
      hint.textContent = "End date cannot be before start date.";
      hint.style.display = 'block';
      btn.disabled = true;
      return false;
    }

    for(const r of blocked){
      if(overlaps(s, e, parse(r.start), parse(r.end))){
        hint.textContent = "Selected dates overlap with another booking.";
        hint.style.display = 'block';
        btn.disabled = true;
        return false;
      }
    }

    return true;
  }

  startEl.addEventListener('change', checkDates);
  endEl.addEventListener('change', checkDates);

  /* ===========================
     GEOLOCATION LOGIC (FINAL)
     =========================== */
  form.addEventListener('submit', function(e){

    if(!checkDates()){
      e.preventDefault();
      return;
    }

    if(!navigator.geolocation){
      return;
    }

    e.preventDefault();
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(

      // ✅ AUTORISÉ
      function success(pos){
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        fetch(`/geo/set?lat=${lat}&lon=${lon}`, {
          method: "GET",
          credentials: "include"
        })
        .then(r => r.json())
        .then(() => {
          btn.disabled = false;
          form.submit();
        })
        .catch(() => {
          const next = encodeURIComponent(location.pathname + location.search);
          location.href = "/geo/pick?next=" + next;
        });
      },

      // ❌ REFUSÉ
      function error(){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = "/geo/pick?next=" + next;
      },

      {
        enableHighAccuracy: true,
        timeout: 8000,
        maximumAge: 0
      }
    );
  });

})();
</script>

{% endblock %}
