{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Booking: {{ item.title }}</h3>

<div class="card">
  <div class="card-body">
    <!-- ✅ IMPORTANT: action لازم تكون /bookings -->
    <form method="post" action="/bookings" id="booking-form">
      <input type="hidden" name="item_id" value="{{ item.id }}">

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Start date</label>
          <input type="date" name="start_date" id="start_date" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">End date</label>
          <input type="date" name="end_date" id="end_date" class="form-control" required>
        </div>
        <div class="col-12">
          <label class="form-label">Note (optional)</label>
          <textarea name="note" class="form-control" rows="2" placeholder="Additional details…"></textarea>
        </div>

        <!-- Instant conflict notice -->
        <div class="col-12">
          <div id="availability_hint" class="alert alert-warning" style="display:none;">
            The selected dates overlap with confirmed bookings. Please choose different dates.
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <!-- ✅ IMPORTANT: type="submit" -->
        <button type="submit" class="btn btn-success" id="submit_btn">Submit booking request</button>
        <a href="/items/{{ item.id }}" class="btn btn-outline-light">Back</a>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  const form    = document.getElementById('booking-form');
  const startEl = document.getElementById('start_date');
  const endEl   = document.getElementById('end_date');
  const hint    = document.getElementById('availability_hint');
  const btn     = document.getElementById('submit_btn');

  // Set minimum to today
  const today = new Date().toISOString().slice(0,10);
  startEl.min = today;
  endEl.min   = today;

  let blocked = []; // booked ranges {start,end}

  // Load booked ranges for this item
  fetch(`/api/items/{{ item.id }}/booked`, { credentials: 'include' })
    .then(r => r.ok ? r.json() : {blocked:[]})
    .then(json => { blocked = json.blocked || []; })
    .catch(() => { blocked = []; });

  function parse(d){
    try { return new Date(d + "T00:00:00"); } catch(e){ return null; }
  }

  function overlaps(aStart, aEnd, bStart, bEnd){
    return aStart <= bEnd && aEnd >= bStart;
  }

  function check(){
    hint.style.display = 'none';
    btn.disabled = false;

    const s = startEl.value;
    const e = endEl.value;
    if(!s || !e) return true;

    const sd = parse(s);
    const ed = parse(e);
    if(ed < sd){
      hint.style.display = 'block';
      hint.textContent = 'End date cannot be before start date.';
      btn.disabled = true;
      return false;
    }

    // Conflict with booked ranges
    for(const r of blocked){
      const rs = parse(r.start);
      const re = parse(r.end);
      if(overlaps(sd, ed, rs, re)){
        hint.style.display = 'block';
        hint.textContent = 'The selected dates overlap with confirmed bookings. Please choose different dates.';
        btn.disabled = true;
        return false;
      }
    }

    hint.style.display = 'none';
    btn.disabled = false;
    return true;
  }

  startEl.addEventListener('change', check);
  endEl.addEventListener('change', check);

  // ✅ GEOLOGATION BEFORE SUBMIT (هذا هو اللي يطلع Popup Allow/Refuse)
  form.addEventListener('submit', function(e){
    // إذا التواريخ غلط أو overlap → ما نكمل
    if(!check()){
      e.preventDefault();
      return;
    }

    // لو ما عنده geolocation أصلاً → نكمل عادي
    if(!navigator.geolocation){
      return;
    }

    // نوقف الإرسال مؤقتًا حتى يطلع popup
    e.preventDefault();
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(
      function success(pos){
        // ✅ المستخدم ضغط Autoriser
        // ما نقدر نطلع country/region من lat/lon بدون reverse geocode
        // فهنا نكمل الحجز مباشرة
        btn.disabled = false;
        form.submit();
      },
      function error(){
        // ✅ المستخدم ضغط Refuser (أو فشل)
        // نوديه لصفحة اختيار البلد يدويًا ثم يرجع لنفس الصفحة
        const next = encodeURIComponent(window.location.pathname + window.location.search);
        window.location.href = "/geo/pick?next=" + next;
      },
      {
        enableHighAccuracy: true,
        timeout: 8000,
        maximumAge: 0
      }
    );
  });

})();
</script>

{% endblock %}
