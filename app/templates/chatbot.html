<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sevor Chatbot</title>

<style>
body[data-path="/chatbot"] header,
body[data-path="/chatbot"] .mobile-tabbar {display:none!important}

.sv-chatbot-page{
  max-width:720px;margin:0 auto;padding:18px;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif
}

#sv-chat-window{
  display:flex;flex-direction:column;gap:14px;
  max-height:65vh;overflow-y:auto;margin-top:14px
}

.sv-msg{max-width:80%;padding:14px 18px;border-radius:18px;font-size:15px}
.sv-msg-user{align-self:flex-end;background:#111827;color:#fff}
.sv-msg-bot{align-self:flex-start;background:#fff;border:1px solid #e5e7eb}

#sv-chat-input{display:none;margin-top:16px}
#sv-send-btn{width:100%;padding:12px;border-radius:12px;background:#6b46c1;color:#fff;border:none}

#sv-ticket-closed-banner{
  display:none;background:#fee2e2;border:1px solid #fca5a5;
  padding:12px;border-radius:10px;color:#991b1b;font-weight:600
}
</style>
</head>

<body data-path="/chatbot">

<div class="sv-chatbot-page">

<div id="sv-ticket-closed-banner"></div>
<div id="sv-chat-window"></div>

<div id="sv-chat-input">
  <form id="sv-send-form">
    <input id="sv-message-input" placeholder="Write your messageâ€¦" style="width:100%;padding:12px;border-radius:12px;border:1px solid #ddd">
    <button id="sv-send-btn">Send</button>
  </form>
</div>

</div>

<script>
// =====================================================
// RESET ALWAYS (IMPORTANT)
// =====================================================
localStorage.removeItem("chatbot_active_ticket");

// =====================================================
// STATE
// =====================================================
let ACTIVE_TICKET_ID=null;
let LAST_MESSAGE_ID=0;
let CHAT_POLL=null;

// =====================================================
// UI
// =====================================================
function addUserMessage(t){
  const c=document.getElementById("sv-chat-window");
  const d=document.createElement("div");
  d.className="sv-msg sv-msg-user";
  d.textContent=t;
  c.appendChild(d);
  c.scrollTop=c.scrollHeight;
}
function addBotMessage(h){
  const c=document.getElementById("sv-chat-window");
  const d=document.createElement("div");
  d.className="sv-msg sv-msg-bot";
  d.innerHTML=h;
  c.appendChild(d);
  c.scrollTop=c.scrollHeight;
}

// =====================================================
// INIT FAQ
// =====================================================
document.addEventListener("DOMContentLoaded",async()=>{
  addBotMessage("ðŸ‘‹ Hello! Iâ€™m the Sevor assistant.<br>Select a category to get started.");
});

// =====================================================
// CREATE TICKET (AFTER NO)
// =====================================================
async function createTicket(){
  const r=await fetch("/chatbot/support",{method:"POST"});
  const d=await r.json();
  if(!d.ok)return;

  ACTIVE_TICKET_ID=d.ticket_id;
  addBotMessage("ðŸŸ£ A support agent will assist you shortlyâ€¦");
  startPolling();
}

// =====================================================
// POLLING (ONLY AGENT MESSAGES)
// =====================================================
async function pollMessages(){
  const r=await fetch(`/api/chatbot/messages/${ACTIVE_TICKET_ID}`);
  const d=await r.json();

  if(d.ticket_status==="closed"){
    document.getElementById("sv-ticket-closed-banner").style.display="block";
    document.getElementById("sv-chat-input").style.display="none";
    clearInterval(CHAT_POLL);
    return;
  }

  (d.messages||[]).forEach(m=>{
    if(m.id<=LAST_MESSAGE_ID)return;
    LAST_MESSAGE_ID=m.id;

    if(m.sender_role==="agent"||m.sender_role==="support"){
      document.getElementById("sv-chat-input").style.display="block";
      addBotMessage(m.body);
    }
  });
}

function startPolling(){
  CHAT_POLL=setInterval(pollMessages,1500);
}

// =====================================================
// SEND MESSAGE
// =====================================================
document.getElementById("sv-send-form").addEventListener("submit",async e=>{
  e.preventDefault();
  if(!ACTIVE_TICKET_ID)return;

  const i=document.getElementById("sv-message-input");
  const t=i.value.trim();
  if(!t)return;

  addUserMessage(t);
  i.value="";

  const fd=new FormData();
  fd.append("body",t);
  await fetch(`/api/chatbot/messages/${ACTIVE_TICKET_ID}`,{method:"POST",body:fd});
});
</script>

</body>
</html>
