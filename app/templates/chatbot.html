<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sevor Chatbot</title>

  <style>
    /* ----------------------------------------------------
       FORCE HIDE ALL TOP + BOTTOM NAV ONLY IN /chatbot
    ---------------------------------------------------- */
    body[data-path="/chatbot"] header.topbar,
    body[data-path="/chatbot"] .m-top-tabs,
    body[data-path="/chatbot"] .searchbar,
    body[data-path="/chatbot"] .stripe-callout,
    body[data-path="/chatbot"] .mobile-tabbar,
    body[data-path="/chatbot"] #fabAdd {
      display: none !important;
    }

    body[data-path="/chatbot"] .page {
      padding-top: 0 !important;
      padding-bottom: 0 !important;
    }

    /* ==========================================================================
      SEVOR CHATBOT â€” AIRBNB EXACT STYLE
      ========================================================================== */

    .sv-chatbot-page {
      max-width: 720px;
      margin: 0 auto;
      padding: 0 18px 40px;
      background: #ffffff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* Header */
    .sv-header {
      padding-top: 28px;
      padding-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .sv-back {
      font-size: 26px;
      text-decoration: none;
      color: #111;
    }

    .sv-header-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }

    .sv-header-logo-wrap {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      overflow: hidden;
      margin-bottom: 4px;
      background: #111;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .sv-header-logo-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .sv-title {
      font-size: 17px;
      font-weight: 600;
      color: #111;
    }

    .sv-header-right {
      width: 30px;
      height: 20px;
    }

    /* Agent banner */
    #sv-live-agent-banner {
      display: none;
      background: #f3f4f6;
      padding: 10px 14px;
      border-radius: 10px;
      margin-top: 12px;
      font-size: 15px;
      font-weight: 600;
    }

    /* Closed ticket banner */
    #sv-ticket-closed-banner {
      display: none;
      background: #fee2e2;
      border: 1px solid #fca5a5;
      padding: 12px 14px;
      border-radius: 10px;
      margin-top: 12px;
      font-size: 15px;
      color: #991b1b;
      font-weight: 600;
    }

    /* Chat window */
    #sv-chat-window {
      margin-top: 18px;
      padding: 20px 14px;
      border-radius: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      max-height: 68vh;
      overflow-y: auto;
    }

    #sv-chat-window::-webkit-scrollbar {
      width: 6px;
    }
    #sv-chat-window::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 50px;
    }

    /* Messages */
    .sv-msg {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.55;
      word-wrap: break-word;
    }

    .sv-msg-bot {
      align-self: flex-start;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #111;
      border-bottom-left-radius: 6px;
    }

    .sv-msg-user {
      align-self: flex-end;
      background: #111827;
      color: #fff;
      border-bottom-right-radius: 6px;
    }

    /* Suggestions */
    .sv-suggestions-wrap {
      margin-top: 30px;
    }

    .sv-suggestions-title {
      font-size: 17px;
      font-weight: 600;
      color: #111;
      margin-bottom: 12px;
    }

    .sv-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .sv-question-chip {
      padding: 10px 16px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #e5e7eb;
      font-size: 15px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .sv-question-chip:hover {
      background: #f3f4f6;
    }

    /* Options chips */
    .sv-options-wrapper {
      margin-top: 10px;
    }

    .sv-options-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .sv-option-chip {
      padding: 8px 14px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      margin: 6px 6px 0 0;
      transition: 0.15s ease;
      font-size: 14px;
    }

    .sv-option-chip:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    /* Feedback buttons */
    .sv-feedback-buttons {
      display: flex;
      gap: 12px;
      margin-top: 10px;
    }

    .sv-feedback-buttons button {
      padding: 8px 16px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #d1d5db;
      cursor: pointer;
      transition: 0.15s;
      font-size: 14px;
    }

    .sv-feedback-buttons button:hover {
      background: #f3f4f6;
    }

    /* Input box */
    #sv-chat-input {
      display: none;
      margin-top: 18px;
    }

    #sv-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #sv-message-input:disabled {
      background: #f3f4f6;
      cursor: not-allowed;
    }

    @media (max-width: 640px) {
      #sv-chat-window {
        max-height: 70vh;
      }
    }

/* ================================
   FIXED INPUT BAR (BOTTOM)
================================ */

/* ================================
   STABLE INPUT BAR â€” iOS SAFE
================================ */

.sv-input-fixed {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 720px;
  background: #ffffff;
  border-top: 1px solid #e5e7eb;
  padding: 10px 12px env(safe-area-inset-bottom);
  z-index: 999;
}


/* Ù„Ø§ ØªØºÙŠÙŠØ± Ø£Ø­Ø¬Ø§Ù… */
.sv-input-fixed * {
  box-sizing: border-box;
}

#sv-message-input {
  height: 44px;
  line-height: 44px;
}

#sv-send-btn {
  height: 44px;
  white-space: nowrap;
  flex-shrink: 0;
}

/* form layout */
.sv-input-fixed form {
  display: flex;
  gap: 10px;
}

/* input */
#sv-message-input {
  flex: 1;
  padding: 12px 14px;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  font-size: 15px;
}

/* send button */
#sv-send-btn {
  padding: 12px 18px;
  border-radius: 999px;
  background: #6b46c1;
  color: #fff;
  border: none;
  font-size: 15px;
  font-weight: 600;
}

/* give space so messages don't hide behind input */
#sv-chat-window {
  padding-bottom: 120px;
}

input,
button {
  font-size: 16px !important;
}
#sv-chat-window {
  overflow-y: auto;
  padding-bottom: 140px;
}

/* ===== iOS APP ONLY â€” TOP SAFE WHITE BAR (CHATBOT) ===== */
@supports (-webkit-touch-callout: none) {
  @media (max-width: 768px) {

    /* Ø´Ø±ÙŠØ· Ø£Ø¨ÙŠØ¶ Ø«Ø§Ø¨Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */
    body[data-path="/chatbot"]::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: env(safe-area-inset-top);
      background: #ffffff;
      z-index: 3000; /* Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù€ chat */
      pointer-events: none;
    }

    /* Ø¯ÙØ¹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø§Øª Ù„Ù„Ø£Ø³ÙÙ„ */
    body[data-path="/chatbot"] {
      padding-top: env(safe-area-inset-top);
    }

  }
}
 
  </style>
</head>

<body data-path="/chatbot">

  <div class="sv-chatbot-page">

    <!-- HEADER -->
    <div class="sv-header">
      <a href="/messages" class="sv-back">â†</a>

      <div class="sv-header-center">
        <div class="sv-header-logo-wrap">
          <img src="/static/sevor-logo.png" alt="Sevor">
        </div>
        <div class="sv-title">Soutien Sevor</div>
      </div>

      <div class="sv-header-right"></div>
    </div>

    <!-- CLOSED TICKET BANNER -->
    <div id="sv-ticket-closed-banner"></div>

    <!-- Agent joined banner -->
    <div id="sv-live-agent-banner"></div>

    <!-- CHAT WINDOW -->
    <div id="sv-chat-window"></div>

    <!-- SUGGESTED QUESTIONS -->
    <div class="sv-suggestions-wrap" id="sv-suggestions-section">
      <div class="sv-suggestions-title">Questions frÃ©quentes</div>
      <div id="sv-suggestions" class="sv-suggestions"></div>
    </div>

    <!-- INPUT BOX -->
    <div id="sv-chat-input" data-chat-input>
  <div class="sv-input-fixed">
    <form id="sv-send-form">
      <input
        id="sv-message-input"
        type="text"
        placeholder="Write your message to support..."
      />
      <button id="sv-send-btn" type="submit">Send</button>
    </form>
  </div>
</div>


  </div>

  <script>
    window.ACTIVE_TICKET_FROM_SERVER = null;

    // =====================================================
    // LOAD TREE.JSON (FAQ SYSTEM)
    // =====================================================
    async function loadTree() {
      const res = await fetch("/chatbot/tree");
      return await res.json();
    }

    // =====================================================
    // UI HELPERS
    // =====================================================
    function addBotMessage(html) {
      const chat = document.getElementById("sv-chat-window");
      if (!chat) return;
      const box = document.createElement("div");
      box.className = "sv-msg sv-msg-bot";
      box.innerHTML = html;
      chat.appendChild(box);
      chat.scrollTop = chat.scrollHeight;
    }

function addUserMessage(text) {
  const clean = text.trim();
  USER_TEXT_CACHE.add(clean); // â¬…ï¸ Ø§Ø­ÙØ¸ Ø§Ù„Ù†Øµ

  const chat = document.getElementById("sv-chat-window");
  if (!chat) return;

  const box = document.createElement("div");
  box.className = "sv-msg sv-msg-user";
  box.textContent = clean;
  chat.appendChild(box);
  chat.scrollTop = chat.scrollHeight;
}


    function clearSuggestions() {
      const s = document.getElementById("sv-suggestions");
      if (s) s.innerHTML = "";
    }

    // =====================================================
    // GLOBAL DATA
    // =====================================================
    let SECTIONS = [];
    let CURRENT_SECTION = null;
    let LAST_QUESTION = null;
    let LAST_ANSWER = null;

    let ACTIVE_TICKET_ID = null;
    let AGENT_WATCH_INTERVAL = null;
    let CHAT_POLL_INTERVAL = null;
    let LAST_MESSAGE_ID = 0;
    let AGENT_JOINED_ONCE = false;
    let IS_TICKET_CLOSED = false;
    let MODE = "FAQ"; // FAQ | WAITING | LIVE | CLOSED
    let LAST_SENT_TEXT = null;
    let LAST_SENT_AT = 0;
    let RENDERED_MESSAGE_IDS = new Set();
    const USER_TEXT_CACHE = new Set();


function setMode(m) {
  if (IS_TICKET_CLOSED) return; // ğŸ”’ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø­Ø§Ø³Ù…
  MODE = m;

  const faqSection = document.getElementById("sv-suggestions-section");
  const chatInput  = document.getElementById("sv-chat-input");

  if (m === "FAQ") {
    if (faqSection) faqSection.style.display = "block";
    if (chatInput)  chatInput.style.display = "none";
  }

  if (m === "WAITING") {
    if (faqSection) faqSection.style.display = "none";
    if (chatInput)  chatInput.style.display = "none";
  }

  if (m === "LIVE") {
    if (faqSection) faqSection.style.display = "none";
    if (chatInput)  chatInput.style.display = "block";
  }

  if (m === "CLOSED") {
    if (faqSection) faqSection.style.display = "none";
    if (chatInput)  chatInput.style.display = "none";
  }
}


    // =====================================================
    // LOCK CHAT UI WHEN TICKET CLOSED
    // =====================================================
function lockChatUI(closeText) {
  if (IS_TICKET_CLOSED) return;

  IS_TICKET_CLOSED = true;
  MODE = "CLOSED";

  // ğŸŸ¥ Ø§Ø­Ø°Ù input Ù…Ù† DOM Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ (Ø­Ù„ iOS)
  const inputWrapper = document.querySelector("[data-chat-input]");
  if (inputWrapper) {
    inputWrapper.remove();
  }

  // ğŸ”´ Banner Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
  const closedBanner = document.getElementById("sv-ticket-closed-banner");
  if (closedBanner) {
    closedBanner.style.display = "block";
    closedBanner.textContent =
      closeText || "This ticket has been closed.";
  }

  // ğŸ›‘ Ø£ÙˆÙ‚Ù ÙƒÙ„ Ø´ÙŠØ¡
  stopFastPolling();
  if (AGENT_WATCH_INTERVAL) clearInterval(AGENT_WATCH_INTERVAL);
  if (CHAT_POLL_INTERVAL) clearInterval(CHAT_POLL_INTERVAL);

  localStorage.removeItem("chatbot_active_ticket");
}



document.addEventListener("DOMContentLoaded", async () => {
  document.body.classList.remove("ticket-closed");
  // âœ… Ø¥Ø°Ø§ Ø¬Ø§ÙŠ Ù…Ù† /messages Ù†Ø¨Ø¯Ø£ FAQ Ø¬Ø¯ÙŠØ¯ Ø¯Ø§Ø¦Ù…Ù‹Ø§
  if ((document.referrer || "").includes("/messages")) {
    localStorage.removeItem("chatbot_active_ticket");
  }

  const savedTicket = localStorage.getItem("chatbot_active_ticket");

  // Reset visuals always
  const chatWindow = document.getElementById("sv-chat-window");
  if (chatWindow) chatWindow.innerHTML = "";

  const liveBanner = document.getElementById("sv-live-agent-banner");
  if (liveBanner) liveBanner.style.display = "none";

  const closedBanner = document.getElementById("sv-ticket-closed-banner");
  if (closedBanner) closedBanner.style.display = "none";

  IS_TICKET_CLOSED = false;
  LAST_MESSAGE_ID = 0;

  if (!savedTicket) {
    // âœ… FAQ MODE
    ACTIVE_TICKET_ID = null;
    setMode("FAQ");

    const data = await loadTree();
    SECTIONS = data.sections || [];

    addBotMessage("ğŸ‘‹ Hello! Iâ€™m the Sevor assistant.<br>Select a category to get started.");
    showSections();
  } else {
    // âœ… Ø¹Ù†Ø¯Ùƒ Ticket Ù…Ø­ÙÙˆØ¸ (Ù…Ø«Ù„Ø§Ù‹ Reload Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ØªØ°ÙƒØ±Ø©)
    ACTIVE_TICKET_ID = parseInt(savedTicket);
    setMode("WAITING");

    // 1) ØªØ£ÙƒØ¯ Ø¥Ø°Ø§ ticket Ù…ØºÙ„Ù‚
    await checkClosedOnLoad(ACTIVE_TICKET_ID);
    if (IS_TICKET_CLOSED) return;

    // 2) Ø´ØºÙ„ watcher (Ù‡Ùˆ Ø§Ù„Ø°ÙŠ Ø³ÙŠÙ‚Ø±Ø± LIVE ÙˆÙŠÙØªØ­ polling)
    startAgentWatcher(ACTIVE_TICKET_ID);

    // 3) Ù†ÙÙ‘Ø° check Ù…Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± 2 Ø«ÙˆØ§Ù†ÙŠ)
    await checkAgentStatus(ACTIVE_TICKET_ID);
  }

  // âœ… Bind SEND form submit
  const form = document.getElementById("sv-send-form");
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Ù„Ø§ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Agent Ù…ÙˆØ¬ÙˆØ¯ + Ø§Ù„ØªØ°ÙƒØ±Ø© Ù„ÙŠØ³Øª Ù…ØºÙ„Ù‚Ø©
      if (!ACTIVE_TICKET_ID || IS_TICKET_CLOSED || MODE !== "LIVE") return;

      const input = document.getElementById("sv-message-input");
      const text = (input?.value || "").trim();
      if (!text) return;

      // ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ù‹Ø§ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
      addUserMessage(text);
      input.value = "";

      // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
      await sendUserMessageToServer(text);
    });
  }
});



    // =====================================================
    // FEEDBACK BUTTONS
    // =====================================================
    function showFeedbackButtons() {
      if (IS_TICKET_CLOSED) return;

      const chat = document.getElementById("sv-chat-window");
      if (!chat) return;

      const wrapper = document.createElement("div");
      wrapper.className = "sv-msg sv-msg-bot";

      wrapper.innerHTML = `
        <div class="sv-feedback-title">âœ”ï¸ Did this answer your question?</div>
        <div class="sv-feedback-buttons">
          <button type="button" class="sv-yes-btn">Yes</button>
          <button type="button" class="sv-no-btn">No</button>
        </div>
      `;

      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;

      wrapper.querySelector(".sv-yes-btn").onclick = handleYes;
      wrapper.querySelector(".sv-no-btn").onclick = handleNo;
    }

    function handleYes() {
      if (IS_TICKET_CLOSED) return;

      addBotMessage("Great! ğŸ˜Š<br>Would you like to ask another question?");

      const chat = document.getElementById("sv-chat-window");
      if (!chat) return;

      const btn = document.createElement("button");
      btn.className = "sv-option-chip";
      btn.type = "button";
      btn.textContent = "Back to Categories";

      btn.onclick = () => showSections();

      const box = document.createElement("div");
      box.className = "sv-msg sv-msg-bot";
      box.appendChild(btn);
      chat.appendChild(box);
      chat.scrollTop = chat.scrollHeight;
    }

    // =============================================================
    // USER CLICKED NO â†’ CREATE SUPPORT TICKET
    // =============================================================

async function handleNo() {
  if (IS_TICKET_CLOSED) return;

  addBotMessage("One momentâ€¦ contacting support ğŸ•“");
  setMode("WAITING");

  const formData = new FormData();
  formData.append("question", LAST_QUESTION || "(unknown)");
  formData.append("answer", LAST_ANSWER || "(unknown)");

  const res = await fetch("/chatbot/support", { method: "POST", body: formData });

  let data;
  try {
    data = await res.json();
  } catch (e) {
    addBotMessage("âš ï¸ Error contacting support.");
    setMode("FAQ");
    return;
  }

  if (!data.ok) {
    addBotMessage("âš ï¸ Failed to create support ticket.");
    setMode("FAQ");
    return;
  }

  ACTIVE_TICKET_ID = data.ticket_id;
  LAST_MESSAGE_ID = 0;
  IS_TICKET_CLOSED = false;

  localStorage.setItem("chatbot_active_ticket", ACTIVE_TICKET_ID);

  addBotMessage("A support agent will assist you shortly ğŸŸ£");

  // âœ… Ù„Ø§ polling Ø§Ù„Ø¢Ù† â€” ÙÙ‚Ø· Ù†Ø±Ø§Ù‚Ø¨ Ø¯Ø®ÙˆÙ„ agent
  startAgentWatcher(ACTIVE_TICKET_ID);

  // âœ… Ù†ÙÙ‘Ø° check Ù…Ø¨Ø§Ø´Ø±Ø©
  await checkAgentStatus(ACTIVE_TICKET_ID);
}

    // =============================================================
    // CHECK AGENT STATUS
    // =============================================================
async function checkAgentStatus(ticketId) {
  if (IS_TICKET_CLOSED) return;
  if (AGENT_JOINED_ONCE) return; // âœ… Ù…Ù‡Ù…

  try {
    const res = await fetch(`/api/chatbot/agent_status/${ticketId}`);
    const data = await res.json();

    if (data.assigned && data.agent_name) {
      AGENT_JOINED_ONCE = true; // âœ… Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§

      // stop watcher
      if (AGENT_WATCH_INTERVAL) clearInterval(AGENT_WATCH_INTERVAL);
      AGENT_WATCH_INTERVAL = null;

      // LIVE MODE
      setMode("LIVE");

      const banner = document.getElementById("sv-live-agent-banner");
      if (banner) {
        banner.style.display = "block";
        banner.innerHTML = `
          You are now chatting with one of our agents:
          <span style="color:#6b46c1; font-weight:700;">${data.agent_name}</span>
        `;
      }

      // start polling only once
      startChatPolling(ticketId);
    }
  } catch (err) {
    console.log("poll error:", err);
  }
}


function startAgentWatcher(ticketId) {
  if (!ticketId || IS_TICKET_CLOSED) return;
  if (AGENT_WATCH_INTERVAL) clearInterval(AGENT_WATCH_INTERVAL);

  // Ù†Ø­Ù† ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± agent
  if (MODE !== "LIVE") setMode("WAITING");

  AGENT_WATCH_INTERVAL = setInterval(() => checkAgentStatus(ticketId), 2000);
}


    // =============================================================
    // POLL REAL MESSAGES (WITH INSTANT CLOSE)
    // =============================================================
async function pollMessages(ticketId) {
  if (IS_TICKET_CLOSED) return;
  if (!ticketId || IS_TICKET_CLOSED) return;

  try {
    const res = await fetch(`/api/chatbot/messages/${ticketId}`);
    const data = await res.json();

  if (data.ticket_status === "closed") {
  lockChatUI(
    data.closed_by
      ? `This ticket has been closed by ${data.closed_by}.`
      : "This ticket has been closed."
  );

  // â›” Ø£ÙˆÙ‚Ù polling ÙÙˆØ±Ù‹Ø§
  stopFastPolling();
  if (AGENT_WATCH_INTERVAL) clearInterval(AGENT_WATCH_INTERVAL);
  if (CHAT_POLL_INTERVAL) clearInterval(CHAT_POLL_INTERVAL);

  return;
}


    (data.messages || []).forEach((msg) => {

      // âœ… Ø£Ù‡Ù… Ø³Ø·Ø± â€” ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§
      if (RENDERED_MESSAGE_IDS.has(msg.id)) return;

      const body = (msg.body || "").trim();
      if (!body) {
        RENDERED_MESSAGE_IDS.add(msg.id);
        return;
      }

      // âŒ Ù…Ù†Ø¹ echo Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (USER_TEXT_CACHE.has(body)) {
        RENDERED_MESSAGE_IDS.add(msg.id);
        return;
      }

      // âŒ Ù„Ø§ ØªØ±Ø³Ù… Ø±Ø³Ø§Ø¦Ù„ user Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      if (msg.sender_role === "user") {
        RENDERED_MESSAGE_IDS.add(msg.id);
        return;
      }

      // âœ… ÙÙ‚Ø· Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³ÙŠØ¨ÙˆØ±
      if (
  msg.sender_role === "agent" ||
  msg.sender_role === "support" ||
  msg.sender_role === "system"
) {
        addBotMessage(body);
        RENDERED_MESSAGE_IDS.add(msg.id);
      }
    });

  } catch (e) {
    console.log("chat poll error:", e);
  }
}



function startChatPolling(ticketId) {
  if (!ticketId || IS_TICKET_CLOSED) return;

  // âœ… Ù„Ø§ polling Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ù†Ø­Ù† ÙÙŠ LIVE
  if (MODE !== "LIVE") return;

  // Ø£ÙˆÙ‚Ù Ø£ÙŠ setInterval Ù‚Ø¯ÙŠÙ…
  if (CHAT_POLL_INTERVAL) {
    clearInterval(CHAT_POLL_INTERVAL);
    CHAT_POLL_INTERVAL = null;
  }

  // âœ… Ø´ØºÙ„ Ø§Ù„Ù€ fast polling
  startFastPolling(ticketId);
}

    // =============================================================
    // SEND MESSAGE
    // =============================================================
async function sendUserMessageToServer(text) {
  if (!ACTIVE_TICKET_ID || IS_TICKET_CLOSED) return;

  const formData = new FormData();
  formData.append("body", text);

  const res = await fetch(`/api/chatbot/messages/${ACTIVE_TICKET_ID}`, {
    method: "POST",
    body: formData,
  });

  // â¬…ï¸ Ù„Ø§ Ù†Ø±Ø³Ù… Ø£ÙŠ Ø´ÙŠØ¡ Ù‡Ù†Ø§
}



    // =============================================================
    // SHOW MAIN SECTIONS
    // =============================================================
    function showSections() {
      if (IS_TICKET_CLOSED) return;

      clearSuggestions();
      const suggestions = document.getElementById("sv-suggestions");
      if (!suggestions) return;
      suggestions.innerHTML = "";

      SECTIONS.forEach((sec) => {
        const btn = document.createElement("button");
        btn.className = "sv-question-chip";
        btn.type = "button";
        btn.textContent = sec.section_title;

        btn.onclick = () => {
          CURRENT_SECTION = sec;
          showQuestionsInSection(sec);
          addUserMessage(sec.section_title);
        };

        suggestions.appendChild(btn);
      });
    }

    // =============================================================
    // SHOW QUESTIONS IN A SECTION
    // =============================================================
    function showQuestionsInSection(section) {
      if (IS_TICKET_CLOSED) return;

      clearSuggestions();
      const suggestions = document.getElementById("sv-suggestions");
      if (!suggestions) return;
      suggestions.innerHTML = "";

      let faqs = section.faqs;

      if (!Array.isArray(faqs)) {
        Object.entries(faqs).forEach(([qText, obj]) => {
          const btn = document.createElement("button");
          btn.className = "sv-question-chip";
          btn.type = "button";
          btn.textContent = qText;

          btn.onclick = () =>
            handleQuestionClick({
              label: qText,
              answer: obj.answer,
              options: obj.options || null,
            });

          suggestions.appendChild(btn);
        });
      } else {
        faqs.forEach((item) => {
          const btn = document.createElement("button");
          btn.className = "sv-question-chip";
          btn.type = "button";
          btn.textContent = item.question;

          btn.onclick = () =>
            handleQuestionClick({
              label: item.question,
              answer: item.answer,
              options: null,
            });

          suggestions.appendChild(btn);
        });
      }
    }

    // =============================================================
    // QUESTION CLICK HANDLER
    // =============================================================
    function handleQuestionClick(q) {
      if (IS_TICKET_CLOSED) return;

      addUserMessage(q.label);
      LAST_QUESTION = q.label;

      clearSuggestions();

      if (q.answer) {
        addBotMessage(q.answer);
        LAST_ANSWER = q.answer;
        showFeedbackButtons();
      }

      if (q.options) {
        const chat = document.getElementById("sv-chat-window");
        if (!chat) return;

        const box = document.createElement("div");
        box.className = "sv-msg sv-msg-bot";

        const wrapper = document.createElement("div");
        wrapper.className = "sv-options-wrapper";

        const title = document.createElement("div");
        title.className = "sv-options-title";
        title.textContent = "Choose a case:";
        wrapper.appendChild(title);

        Object.entries(q.options).forEach(([label, data]) => {
          const btn = document.createElement("button");
          btn.className = "sv-option-chip";
          btn.type = "button";
          btn.textContent = label;

          btn.onclick = () => {
            addUserMessage(label);
            addBotMessage(data.answer || "â€¦");
            LAST_ANSWER = data.answer || "â€¦";
            showFeedbackButtons();
          };

          wrapper.appendChild(btn);
        });

        box.appendChild(wrapper);
        chat.appendChild(box);
        chat.scrollTop = chat.scrollHeight;
      }
    }

    // =====================================================
    // CHECK CLOSED STATUS ON LOAD (IMPORTANT)
    // =====================================================
    async function checkClosedOnLoad(ticketId) {
      try {
        const res = await fetch(`/api/chatbot/messages/${ticketId}`);
        const data = await res.json();

        if (data.ticket_status === "closed") {
          lockChatUI(
            data.closed_by
              ? `This ticket has been closed by ${data.closed_by}.`
              : "This ticket has been closed."
          );
        }
      } catch (e) {
        console.log("initial close check error", e);
      }
    }


    // =============================================================
// FAST RECURSIVE POLLING (SUPER FAST)
// =============================================================
let FAST_POLL_STOP = false;

async function startFastPolling(ticketId) {
    if (!ticketId || IS_TICKET_CLOSED || MODE !== "LIVE") return;

  FAST_POLL_STOP = false;

  const loop = async () => {
    if (FAST_POLL_STOP || IS_TICKET_CLOSED) return;

    await pollMessages(ticketId);

    setTimeout(loop, 150);
  };

  loop();
}


function stopFastPolling() {
  FAST_POLL_STOP = true;
}




  </script>
</body>
</html>
