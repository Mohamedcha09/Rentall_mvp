{% extends "base.html" %}
{% block content %}
<div class="container py-3">

  <h4 class="mb-3">Message Center (CS Inbox)</h4>

  <div class="row g-3">
    <!-- Section 1: New -->
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header fw-bold">New</div>
        <div class="list-group list-group-flush">
          {% if data.new %}
            {% for t in data.new %}
              <div class="list-group-item d-flex justify-content-between align-items-start">
                <div class="me-2">
                  <div class="fw-semibold">#{{ t.id }} — {{ t.subject or 'No Title' }}</div>
                  <div class="small text-muted">
                    Opened: {{ (t.created_at|string)[:16] }}
                    {% if t.last_msg_at %} · Last Activity: {{ (t.last_msg_at|string)[:16] }}{% endif %}
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <!-- Open = Assign + Open Ticket Page -->
                  <button class="btn btn-sm btn-primary" onclick="assignSelfAndOpen({{ t.id }})">Open</button>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="list-group-item text-muted">No new tickets.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Section 2: In Review -->
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header fw-bold">In Review</div>
        <div class="list-group list-group-flush">
          {% if data.in_review %}
            {% for t in data.in_review %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <div class="me-2">
                    <div class="fw-semibold">#{{ t.id }} — {{ t.subject or 'No Title' }}</div>
                    <div class="small text-muted">
                      {% if t.assigned_to_id %}Assigned To: {{ t.assigned_to_id }} · {% endif %}
                      Last Activity: {{ (t.last_msg_at or t.updated_at or t.created_at)|string }}
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <!-- Open goes directly to the ticket page -->
                    <a class="btn btn-sm btn-primary" href="/cs/ticket/{{ t.id }}">Open</a>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="list-group-item text-muted">No tickets under review.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Section 3: Resolved -->
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Resolved</div>
        <div class="list-group list-group-flush">
          {% if data.resolved %}
            {% for t in data.resolved %}
              <div class="list-group-item d-flex justify-content-between align-items-start">
                <div class="me-2">
                  <div class="fw-semibold">#{{ t.id }} — {{ t.subject or 'No Title' }}</div>
                  <div class="small text-muted">
                    Closed: {{ (t.resolved_at or t.updated_at or t.last_msg_at or t.created_at)|string }}
                  </div>
                </div>
                <!-- View Only -->
                <a class="btn btn-sm btn-outline-secondary" href="/cs/ticket/{{ t.id }}">View</a>
              </div>
            {% endfor %}
          {% else %}
            <div class="list-group-item text-muted">No resolved tickets.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Script: Open = Assign + Redirect to Ticket Page -->
<script>
async function assignSelfAndOpen(id){
  try{
    const r = await fetch(`/cs/tickets/${id}/assign_self`, { method: 'POST' });
    if(!r.ok) throw new Error();
    window.location.href = `/cs/ticket/${id}`;
  }catch(e){
    alert('Failed to open the ticket');
  }
}
</script>
{% endblock %}
