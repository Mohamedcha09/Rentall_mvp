{# app/templates/dm_queue.html #}
{% extends "base.html" %}

{% block title %}Deposit Cases{% endblock %}

{% block head %}
<style>
  .queue-wrap{max-width:1100px;margin:auto}
  .chip{padding:.35rem .6rem;border:1px solid var(--border,#e5e7eb);border-radius:999px}
  .muted{opacity:.65}
  .row-item{border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:12px;background:#fff}
  .stat{display:flex;gap:12px;flex-wrap:wrap}
  .stat > div{background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:10px;padding:8px 10px}
  .table thead th{white-space:nowrap}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap}
</style>
{% endblock %}

{% block content %}
<div class="queue-wrap">

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h4 class="m-0">Deposit Cases</h4>
    <div class="searchbar">
      <form class="d-flex gap-2" method="get" action="/dm/deposits">
        <input class="form-control" name="q" value="{{ q or '' }}" placeholder="Search (booking #, email, name)…">

        <!-- ✅ FIXED FILTER -->
        <select class="form-select" name="state">
          <option value="all">All statuses</option>
          <option value="new" {{ 'selected' if state=='new' }}>New</option>
          <option value="awaiting_renter" {{ 'selected' if state=='awaiting_renter' }}>Awaiting renter response</option>
          <option value="awaiting_dm" {{ 'selected' if state=='awaiting_dm' }}>Awaiting DM decision</option>
          <option value="closed" {{ 'selected' if state=='closed' }}>Closed</option>
        </select>

        <button class="btn btn-primary">Search</button>
      </form>
      <a class="btn btn-light" href="/dm/deposits">Reset</a>
    </div>
  </div>

  {% if counters is defined and counters %}
  <div class="stat mb-3">
    <div>New: <strong>{{ counters.new or 0 }}</strong></div>
    <div>Awaiting renter: <strong>{{ counters.awaiting_renter or 0 }}</strong></div>
    <div>Awaiting DM: <strong>{{ counters.awaiting_dm or 0 }}</strong></div>
    <div>Closed: <strong>{{ counters.closed or 0 }}</strong></div>
  </div>
  {% endif %}

  {% set LIST = cases if cases is defined else (items if items is defined else []) %}

  {% if LIST and LIST|length %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Item</th>
            <th>Renter</th>
            <th>Owner</th>
            <th>Period</th>
            <th>Booking Status</th>
            <th>Deposit Status</th>
            <th>Last Update</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for B in LIST %}
            <tr>
              <td class="mono">#{{ B.id }}</td>

              <td style="min-width:220px;">
                {% if B.item %}
                  <div class="fw-semibold">
                    <a href="/items/{{ B.item.id }}" target="_blank">{{ B.item.title }}</a>
                  </div>
                {% else %}
                  <div class="fw-semibold">—</div>
                {% endif %}
                <div class="muted small">Booking: {{ B.created_at or '' }}</div>
              </td>

              <td>
                {% if B.renter %}
                  <div class="fw-semibold">{{ B.renter.full_name }}</div>
                  <div class="muted small">{{ B.renter.email }}</div>
                {% else %}—{% endif %}
              </td>

              <td>
                {% if B.owner %}
                  <div class="fw-semibold">{{ B.owner.full_name }}</div>
                  <div class="muted small">{{ B.owner.email }}</div>
                {% else %}—{% endif %}
              </td>

              <td>
                <div class="mono small">
                  {{ B.start_date or '—' }} → {{ B.end_date or '—' }}
                </div>
                {% if B.days %}
                  <div class="muted small">{{ B.days }} days</div>
                {% endif %}
              </td>

              <td><span class="chip">{{ B.status or '—' }}</span></td>
              <td><span class="chip">{{ B.deposit_status or '—' }}</span></td>

              <td class="mono small">
                {{ B.updated_at or B.returned_at or B.accepted_at or B.created_at or '' }}
              </td>

              <td class="text-end">
                <a class="btn btn-outline-primary btn-sm" href="/dm/deposits/{{ B.id }}">
                  Open Case
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="row-item">
      No matching cases right now.
      <span class="muted">Try removing filters.</span>
    </div>
  {% endif %}

</div>
{% endblock %}
