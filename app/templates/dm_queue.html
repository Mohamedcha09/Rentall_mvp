{# app/templates/dm_queue.html #}
{% extends "base.html" %}

{% block title %}Deposit Cases{% endblock %}

{% block head %}
<style>
  .queue-wrap{max-width:1100px;margin:auto}
  .chip{
    padding:.35rem .6rem;
    border:1px solid var(--border,#e5e7eb);
    border-radius:999px;
    font-size:.85rem;
    font-weight:500;
  }
  .muted{opacity:.65}
  .row-item{border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:12px;background:#fff}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap}

  /* ===== Status styles ===== */
  .status-in_review{background:#fef3c7;border-color:#f59e0b}
  .status-awaiting_manager{background:#ffedd5;border-color:#f97316}
  .status-accepted{background:#dbeafe;border-color:#3b82f6}
  .status-paid{background:#dcfce7;border-color:#22c55e}
  .status-picked_up{background:#ede9fe;border-color:#8b5cf6}
  .status-completed{background:#bbf7d0;border-color:#16a34a}
  .status-closed{background:#f3f4f6;border-color:#9ca3af;color:#6b7280}
</style>
{% endblock %}

{% block content %}
<div class="queue-wrap">

  <!-- ================= Header + Filters ================= -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h4 class="m-0">Deposit Cases</h4>

    <div class="searchbar">
      <form class="d-flex gap-2" method="get" action="/dm/deposits">
        <input class="form-control"
               name="q"
               value="{{ q or '' }}"
               placeholder="Search (booking #, email, name)…">

        <select class="form-select" name="status">
          <option value="">All (open only)</option>

          <optgroup label="Deposit">
            <option value="in_review" {{ 'selected' if status=='in_review' }}>In review</option>
            <option value="awaiting_renter" {{ 'selected' if status=='awaiting_renter' }}>Awaiting decision</option>
            <option value="closed" {{ 'selected' if status=='closed' }}>Closed</option>
          </optgroup>

          <optgroup label="Booking">
            <option value="accepted" {{ 'selected' if status=='accepted' }}>Accepted</option>
            <option value="paid" {{ 'selected' if status=='paid' }}>Paid</option>
            <option value="picked_up" {{ 'selected' if status=='picked_up' }}>Picked up</option>
            <option value="completed" {{ 'selected' if status=='completed' }}>Completed</option>
          </optgroup>
        </select>

        <button class="btn btn-primary">Search</button>
      </form>

      <a class="btn btn-light" href="/dm/deposits">Reset</a>
    </div>
  </div>

  {% set LIST = cases if cases is defined else (items if items is defined else []) %}

  <!-- ================= Table ================= -->
  {% if LIST and LIST|length %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>Item</th>
          <th>Renter</th>
          <th>Owner</th>
          <th>Period</th>
          <th>Booking Status</th>
          <th>Deposit Status</th>
          <th>Last Update</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        {% for B in LIST %}
        <tr>
          <td class="mono">#{{ B.id }}</td>

          <!-- Item -->
          <td style="min-width:220px;">
            {% if B.item %}
              <div class="fw-semibold">
                <a href="/items/{{ B.item.id }}" target="_blank">
                  {{ B.item.title }}
                </a>
              </div>
            {% else %}
              <div class="fw-semibold">—</div>
            {% endif %}

            <div class="muted small">Booking: {{ B.created_at or '' }}</div>

            {% if B.owner_report_type or B.owner_report_reason %}
              <div class="muted small mt-1">
                <span class="badge bg-warning-subtle text-dark">
                  Report: {{ B.owner_report_type or '—' }}
                </span>
                {% if B.owner_report_reason %}
                  <span class="ms-2">
                    {{ B.owner_report_reason[:120] }}
                    {% if B.owner_report_reason|length > 120 %}…{% endif %}
                  </span>
                {% endif %}
              </div>
            {% endif %}
          </td>

          <!-- Renter -->
          <td>
            {% if B.renter %}
              <div class="fw-semibold">{{ B.renter.full_name }}</div>
              <div class="muted small">{{ B.renter.email }}</div>
            {% else %}—{% endif %}
          </td>

          <!-- Owner -->
          <td>
            {% if B.owner %}
              <div class="fw-semibold">{{ B.owner.full_name }}</div>
              <div class="muted small">{{ B.owner.email }}</div>
            {% else %}—{% endif %}
          </td>

          <!-- Period -->
          <td>
            <div class="mono small">
              {{ B.start_date or '—' }} → {{ B.end_date or '—' }}
            </div>
            {% if B.days %}
              <div class="muted small">{{ B.days }} days</div>
            {% endif %}
          </td>

          <!-- Booking status -->
          <td>
            <span class="chip status-{{ B.status }}">
              {{ B.status or '—' }}
            </span>
          </td>

          <!-- Deposit status -->
          <td>
            <span class="chip status-{{ B.deposit_status }}">
              {{ B.deposit_status or '—' }}
            </span>
          </td>

          <!-- Last update -->
          <td class="mono small">
            {{ B.updated_at or B.returned_at or B.accepted_at or B.created_at or '' }}
          </td>

          <!-- Action -->
          <td class="text-end">
            <a class="btn btn-outline-primary btn-sm"
               href="/dm/deposits/{{ B.id }}">
              Open Case
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
    <div class="row-item">
      No matching cases right now.
      <span class="muted">Try removing filters.</span>
    </div>
  {% endif %}

</div>
{% endblock %}
