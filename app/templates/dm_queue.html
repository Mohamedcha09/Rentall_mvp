{# app/templates/dm_queue.html #}
{% extends "base.html" %}

{% block title %}قضايا الوديعة{% endblock %}

{% block head %}
<style>
  .queue-wrap{max-width:1100px;margin:auto}
  .chip{padding:.35rem .6rem;border:1px solid var(--border,#e5e7eb);border-radius:999px}
  .muted{opacity:.65}
  .row-item{border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:12px;background:#fff}
  .stat{display:flex;gap:12px;flex-wrap:wrap}
  .stat > div{background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:10px;padding:8px 10px}
  .table thead th{white-space:nowrap}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap}
</style>
{% endblock %}

{% block content %}
<div class="queue-wrap">

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h4 class="m-0">قضايا الوديعة</h4>
    <div class="searchbar">
      <form class="d-flex gap-2" method="get" action="/dm/deposits">
        <input class="form-control" name="q" value="{{ q or '' }}" placeholder="ابحث (#حجز، بريد، اسم)…">
        <select class="form-select" name="status">
          <option value="">كل الحالات</option>
          <option value="new" {{ 'selected' if status=='new' }}>جديدة</option>
          <option value="awaiting_renter" {{ 'selected' if status=='awaiting_renter' }}>بانتظار رد المستأجر</option>
          <option value="awaiting_manager" {{ 'selected' if status=='awaiting_manager' }}>بانتظار قرار DM</option>
          <option value="finalized" {{ 'selected' if status=='finalized' }}>مغلقة</option>
        </select>
        <button class="btn btn-primary">بحث</button>
      </form>
      <a class="btn btn-light" href="/dm/deposits">إعادة التعيين</a>
    </div>
  </div>

  {# أرقام سريعة اختيارية لو تم تمريرها من الراوتر #}
  {% if counters is defined and counters %}
  <div class="stat mb-3">
    <div>جديدة: <strong>{{ counters.new or 0 }}</strong></div>
    <div>بانتظار المستأجر: <strong>{{ counters.awaiting_renter or 0 }}</strong></div>
    <div>بانتظار DM: <strong>{{ counters.awaiting_manager or 0 }}</strong></div>
    <div>مغلقة: <strong>{{ counters.finalized or 0 }}</strong></div>
  </div>
  {% endif %}

  {% set LIST = cases if cases is defined else (items if items is defined else []) %}

  {% if LIST and LIST|length %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>العنصر</th>
            <th>المستأجر</th>
            <th>المالك</th>
            <th>الفترة</th>
            <th>حالة الحجز</th>
            <th>حالة الوديعة</th>
            <th>آخر تحديث</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for B in LIST %}
            <tr>
              <td class="mono">#{{ B.id }}</td>
              <td style="min-width:220px;">
                {% if B.item %}
                  <div class="fw-semibold"><a href="/items/{{ B.item.id }}" target="_blank">{{ B.item.title }}</a></div>
                {% else %}
                  <div class="fw-semibold">—</div>
                {% endif %}
                <div class="muted small">حجز: {{ B.created_at or '' }}</div>
              </td>

              <td>
                {% if B.renter %}
                  <div class="fw-semibold">{{ B.renter.full_name }}</div>
                  <div class="muted small">{{ B.renter.email }}</div>
                {% else %}—{% endif %}
              </td>

              <td>
                {% if B.owner %}
                  <div class="fw-semibold">{{ B.owner.full_name }}</div>
                  <div class="muted small">{{ B.owner.email }}</div>
                {% else %}—{% endif %}
              </td>

              <td>
                <div class="mono small">
                  {{ B.start_date or '—' }} → {{ B.end_date or '—' }}
                </div>
                {% if B.days %}<div class="muted small">{{ B.days }} يوم</div>{% endif %}
              </td>

              <td><span class="chip">{{ B.status or '—' }}</span></td>
              <td><span class="chip">{{ B.deposit_status or '—' }}</span></td>

              <td class="mono small">
                {{ B.updated_at or B.returned_at or B.accepted_at or B.created_at or '' }}
              </td>

              <td class="text-end">
                <a class="btn btn-outline-primary btn-sm" href="/dm/deposits/{{ B.id }}">
                  فتح القضية
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# ترقيم صفحات اختياري #}
    {% if pagination is defined and pagination %}
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="muted small">الصفحة {{ pagination.page }} من {{ pagination.pages }}</div>
        <div class="d-flex gap-2">
          {% if pagination.prev_url %}<a class="btn btn-light btn-sm" href="{{ pagination.prev_url }}">السابق</a>{% endif %}
          {% if pagination.next_url %}<a class="btn btn-light btn-sm" href="{{ pagination.next_url }}">التالي</a>{% endif %}
        </div>
      </div>
    {% endif %}

  {% else %}
    <div class="row-item">
      لا توجد قضايا مطابقة حالياً.
      <span class="muted">جرّب إزالة فلاتر البحث.</span>
    </div>
  {% endif %}

</div>
{% endblock %}
