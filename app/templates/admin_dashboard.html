{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-4">لوحة الأدمين</h3>

  <!-- ===== إحصائيات الزيارات ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 text-center">
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">زوار اليوم</div>
            <div id="m_today" class="fs-3 fw-bold">—</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">زوار هذا الشهر</div>
            <div id="m_month" class="fs-3 fw-bold">—</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">زوار هذه السنة</div>
            <div id="m_year" class="fs-3 fw-bold">—</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">المتصلون الآن</div>
            <div id="m_online" class="fs-3 fw-bold">—</div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <canvas id="dailyChart" height="120" style="max-height:240px"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
  (async function(){
    try{
      const sum = await (await fetch("/api/admin/metrics/summary")).json();
      document.getElementById("m_today").textContent  = sum.today  ?? 0;
      document.getElementById("m_month").textContent  = sum.month  ?? 0;
      document.getElementById("m_year").textContent   = sum.year   ?? 0;
      document.getElementById("m_online").textContent = sum.online_now ?? 0;

      const d = await (await fetch("/api/admin/metrics/daily_chart")).json();
      const ctx = document.getElementById("dailyChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: d.labels || [],
          datasets: [{ label: "زوار فريدون", data: d.values || [], tension: .3, fill: false }]
        },
        options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
      });
    }catch(e){}
  })();
  </script>

  <!-- ==================== في انتظار الموافقة ==================== -->
  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>في انتظار الموافقة</strong>
      <span class="badge bg-secondary">{{ pending_users|length }}</span>
    </div>
    <div class="card-body p-0">
      {% if not pending_users %}
        <div class="p-3 text-muted">لا يوجد طلبات حالياً.</div>
      {% else %}
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>البريد</th>
              <th>الهاتف</th>
              <th>صورة الحساب</th>
              <th>هوية (أمامي/خلفي)</th>
              <th>توثيق البريد</th>
              <th class="text-end">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for row in pending_users %}
              {# يدعم الشكلين: row.u أو row نفسه User #}
              {% set u = row.u if row is mapping and 'u' in row else row %}
              {% set docs = u.documents or [] %}
              {% if row is mapping and 'latest_doc' in row %}
                {% set d = row.latest_doc %}
              {% else %}
                {% set d = (docs|sort(attribute='created_at'))|last %}
              {% endif %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.first_name }} {{ u.last_name }}</td>
              <td>{{ u.email }}</td>
              <td>{{ u.phone }}</td>

              <!-- صورة الحساب -->
              <td>
                {% if u.avatar_path %}
                  <a href="{{ u.avatar_path | media_url }}" target="_blank" rel="noopener">
                    <img src="{{ u.avatar_path | media_url }}" alt="avatar"
                         style="width:54px;height:54px;object-fit:cover;border-radius:6px">
                  </a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <!-- صور الهوية -->
              <td>
                {% if d and d.file_front_path %}
                  <a href="{{ d.file_front_path | media_url }}" target="_blank" title="الوجه الأمامي" rel="noopener">
                    <img src="{{ d.file_front_path | media_url }}" style="width:60px;height:40px;object-fit:cover;border-radius:4px;margin-inline-end:6px">
                  </a>
                {% endif %}
                {% if d and d.file_back_path %}
                  <a href="{{ d.file_back_path | media_url }}" target="_blank" title="الوجه الخلفي" rel="noopener">
                    <img src="{{ d.file_back_path | media_url }}" style="width:60px;height:40px;object-fit:cover;border-radius:4px">
                  </a>
                {% endif %}
                {% if not (d and (d.file_front_path or d.file_back_path)) %}
                  <span class="text-muted">لا توجد وثيقة</span>
                {% endif %}
              </td>

              <td>
                {% if u.is_verified|default(false) %}
                  <span class="badge bg-success">موثّق</span>
                {% else %}
                  <span class="badge bg-warning text-dark">غير موثّق</span>
                {% endif %}
              </td>

              <td class="text-end">
                <form method="post" action="/admin/users/{{ u.id }}/approve" class="d-inline">
                  <button class="btn btn-sm btn-success">موافقة</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/reject" class="d-inline">
                  <button class="btn btn-sm btn-outline-danger">رفض</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/message" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary">مراسلة</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ==================== كل المستخدمين ==================== -->
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>كل المستخدمين</strong>
      <span class="badge bg-secondary">{{ all_users|length }}</span>
    </div>
    <div class="card-body p-0">
      {% if not all_users %}
        <div class="p-3 text-muted">لا يوجد مستخدمون.</div>
      {% else %}
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>البريد</th>
              <th>الحالة</th>
              <th>الدور</th>
              <th>صورة الحساب</th>
              <th>هوية (أ/خ)</th>
              <th>توثيق</th>
              <th>MD</th>
              <th class="text-end">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for row in all_users %}
              {% set u = row.u if row is mapping and 'u' in row else row %}
              {% set docs = u.documents or [] %}
              {% if row is mapping and 'latest_doc' in row %}
                {% set d = row.latest_doc %}
              {% else %}
                {% set d = (docs|sort(attribute='created_at'))|last %}
              {% endif %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.first_name }} {{ u.last_name }}</td>
              <td>{{ u.email }}</td>
              <td>
                {% if u.status == 'approved' %}
                  <span class="badge bg-success">مقبول</span>
                {% elif u.status == 'rejected' %}
                  <span class="badge bg-danger">مرفوض</span>
                {% else %}
                  <span class="badge bg-secondary">معلّق</span>
                {% endif %}
              </td>
              <td>
                {% if u.role == 'admin' %}
                  <span class="badge bg-dark">Admin</span>
                {% else %}
                  <span class="badge bg-info text-dark">User</span>
                {% endif %}
              </td>
              <td>
                {% if u.avatar_path %}
                  <a href="{{ u.avatar_path | media_url }}" target="_blank" rel="noopener">
                    <img src="{{ u.avatar_path | media_url }}" style="width:46px;height:46px;object-fit:cover;border-radius:6px">
                  </a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if d and d.file_front_path %}
                  <a href="{{ d.file_front_path | media_url }}" target="_blank" title="أمامي" rel="noopener">
                    <img src="{{ d.file_front_path | media_url }}" style="width:44px;height:30px;object-fit:cover;border-radius:4px;margin-inline-end:4px">
                  </a>
                {% endif %}
                {% if d and d.file_back_path %}
                  <a href="{{ d.file_back_path | media_url }}" target="_blank" title="خلفي" rel="noopener">
                    <img src="{{ d.file_back_path | media_url }}" style="width:44px;height:30px;object-fit:cover;border-radius:4px">
                  </a>
                {% endif %}
              </td>
              <td>
                {% if u.is_verified|default(false) %}
                  <span class="badge bg-success">موثّق</span>
                  <form method="post" action="/admin/users/{{ u.id }}/unverify" class="d-inline">
                    <button class="btn btn-sm btn-outline-warning">إلغاء</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/verify" class="d-inline">
                    <button class="btn btn-sm btn-outline-success">توثيق</button>
                  </form>
                {% endif %}
              </td>
              <td>
                {% if u.is_deposit_manager|default(false) %}
                  <span class="badge bg-primary">MD</span>
                {% else %}
                  <span class="badge bg-secondary">—</span>
                {% endif %}
              </td>
              <td class="text-end">
                {% if u.is_deposit_manager|default(false) %}
                  <form method="post" action="/admin/users/{{ u.id }}/deposit_manager/disable" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">إلغاء MD</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/deposit_manager/enable" class="d-inline">
                    <button class="btn btn-sm btn-outline-primary">منح MD</button>
                  </form>
                {% endif %}

                {% if u.status != 'approved' %}
                  <form method="post" action="/admin/users/{{ u.id }}/approve" class="d-inline">
                    <button class="btn btn-sm btn-success">موافقة</button>
                  </form>
                {% endif %}

                <form method="post" action="/admin/users/{{ u.id }}/message" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary">مراسلة</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}