{% extends "base.html" %}
{% block content %}

<div class="admin-wrap">

  <div class="admin-header">
    <h4 class="mb-0 d-flex align-items-center gap-2">
      لوحة الأدمين
      <span class="badge bg-dark-subtle">إدارة المستخدمين</span>
    </h4>
    <a href="/welcome" class="btn btn-outline-light btn-sm">العودة للرئيسية</a>
  </div>

  <!-- إحصائيات سريعة -->
  <div class="admin-stats mb-3">
    <div class="admin-stat">
      <div class="text-muted small">بإنتظار الموافقة</div>
      <div class="fs-5 fw-bold">{{ pending_users|length }}</div>
    </div>
    <div class="admin-stat">
      <div class="text-muted small">إجمالي المستخدمين</div>
      <div class="fs-5 fw-bold">{{ all_users|length }}</div>
    </div>
  </div>

  <!-- بانتظار الموافقة -->
  <div class="card card-blur mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="m-0">طلبات جديدة</h6>
        <span class="badge bg-warning text-dark">{{ pending_users|length }}</span>
      </div>

      {% if pending_users and pending_users|length %}
      <div class="table-wrap">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>المستخدم</th>
              <th>البريد</th>
              <th>الهاتف</th>
              <th>تاريخ الإنشاء</th>
              <th>حالة الوثائق</th>
              <th class="text-center">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for u in pending_users %}
            <tr>
              <td class="fw-semibold">
                {{ u.first_name }} {{ u.last_name }}
                {% if getattr(u, 'is_deposit_manager', False) %}
                  <span class="badge bg-primary ms-1">Deposit&nbsp;Manager</span>
                {% endif %}
              </td>
              <td class="text-muted small">{{ u.email }}</td>
              <td class="text-muted small">{{ u.phone or '—' }}</td>
              <td class="text-muted small">{{ u.created_at.strftime('%Y-%m-%d') if u.created_at }}</td>
              <td>
                {% set doc = (u.documents[0] if u.documents else None) %}
                {% if doc %}
                  {% if doc.review_status == 'approved' %}<span class="badge bg-success">مقبولة</span>
                  {% elif doc.review_status == 'rejected' %}<span class="badge bg-danger">مرفوضة</span>
                  {% elif doc.review_status == 'needs_fix' %}<span class="badge bg-warning text-dark">تحتاج تصحيح</span>
                  {% else %}<span class="badge bg-secondary">قيد المراجعة</span>{% endif %}
                {% else %}
                  <span class="badge bg-secondary">لا وثائق</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="action-btns">
                  <form method="post" action="/admin/users/{{ u.id }}/approve">
                    <button class="btn btn-sm btn-success" type="submit">قبول</button>
                  </form>
                  <form method="post" action="/admin/users/{{ u.id }}/reject">
                    <button class="btn btn-sm btn-danger" type="submit">رفض</button>
                  </form>
                  <form method="post" action="/admin/users/{{ u.id }}/message">
                    <button class="btn btn-sm btn-outline-light" type="submit">مراسلة</button>
                  </form>
                  <form method="post" action="/admin/users/{{ u.id }}/request_fix">
                    <input type="hidden" name="reason" value="يرجى رفع صورة أوضح/وثيقة صالحة.">
                    <button class="btn btn-sm btn-warning text-dark" type="submit">طلب تصحيح</button>
                  </form>

                  <!-- (NEW) إدارة صلاحية متحكّم الوديعة -->
                  {% if getattr(u, 'is_deposit_manager', False) %}
                    <form method="post" action="/admin/users/{{ u.id }}/revoke_deposit_manager">
                      <button class="btn btn-sm btn-outline-danger" type="submit" title="سحب صلاحية متحكم الوديعة">
                        سحب DM
                      </button>
                    </form>
                  {% else %}
                    <form method="post" action="/admin/users/{{ u.id }}/grant_deposit_manager">
                      <button class="btn btn-sm btn-outline-primary" type="submit" title="منح صلاحية متحكم الوديعة">
                        منح DM
                      </button>
                    </form>
                  {% endif %}
                  <!-- /NEW -->
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="text-muted">لا توجد طلبات حاليًا.</div>
      {% endif %}
    </div>
  </div>

  <!-- جميع المستخدمين -->
  <div class="card card-blur">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="m-0">جميع المستخدمين</h6>
        <span class="badge bg-dark-subtle">{{ all_users|length }}</span>
      </div>

      {% if all_users and all_users|length %}
      <div class="table-wrap">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>الاسم</th>
              <th>البريد</th>
              <th>الدور</th>
              <th>الحالة</th>
              <th>موثّق</th>
              <th>شارات</th>
              <th class="text-center">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for u in all_users %}
            <tr>
              <td class="fw-semibold">
                {{ u.first_name }} {{ u.last_name }}
                {% if getattr(u, 'is_deposit_manager', False) %}
                  <span class="badge bg-primary ms-1">Deposit&nbsp;Manager</span>
                {% endif %}
              </td>
              <td class="text-muted small">{{ u.email }}</td>
              <td>
                <span class="badge {% if u.role=='admin' %}bg-info text-dark{% else %}bg-secondary{% endif %}">
                  {{ u.role }}
                </span>
              </td>
              <td>
                <span class="badge
                  {% if u.status=='approved' %}bg-success
                  {% elif u.status=='pending' %}bg-warning text-dark
                  {% else %}bg-danger{% endif %}">
                  {{ u.status }}
                </span>
              </td>
              <td>
                {% if u.is_verified %}
                  <span class="badge bg-primary">✓ موثّق</span>
                {% else %}
                  <span class="badge bg-secondary">غير موثّق</span>
                {% endif %}
              </td>
              <td class="small">
                {% if u.badge_new_yellow %}<span class="badge bg-warning text-dark">جديد</span>{% endif %}
                {% if u.badge_purple_trust %}<span class="badge bg-dark-subtle">ثقة</span>{% endif %}
                {% if u.badge_pro_green %}<span class="badge bg-success">Pro</span>{% endif %}
                {% if u.badge_pro_gold %}<span class="badge bg-warning text-dark">Pro+</span>{% endif %}
                {% if u.badge_admin %}<span class="badge bg-info text-dark">Admin</span>{% endif %}
              </td>
              <td class="text-center">
                <div class="action-btns">
                  {% if not u.is_verified %}
                  <form method="post" action="/admin/users/{{ u.id }}/verify">
                    <button class="btn btn-sm btn-primary" type="submit">توثيق</button>
                  </form>
                  {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/unverify">
                    <button class="btn btn-sm btn-outline-light" type="submit">إلغاء التوثيق</button>
                  </form>
                  {% endif %}

                  <form method="post" action="/admin/users/{{ u.id }}/approve">
                    <button class="btn btn-sm btn-success" type="submit">قبول</button>
                  </form>
                  <form method="post" action="/admin/users/{{ u.id }}/reject">
                    <button class="btn btn-sm btn-danger" type="submit">رفض</button>
                  </form>

                  <form method="post" action="/admin/users/{{ u.id }}/message">
                    <button class="btn btn-sm btn-outline-light" type="submit">مراسلة</button>
                  </form>

                  <!-- ضبط الشارات بسرعة -->
                  <form method="post" action="/users/{{ u.id }}/badges" class="d-inline-block">
                    <input type="hidden" name="badge_new_yellow" value="{{ 'on' if u.badge_new_yellow else '' }}">
                    <input type="hidden" name="badge_purple_trust" value="{{ 'on' if u.badge_purple_trust else '' }}">
                    <input type="hidden" name="badge_pro_green" value="{{ 'on' if u.badge_pro_green else '' }}">
                    <input type="hidden" name="badge_pro_gold" value="{{ 'on' if u.badge_pro_gold else '' }}">
                    <input type="hidden" name="badge_admin" value="{{ 'on' if u.role=='admin' or u.badge_admin else '' }}">
                    <button class="btn btn-sm btn-secondary" type="submit">حفظ الشارات</button>
                  </form>

                  <!-- (NEW) إدارة صلاحية متحكّم الوديعة -->
                  {% if getattr(u, 'is_deposit_manager', False) %}
                    <form method="post" action="/admin/users/{{ u.id }}/revoke_deposit_manager">
                      <button class="btn btn-sm btn-outline-danger" type="submit" title="سحب صلاحية متحكم الوديعة">
                        سحب DM
                      </button>
                    </form>
                  {% else %}
                    <form method="post" action="/admin/users/{{ u.id }}/grant_deposit_manager">
                      <button class="btn btn-sm btn-outline-primary" type="submit" title="منح صلاحية متحكم الوديعة">
                        منح DM
                      </button>
                    </form>
                  {% endif %}
                  <!-- /NEW -->
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="text-muted">لا يوجد مستخدمون.</div>
      {% endif %}
    </div>
  </div>

</div>

{% endblock %}
