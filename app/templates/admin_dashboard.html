{% extends "base.html" %}

{% block content %}
<div class="container py-4" style="direction:ltr; text-align:left;">
  <h3 class="mb-4">Admin Dashboard</h3>

<!-- Broadcast Email -->
<div class="mb-4">
  <a href="/admin/broadcast" class="btn btn-warning btn-lg">
    ðŸ“¢ Send Email to All Users
  </a>
</div>

<!-- Button to Pending Items Review -->
<div class="mb-4">
  <a href="/admin/items/pending" class="btn btn-dark btn-lg">
    Review Pending Listings
  </a>
</div>


  <!-- ===== Traffic Metrics ===== -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 text-center">
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">Visitors Today</div>
            <div id="m_today" class="fs-3 fw-bold">â€”</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">Visitors This Month</div>
            <div id="m_month" class="fs-3 fw-bold">â€”</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">Visitors This Year</div>
            <div id="m_year" class="fs-3 fw-bold">â€”</div>
          </div>
        </div>
        <div class="col-6 col-lg-3">
          <div class="p-3 rounded-3 border">
            <div class="small text-muted">Online Now</div>
            <div id="m_online" class="fs-3 fw-bold">â€”</div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <canvas id="dailyChart" height="120" style="max-height:240px"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
  (async function(){
    try{
      const sum = await (await fetch("/api/admin/metrics/summary")).json();
      document.getElementById("m_today").textContent  = sum.today  ?? 0;
      document.getElementById("m_month").textContent  = sum.month  ?? 0;
      document.getElementById("m_year").textContent   = sum.year   ?? 0;
      document.getElementById("m_online").textContent = sum.online_now ?? 0;

      const d = await (await fetch("/api/admin/metrics/daily_chart")).json();
      const ctx = document.getElementById("dailyChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: d.labels || [],
          datasets: [{ label: "Unique Visitors", data: d.values || [], tension: .3, fill: false }]
        },
        options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
      });
    }catch(e){}
  })();
  </script>

  <!-- ==================== Pending Approval ==================== -->
  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>Pending Approval</strong>
      <span class="badge bg-secondary">{{ pending_users|length }}</span>
    </div>
    <div class="card-body p-0">
      {% if not pending_users %}
        <div class="p-3 text-muted">No requests at the moment.</div>
      {% else %}
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Avatar</th>
              <th>ID (Front/Back)</th>
              <th>Email Verification</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in pending_users %}
              {# supports both shapes: row.u or row itself (User) #}
              {% set u = row.u if row is mapping and 'u' in row else row %}
              {% set docs = u.documents or [] %}
              {% if row is mapping and 'latest_doc' in row %}
                {% set d = row.latest_doc %}
              {% else %}
                {% set d = (docs|sort(attribute='created_at'))|last %}
              {% endif %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.first_name }} {{ u.last_name }}</td>
              <td>{{ u.email }}</td>
              <td>{{ u.phone }}</td>

              <!-- Avatar -->
              <td>
                {% if u.avatar_path %}
                  <a href="{{ u.avatar_path | media_url }}" target="_blank" rel="noopener">
                    <img src="{{ u.avatar_path | media_url }}" alt="avatar"
                         style="width:54px;height:54px;object-fit:cover;border-radius:6px">
                  </a>
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>

              <!-- ID images -->
              <td>
                {% if d and d.file_front_path %}
                  <a href="{{ d.file_front_path | media_url }}" target="_blank" title="Front" rel="noopener">
                    <img src="{{ d.file_front_path | media_url }}" style="width:60px;height:40px;object-fit:cover;border-radius:4px;margin-inline-end:6px">
                  </a>
                {% endif %}
                {% if d and d.file_back_path %}
                  <a href="{{ d.file_back_path | media_url }}" target="_blank" title="Back" rel="noopener">
                    <img src="{{ d.file_back_path | media_url }}" style="width:60px;height:40px;object-fit:cover;border-radius:4px">
                  </a>
                {% endif %}
                {% if not (d and (d.file_front_path or d.file_back_path)) %}
                  <span class="text-muted">No document</span>
                {% endif %}
              </td>

              <td>
                {% if u.is_verified|default(false) %}
                  <span class="badge bg-success">Verified</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Unverified</span>
                {% endif %}
              </td>

              <td class="text-end">
                <form method="post" action="/admin/users/{{ u.id }}/approve" class="d-inline">
                  <button class="btn btn-sm btn-success">Approve</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/reject" class="d-inline">
                  <button class="btn btn-sm btn-outline-danger">Reject</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/message" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary">Message</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ==================== All Users ==================== -->
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>All Users</strong>
      <span class="badge bg-secondary">{{ all_users|length }}</span>
    </div>
    <div class="card-body p-0">
      {% if not all_users %}
        <div class="p-3 text-muted">No users.</div>
      {% else %}
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Status</th>
              <th>Role</th>
              <th>Avatar</th>
              <th>ID (F/B)</th>
              <th>Verification</th>
              <th>MD</th>
              <th>MOD</th>
              <th>CS</th>  {# Customer Support column #}
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in all_users %}
              {% set u = row.u if row is mapping and 'u' in row else row %}
              {% set docs = u.documents or [] %}
              {% if row is mapping and 'latest_doc' in row %}
                {% set d = row.latest_doc %}
              {% else %}
                {% set d = (docs|sort(attribute='created_at'))|last %}
              {% endif %}
            <tr>
              <td>{{ u.id }}</td>
              <td>
                {{ u.first_name }} {{ u.last_name }}
                {% if u.is_mod|default(false) %}
                  <span class="badge bg-secondary ms-1" title="Content Moderator">MOD</span>
                {% endif %}
              </td>
              <td>{{ u.email }}</td>
              <td>
                {% if u.status == 'approved' %}
                  <span class="badge bg-success">Approved</span>
                {% elif u.status == 'rejected' %}
                  <span class="badge bg-danger">Rejected</span>
                {% else %}
                  <span class="badge bg-secondary">Pending</span>
                {% endif %}
              </td>
              <td>
                {% if u.role == 'admin' %}
                  <span class="badge bg-dark">Admin</span>
                {% else %}
                  <span class="badge bg-info text-dark">User</span>
                {% endif %}
              </td>
              <td>
                {% if u.avatar_path %}
                  <a href="{{ u.avatar_path | media_url }}" target="_blank" rel="noopener">
                    <img src="{{ u.avatar_path | media_url }}" style="width:46px;height:46px;object-fit:cover;border-radius:6px">
                  </a>
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
              <td>
                {% if d and d.file_front_path %}
                  <a href="{{ d.file_front_path | media_url }}" target="_blank" title="Front" rel="noopener">
                    <img src="{{ d.file_front_path | media_url }}" style="width:44px;height:30px;object-fit:cover;border-radius:4px;margin-inline-end:4px">
                  </a>
                {% endif %}
                {% if d and d.file_back_path %}
                  <a href="{{ d.file_back_path | media_url }}" target="_blank" title="Back" rel="noopener">
                    <img src="{{ d.file_back_path | media_url }}" style="width:44px;height:30px;object-fit:cover;border-radius:4px">
                  </a>
                {% endif %}
              </td>
              <td>
                {% if u.is_verified|default(false) %}
                  <span class="badge bg-success">Verified</span>
                  <form method="post" action="/admin/users/{{ u.id }}/unverify" class="d-inline">
                    <button class="btn btn-sm btn-outline-warning">Unverify</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/verify" class="d-inline">
                    <button class="btn btn-sm btn-outline-success">Verify</button>
                  </form>
                {% endif %}
              </td>

              <!-- MD -->
              <td>
                {% if u.is_deposit_manager|default(false) %}
                  <span class="badge bg-primary">MD</span>
                {% else %}
                  <span class="badge bg-secondary">â€”</span>
                {% endif %}
              </td>

              <!-- MOD -->
              <td>
                {% if u.is_mod|default(false) %}
                  <span class="badge bg-secondary">MOD</span>
                {% else %}
                  <span class="badge bg-secondary">â€”</span>
                {% endif %}
              </td>

              <!-- CS -->
              <td>
                {% if u.is_support|default(false) %}
                  <span class="badge bg-success">CS</span>
                {% else %}
                  <span class="badge bg-secondary">â€”</span>
                {% endif %}
              </td>

              <td class="text-end">
                {# MD actions #}
                {% if u.is_deposit_manager|default(false) %}
                  <form method="post" action="/admin/users/{{ u.id }}/deposit_manager/disable" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">Disable MD</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/deposit_manager/enable" class="d-inline">
                    <button class="btn btn-sm btn-outline-primary">Enable MD</button>
                  </form>
                {% endif %}

                {# MOD actions #}
                {% if u.is_mod|default(false) %}
                  <form method="post" action="/admin/users/{{ u.id }}/mod/disable" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">Disable MOD</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/mod/enable" class="d-inline">
                    <button class="btn btn-sm btn-outline-primary">Enable MOD</button>
                  </form>
                {% endif %}

                {# CS actions #}
                {% if u.is_support|default(false) %}
                  <form method="post" action="/admin/users/{{ u.id }}/cs/disable" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">Disable CS</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/cs/enable" class="d-inline">
                    <button class="btn btn-sm btn-outline-primary">Enable CS</button>
                  </form>
                {% endif %}

                {% if u.status != 'approved' %}
                  <form method="post" action="/admin/users/{{ u.id }}/approve" class="d-inline">
                    <button class="btn btn-sm btn-success">Approve</button>
                  </form>
                {% endif %}

                <form method="post" action="/admin/users/{{ u.id }}/message" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary">Message</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
