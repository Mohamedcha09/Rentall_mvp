{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-4">لوحة الأدمين</h3>

  <!-- مستخدمون بإنتظار الموافقة -->
  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>في انتظار الموافقة</strong>
      <span class="badge bg-secondary">{{ pending_users|length }}</span>
    </div>
    <div class="card-body p-0">
      {% if not pending_users %}
        <div class="p-3 text-muted">لا يوجد طلبات حالياً.</div>
      {% else %}
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>البريد</th>
              <th>الهاتف</th>
              <th>توثيق</th>
              <th class="text-end">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for u in pending_users %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.first_name }} {{ u.last_name }}</td>
              <td>{{ u.email }}</td>
              <td>{{ u.phone }}</td>
              <td>
                {% if u.is_verified|default(false) %}
                  <span class="badge bg-success">موثّق</span>
                {% else %}
                  <span class="badge bg-warning text-dark">قيد المراجعة</span>
                {% endif %}
              </td>
              <td class="text-end">
                <form method="post" action="/admin/users/{{ u.id }}/approve" class="d-inline">
                  <button class="btn btn-sm btn-success">موافقة</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/reject" class="d-inline">
                  <button class="btn btn-sm btn-outline-danger">رفض</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/message" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary">مراسلة</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- كل المستخدمين -->
  <div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
      <strong>كل المستخدمين</strong>
      <span class="badge bg-secondary">{{ all_users|length }}</span>
    </div>
    <div class="card-body p-0">
      {% if not all_users %}
        <div class="p-3 text-muted">لا يوجد مستخدمون.</div>
      {% else %}
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>الاسم</th>
              <th>البريد</th>
              <th>الحالة</th>
              <th>الدور</th>
              <th>توثيق</th>
              <th>MD</th>
              <th class="text-end">إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for u in all_users %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.first_name }} {{ u.last_name }}</td>
              <td>{{ u.email }}</td>
              <td>
                {% if u.status == 'approved' %}
                  <span class="badge bg-success">مقبول</span>
                {% elif u.status == 'rejected' %}
                  <span class="badge bg-danger">مرفوض</span>
                {% else %}
                  <span class="badge bg-secondary">معلّق</span>
                {% endif %}
              </td>
              <td>
                {% if u.role == 'admin' %}
                  <span class="badge bg-dark">Admin</span>
                {% else %}
                  <span class="badge bg-info text-dark">User</span>
                {% endif %}
              </td>
              <td>
                {% if u.is_verified|default(false) %}
                  <span class="badge bg-success">موثّق</span>
                  <form method="post" action="/admin/users/{{ u.id }}/unverify" class="d-inline">
                    <button class="btn btn-sm btn-outline-warning">إلغاء التوثيق</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/verify" class="d-inline">
                    <button class="btn btn-sm btn-outline-success">توثيق</button>
                  </form>
                {% endif %}
              </td>

              <!-- عمود صلاحية متحكّم الوديعة (MD) -->
              <td>
                {% if u.is_deposit_manager|default(false) %}
                  <span class="badge bg-primary">MD</span>
                {% else %}
                  <span class="badge bg-secondary">—</span>
                {% endif %}
              </td>

              <td class="text-end">
                {% if u.is_deposit_manager|default(false) %}
                  <form method="post" action="/admin/users/{{ u.id }}/deposit_manager/disable" class="d-inline">
                    <button class="btn btn-sm btn-outline-danger">إلغاء MD</button>
                  </form>
                {% else %}
                  <form method="post" action="/admin/users/{{ u.id }}/deposit_manager/enable" class="d-inline">
                    <button class="btn btn-sm btn-outline-primary">منح MD</button>
                  </form>
                {% endif %}

                {% if u.status != 'approved' %}
                  <form method="post" action="/admin/users/{{ u.id }}/approve" class="d-inline">
                    <button class="btn btn-sm btn-success">موافقة</button>
                  </form>
                {% endif %}

                <form method="post" action="/admin/users/{{ u.id }}/message" class="d-inline">
                  <button class="btn btn-sm btn-outline-primary">مراسلة</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
