{% extends "base.html" %}
{% block title %}قضية وديعة #{{ bk.id }}{% endblock %}

{% block content %}
<div class="container">
  <h2>قضية وديعة #{{ bk.id }}</h2>

  <!-- معلومات عامة عن الحجز -->
  <div class="card" style="padding:16px;margin-bottom:16px;">
    <div><b>العنصر:</b> {{ (item.title if item else "—") }}</div>
    <div><b>المالك:</b> #{{ bk.owner_id }} — <b>المستأجر:</b> #{{ bk.renter_id }}</div>
    <div><b>حالة الحجز:</b> {{ bk.status }} — <b>حالة الوديعة:</b> {{ bk.deposit_status }}</div>
    {% if bk.owner_return_note %}
      <div style="margin-top:8px;">
        <b>ملاحظة المالك:</b><br>
        {{ (bk.owner_return_note or "") | replace('\n','<br>') | safe }}
      </div>
    {% endif %}
  </div>

  <h3>الأدلة المرفوعة</h3>

  <!-- ===== Evidence (Client-side fetch + Server vars) ===== -->
  <div id="ev-container" class="card" style="padding:8px;margin-bottom:10px;">
    <div style="font-size:13px;">
      Evidence — <b id="ev-count">0</b>
    </div>
    <div id="ev-grid" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;"></div>
    <div id="ev-empty" class="muted" style="margin-top:8px;">لا توجد ملفات أدلة.</div>
  </div>

  <!-- نموذج القرار -->
  <form action="/dm/deposits/{{ bk.id }}/decision" method="post" class="card" style="padding:16px;gap:12px;">
    <h3 style="margin-top:0;">اتخاذ القرار النهائي</h3>

    <label>نوع القرار</label>
    <select name="decision" required>
      <option value="">— اختر —</option>
      <option value="release">رد كامل الوديعة</option>
      <option value="withhold">اقتطاع من الوديعة</option>
    </select>

    <label>المبلغ الجزئي (إن وجد)</label>
    <input name="amount" type="number" min="0" step="1" value="0" />

    <label>السبب/التفاصيل</label>
    <textarea name="reason" rows="3" placeholder="اكتب سبب القرار…"></textarea>

    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <a class="btn btn-secondary" href="/dm/deposits">رجوع</a>
      <button class="btn btn-success" type="submit">تنفيذ القرار</button>
    </div>
  </form>

  <!-- استلام القضية -->
  <form action="/dm/deposits/{{ bk.id }}/claim" method="post" style="margin-top:12px;">
    <button class="btn btn-outline">استلام القضية (اختياري)</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // ===== قيم مرسلة من السيرفر (قد تكون null) =====
  const serverEvidence = {{ evidence|tojson if evidence is defined else 'null' }};
  const serverEvList   = {{ ev_list|tojson   if ev_list   is defined else 'null' }};

  // عناصر DOM
  var grid    = document.getElementById('ev-grid');
  var countEl = document.getElementById('ev-count');
  var emptyEl = document.getElementById('ev-empty');

  function isVideo(url){
    var s = (url || '').toLowerCase();
    return s.endsWith('.mp4') || s.endsWith('.mov') || s.endsWith('.m4v') ||
           s.endsWith('.avi') || s.endsWith('.wmv') || s.endsWith('.webm');
  }

  function addImg(u){
    var a = document.createElement('a');
    a.href = u; a.target = '_blank'; a.style.display = 'inline-block';
    var img = document.createElement('img');
    img.src = u + '?v={{ bk.updated_at.timestamp() if bk.updated_at else 0 }}';
    img.alt = 'evidence'; img.loading = 'lazy';
    img.style.maxWidth = '220px'; img.style.maxHeight = '160px';
    img.style.borderRadius = '8px'; img.style.objectFit = 'cover';
    a.appendChild(img); grid.appendChild(a);
  }

  function addVideo(u){
    var v = document.createElement('video');
    v.src = u + '?v={{ bk.updated_at.timestamp() if bk.updated_at else 0 }}';
    v.controls = true;
    v.style.maxWidth = '320px'; v.style.maxHeight = '220px'; v.style.borderRadius = '8px';
    grid.appendChild(v);
  }

  function render(urls){
    if (!Array.isArray(urls)) urls = [];
    urls.forEach(function(u){ isVideo(u) ? addVideo(u) : addImg(u); });
    countEl.textContent = urls.length;
    emptyEl.style.display = urls.length ? 'none' : '';
  }

  // 1) حاول أولاً القيم القادمة من السيرفر (evidence أو ev_list)
  var fromServer = Array.isArray(serverEvidence) && serverEvidence.length ? serverEvidence
                 : (Array.isArray(serverEvList) && serverEvList.length ? serverEvList : null);

  if (fromServer){
    render(fromServer);
  } else {
    // 2) لو لا يوجد، اجلبها من API التشخيصي
    var id = {{ bk.id }};
    fetch('/debug/evidence/' + id, {credentials:'include'})
      .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
      .then(function(data){ render((data && data.urls) ? data.urls : []); })
      .catch(function(){ render([]); });
  }
})();
</script>
{% endblock %}