{% extends "base.html" %}
{% block title %}قضية وديعة #{{ bk.id }}{% endblock %}

{% block content %}
<div class="container">
  <h2>قضية وديعة #{{ bk.id }}</h2>

  <div class="card" style="padding:16px;margin-bottom:16px;">
    <div><b>العنصر:</b> {{ (item.title if item else "—") }}</div>
    <div><b>المالك:</b> #{{ bk.owner_id }} — <b>المستأجر:</b> #{{ bk.renter_id }}</div>
    <div><b>حالة الحجز:</b> {{ bk.status }} — <b>حالة الوديعة:</b> {{ bk.deposit_status }}</div>
    {% if bk.owner_return_note %}
      <div style="margin-top:8px;"><b>ملاحظة المالك:</b><br>{{ (bk.owner_return_note or "") | replace('\n','<br>') | safe }}</div>
    {% endif %}
  </div>

  <h3>الأدلة المرفوعة</h3>

<div class="card" style="padding:8px;margin-bottom:10px;">
  <div style="font-size:13px;">
    Evidence debug — count: <b>{{ ev_list|length if ev_list is defined else 0 }}</b>
  </div>
  {% if ev_list is defined %}
    <pre style="white-space:pre-wrap;max-height:120px;overflow:auto;margin:6px 0 0;">
{{ ev_list }}
    </pre>
  {% endif %}
</div>

{% if ev_list is defined and (ev_list|length) > 0 %}
  <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
    {% for url in ev_list %}
      {% set lower = (url or '')|lower %}
      {% if lower.endswith('.mp4') or lower.endswith('.mov') or lower.endswith('.m4v') or lower.endswith('.avi') or lower.endswith('.wmv') %}
        <video src="{{ url }}?v={{ bk.updated_at.timestamp() if bk.updated_at }}" controls
               style="max-width:320px;max-height:220px;border-radius:8px;"></video>
      {% else %}
        <a href="{{ url }}" target="_blank" style="display:inline-block;">
          <img src="{{ url }}?v={{ bk.updated_at.timestamp() if bk.updated_at }}"
               alt="evidence"
               style="max-width:220px;max-height:160px;border-radius:8px;object-fit:cover;">
        </a>
      {% endif %}
    {% endfor %}
  </div>
{% else %}
  <p class="muted">لا توجد ملفات أدلة.</p>
{% endif %}
  </div>

  {% set ev_list = evidence|default([]) %}
  {% if ev_list and (ev_list|length) > 0 %}
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
      {% for url in ev_list %}
        {% set u = (url or '') %}
        {% set lower = u|lower %}
        {% if lower.endswith('.mp4') or lower.endswith('.mov') or lower.endswith('.m4v') or lower.endswith('.avi') or lower.endswith('.wmv') %}
          <video src="{{ u }}" controls style="max-width:320px;max-height:220px;border-radius:8px;"></video>
        {% elif lower.endswith('.jpg') or lower.endswith('.jpeg') or lower.endswith('.png') or lower.endswith('.webp') or lower.endswith('.gif') or lower.endswith('.heic') or lower.endswith('.heif') or lower.endswith('.bmp') or lower.endswith('.tiff') %}
          <a href="{{ u }}" target="_blank" style="display:inline-block;">
            <img src="{{ u }}" alt="evidence" loading="lazy"
                 style="max-width:220px;max-height:160px;border-radius:8px;object-fit:cover;">
          </a>
        {% else %}
          <!-- أي ملف غير صورة/فيديو: نظهره كرابط -->
          <a href="{{ u }}" target="_blank" class="btn btn-outline" style="padding:6px 10px;">
            ملف: {{ u.split('/')[-1] }}
          </a>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">لا توجد ملفات أدلة.</p>
  {% endif %}

  <form action="/dm/deposits/{{ bk.id }}/decision" method="post" class="card" style="padding:16px;gap:12px;">
    <h3 style="margin-top:0;">اتخاذ القرار النهائي</h3>

    <label>نوع القرار</label>
    <select name="decision" required>
      <option value="">— اختر —</option>
      <option value="release">رد كامل الوديعة</option>
      <option value="withhold">اقتطاع من الوديعة</option>
    </select>

    <label>المبلغ الجزئي (إن وجد)</label>
    <input name="amount" type="number" min="0" step="1" value="0" />

    <label>السبب/التفاصيل</label>
    <textarea name="reason" rows="3" placeholder="اكتب سبب القرار…"></textarea>

    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <a class="btn btn-secondary" href="/dm/deposits">رجوع</a>
      <button class="btn btn-success" type="submit">تنفيذ القرار</button>
    </div>
  </form>

  <form action="/dm/deposits/{{ bk.id }}/claim" method="post" style="margin-top:12px;">
    <button class="btn btn-outline">استلام القضية (اختياري)</button>
  </form>
</div>
{% endblock %}