{% extends "base.html" %}
{% block title %}قضية وديعة #{{ bk.id }}{% endblock %}

{% block content %}
<div class="container">
  <h2>قضية وديعة #{{ bk.id }}</h2>

  {# ==== تنبيه نجاح عند بدء المهلة (?started=1) ==== #}
  {% if request.query_params.get('started') in ['1', 'true', 'yes'] %}
    <div id="start-ok" class="card"
         style="padding:12px;margin-bottom:16px;border-left:6px solid #2ecc71;background:#ecfff1;">
      <div style="font-weight:700;margin-bottom:4px;">تم تفعيل مهلة ردّ المستأجر</div>
      <div>
        تم إرسال إشعار إلى المستأجر لرفع الأدلة. إذا لم يرد خلال 24 ساعة سيتم تنفيذ القرار تلقائيًا.
      </div>
    </div>
    <script>
      (function () {
        setTimeout(function(){ var el = document.getElementById('start-ok'); if (el) el.style.display='none'; }, 6000);
        try {
          var url = new URL(window.location.href);
          if (url.searchParams.has('started')) {
            url.searchParams.delete('started');
            var q = url.searchParams.toString();
            window.history.replaceState({}, document.title, url.pathname + (q ? '?' + q : '') + url.hash);
          }
        } catch(e){}
      })();
    </script>
  {% endif %}

  <!-- معلومات عامة -->
  <div class="card" style="padding:16px;margin-bottom:16px;">
    <div><b>العنصر:</b> {{ (item.title if item else "—") }}</div>
    <div><b>المالك:</b> #{{ bk.owner_id }} — <b>المستأجر:</b> #{{ bk.renter_id }}</div>
    <div><b>حالة الحجز:</b> {{ bk.status }} — <b>حالة الوديعة:</b> {{ bk.deposit_status }}</div>

    {% if bk.owner_return_note %}
      <div style="margin-top:8px;">
        <b>ملاحظة المالك:</b><br>
        {{ (bk.owner_return_note or "") | replace('\n','<br>') | safe }}
      </div>
    {% endif %}

    {% if bk.renter_response_text %}
      <div style="margin-top:8px;">
        <b>ملاحظة/رد المستأجر:</b><br>
        {{ (bk.renter_response_text or "") | replace('\n','<br>') | safe }}
      </div>
    {% endif %}
  </div>

  <!-- إشعار حالة الانتظار يظهر فقط إذا لا يوجد رد من المستأجر حتى الآن -->
  {% if (bk.deposit_status or '') == 'awaiting_renter' and not (has_renter_reply or false) %}
    <div class="card" style="padding:12px;margin-bottom:16px;border-left:6px solid #6f42c1;">
      <div style="font-weight:700;margin-bottom:6px;">تم إشعار المستأجر وتفعيل تنفيذ القرار تلقائيًا</div>
      <div>لدى المستأجر مهلة للرد حتى:
        <b>
          {% if bk.renter_response_deadline_at %}
            {{ bk.renter_response_deadline_at }}
          {% else %}
            —
          {% endif %}
        </b>.
        بعد انتهاء المهلة ينفَّذ القرار تلقائيًا إن لم يرد.
      </div>
    </div>
  {% endif %}

  <!-- الأدلة (مفصولة حسب الجهة) -->
  <h3>الأدلة المرفوعة</h3>

  <div class="card" style="padding:12px;margin-bottom:12px;">
    <div style="display:flex;gap:16px;flex-wrap:wrap;">
      <!-- أدلة المالك -->
      <div style="flex:1 1 360px;min-width:320px;">
        <h4 style="margin-top:0;">أدلة المالك</h4>
        <div style="font-size:13px;">Owner — <b id="ev-owner-count">0</b></div>
        <div id="ev-owner-grid" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;"></div>
        <div id="ev-owner-empty" class="muted" style="margin-top:8px;">لا توجد أدلة للمالك.</div>
      </div>

      <!-- أدلة المستأجر -->
      <div style="flex:1 1 360px;min-width:320px;">
        <h4 style="margin-top:0;">أدلة المستأجر</h4>
        <div style="font-size:13px;">Renter — <b id="ev-renter-count">0</b></div>
        <div id="ev-renter-grid" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;"></div>
        <div id="ev-renter-empty" class="muted" style="margin-top:8px;">لا توجد أدلة للمستأجر.</div>
      </div>
    </div>
  </div>

  <!-- نموذج القرار (لـ DM) -->
  <form id="dm-decision-form" action="/dm/deposits/{{ bk.id }}/decision" method="post" class="card" style="padding:16px;gap:12px;">
    <h3 style="margin-top:0;">اتخاذ القرار النهائي</h3>

    <label>نوع القرار</label>
    <select id="decision" name="decision" required>
      <option value="">— اختر —</option>
      <option value="release">رد كامل الوديعة</option>
      <option value="withhold">اقتطاع من الوديعة</option>
    </select>

    <label>المبلغ الجزئي (إن وجد)</label>
    <input id="amount" name="amount" type="number" min="0" step="1" value="0" />

    <label>السبب/التفاصيل</label>
    <textarea id="reason" name="reason" rows="3" placeholder="اكتب سبب القرار…"></textarea>

    <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
      <a class="btn btn-secondary" href="/dm/deposits">رجوع</a>

      <!-- زر تنفيذ القرار التقليدي -->
      <button class="btn btn-success" type="submit">تنفيذ القرار</button>

      <!-- نعرض أحد الزرين حسب الحالة (يُضبط بالـJS أيضًا) -->
      <button id="btn-start-window" class="btn" type="button"
              style="background:#6f42c1;color:#fff;border-radius:10px;display:none;">
        بدء مهلة الرد 24h وإشعار المستأجر
      </button>

      <button id="btn-finalize-now" class="btn" type="button"
              style="background:#6f42c1;color:#fff;border-radius:10px;display:none;">
        اتخاذ القرار النهائي الآن
      </button>
    </div>

    <div id="hint-text" class="muted" style="margin-top:10px;font-size:12px;"></div>
  </form>

  <!-- استلام القضية -->
  <form action="/dm/deposits/{{ bk.id }}/claim" method="post" style="margin-top:12px;">
    <button class="btn btn-outline">استلام القضية (اختياري)</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // ===== متغيرات من السيرفر =====
  const serverEvidence = {{ evidence|tojson if evidence is defined else 'null' }};
  const serverEvList   = {{ ev_list|tojson   if ev_list   is defined else 'null' }};
  const hasRenterReplyServer = {{ 'true' if (has_renter_reply or false) else 'false' }};
  var bkId = {{ bk.id }};

  // ===== عناصر DOM لقسم المالك والمستأجر =====
  var ownerGrid    = document.getElementById('ev-owner-grid');
  var ownerCountEl = document.getElementById('ev-owner-count');
  var ownerEmptyEl = document.getElementById('ev-owner-empty');

  var renterGrid    = document.getElementById('ev-renter-grid');
  var renterCountEl = document.getElementById('ev-renter-count');
  var renterEmptyEl = document.getElementById('ev-renter-empty');

  // ===== أزرار القرار =====
  var btnStart    = document.getElementById('btn-start-window');
  var btnFinalize = document.getElementById('btn-finalize-now');
  var form        = document.getElementById('dm-decision-form');
  var selDecision = document.getElementById('decision');
  var amount      = document.getElementById('amount');
  var hintText    = document.getElementById('hint-text');

  function isVideoUrl(url){
    var s = (url || '').toLowerCase();
    return s.endsWith('.mp4') || s.endsWith('.mov') || s.endsWith('.m4v') ||
           s.endsWith('.avi') || s.endsWith('.wmv') || s.endsWith('.webm');
  }
  function addImg(grid, url){
    var a = document.createElement('a');
    a.href = url; a.target = '_blank'; a.style.display = 'inline-block';
    var img = document.createElement('img');
    img.src = url + '?v={{ bk.updated_at.timestamp() if bk.updated_at else 0 }}';
    img.alt = 'evidence'; img.loading = 'lazy';
    img.style.maxWidth = '220px'; img.style.maxHeight = '160px';
    img.style.borderRadius = '8px'; img.style.objectFit = 'cover';
    a.appendChild(img); grid.appendChild(a);
  }
  function addVideo(grid, url){
    var v = document.createElement('video');
    v.src = url + '?v={{ bk.updated_at.timestamp() if bk.updated_at else 0 }}';
    v.controls = true;
    v.style.maxWidth = '320px'; v.style.maxHeight = '220px'; v.style.borderRadius = '8px';
    grid.appendChild(v);
  }
  function addNote(grid, text){
    var d = document.createElement('div');
    d.className = 'card';
    d.style.padding = '10px';
    d.style.maxWidth = '360px';
    d.style.whiteSpace = 'pre-wrap';
    d.textContent = text || '—';
    grid.appendChild(d);
  }
  function incCount(el, emptyEl, by){
    var cur = parseInt(el.textContent || '0', 10);
    el.textContent = cur + by;
    emptyEl.style.display = (cur + by) > 0 ? 'none' : '';
  }

  // توزيع عنصر واحد حسب الجهة
  function renderOne(ev){
    var side = (ev && ev.side) ? (''+ev.side).toLowerCase() : '';
    var file = ev && ev.file ? ev.file : '';
    var kind = (ev && ev.kind) || '';
    var desc = (ev && ev.description) || '';

    var grid, cnt, empty;
    if (side === 'renter'){
      grid = renterGrid; cnt = renterCountEl; empty = renterEmptyEl;
    } else if (side === 'owner'){
      grid = ownerGrid; cnt = ownerCountEl; empty = ownerEmptyEl;
    } else {
      // لو غير معروف (manager/قديم) نضعه في قسم المالك حتى لا يختلط
      grid = ownerGrid; cnt = ownerCountEl; empty = ownerEmptyEl;
    }

    if (kind === 'note' && !file){
      addNote(grid, desc); incCount(cnt, empty, 1); return (side === 'renter');
    } else if (file){
      if (isVideoUrl(file)) addVideo(grid, file); else addImg(grid, file);
      incCount(cnt, empty, 1); return (side === 'renter');
    }
    return false;
  }

  // JSON من الـAPI
  var renterSeen = false;
  function renderFromJson(items){
    items = Array.isArray(items) ? items : [];
    items.forEach(function(ev){
      var isRenterItem = renderOne(ev);
      if (isRenterItem) renterSeen = true;
    });
  }

  // روابط قديمة من مجلد /uploads (بدون side) → نعتبرها للمالك
  function renderLegacyUrls(urls){
    if (!Array.isArray(urls)) urls = [];
    urls.forEach(function(u){
      if (isVideoUrl(u)) addVideo(ownerGrid, u); else addImg(ownerGrid, u);
    });
    incCount(ownerCountEl, ownerEmptyEl, urls.length);
  }

  // تبديل الأزرار بحسب وجود رد للمستأجر
  function toggleButtons(hasRenterReply){
    if (hasRenterReply){
      if (btnStart)    btnStart.style.display    = 'none';
      if (btnFinalize) btnFinalize.style.display = '';
      if (hintText)    hintText.textContent = 'بعد وصول ردّ المستأجر يمكنك اتخاذ القرار النهائي مباشرة.';
    } else {
      if (btnStart)    btnStart.style.display    = '';
      if (btnFinalize) btnFinalize.style.display = 'none';
      if (hintText)    hintText.textContent = 'زر “بدء مهلة الرد 24h” يثبت القرار على “اقتطاع من الوديعة” ويضبط المهلة 24 ساعة ويُرسل إشعارًا للمستأجر.';
    }
  }

  // أولاً اضبط الحالة المبدئية من السيرفر
  toggleButtons(Boolean(hasRenterReplyServer));

  // 1) جلب الأدلة من قاعدة البيانات (تشمل side)
  fetch('/deposits/' + bkId + '/evidence', {credentials:'include'})
    .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
    .then(function(data){ renderFromJson(data && data.items); })
    .catch(function(){ /* تجاهل */ })
    .finally(function(){
      // 2) دمج أدلة قديمة (بدون side) — توضع كأدلة مالك
      var fromServer = Array.isArray(serverEvidence) && serverEvidence.length ? serverEvidence
                     : (Array.isArray(serverEvList) && serverEvList.length ? serverEvList : null);
      if (fromServer){ renderLegacyUrls(fromServer); }
      else {
        fetch('/debug/evidence/' + bkId, {credentials:'include'})
          .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
          .then(function(d){ renderLegacyUrls((d && d.urls) ? d.urls : []); })
          .catch(function(){ /* لا شيء */ });
      }

      // 3) بعد العرض: إن وُجد عنصر للمستأجر من JSON نبدّل الأزرار فورًا
      if (renterSeen) toggleButtons(true);
    });

  // ===== أحداث الأزرار =====
  if (btnStart && form && selDecision && amount){
    btnStart.addEventListener('click', function(){
      var amt = parseInt(amount.value || '0', 10);
      if (isNaN(amt) || amt <= 0){
        alert('ضع مبلغ الخصم أولًا (أكبر من صفر) قبل بدء مهلة الرد.');
        amount.focus(); return;
      }
      selDecision.value = 'withhold';
      form.action = '/dm/deposits/{{ bk.id }}/start-window';
      form.submit();
    });
  }

  if (btnFinalize && form){
    btnFinalize.addEventListener('click', function(){
      form.action = '/dm/deposits/{{ bk.id }}/decision';
      form.submit();
    });
  }
})();
</script>
{% endblock %}