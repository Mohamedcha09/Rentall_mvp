{# app/templates/dm_case.html #}
{% extends "base.html" %}
{% block title %}Ù‚Ø¶ÙŠØ© ÙˆØ¯ÙŠØ¹Ø© â€” #{{ bk.id }}{% endblock %}

{% block head %}
<style>
  .case-wrap{max-width:1100px;margin:auto}
  .box{border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:14px;background:#fff}
  .muted{opacity:.65}
  .grid{display:grid;gap:10px}
  .grid-ev{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .thumb{width:100%;aspect-ratio:1/1;border-radius:10px;object-fit:cover;border:1px solid var(--border,#e5e7eb)}
  .chip{padding:.35rem .6rem;border:1px solid var(--border,#e5e7eb);border-radius:999px}
  .k{opacity:.7}
  .acts form{display:inline}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .alert-mini{padding:.6rem .8rem}
  .locked{position:relative;opacity:.6;pointer-events:none}
  .locked::after{
    content:"Ø§Ù„Ù‚Ø¶ÙŠØ© Ù…ØºÙ„Ù‚Ø© â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§";
    position:absolute;inset:0;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,.6);backdrop-filter:saturate(0.6) blur(2px);
    font-weight:600;color:#444;border-radius:12px
  }
</style>
{% if bk.renter_response_deadline_at %}
  <script defer src="/static/js/countdown.js"></script>
{% endif %}
{% endblock %}

{% block content %}
{# Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ù‚Ø¶ÙŠØ© â€œÙ…Ù‚ÙÙ„Ø©â€ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø¬Ø² Ù…ØºÙ„Ù‚Ø§Ù‹ Ø£Ùˆ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹/Ø§Ù‚ØªØ·Ø§Ø¹ Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ #}
{% set is_locked = (bk.status in ['closed','completed']) 
                    or (bk.deposit_status in ['refunded','partially_withheld','no_deposit']) 
                    or (bk.dm_decision in ['release','withhold'] and bk.dm_decision_at) %}

<div class="case-wrap">
  <div class="d-flex justify-content-between align-items-start flex-wrap mb-2">
    <div class="mb-2">
      <h4 class="mb-1">Ù‚Ø¶ÙŠØ© ÙˆØ¯ÙŠØ¹Ø© â€” Ø­Ø¬Ø² #{{ bk.id }}</h4>
      <div class="k">
        Ø§Ù„Ø¹Ù†ØµØ±:
        {% if item %}
          <strong>{{ item.title }}</strong> â€” <a href="/items/{{ item.id }}" target="_blank">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ù†ØµØ±</a>
        {% else %}
          â€”
        {% endif %}
      </div>
      <div class="k">Ø§Ù„ÙØªØ±Ø©: {{ bk.start_date }} â†’ {{ bk.end_date }} ({{ bk.days }} ÙŠÙˆÙ…)</div>
    </div>
    <div class="d-flex flex-column align-items-end gap-1">
      <span class="chip">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²: {{ bk.status or 'â€”' }}</span>
      <span class="chip">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ¯ÙŠØ¹Ø©: {{ bk.deposit_status or 'â€”' }}</span>
      {% if is_locked %}
        <span class="chip" style="background:#f8f9fa">ğŸ”’ Ù…ØºÙ„Ù‚Ø©</span>
      {% endif %}
    </div>
  </div>

  <div class="grid" style="grid-template-columns: 1fr 360px;">
    <!-- ÙŠØ³Ø§Ø±: ØªÙØ§ØµÙŠÙ„ Ùˆ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
    <div class="grid">

      {# ===== Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø§Ù„Ùƒ + Ø£Ø¯Ù„ØªÙ‡ ===== #}
      {% if bk.owner_report_type or bk.owner_report_reason or (bk.deposit_evidences and bk.deposit_evidences|length) %}
        <div class="box mb-3">
          <div class="d-flex align-items-center gap-2 mb-2">
            <i class="bi bi-exclamation-octagon"></i>
            <h6 class="m-0">Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø§Ù„Ùƒ</h6>
          </div>

          <div class="mb-1">
            <div class="k">Ø§Ù„Ù†ÙˆØ¹:</div>
            <div class="fw-semibold">{{ bk.owner_report_type or 'â€”' }}</div>
          </div>

          {% if bk.owner_report_reason %}
            <div class="mb-2">
              <div class="k">Ø§Ù„ÙˆØµÙ:</div>
              <div style="white-space:pre-wrap">{{ bk.owner_report_reason }}</div>
            </div>
          {% endif %}

          {% if bk.deposit_evidences and bk.deposit_evidences|length %}
            {% set owner_evs = bk.deposit_evidences | selectattr('side','equalto','owner') | list %}
            {% if owner_evs and owner_evs|length %}
              <div class="d-flex flex-wrap" style="gap:8px">
                {% for ev in owner_evs[:6] %}
                  {% if ev.kind == 'video' or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
                    <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                      <video src="{{ ev.file_path }}" muted
                             style="width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border)"></video>
                    </a>
                  {% else %}
                    <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                      <img src="{{ ev.file_path }}"
                           style="width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border)"/>
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯Ù„Ø© Ù…Ø±ÙÙˆØ¹Ø© Ø¨Ø¹Ø¯.</div>
            {% endif %}
          {% else %}
            <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯Ù„Ø© Ù…Ø±ÙÙˆØ¹Ø© Ø¨Ø¹Ø¯.</div>
          {% endif %}
        </div>
      {% endif %}

      {# ===== Ø£Ø¯Ù„Ø© Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ===== #}
      <div class="box mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-person-bounding-box"></i>
          <h6 class="m-0">Ø£Ø¯Ù„Ø© Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</h6>
        </div>
        {% set renter_evs = bk.deposit_evidences | selectattr('side','equalto','renter') | list %}
        {% if renter_evs and renter_evs|length %}
          <div class="d-flex flex-wrap" style="gap:8px">
            {% for ev in renter_evs[:12] %}
              {% set _is_video = (ev.kind == 'video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                {% if _is_video %}
                  <video src="{{ ev.file_path }}" muted
                         style="width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border)"></video>
                {% else %}
                  <img src="{{ ev.file_path }}"
                       style="width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border)" />
                {% endif %}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯Ù„Ø© Ù…Ø±ÙÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
        {% endif %}
      </div>

      {# ===== Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª DM ===== #}
      <div class="box {% if is_locked %}locked{% endif %}">
        <h6 class="mb-3"><i class="bi bi-hammer me-1"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…ØªØ­ÙƒÙ‘Ù… Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© (DM)</h6>

        {% if not is_locked and bk.deposit_status == 'awaiting_renter' and bk.renter_response_deadline_at %}
          <div class="alert alert-info alert-mini mb-3">
            Ù†Ø§ÙØ°Ø© Ø±Ø¯Ù‘ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…ÙØªÙˆØ­Ø© â€” Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù‡Ù„Ø© Ø¥Ù† Ù„Ù… ÙŠØ±Ø¯Ù‘.
            <div class="mt-1 mono">
              ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ:
              <span id="deadlineCountdown">{{ bk.renter_response_deadline_at }}</span>
            </div>
          </div>
        {% endif %}

        {% if not is_locked %}
          <div class="acts mb-2">
            <!-- ÙØªØ­ Ù†Ø§ÙØ°Ø© 24h -->
            <form method="post" action="/dm/deposits/{{ bk.id }}/start-window" class="d-inline-block js-confirm-window">
              <div class="row g-2 align-items-end">
                <div class="col-auto">
                  <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº (CAD)</label>
                  <input class="form-control" type="number" name="amount" min="1" step="1" required>
                </div>
                <div class="col-auto">
                  <label class="form-label">Ø§Ù„Ø³Ø¨Ø¨</label>
                  <input class="form-control" type="text" name="reason" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±" />
                </div>
                <div class="col-auto">
                  <button class="btn btn-warning">
                    <i class="bi bi-hourglass-split"></i> ÙØªØ­ Ù…Ù‡Ù„Ø© 24h
                  </button>
                </div>
              </div>
            </form>
          </div>

          <div class="acts mb-2">
            <!-- Ø®ØµÙ… Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ø¢Ù† -->
            <form method="post" action="/dm/deposits/{{ bk.id }}/decision" class="d-inline-block js-confirm-final-withhold">
              <input type="hidden" name="decision" value="withhold">
              <input type="hidden" name="finalize" value="1">
              <div class="row g-2 align-items-end">
                <div class="col-auto">
                  <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº (CAD)</label>
                  <input class="form-control" type="number" name="amount" min="1" step="1" required>
                </div>
                <div class="col-auto">
                  <label class="form-label">Ø§Ù„Ø³Ø¨Ø¨</label>
                  <input class="form-control" type="text" name="reason" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±" />
                </div>
                <div class="col-auto">
                  <button class="btn btn-danger">
                    <i class="bi bi-shield-shaded"></i> Ø®ØµÙ… Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ø¢Ù†
                  </button>
                </div>
              </div>
            </form>
          </div>

          <div class="acts">
            <!-- Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„ -->
            <form method="post" action="/dm/deposits/{{ bk.id }}/decision" class="js-confirm-final-release">
              <input type="hidden" name="decision" value="release">
              <button class="btn btn-outline-success">
                <i class="bi bi-check2-circle"></i> Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
              </button>
            </form>
          </div>
        {% else %}
          <div class="alert alert-secondary m-0">
            ØªÙ… Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø¶ÙŠØ© â€” ÙŠÙ…ÙƒÙ† Ù…Ø±Ø§Ù‚Ø¨ØªÙ‡Ø§ ÙÙ‚Ø·.
          </div>
        {% endif %}
      </div>

      <!-- Ù„ÙˆØ¬ Ù…Ø®ØªØµØ± -->
      <div class="box">
        <h6 class="mb-2"><i class="bi bi-journal-text me-1"></i> Ù…Ù„Ø®Øµ ØªÙ‚Ù†ÙŠ</h6>
        <div class="mono small k">
          deposit_status={{ bk.deposit_status }} |
          dm_decision={{ bk.dm_decision }} |
          dm_amount={{ bk.dm_decision_amount }} |
          renter_deadline={{ bk.renter_response_deadline_at }}
        </div>
      </div>
    </div>

    <!-- ÙŠÙ…ÙŠÙ†: Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ ÙˆØ¹Ø§Ù… -->
    <div class="grid">
      <div class="box">
        <h6 class="mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙØ¹</h6>
        <div class="d-flex justify-content-between"><span>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</span><strong>{{ bk.payment_method or 'â€”' }}</strong></div>
        <div class="d-flex justify-content-between"><span>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</span><strong>{{ bk.rent_amount or bk.total_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ø§Ù„Ù…Ø­ØªØ¬Ø²Ø©</span><strong>{{ bk.hold_deposit_amount or bk.deposit_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ·Ø¹</span><strong>{{ bk.deposit_charged_amount or 0 }}$</strong></div>
        <hr>
        <div class="k mono small">
          {% if bk.accepted_at %}accepted_at: {{ bk.accepted_at }}<br>{% endif %}
          {% if bk.picked_up_at %}picked_up_at: {{ bk.picked_up_at }}<br>{% endif %}
          {% if bk.returned_at %}returned_at: {{ bk.returned_at }}<br>{% endif %}
          {% if bk.dm_decision_at %}dm_decision_at: {{ bk.dm_decision_at }}<br>{% endif %}
        </div>
      </div>

      {% if item %}
      <div class="box">
        <h6 class="mb-2">Ø§Ù„Ø¹Ù†ØµØ±</h6>
        <div class="d-flex gap-3">
          <img src="{{ (('/' ~ item.image_path) if item.image_path and item.image_path[0] != '/' else (item.image_path or '/static/placeholder.jpg')) }}"
               style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
          <div>
            <div class="fw-bold">{{ item.title }}</div>
            <div class="k">{{ category_label(item.category) if item and item.category else 'â€”' }}</div>
            <div class="k">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ: {{ item.price_per_day }}$</div>
            <a class="small" href="/items/{{ item.id }}" target="_blank">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ù†ØµØ±</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% if bk.renter_response_deadline_at %}
<script>
  try{
    if(window.initCountdown){
      initCountdown('deadlineCountdown','{{ bk.renter_response_deadline_at }}');
    }else{
      var el = document.getElementById('deadlineCountdown');
      if(el){ el.textContent = new Date('{{ bk.renter_response_deadline_at }}').toLocaleString(); }
    }
  }catch(e){}
</script>
{% endif %}

<script>
  // ØªØ£ÙƒÙŠØ¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  (function(){
    const q = sel => document.querySelector(sel);

    const confirmWithhold = q('.js-confirm-final-withhold');
    if (confirmWithhold){
      confirmWithhold.addEventListener('submit', function(ev){
        const amt = this.querySelector('input[name="amount"]').value || 0;
        const reason = this.querySelector('input[name="reason"]').value || '';
        const ok = confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ø¢Ù† Ø¨Ù…Ø¨Ù„Øº ${amt} CADØŸ` + (reason ? `\nØ§Ù„Ø³Ø¨Ø¨: ${reason}` : ''));
        if(!ok){ ev.preventDefault(); }
      });
    }

    const confirmRelease = q('.js-confirm-final-release');
    if (confirmRelease){
      confirmRelease.addEventListener('submit', function(ev){
        const ok = confirm('ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØ¯ÙŠØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¢Ù†ØŸ');
        if(!ok){ ev.preventDefault(); }
      });
    }

    const confirmWindow = q('.js-confirm-window');
    if (confirmWindow){
      confirmWindow.addEventListener('submit', function(ev){
        const amt = this.querySelector('input[name="amount"]').value || 0;
        const reason = this.querySelector('input[name="reason"]').value || '';
        const ok = confirm(`ÙØªØ­ Ù…Ù‡Ù„Ø© 24 Ø³Ø§Ø¹Ø© Ù„Ø§Ù‚ØªØ·Ø§Ø¹ ${amt} CADØŸ` + (reason ? `\nØ§Ù„Ø³Ø¨Ø¨: ${reason}` : ''));
        if(!ok){ ev.preventDefault(); }
      });
    }
  })();
</script>
{% endblock %}
