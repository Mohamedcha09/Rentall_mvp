{# app/templates/dm_case.html ‚Äî Full version after the split (Pickup/Return/Other) #}
{% extends "base.html" %}
{% block title %}Deposit Case ‚Äî #{{ bk.id }}{% endblock %}

{% block head %}
<style>
  .case-wrap{max-width:1100px;margin:auto}
  .box{border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:14px;background:#fff}
  .muted{opacity:.65}
  .grid{display:grid;gap:10px}
  .thumb{width:100%;aspect-ratio:1/1;border-radius:10px;object-fit:cover;border:1px solid var(--border,#e5e7eb)}
  .chip{padding:.35rem .6rem;border:1px solid var(--border,#e5e7eb);border-radius:999px}
  .k{opacity:.7}
  .acts form{display:inline}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .alert-mini{padding:.6rem .8rem}
  .locked{position:relative;opacity:.6;pointer-events:none}
  .locked::after{
    content:"Case is closed ‚Äî no edits allowed";
    position:absolute;inset:0;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,.6);backdrop-filter:saturate(0.6) blur(2px);
    font-weight:600;color:#444;border-radius:12px
  }
  .ev-grid{display:flex;flex-wrap:wrap;gap:8px}
  .ev-thumb{width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
</style>
{% if bk.renter_response_deadline_at %}
  <script defer src="/static/js/countdown.js"></script>
{% endif %}
{% endblock %}

{% block content %}
{# Consider the case ‚Äúlocked‚Äù if the booking is closed or if the deposit was returned/charged finally #}
{% set is_locked = (bk.status in ['closed','completed'])
                    or (bk.deposit_status in ['refunded','partially_withheld','no_deposit'])
                    or (bk.dm_decision in ['release','withhold'] and bk.dm_decision_at) %}

<div class="case-wrap">
  <div class="d-flex justify-content-between align-items-start flex-wrap mb-2">
    <div class="mb-2">
      <h4 class="mb-1">Deposit Case ‚Äî Booking #{{ bk.id }}</h4>
      <div class="k">
        Item:
        {% if item %}
          <strong>{{ item.title }}</strong> ‚Äî <a href="/items/{{ item.id }}" target="_blank">Open item page</a>
        {% else %} ‚Äî {% endif %}
      </div>
      <div class="k">Period: {{ bk.start_date }} ‚Üí {{ bk.end_date }} ({{ bk.days }} days)</div>
    </div>
    <div class="d-flex flex-column align-items-end gap-1">
      <span class="chip">Booking status: {{ bk.status or '‚Äî' }}</span>
      <span class="chip">Deposit status: {{ bk.deposit_status or '‚Äî' }}</span>
      {% if is_locked %}<span class="chip" style="background:#f8f9fa">üîí Closed</span>{% endif %}
    </div>
  </div>

  <div class="grid" style="grid-template-columns: 1fr 360px;">
    <!-- Left: Details & Actions -->
    <div class="grid">

      {# ===== Owner report + evidence ===== #}
      {% if bk.owner_report_type or bk.owner_report_reason or (bk.deposit_evidences and bk.deposit_evidences|length) %}
      <div class="box mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-exclamation-octagon"></i>
          <h6 class="m-0">Owner Report</h6>
        </div>

        <div class="mb-1">
          <div class="k">Type:</div>
          <div class="fw-semibold">{{ bk.owner_report_type or '‚Äî' }}</div>
        </div>

        {% if bk.owner_report_reason %}
        <div class="mb-2">
          <div class="k">Description:</div>
          <div style="white-space:pre-wrap">{{ bk.owner_report_reason }}</div>
        </div>
        {% endif %}

        {% set owner_evs = bk.deposit_evidences | selectattr('side','equalto','owner') | list %}
        {% if owner_evs and owner_evs|length %}
          <div class="ev-grid">
            {% for ev in owner_evs[:6] %}
              {% set _is_video = (ev.kind == 'video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                {% if _is_video %}
                  <video src="{{ ev.file_path }}" muted class="ev-thumb"></video>
                {% else %}
                  <img src="{{ ev.file_path }}" class="ev-thumb"/>
                {% endif %}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">No evidence uploaded yet.</div>
        {% endif %}
      </div>
      {% endif %}

      {# ===== Renter evidence ‚Äî at pickup ===== #}
      <div class="box mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-person-bounding-box"></i>
          <h6 class="m-0">Renter Evidence ‚Äî at Pickup</h6>
        </div>
        {% if renter_pickup and renter_pickup|length %}
          <div class="ev-grid">
            {% for ev in renter_pickup[:12] %}
              {% set _is_video = (ev.kind == 'video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                {% if _is_video %}
                  <video src="{{ ev.file_path }}" muted class="ev-thumb"></video>
                {% else %}
                  <img src="{{ ev.file_path }}" class="ev-thumb"/>
                {% endif %}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">No pickup photos from the renter.</div>
        {% endif %}
      </div>

      {# ===== Renter evidence ‚Äî at return ===== #}
      <div class="box mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-arrow-return-left"></i>
          <h6 class="m-0">Renter Evidence ‚Äî at Return</h6>
        </div>
        {% if renter_return and renter_return|length %}
          <div class="ev-grid">
            {% for ev in renter_return[:12] %}
              {% set _is_video = (ev.kind == 'video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                {% if _is_video %}
                  <video src="{{ ev.file_path }}" muted class="ev-thumb"></video>
                {% else %}
                  <img src="{{ ev.file_path }}" class="ev-thumb"/>
                {% endif %}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">No return photos from the renter.</div>
        {% endif %}
      </div>

      {# ===== (Optional) Other renter evidence ===== #}
      {% if renter_other and renter_other|length %}
      <div class="box mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-images"></i>
          <h6 class="m-0">Other Renter Evidence</h6>
        </div>
        <div class="ev-grid">
          {% for ev in renter_other[:12] %}
            {% set _is_video = (ev.kind == 'video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
            <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
              {% if _is_video %}
                <video src="{{ ev.file_path }}" muted class="ev-thumb"></video>
              {% else %}
                <img src="{{ ev.file_path }}" class="ev-thumb"/>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {# ===== DM actions ===== #}
      <div class="box {% if is_locked %}locked{% endif %}">
        <h6 class="mb-3"><i class="bi bi-hammer me-1"></i> Deposit Manager (DM) Actions</h6>

        {% if not is_locked and bk.deposit_status == 'awaiting_renter' and bk.renter_response_deadline_at %}
          <div class="alert alert-info alert-mini mb-3">
            Renter response window is open ‚Äî automatic execution after the deadline if there‚Äôs no response.
            <div class="mt-1 mono">
              Ends at: <span id="deadlineCountdown">{{ bk.renter_response_deadline_at }}</span>
            </div>
          </div>
        {% endif %}

        {% if not is_locked %}
          <div class="acts mb-2">
            <!-- Open 24h window -->
            <form method="post" action="/dm/deposits/{{ bk.id }}/start-window" class="d-inline-block js-confirm-window">
              <div class="row g-2 align-items-end">
                <div class="col-auto">
                  <label class="form-label">Amount (CAD)</label>
                  <input class="form-control" type="number" name="amount" min="1" step="1" required>
                </div>
                <div class="col-auto">
                  <label class="form-label">Reason</label>
                  <input class="form-control" type="text" name="reason" placeholder="Short description">
                </div>
                <div class="col-auto">
                  <button class="btn btn-warning">
                    <i class="bi bi-hourglass-split"></i> Open 24h Window
                  </button>
                </div>
              </div>
            </form>
          </div>

          <div class="acts mb-2">
            <!-- Final withhold now -->
            <form method="post" action="/dm/deposits/{{ bk.id }}/decision" class="d-inline-block js-confirm-final-withhold">
              <input type="hidden" name="decision" value="withhold">
              <input type="hidden" name="finalize" value="1">
              <div class="row g-2 align-items-end">
                <div class="col-auto">
                  <label class="form-label">Amount (CAD)</label>
                  <input class="form-control" type="number" name="amount" min="1" step="1" required>
                </div>
                <div class="col-auto">
                  <label class="form-label">Reason</label>
                  <input class="form-control" type="text" name="reason" placeholder="Short description">
                </div>
                <div class="col-auto">
                  <button class="btn btn-danger">
                    <i class="bi bi-shield-shaded"></i> Final Withhold Now
                  </button>
                </div>
              </div>
            </form>
          </div>

          <div class="acts">
            <!-- Full release -->
            <form method="post" action="/dm/deposits/{{ bk.id }}/decision" class="js-confirm-final-release">
              <input type="hidden" name="decision" value="release">
              <button class="btn btn-outline-success">
                <i class="bi bi-check2-circle"></i> Release Full Deposit
              </button>
            </form>
          </div>
        {% else %}
          <div class="alert alert-secondary m-0">
            The final decision for this case has been issued ‚Äî view only.
          </div>
        {% endif %}
      </div>

      <!-- Short log -->
      <div class="box">
        <h6 class="mb-2"><i class="bi bi-journal-text me-1"></i> Technical Summary</h6>
        <div class="mono small k">
          deposit_status={{ bk.deposit_status }} |
          dm_decision={{ bk.dm_decision }} |
          dm_amount={{ bk.dm_decision_amount }} |
          renter_deadline={{ bk.renter_response_deadline_at }}
        </div>
      </div>
    </div>

    <!-- Right: Financial & general summary -->
    <div class="grid">
      <div class="box">
        <h6 class="mb-2">Payment Summary</h6>
        <div class="d-flex justify-content-between">
          <span>Payment method</span><strong>{{ bk.payment_method or '‚Äî' }}</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>Rent</span><strong>{{ bk.rent_amount or bk.total_amount or 0 }}$</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>Deposit held</span><strong>{{ bk.hold_deposit_amount or bk.deposit_amount or 0 }}$</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>Amount charged</span><strong>{{ bk.deposit_charged_amount or 0 }}$</strong>
        </div>
        <hr>
        <div class="k mono small">
          {% if bk.accepted_at %}accepted_at: {{ bk.accepted_at }}<br>{% endif %}
          {% if bk.picked_up_at %}picked_up_at: {{ bk.picked_up_at }}<br>{% endif %}
          {% if bk.returned_at %}returned_at: {{ bk.returned_at }}<br>{% endif %}
          {% if bk.dm_decision_at %}dm_decision_at: {{ bk.dm_decision_at }}<br>{% endif %}
        </div>
      </div>

      {% if item %}
      <div class="box">
        <h6 class="mb-2">Item</h6>
        <div class="d-flex gap-3">
          <img src="{{ (('/' ~ item.image_path) if item.image_path and item.image_path[0] != '/' else (item.image_path or '/static/placeholder.jpg')) }}"
               style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
          <div>
            <div class="fw-bold">{{ item.title }}</div>
            <div class="k">{{ category_label(item.category) if item and item.category else '‚Äî' }}</div>
            <div class="k">Daily price: {{ item.price_per_day }}$</div>
            <a class="small" href="/items/{{ item.id }}" target="_blank">Open item page</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% if bk.renter_response_deadline_at %}
<script>
  try{
    if(window.initCountdown){
      initCountdown('deadlineCountdown','{{ bk.renter_response_deadline_at }}');
    }else{
      var el = document.getElementById('deadlineCountdown');
      if(el){ el.textContent = new Date('{{ bk.renter_response_deadline_at }}').toLocaleString(); }
    }
  }catch(e){}
</script>
{% endif %}

<script>
  // Confirmations before final actions
  (function(){
    const q = sel => document.querySelector(sel);

    const confirmWithhold = q('.js-confirm-final-withhold');
    if (confirmWithhold){
      confirmWithhold.addEventListener('submit', function(ev){
        const amt = this.querySelector('input[name="amount"]').value || 0;
        const reason = this.querySelector('input[name="reason"]').value || '';
        const ok = confirm(`Confirm final withhold of ${amt} CAD now?` + (reason ? `\nReason: ${reason}` : ''));
        if(!ok){ ev.preventDefault(); }
      });
    }

    const confirmRelease = q('.js-confirm-final-release');
    if (confirmRelease){
      confirmRelease.addEventListener('submit', function(ev){
        const ok = confirm('Confirm releasing the full deposit now?');
        if(!ok){ ev.preventDefault(); }
      });
    }

    const confirmWindow = q('.js-confirm-window');
    if (confirmWindow){
      confirmWindow.addEventListener('submit', function(ev){
        const amt = this.querySelector('input[name="amount"]').value || 0;
        const reason = this.querySelector('input[name="reason"]').value || '';
        const ok = confirm(`Open a 24-hour window to withhold ${amt} CAD?` + (reason ? `\nReason: ${reason}` : ''));
        if(!ok){ ev.preventDefault(); }
      });
    }
  })();
</script>
{% endblock %}
