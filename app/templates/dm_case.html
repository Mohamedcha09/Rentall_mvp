{# app/templates/dm_case.html #}
{% extends "base.html" %}
{% block title %}قضية وديعة — #{{ bk.id }}{% endblock %}

{% block head %}
<style>
  .case-wrap{max-width:1100px;margin:auto}
  .box{border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:14px;background:#fff}
  .muted{opacity:.65}
  .grid{display:grid;gap:10px}
  .grid-ev{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .thumb{width:100%;aspect-ratio:1/1;border-radius:10px;object-fit:cover;border:1px solid var(--border,#e5e7eb)}
  .chip{padding:.35rem .6rem;border:1px solid var(--border,#e5e7eb);border-radius:999px}
  .k{opacity:.7}
  .acts form{display:inline}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .alert-mini{padding:.6rem .8rem}
</style>
{% if bk.renter_response_deadline_at %}
  <script defer src="/static/js/countdown.js"></script>
{% endif %}
{% endblock %}

{% block content %}
<div class="case-wrap">
  <div class="d-flex justify-content-between align-items-start flex-wrap mb-2">
    <div class="mb-2">
      <h4 class="mb-1">قضية وديعة — حجز #{{ bk.id }}</h4>
      <div class="k">
        العنصر:
        {% if item %}
          <strong>{{ item.title }}</strong> — <a href="/items/{{ item.id }}" target="_blank">فتح صفحة العنصر</a>
        {% else %}
          —
        {% endif %}
      </div>
      <div class="k">الفترة: {{ bk.start_date }} → {{ bk.end_date }} ({{ bk.days }} يوم)</div>
    </div>
    <div class="d-flex flex-column align-items-end gap-1">
      <span class="chip">حالة الحجز: {{ bk.status or '—' }}</span>
      <span class="chip">حالة الوديعة: {{ bk.deposit_status or '—' }}</span>
    </div>
  </div>

  <div class="grid" style="grid-template-columns: 1fr 360px;">
    <!-- يسار: تفاصيل و إجراءات -->
    <div class="grid">

      {# ===== بلاغ المالك + أدلته (الموديول الأول) ===== #}
      {% if bk.owner_report_type or bk.owner_report_reason or (bk.deposit_evidences and bk.deposit_evidences|length) %}
        <div class="box mb-3">
          <div class="d-flex align-items-center gap-2 mb-2">
            <i class="bi bi-exclamation-octagon"></i>
            <h6 class="m-0">بلاغ المالك</h6>
          </div>

          <div class="mb-1">
            <div class="k">النوع:</div>
            <div class="fw-semibold">{{ bk.owner_report_type or '—' }}</div>
          </div>

          {% if bk.owner_report_reason %}
            <div class="mb-2">
              <div class="k">الوصف:</div>
              <div style="white-space:pre-wrap">{{ bk.owner_report_reason }}</div>
            </div>
          {% endif %}

          {# أول 6 أدلة مرفوعة من المالك (صور/فيديو) #}
          {% if bk.deposit_evidences and bk.deposit_evidences|length %}
            {% set owner_evs = bk.deposit_evidences | selectattr('side','equalto','owner') | list %}
            {% if owner_evs and owner_evs|length %}
              <div class="d-flex flex-wrap" style="gap:8px">
                {% for ev in owner_evs[:6] %}
                  {% if ev.kind == 'video' or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
                    <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                      <video src="{{ ev.file_path }}" muted
                             style="width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border)"></video>
                    </a>
                  {% else %}
                    <a href="{{ ev.file_path }}" target="_blank" class="d-inline-block">
                      <img src="{{ ev.file_path }}"
                           style="width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border)"/>
                    </a>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <div class="muted">لا توجد أدلة مرفوعة بعد.</div>
            {% endif %}
          {% else %}
            <div class="muted">لا توجد أدلة مرفوعة بعد.</div>
          {% endif %}
        </div>
      {% endif %}

      {# ===== إشعار المستأجر لرفع أدلة (الموديول الثاني) ===== #}
      <div class="box mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-bell"></i>
          <h6 class="m-0">إشعار المستأجر لرفع أدلة</h6>
        </div>
        <form method="post" action="/dm/deposits/{{ bk.id }}/nudge-renter" class="d-flex gap-2 flex-wrap">
          <input type="hidden" name="kind" value="evidence_nudge">
          <input class="form-control" name="note" placeholder="رسالة قصيرة (اختياري)" style="max-width:420px">
          <button class="btn btn-outline-primary">
            <i class="bi bi-send"></i> إرسال إشعار الآن
          </button>
          <a class="btn btn-light" href="/deposits/{{ bk.id }}/evidence/form" target="_blank">
            فتح نموذج رفع الأدلة (معاينة)
          </a>
        </form>
        <div class="k small mt-2">سيصل للمستأجر إشعار داخل الموقع + إيميل يحتوي رابط النموذج.</div>
      </div>

      <!-- ردود/أدلة المستأجر -->
      <div class="box">
        <h6 class="mb-2"><i class="bi bi-person-bounding-box me-1"></i> المستأجر</h6>
        {% if has_renter_reply %}
          <div class="alert alert-success alert-mini mb-2">هناك رد/أدلة من المستأجر.</div>
        {% else %}
          <div class="alert alert-warning alert-mini mb-2">لا يوجد رد من المستأجر حتى الآن.</div>
        {% endif %}
        <div class="d-flex gap-2 flex-wrap">
          <a class="btn btn-outline-secondary btn-sm" href="/bookings/flow/{{ bk.id }}" target="_blank">
            فتح صفحة الحجز (للاطلاع على كل الأدلة)
          </a>
          <a class="btn btn-sm btn-light" href="/deposits/{{ bk.id }}/evidence/form" target="_blank">
            رابط نموذج رفع الأدلة (للمشاركة مع الأطراف)
          </a>
        </div>
      </div>

      <!-- إجراءات المراجع DM -->
      <div class="box">
        <h6 class="mb-3"><i class="bi bi-hammer me-1"></i> إجراءات متحكّم الوديعة (DM)</h6>

        {% if bk.deposit_status == 'awaiting_renter' and bk.renter_response_deadline_at %}
          <div class="alert alert-info alert-mini mb-3">
            نافذة ردّ المستأجر مفتوحة — التنفيذ التلقائي بعد نهاية المهلة إن لم يردّ.
            <div class="mt-1 mono">
              ينتهي في:
              <span id="deadlineCountdown">{{ bk.renter_response_deadline_at }}</span>
            </div>
          </div>
        {% endif %}

        <div class="acts mb-2">
          <!-- فتح نافذة 24h (withhold pending) -->
          <form method="post" action="/dm/deposits/{{ bk.id }}/start-window" class="d-inline-block">
            <div class="row g-2 align-items-end">
              <div class="col-auto">
                <label class="form-label">المبلغ (CAD)</label>
                <input class="form-control" type="number" name="amount" min="1" step="1" required>
              </div>
              <div class="col-auto">
                <label class="form-label">السبب</label>
                <input class="form-control" type="text" name="reason" placeholder="وصف مختصر" />
              </div>
              <div class="col-auto">
                <button class="btn btn-warning">
                  <i class="bi bi-hourglass-split"></i> فتح مهلة 24h
                </button>
              </div>
            </div>
          </form>
        </div>

        <div class="acts mb-2">
          <!-- خصم نهائي الآن -->
          <form method="post" action="/dm/deposits/{{ bk.id }}/decision" class="d-inline-block">
            <input type="hidden" name="decision" value="withhold">
            <input type="hidden" name="finalize" value="1">
            <div class="row g-2 align-items-end">
              <div class="col-auto">
                <label class="form-label">المبلغ (CAD)</label>
                <input class="form-control" type="number" name="amount" min="1" step="1" required>
              </div>
              <div class="col-auto">
                <label class="form-label">السبب</label>
                <input class="form-control" type="text" name="reason" placeholder="وصف مختصر" />
              </div>
              <div class="col-auto">
                <button class="btn btn-danger">
                  <i class="bi bi-shield-shaded"></i> خصم نهائي الآن
                </button>
              </div>
            </div>
          </form>
        </div>

        <div class="acts">
          <!-- إرجاع كامل -->
          <form method="post" action="/dm/deposits/{{ bk.id }}/decision">
            <input type="hidden" name="decision" value="release">
            <button class="btn btn-outline-success">
              <i class="bi bi-check2-circle"></i> إرجاع الوديعة بالكامل
            </button>
          </form>
        </div>
      </div>

      <!-- لوج مختصر -->
      <div class="box">
        <h6 class="mb-2"><i class="bi bi-journal-text me-1"></i> ملخص تقني</h6>
        <div class="mono small k">
          deposit_status={{ bk.deposit_status }} |
          dm_decision={{ bk.dm_decision }} |
          dm_amount={{ bk.dm_decision_amount }} |
          renter_deadline={{ bk.renter_response_deadline_at }}
        </div>
      </div>
    </div>

    <!-- يمين: ملخص مالي وعام -->
    <div class="grid">
      <div class="box">
        <h6 class="mb-2">ملخص الدفع</h6>
        <div class="d-flex justify-content-between"><span>طريقة الدفع</span><strong>{{ bk.payment_method or '—' }}</strong></div>
        <div class="d-flex justify-content-between"><span>الإيجار</span><strong>{{ bk.rent_amount or bk.total_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>الوديعة المحتجزة</span><strong>{{ bk.hold_deposit_amount or bk.deposit_amount or 0 }}$</strong></div>
        <div class="d-flex justify-content-between"><span>المحصول المقتطع</span><strong>{{ bk.deposit_charged_amount or 0 }}$</strong></div>
        <hr>
        <div class="k mono small">
          {% if bk.accepted_at %}accepted_at: {{ bk.accepted_at }}<br>{% endif %}
          {% if bk.picked_up_at %}picked_up_at: {{ bk.picked_up_at }}<br>{% endif %}
          {% if bk.returned_at %}returned_at: {{ bk.returned_at }}<br>{% endif %}
          {% if bk.dm_decision_at %}dm_decision_at: {{ bk.dm_decision_at }}<br>{% endif %}
        </div>
      </div>

      {% if item %}
      <div class="box">
        <h6 class="mb-2">العنصر</h6>
        <div class="d-flex gap-3">
          <img src="{{ (('/' ~ item.image_path) if item.image_path and item.image_path[0] != '/' else (item.image_path or '/static/placeholder.jpg')) }}"
               style="width:96px;height:96px;object-fit:cover;border-radius:10px" alt="">
          <div>
            <div class="fw-bold">{{ item.title }}</div>
            <div class="k">{{ category_label(item.category) if item and item.category else '—' }}</div>
            <div class="k">السعر اليومي: {{ item.price_per_day }}$</div>
            <a class="small" href="/items/{{ item.id }}" target="_blank">فتح صفحة العنصر</a>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% if bk.renter_response_deadline_at %}
<script>
  try{
    if(window.initCountdown){
      initCountdown('deadlineCountdown','{{ bk.renter_response_deadline_at }}');
    }else{
      var el = document.getElementById('deadlineCountdown');
      if(el){ el.textContent = new Date('{{ bk.renter_response_deadline_at }}').toLocaleString(); }
    }
  }catch(e){}
</script>
{% endif %}
{% endblock %}
