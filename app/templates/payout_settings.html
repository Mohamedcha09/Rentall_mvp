{# app/templates/payout_connect.html #}
{% extends "base.html" %}
{% block head %}
<style>
  .cardish{border:1px solid var(--border);border-radius:14px;padding:16px}
  .illus-box{display:flex;align-items:center;justify-content:center;padding:24px;border:1px solid var(--border);border-radius:14px;background:var(--surface)}
  .illus-box img{display:block;max-width:420px;width:88%;height:auto;object-fit:contain;opacity:.98}
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:920px">
  <h3 class="mb-3">إعداد استلام الأرباح (Stripe Connect)</h3>

  <div class="cardish mb-3">
    <p class="mb-2">
      ليتلقّى <strong>المالك</strong> الأموال إلى حسابه البنكي عبر Stripe،
      اربط حساب <strong>Stripe Connect</strong> وأكمل التحقق (KYC).
    </p>
    <p class="mb-2">ستقوم المنصة باقتطاع <strong>8%</strong> من كل عملية كرسوم خدمة.</p>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <a class="btn btn-primary" href="/payout/connect/start">ابدأ الربط الآن</a>
      <button id="chkBtn" class="btn btn-outline-secondary">تحقّق من الحالة</button>
      <button id="kycBtn" class="btn btn-warning d-none">أكمل التحقق الآن</button>
    </div>
  </div>

  {# ✅ عرض صورة الحالة فقط #}
  <div class="illus-box">
    <img id="stateImg" src="{{ url_for('static', path='photo/fon.png') }}" alt="Stripe Connect state">
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const imgEl  = document.getElementById('stateImg');
  const kycBtn = document.getElementById('kycBtn');

  const FON = "{{ url_for('static', path='photo/fon.png') }}"; // الكل false / غير مكتمل
  const BON = "{{ url_for('static', path='photo/bon.png') }}"; // الكل true / مكتمل

  function show(el, yes){ el?.classList.toggle('d-none', !yes); }

  async function load(){
    try{
      const r = await fetch('/api/stripe/connect/status?autocreate=1', {credentials:'same-origin'});
      if(!r.ok) throw new Error('status failed');
      const d = await r.json();

      const payouts = !!d.payouts_enabled;
      const charges = !!d.charges_enabled;
      const details = !!d.details_submitted;

      const allFalse = !payouts && !charges && !details;
      const allTrue  =  payouts &&  charges &&  details;

      // اختر الصورة حسب الحالة
      imgEl.src = allTrue ? BON : FON;

      // نظهر زر KYC إذا لم تكتمل كل القيم
      show(kycBtn, !allTrue);
    }catch(e){
      console.error(e);
      // في حالة الخطأ نظهر حالة غير مكتمل
      imgEl.src = FON;
      show(kycBtn, true);
    }
  }

  document.getElementById('chkBtn')?.addEventListener('click', e => { e.preventDefault(); load(); });

  // زر "أكمل التحقق الآن" → نطلب رابط Onboarding من الباك-إند
  kycBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{
      const r = await fetch('/api/stripe/connect/onboard_link', {credentials:'same-origin'});
      const d = await r.json();
      if (d && d.url) window.location.href = d.url;
    }catch(err){ console.error(err); }
  });

  // تحميل تلقائي عند فتح الصفحة
  load();
})();
</script>
{% endblock %}
