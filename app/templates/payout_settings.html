{% extends "base.html" %}
{% block head %}
<style>
  .cardish{border:1px solid var(--border);border-radius:14px;padding:16px}
  .muted{opacity:.7}
  .k{opacity:.65}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:920px">
  <h3 class="mb-3">ุฅุนุฏุงุฏ ุงุณุชูุงู ุงูุฃุฑุจุงุญ (Stripe Connect)</h3>

  <div class="cardish mb-3">
    <p class="mb-2">
      ููุชูููู <strong>ุงููุงูู</strong> ุงูุฃููุงู ุฅูู ุญุณุงุจู ุงูุจููู ุนุจุฑ Stripeุ
      ุงุฑุจุท ุญุณุงุจ <strong>Stripe Connect</strong> ูุฃููู ุงูุชุญูู (KYC).
    </p>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <!-- ูุจุฏุฃ ุฃู ูููุดุฆ ุงูุญุณุงุจ ููุฑุณู ุงููุณุชุฎุฏู ุฅูู ุตูุญุฉ Stripe -->
      <a class="btn btn-primary" href="/payout/connect/start">
        <i class="bi bi-plug"></i> ุงุจุฏุฃ ุงูุฑุจุท ุงูุขู
      </a>

      <!-- ูุญุต ุงูุญุงูุฉ -->
      <button id="chkBtn" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-repeat"></i> ุชุญููู ูู ุงูุญุงูุฉ
      </button>

      <!-- ุฒุฑ ููุธูุฑ ููุท ุฅุฐุง ุงูุญุณุงุจ ุบูุฑ ููุชูู -->
      <a id="onboardBtn" class="btn btn-warning" href="/connect/onboard" style="display:none">
        <i class="bi bi-shield-check"></i> ุฃููู ุงูุชุญูู ุงูุขู
      </a>
    </div>

    <div class="small muted mt-2">
      ููุงุญุธุฉ ุนูููุฉ ุงูููุตูุฉ: ุณูุชู ุงูุชุทุงุน <strong>8%</strong> ูู ูู ุนูููุฉ ุฏูุน ูุฑุณูู ุฎุฏูุฉ.
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="cardish">
        <h5 class="mb-3">ุญุงูุฉ ุญุณุงุจู</h5>

        <div class="mb-2"><span class="k">Stripe Account ID:</span>
          <code class="mono" id="accId">โ</code></div>
        <div class="mb-2"><span class="k">payouts_enabled:</span>
          <span id="payouts">โ</span></div>
        <div class="mb-2"><span class="k">charges_enabled:</span>
          <span id="charges">โ</span></div>
        <div class="mb-2"><span class="k">details_submitted:</span>
          <span id="details">โ</span></div>

        <!-- ุชูุจูู ุนูุฏูุง ุงูุญุณุงุจ ุบูุฑ ุฌุงูุฒ -->
        <div class="alert alert-warning mt-3" id="callout" style="display:none">
          ุงูุญุณุงุจ ุบูุฑ ุฌุงูุฒ ุจุนุฏ ูุงุณุชูุงู ุงูุฃุฑุจุงุญ. ุงุถุบุท
          <strong>ุฃููู ุงูุชุญูู ุงูุขู</strong> ูุฃุฏุฎู ูุณุชูุฏ ุงููููุฉ ูุจูุงูุงุช ุงูุจูู.
        </div>

        <!-- ุฑุณุงูุฉ ูุฌุงุญ ุนูุฏูุง ูุฌูุฒ ุงูุญุณุงุจ -->
        <div class="alert alert-success mt-3" id="okcall" style="display:none">
          ๐ ุญุณุงุจู ุงูุขู ูููุนู ูููููู ุงุณุชูุจุงู ุงูุฃููุงู. ุณูุชู ุงูุชุทุงุน <strong>8%</strong> ูุนูููุฉ ููุตูุชูุง ูู ูู ุนูููุฉ.
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="cardish">
        <h6 class="mb-2">ููุงุญุธุงุช</h6>
        <ul class="mb-0">
          <li>ุงููุถุน ุงูุญุงูู: ููุงุชูุญ ุงุฎุชุจุงุฑ <code>pk_test</code> / <code>sk_test</code>.</li>
          <li>ุจุนุฏ ุฅููุงู KYC ูุฅุถุงูุฉ ุญุณุงุจ ุจููู (ุงุฎุชุจุงุฑ/ุญูููู)ุ ูุตุจุญ
            <code>payouts_enabled = true</code>.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const btn        = document.getElementById('chkBtn');
  const accId      = document.getElementById('accId');
  const payouts    = document.getElementById('payouts');
  const charges    = document.getElementById('charges');
  const details    = document.getElementById('details');
  const callout    = document.getElementById('callout');
  const okcall     = document.getElementById('okcall');
  const onboardBtn = document.getElementById('onboardBtn');

  function set(val, el){
    el.textContent = (val===true)?'true':(val===false)?'false':(val||'โ');
  }

  async function load(){
    try{
      const r = await fetch('/api/stripe/connect/status', {credentials:'same-origin'});
      if(!r.ok){ throw new Error('status fetch failed'); }
      const d = await r.json();

      set(d.account_id || 'โ', accId);
      set(d.payouts_enabled, payouts);
      set(d.charges_enabled, charges);
      set(d.details_submitted, details);

      const ready = !!d.payouts_enabled && !!d.charges_enabled && !!d.details_submitted;

      // ุฅุธูุงุฑ/ุฅุฎูุงุก ุงูุนูุงุตุฑ ุญุณุจ ุงูุฌุงูุฒูุฉ
      okcall.style.display   = ready ? '' : 'none';
      callout.style.display  = ready ? 'none' : '';
      onboardBtn.style.display = ready ? 'none' : '';
    }catch(e){
      // ูู ุญุงู ุงููุดูโฆ ุงุธูุฑ ุฒุฑ ุงูุฅุชูุงู ูุงูุชูุจูู
      callout.style.display = '';
      onboardBtn.style.display = '';
    }
  }

  // ุฅุนุงุฏุฉ ูุญุต ุชููุงุฆู ุนูุฏ ุงูุนูุฏุฉ ูู Stripe (?done=1)
  if (new URLSearchParams(window.location.search).get('done') === '1') {
    // ุฃุญูุงูุงู Stripe ูุญุชุงุฌ ุซูุงูู ููุฒุงููุฉ ุงูุญุงูุฉ โ ูุฌุฑุจ ุฅุนุงุฏุฉ ุงูุชุญููู ุจุนุฏ ูุญุธุงุช
    setTimeout(load, 1500);
  }

  btn?.addEventListener('click', (e)=>{ e.preventDefault(); load(); });
  load();
})();
</script>
{% endblock %}