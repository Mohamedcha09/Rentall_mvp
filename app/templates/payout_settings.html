{% extends "base.html" %}
{% block head %}
<style>
  .cardish{border:1px solid var(--border);border-radius:14px;padding:16px}
  .k{opacity:.65}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:920px">
  <h3 class="mb-3">إعداد استلام الأرباح (Stripe Connect)</h3>

  <div class="cardish mb-3">
    <p class="mb-2">
      ليتلقّى <strong>المالك</strong> الأموال إلى حسابه البنكي عبر Stripe،
      اربط حساب <strong>Stripe Connect</strong> وأكمل التحقق KYC.
    </p>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <a class="btn btn-primary" href="/payout/connect/start">ابدأ الربط الآن</a>
      <button id="chkBtn" class="btn btn-outline-secondary">تحقّق من الحالة</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="cardish">
        <h5 class="mb-3">حالة حسابك</h5>

        <div class="mb-2"><span class="k">Stripe Account ID:</span>
          <code class="mono" id="accId">—</code></div>
        <div class="mb-2"><span class="k">payouts_enabled:</span>
          <span id="payouts">—</span></div>
        <div class="mb-2"><span class="k">charges_enabled:</span>
          <span id="charges">—</span></div>
        <div class="mb-2"><span class="k">details_submitted:</span>
          <span id="details">—</span></div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="cardish">
        <h6 class="mb-2">ملاحظات</h6>
        <ul class="mb-0">
          <li>الوضع الحالي: مفاتيح اختبار <code>pk_test / sk_test</code>.</li>
          <li>بعد إكمال KYC وإضافة بنك اختبار، يصبح <code>payouts_enabled = true</code>.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const accId   = document.getElementById('accId');
  const payouts = document.getElementById('payouts');
  const charges = document.getElementById('charges');
  const details = document.getElementById('details');

  function set(val, el){ el.textContent = (val===true)?'true':(val===false)?'false':(val||'—'); }

  async function load(){
    const r = await fetch('/api/stripe/connect/status', {credentials:'same-origin'});
    const d = await r.json();
    set(d.account_id || '—', accId);
    set(d.payouts_enabled, payouts);
    set(d.charges_enabled, charges);
    set(d.details_submitted, details);
  }
  document.getElementById('chkBtn').addEventListener('click', (e)=>{ e.preventDefault(); load(); });
  load();
})();
</script>
{% endblock %}