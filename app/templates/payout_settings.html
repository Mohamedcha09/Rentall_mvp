{% extends "base.html" %}
{% block head %}
<style>
  .cardish{border:1px solid var(--border);border-radius:14px;padding:16px}
  .muted{opacity:.7}
  .k{opacity:.65}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:920px">
  <h3 class="mb-3">إعداد استلام الأرباح (Stripe Connect)</h3>

  <div class="cardish mb-3">
    <p class="mb-2">
      ليتلقّى <strong>المالك</strong> الأموال إلى حسابه البنكي عبر Stripe،
      اربط حساب <strong>Stripe Connect</strong> وأكمل التحقق KYC.
    </p>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <!-- نستخدم GET (يدعمه الراوتر) -->
      <a class="btn btn-primary" href="/payout/connect/start">
        <i class="bi bi-plug"></i> ابدأ الربط الآن
      </a>

      <button id="chkBtn" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-repeat"></i> تحقّق من الحالة
      </button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="cardish">
        <h5 class="mb-3">حالة حسابك</h5>

        <div class="mb-2"><span class="k">Stripe Account ID:</span>
          <code class="mono" id="accId">—</code></div>
        <div class="mb-2"><span class="k">payouts_enabled:</span>
          <span id="payouts">—</span></div>
        <div class="mb-2"><span class="k">charges_enabled:</span>
          <span id="charges">—</span></div>
        <div class="mb-2"><span class="k">details_submitted:</span>
          <span id="details">—</span></div>

        <div class="alert alert-warning mt-3" id="callout" style="display:none">
          لم يكتمل الربط بعد. اضغط <strong>ابدأ الربط الآن</strong> وأكمل خطوات Stripe.
        </div>
        <div class="alert alert-success mt-3" id="okcall" style="display:none">
          الحساب جاهز لاستلام الأرباح ✅
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="cardish">
        <h6 class="mb-2">ملاحظات</h6>
        <ul class="mb-0">
          <li>الوضع الحالي: مفاتيح اختبار <code>sk_test/ pk_test</code>.</li>
          <li>بعد إكمال KYC يصبح <code>payouts_enabled = true</code>.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const btn = document.getElementById('chkBtn');
  const accId = document.getElementById('accId');
  const payouts = document.getElementById('payouts');
  const charges = document.getElementById('charges');
  const details = document.getElementById('details');
  const callout = document.getElementById('callout');
  const okcall = document.getElementById('okcall');

  function set(val, el){ el.textContent = (val===true)?'true':(val===false)?'false':(val||'—'); }

  async function load(){
    try{
      const r = await fetch('/api/stripe/connect/status', {credentials:'same-origin'});
      if(!r.ok) throw 0;
      const d = await r.json();
      set(d.account_id || '—', accId);
      set(d.payouts_enabled, payouts);
      set(d.charges_enabled, charges);
      set(d.details_submitted, details);
      const ok = !!d.payouts_enabled && !!d.charges_enabled && !!d.details_submitted;
      okcall.style.display = ok ? '' : 'none';
      callout.style.display = ok ? 'none' : '';
    }catch(e){
      callout.style.display='';
    }
  }
  btn?.addEventListener('click', e=>{ e.preventDefault(); load(); });
  load();
})();
</script>
{% endblock %}