{% extends "base.html" %}
{% block head %}
<style>
  .cardish{border:1px solid var(--border);border-radius:14px;padding:16px}
  .muted{opacity:.7}
  .k{opacity:.65}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:920px">
  <h3 class="mb-3">ุฅุนุฏุงุฏ ุงุณุชูุงู ุงูุฃุฑุจุงุญ (Stripe Connect)</h3>

  <div class="cardish mb-3">
    <p class="mb-2">
      ููุชูููู <strong>ุงููุงูู</strong> ุงูุฃููุงู ุฅูู ุญุณุงุจู ุงูุจููู ุนุจุฑ Stripeุ
      ุงุฑุจุท ุญุณุงุจ <strong>Stripe Connect</strong> ูุฃููู ุงูุชุญูู (KYC).
    </p>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      <!-- ูุจุฏุฃ ุฃู ูููุดุฆ ุงูุญุณุงุจ ููุฑุณู ุงููุณุชุฎุฏู ุฅูู ุตูุญุฉ Stripe -->
      <a class="btn btn-primary" href="/payout/connect/start">
        <i class="bi bi-plug"></i> ุงุจุฏุฃ ุงูุฑุจุท ุงูุขู
      </a>

      <!-- ูุญุต ุงูุญุงูุฉ -->
      <button id="chkBtn" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-repeat"></i> ุชุญููู ูู ุงูุญุงูุฉ
      </button>

      <!-- โ ูุธูุฑ ููุท ุฅุฐุง ุชู ุงูุฑุจุท (account_id ููุฌูุฏ) ููู payouts ูุง ุฒุงูุช false -->
      <a id="onboardBtn" class="btn btn-warning" href="/connect/onboard" style="display:none">
        <i class="bi bi-shield-check"></i> ุฃููู ุงูุชุญูู ุงูุขู
      </a>
    </div>

    <div class="small muted mt-2">
      ุณุชููู ุงูููุตูุฉ ุจุงูุชุทุงุน <strong>8%</strong> ูู ูู ุนูููุฉ ูุฑุณูู ุฎุฏูุฉ.
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="cardish">
        <h5 class="mb-3">ุญุงูุฉ ุญุณุงุจู</h5>

        <div class="mb-2"><span class="k">Stripe Account ID:</span>
          <code class="mono" id="accId">โ</code></div>
        <div class="mb-2"><span class="k">payouts_enabled:</span>
          <span id="payouts">โ</span></div>
        <div class="mb-2"><span class="k">charges_enabled:</span>
          <span id="charges">โ</span></div>
        <div class="mb-2"><span class="k">details_submitted:</span>
          <span id="details">โ</span></div>

        <!-- โ ูุธูุฑ ููุท ุนูุฏูุง: ุชู ุงูุฑุจุท ููู ูู ููุชูู ุงูุชูุนูู -->
        <div class="alert alert-warning mt-3" id="callout" style="display:none">
          ุญุณุงุจู ูุฑุชุจุท ููู ูู ููุชูู ุงูุชูุนูู ุจุนุฏ. ูุฅุชูุงู ุงูุชูุนูู ุจุดูู ูุงููุ ุงุถุบุท
          <strong>ุฃููู ุงูุชุญูู ุงูุขู</strong> ูุงุฑูุน ูุณุชูุฏ ุงููููุฉ ูุตูุฑุชู ูุฃููู ุจูุงูุงุช ุงูุจูู.
        </div>

        <!-- โ ูุธูุฑ ููุท ุนูุฏูุง: ุงูุญุณุงุจ ุฌุงูุฒ 100% -->
        <div class="alert alert-success mt-3" id="okcall" style="display:none">
          ๐ ุญุณุงุจู ูููุนู 100% ูููููู ุงุณุชูุจุงู ุงูุฃููุงู ุงูุขู. ุณูุชู ุงูุชุทุงุน <strong>8%</strong> ูุนูููุฉ ุงูููุตูุฉ ูู ูู ุนูููุฉ.
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="cardish">
        <h6 class="mb-2">ููุงุญุธุงุช</h6>
        <ul class="mb-0">
          <li>ุงููุถุน ุงูุญุงูู: ููุงุชูุญ ุงุฎุชุจุงุฑ <code>pk_test</code> / <code>sk_test</code>.</li>
          <li>ููู ูุตุจุญ <code>payouts_enabled = true</code> ูุฌุจ ุฅููุงุก ุงูุชุญูู ูุฅุถุงูุฉ ุญุณุงุจ ุจููู.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const btn        = document.getElementById('chkBtn');
  const accId      = document.getElementById('accId');
  const payouts    = document.getElementById('payouts');
  const charges    = document.getElementById('charges');
  const details    = document.getElementById('details');
  const callout    = document.getElementById('callout');
  const okcall     = document.getElementById('okcall');
  const onboardBtn = document.getElementById('onboardBtn');

  function set(val, el){
    el.textContent = (val===true)?'true':(val===false)?'false':(val||'โ');
  }

  async function load(){
    try{
      const r = await fetch('/api/stripe/connect/status', {credentials:'same-origin'});
      if(!r.ok){ throw new Error('status fetch failed'); }
      const d = await r.json();

      const accountId = d.account_id || null;
      const pe = !!d.payouts_enabled;
      const ce = !!d.charges_enabled;
      const ds = !!d.details_submitted;

      set(accountId || 'โ', accId);
      set(pe, payouts);
      set(ce, charges);
      set(ds, details);

      const ready = pe && ce && ds;
      const connectedOnly = !!accountId && !ready; // โ ุชู ุงูุฑุจุท ููู ูู ููุชูู ุงูุชูุนูู

      // โ ุงูููุทู ุงููุทููุจ:
      // ุฅุฐุง ุชู ุงูุฑุจุท ูููู payouts_enabled ูุง ุฒุงูุช false โ ุฃุธูุฑ ุฒุฑ "ุฃููู ุงูุชุญูู ุงูุขู"
      onboardBtn.style.display = connectedOnly ? '' : 'none';

      // ุฑุณุงูุฉ ุชูุจูู ุนูุฏ ุงูููุต
      callout.style.display = connectedOnly ? '' : 'none';

      // ุฑุณุงูุฉ ูุฌุงุญ ุนูุฏ ุงูุฌุงูุฒูุฉ 100%
      okcall.style.display = ready ? '' : 'none';

    }catch(e){
      // ูู ุญุงู ุงููุดูโฆ ูุง ูุนุฑู ุงูุญุงูุฉุ ุณูุฎูู ุฑุณุงูุฉ ุงููุฌุงุญ ููุธูุฑ ุชูุจูู ุนุงู
      okcall.style.display = 'none';
      callout.style.display = '';
      // ูุนุฑุถ ุฒุฑ ุงูุฅููุงุก ูุฅุนุทุงุก ุงููุณุชุฎุฏู ุทุฑููุฉ ูุฅููุงู ุงูุฎุทูุงุช
      onboardBtn.style.display = '';
    }
  }

  // ุฅุนุงุฏุฉ ูุญุต ุชููุงุฆู ุนูุฏ ุงูุนูุฏุฉ ูู Stripe (?done=1)
  if (new URLSearchParams(window.location.search).get('done') === '1') {
    setTimeout(load, 1500);
  }

  btn?.addEventListener('click', (e)=>{ e.preventDefault(); load(); });
  load();
})();
</script>
{% endblock %}