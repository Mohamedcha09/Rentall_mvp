{% extends "base.html" %}
{% block head %}
<style>
  .cardish{border:1px solid var(--border);border-radius:14px;padding:16px}
  .k{opacity:.65}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:920px">
  <h3 class="mb-3">ุฅุนุฏุงุฏ ุงุณุชูุงู ุงูุฃุฑุจุงุญ (Stripe Connect)</h3>

  <div class="cardish mb-3">
    <p class="mb-2">
      ููุชูููู <strong>ุงููุงูู</strong> ุงูุฃููุงู ุฅูู ุญุณุงุจู ุงูุจููู ุนุจุฑ Stripeุ
      ุงุฑุจุท ุญุณุงุจ <strong>Stripe Connect</strong> ูุฃููู ุงูุชุญูู (KYC).
    </p>
    <p class="mb-2">
      ุณุชููู ุงูููุตุฉ ุจุงูุชุทุงุน <strong>8%</strong> ูู ูู ุนูููุฉ ูุฑุณูู ุฎุฏูุฉ.
    </p>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <a class="btn btn-primary" href="/payout/connect/start">ุงุจุฏุฃ ุงูุฑุจุท ุงูุขู</a>
      <button id="chkBtn" class="btn btn-outline-secondary">ุชุญููู ูู ุงูุญุงูุฉ</button>
      <!-- ูุฐุง ุงูุฒุฑ ูุธูุฑู ููุท ุนูุฏ ุงูุญุงุฌุฉ ุนุจุฑ ุงูุฌุงูุงุณูุฑุจุช -->
      <button id="kycBtn" class="btn btn-warning d-none">ุฃููู ุงูุชุญูู ุงูุขู</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="cardish">
        <h5 class="mb-3">ุญุงูุฉ ุญุณุงุจู</h5>

        <div class="mb-2"><span class="k">Stripe Account ID:</span>
          <code class="mono" id="accId">โ</code></div>
        <div class="mb-2"><span class="k">payouts_enabled:</span>
          <span id="payouts">โ</span></div>
        <div class="mb-2"><span class="k">charges_enabled:</span>
          <span id="charges">โ</span></div>
        <div class="mb-2"><span class="k">details_submitted:</span>
          <span id="details">โ</span></div>

        <div class="alert alert-warning mt-3 d-none" id="callout">
          ูู ููุชูู ุงูุชุญูู ุจุนุฏ. ุงุถุบุท <strong>ุฃููู ุงูุชุญูู ุงูุขู</strong> ูุฑูุน ุงููููุฉ/ุงูุตูุฑุฉ ูุฅุถุงูุฉ ุญุณุงุจู ุงูุจููู.
        </div>
        <div class="alert alert-success mt-3 d-none" id="okcall">
          ๐ ุญุณุงุจู ุงูุขู <strong>ููุนูู ุจุงููุงูู</strong> ูููููู ุงุณุชูุงู ุงูุฃุฑุจุงุญ!
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="cardish">
        <h6 class="mb-2">ููุงุญุธุงุช</h6>
        <ul class="mb-0">
          <li>ุงููุถุน ุงูุญุงูู: ููุงุชูุญ ุงุฎุชุจุงุฑ <code>pk_test/sk_test</code> (ุฅู ููุช ูู ูุถุน ุงูุงุฎุชุจุงุฑ).</li>
          <li>ุจุนุฏ ุฅููุงู KYC ูุฅุถุงูุฉ ุจููุ ูุตุจุญ <code>payouts_enabled = true</code>.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const accId   = document.getElementById('accId');
  const payouts = document.getElementById('payouts');
  const charges = document.getElementById('charges');
  const details = document.getElementById('details');

  const callout = document.getElementById('callout');
  const okcall  = document.getElementById('okcall');
  const kycBtn  = document.getElementById('kycBtn');

  function set(val, el){ el.textContent = (val===true)?'true':(val===false)?'false':(val||'โ'); }
  function show(el, yes){ el.classList.toggle('d-none', !yes); }

  async function load(){
    try{
      const r = await fetch('/api/stripe/connect/status?autocreate=1', {credentials:'same-origin'});
      if(!r.ok) throw new Error('status failed');
      const d = await r.json();

      set(d.account_id || 'โ', accId);
      set(d.payouts_enabled, payouts);
      set(d.charges_enabled, charges);
      set(d.details_submitted, details);

      const needKyc = !!d.connected && !!d.charges_enabled && !d.payouts_enabled;
      const fullyOk = !!d.payouts_enabled && !!d.charges_enabled;

      show(callout, needKyc);
      show(kycBtn, needKyc);
      show(okcall, fullyOk);

    }catch(e){
      console.error(e);
      show(callout, true);
    }
  }

  document.getElementById('chkBtn')?.addEventListener('click', e => { e.preventDefault(); load(); });

  // ุฒุฑ "ุฃููู ุงูุชุญูู ุงูุขู" โ ูุทูุจ ูููู ุงูู Onboarding ูู ุงูุจุงููุฏ
  kycBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{
      const r = await fetch('/api/stripe/connect/onboard_link', {credentials:'same-origin'});
      const d = await r.json();
      if (d && d.url) window.location.href = d.url;
    }catch(err){ console.error(err); }
  });

  // ุชุญููู ุชููุงุฆู ุนูุฏ ูุชุญ ุงูุตูุญุฉ
  load();
})();
</script>
{% endblock %}