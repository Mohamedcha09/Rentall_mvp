{% extends "base.html" %}
{% from "_badges.html" import render_badges %}
{% block content %}

<style>
  /* ألوان عالية التباين للوضع الداكن */
  :root {
    --surface: rgba(18, 22, 30, .75);
    --surface-border: rgba(255,255,255,.18);
    --text-strong: #ffffff;          /* عناوين ونصوص أساسية */
    --text-normal: #e6e9ef;          /* نصوص عادية */
    --text-soft: #cfd3da;            /* وصف/نص ثانوي */
    --text-dim: #b9bec7;             /* تفاصيل صغيرة */
    --accent: #a78bfa;               /* بنفسجي خفيف لإطارات */
    --chip-bg: rgba(255,255,255,.12);
  }

  .card-blur {
    background: var(--surface);
    border: 1px solid var(--surface-border);
    backdrop-filter: blur(6px);
    border-radius: 14px;
    color: var(--text-normal);
  }

  .text-soft   { color: var(--text-soft) !important; }
  .text-dim    { color: var(--text-dim) !important; }
  .text-strong { color: var(--text-strong) !important; }

  .stat-chip {
    border-radius: 999px;
    padding: .35rem .75rem;
    font-weight: 600;
    background: var(--chip-bg);
    color: var(--text-strong);
    border: 1px solid rgba(255,255,255,.1);
  }

  .star {
    font-size: 1.1rem;
    line-height: 1;
    margin-inline: 1px;
  }

  .section-title {
    color: var(--text-strong);
    letter-spacing: .2px;
  }

  .review-item {
    background: transparent;
    color: var(--text-normal);
    border-color: rgba(255,255,255,.14) !important;
  }

  .review-comment { color: var(--text-normal); }
  .outlined { box-shadow: inset 0 0 0 1px var(--accent); border-radius: 16px; }

  /* حجم أيقونات الشارات داخل العناوين */
  .badge-icon{height:22px;width:22px;margin-inline-start:6px;vertical-align:middle;display:inline-block;}
</style>

<div class="mb-4 d-flex align-items-center justify-content-between">
  <h3 class="mb-0 text-strong d-flex align-items-center gap-1">
    صفحتي
  </h3>
  <a class="btn btn-outline-light btn-sm" href="/u/{{ user.id }}">عرض عام</a>
</div>

<!-- بطاقة معلومات المستخدم -->
<div class="card card-blur mb-4 outlined">
  <div class="card-body d-flex align-items-center gap-4 flex-wrap">

    <div class="flex-grow-1">
      <h5 class="mb-1 d-flex align-items-center gap-1">
        {{ user.first_name }} {{ user.last_name }}

        {# ✅ شارات الحساب (تعتمد على الحقول الموجودة في user) #}
        {{ render_badges(user, '22px') }}

        {# شارة نصية فقط للتوثيق إن أردت إبقاءها #}
        {% if user.is_verified %}
          <span class="badge bg-primary ms-1">موثّق ✓</span>
        {% endif %}
      </h5>

      <div class="small text-soft mb-2">
        البريد: <span class="text-normal">{{ user.email }}</span>
        &nbsp;•&nbsp;
        الهاتف: <span class="text-normal">{{ user.phone }}</span>
      </div>

      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge bg-{% if user.status=='approved' %}success{% elif user.status=='pending' %}warning text-dark{% else %}danger{% endif %}">
          {{ user.status }}
        </span>
        <span class="badge {% if user.role=='admin' %}bg-info text-dark{% else %}bg-secondary{% endif %}">
          {{ user.role }}
        </span>
        <span class="badge bg-dark-subtle text-dark">
          عضو منذ {{ joined_at.strftime("%Y-%m-%d") if joined_at else (user.created_at.strftime("%Y-%m-%d") if user.created_at else '') }}
        </span>
      </div>
    </div>

    <div class="text-end">
      <a href="/profile/edit" class="btn btn-primary">تعديل الملف</a>
    </div>
  </div>
</div>

<!-- الإحصائيات السريعة -->
<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="card card-blur outlined h-100">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">العناصر المنشورة</div>
          <div class="fs-4 fw-bold text-strong">{{ items_count }}</div>
        </div>
        <span class="stat-chip">النشطة: {{ items_active_count }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-blur outlined h-100">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">متوسط التقييم</div>
          <div class="d-flex align-items-end gap-2">
            <div class="fs-4 fw-bold text-strong">{{ "%.1f"|format(avg_stars) }}</div>
            <div aria-label="تقييم نجوم">
              {% for i in range(1,6) %}
                {% if i <= avg_stars|round(0, 'floor') %}
                  <span class="star text-warning">★</span>
                {% elif i - avg_stars < 1 and i > avg_stars %}
                  <span class="star text-warning">☆</span>
                {% else %}
                  <span class="star text-dim">☆</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
        <span class="stat-chip">التقييمات: {{ ratings_count }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-blur outlined h-100">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">الرسائل غير المقروءة</div>
          <div class="fs-4 fw-bold text-strong">
            {% set unread = (request.state.unread_messages|default(0))|int %}
            {% if unread > 9 %}+9{% else %}{{ unread }}{% endif %}
          </div>
        </div>
        <a class="btn btn-outline-light" href="/messages">عرض الرسائل</a>
      </div>
    </div>
  </div>
</div>

<!-- آخر المراجعات -->
<div class="card card-blur outlined">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0 section-title">آخر المراجعات</h5>
      <a class="btn btn-sm btn-outline-secondary disabled">قريبًا: عرض الكل</a>
    </div>

    {% if reviews and reviews|length %}
      <div class="list-group">
        {% for r in reviews %}
          <div class="list-group-item review-item border-secondary">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
              <div class="fw-semibold text-strong">{{ r.rater_name }}</div>
              <div class="small text-soft">{{ r.created_at.strftime("%Y-%m-%d") }}</div>
            </div>

            <div class="mb-1">
              {% for i in range(1,6) %}
                {% if i <= r.stars %}
                  <span class="star text-warning">★</span>
                {% else %}
                  <span class="star text-dim">☆</span>
                {% endif %}
              {% endfor %}
            </div>

            {% if r.comment %}
              <div class="review-comment">
                {{ r.comment | e | replace('\n', '<br>') | safe }}
              </div>
            {% else %}
              <div class="text-soft">لا توجد ملاحظة نصّية.</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-light border-0 mb-0 text-dark">لا توجد تقييمات بعد.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
