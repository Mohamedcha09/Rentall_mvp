{# app/templates/profile.html #}
{% extends "base.html" %}
{% from "base.html" import avatar_src, build_src %}
{% set _ava3 = avatar_src(u.avatar_path if u else '') %}

{% from "_badges.html" import render_badges %}
{% block content %}

{# helper: يبني src صحيح سواء كان http(s) أو مسار محلي #}
{% macro build_src(p) -%}
  {%- set s = (p or '') -%}
  {%- if s.startswith('http://') or s.startswith('https://') -%}
    {{- s -}}
  {%- else -%}
    {{- '/' ~ s.lstrip('/') if s else '' -}}
  {%- endif -%}
{%- endmacro %}

{# نقرأ من session_user دومًا لصور البروفايل #}
{% set u = session_user or user %}

<div class="d-flex align-items-center gap-3 mb-3">
  <div class="rounded-circle border" style="width:64px;height:64px;overflow:hidden">
    {% set _ava3 = avatar_src(u.avatar_path if u else '') %}
{% if _ava3 and not _ava3.endswith('placeholder.png') %}
  <img
    src="{{ _ava3 }}"
    alt="avatar"
    referrerpolicy="no-referrer"
    onerror="this.onerror=null;this.src='/static/placeholder.png'"
    style="width:100%;height:100%;object-fit:cover">
{% else %}
  <div class="w-100 h-100 d-flex align-items-center justify-content-center fw-bold">
    {{ (u.first_name or u.email or 'U')[:1] | upper if u else 'U' }}
  </div>
{% endif %}

  </div>

  <div>
    <div class="d-flex align-items-center gap-2">
      <h2 class="m-0">{{ (u.first_name or user.first_name) }} {{ (u.last_name or user.last_name) }}</h2>
      {{ render_badges(user, '20px') }}
    </div>
    <div class="text-muted small mt-1">
      البريد: {{ u.email or user.email }} · الهاتف: {{ u.phone or user.phone or '—' }}
      · عضو منذ: {{ (user.created_at.strftime('%d-%m-%Y') if user.created_at) }}
    </div>
  </div>
</div>

{# ... بقية صفحتك كما هي (قوائم عناصر، تقييمات، الخ) ... #}

{% endblock %}
