{# ============================================================
   app/templates/profile.html
   ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” ØªØ¹Ù…Ù„ Ù…Ø¹ Cloudinary
   ============================================================ #}

{% extends "base.html" %}

{# == Ù…Ø§ÙƒØ±ÙˆØ² Ù…Ø­Ù„ÙŠØ© (Ù†Ø³Ø®Ø© Ø¢Ù…Ù†Ø©) == #}
{% macro build_src(p) -%}
  {%- set s = (p or '') -%}
  {%- if s.startswith('http://') or s.startswith('https://') -%}
    {{- s -}}
  {%- else -%}
    {{- '/' ~ s.lstrip('/') if s else '' -}}
  {%- endif -%}
{%- endmacro %}

{% macro avatar_src(p) -%}
  {%- set s = (p or '') -%}
  {%- if s.startswith('http://') or s.startswith('https://') -%}
    {{- s -}}
  {%- elif s and (not s.startswith('/uploads/')) -%}
    {{- '/' ~ s.lstrip('/') -}}
  {%- else -%}
    {{- '/static/placeholder.png' -}}
  {%- endif -%}
{%- endmacro %}

{% from "_badges.html" import render_badges %}
{% block content %}

{# ğŸ”’ IMPORTANT:
   ÙØ¶Ù‘Ù„ ØµÙˆØ±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø¬Ù„Ø³Ø©.
   Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù„Ùˆ Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ø§Ù‚ØµØ©ØŒ Ù„Ù† Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø­Ø±Ù "1".
#}
{% set db_user = user %}
{% set sess    = session_user %}
{% set avatar_candidate = (db_user and db_user.avatar_path) or (sess and sess.avatar_path) or '' %}
{% set _ava3 = avatar_src(avatar_candidate) %}

<div class="d-flex align-items-center gap-3 mb-3">
  <div class="rounded-circle border" style="width:64px;height:64px;overflow:hidden">
    {% if _ava3 and not _ava3.endswith('placeholder.png') %}
      <img src="{{ _ava3 }}"
           alt="avatar"
           referrerpolicy="no-referrer"
           onerror="this.onerror=null;this.src='/static/placeholder.png'"
           style="width:100%;height:100%;object-fit:cover">
    {% else %}
      {# Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¹Ù†Ø¯ ØºÙŠØ§Ø¨ Ø§Ù„ØµÙˆØ±Ø© ÙØ¹Ù„Ø§Ù‹ ÙÙ‚Ø· #}
      <div class="w-100 h-100 d-flex align-items-center justify-content-center fw-bold">
        {{ ((db_user.first_name or db_user.email or 'U')[:1] | upper) if db_user else 'U' }}
      </div>
    {% endif %}
  </div>

  <div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h2 class="m-0">{{ (db_user.first_name or '') }} {{ (db_user.last_name or '') }}</h2>
      {{ render_badges(db_user, '20px') }}
    </div>
    <div class="text-muted small mt-1">
      Ø§Ù„Ø¨Ø±ÙŠØ¯: {{ db_user.email or 'â€”' }} Â· Ø§Ù„Ù‡Ø§ØªÙ: {{ db_user.phone or 'â€”' }}
      Â· Ø¹Ø¶Ùˆ Ù…Ù†Ø°: {{ (db_user.created_at.strftime('%d-%m-%Y') if db_user.created_at) }}
    </div>
  </div>
</div>

<hr class="my-3">

<div class="row gy-3">
  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">ğŸ“¦ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ</h5>
      <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: <strong>{{ items_count }}</strong></div>
      <div>Ø§Ù„ÙØ¹Ø§Ù„Ø©: <strong>{{ items_active_count }}</strong></div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h5>
      <div>Ø§Ù„Ù…ØªÙˆØ³Ø·: <strong>{{ avg_stars }}/5</strong></div>
      <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª: <strong>{{ ratings_count }}</strong></div>
    </div>
  </div>
</div>

{% if reviews and reviews|length %}
<hr class="my-4">
<h5>Ø¢Ø®Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</h5>
<ul class="list-group">
  {% for r in reviews %}
    <li class="list-group-item">
      <div class="fw-bold text-warning">â˜… {{ r.stars }}/5</div>
      <div class="text-muted small">{{ r.created_at.strftime('%d-%m-%Y') if r.created_at }}</div>
      <div class="mt-1">{{ r.comment or 'â€”' }}</div>
      <div class="text-muted small">Ù…Ù†: {{ r.rater_name }}</div>
    </li>
  {% endfor %}
</ul>
{% endif %}

<hr class="my-4">
<div class="text-center">
  <a href="/profile/docs" class="btn btn-outline-primary">ğŸ“„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø£Ùˆ ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</a>
</div>

{% endblock %}
