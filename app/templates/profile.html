{% extends "base.html" %}
{% block content %}
{% from "_badges.html" import render_badges %}

<style>
  .card-blur {
    background: rgba(18, 22, 30, .75);
    border: 1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(6px);
    border-radius: 14px;
    color: #e6e9ef;
  }
  .text-strong { color: #fff; }
  .text-soft { color: #cfd3da; }
  .star { font-size: 1.1rem; margin-inline: 1px; }
  .badge-icon { height: 20px; width: 20px; vertical-align: middle; margin-inline-start: 4px; }
</style>

<div class="mb-4 d-flex align-items-center justify-content-between">
  <h3 class="mb-0 text-strong">
    {{ user.first_name }} {{ user.last_name }}
    {{ render_badges(user, 20) }}
  </h3>
  <a class="btn btn-outline-light btn-sm" href="/u/{{ user.id }}">عرض عام</a>
</div>

<!-- بطاقة معلومات -->
<div class="card card-blur mb-4">
  <div class="card-body d-flex flex-wrap justify-content-between gap-3">
    <div class="flex-grow-1">
      <div class="small text-soft mb-2">
        البريد: <span class="text-light">{{ user.email }}</span> •
        الهاتف: <span class="text-light">{{ user.phone }}</span> •
        عضو منذ {{ user.created_at.strftime("%Y-%m-%d") if user.created_at else "" }}
      </div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge {% if user.status=='approved' %}bg-success{% elif user.status=='pending' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
          {{ user.status }}
        </span>
        <span class="badge bg-secondary">{{ user.role }}</span>
        {% if user.is_verified %}
          <span class="badge bg-primary">موثّق ✔</span>
        {% endif %}
      </div>
    </div>
    <div>
      <a href="/profile/edit" class="btn btn-primary">تعديل الملف</a>
    </div>
  </div>
</div>

<!-- إحصائيات سريعة -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card card-blur">
      <div class="card-body d-flex justify-content-between">
        <div>
          <div class="small text-soft">العناصر المنشورة</div>
          <div class="fs-4 fw-bold text-strong">{{ items_count }}</div>
        </div>
        <span class="badge bg-dark">النشطة: {{ items_active_count }}</span>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card card-blur">
      <div class="card-body d-flex justify-content-between">
        <div>
          <div class="small text-soft">متوسط التقييم</div>
          <div class="d-flex align-items-end gap-2">
            <div class="fs-4 fw-bold text-strong">{{ "%.1f"|format(avg_stars) }}</div>
            <div>
              {% for i in range(1,6) %}
                {% if i <= avg_stars|round(0,'floor') %}
                  <span class="star text-warning">★</span>
                {% else %}
                  <span class="star text-muted">☆</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
        <span class="badge bg-dark">التقييمات: {{ ratings_count }}</span>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card card-blur">
      <div class="card-body d-flex justify-content-between">
        <div>
          <div class="small text-soft">رسائل غير مقروءة</div>
          <div class="fs-4 fw-bold text-strong">
            {% set unread = (request.state.unread_messages|default(0))|int %}
            {% if unread > 9 %}+9{% else %}{{ unread }}{% endif %}
          </div>
        </div>
        <a href="/messages" class="btn btn-outline-light">عرض</a>
      </div>
    </div>
  </div>
</div>

<!-- مقالاتي -->
<div class="card card-blur mb-4">
  <div class="card-body">
    <h5 class="mb-3">مقالاتي</h5>
    {% if items and items|length %}
      <ul>
        {% for it in items %}
          <li><a href="/items/{{ it.id }}">{{ it.title }}</a></li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">لا يوجد عناصر.</div>
    {% endif %}
  </div>
</div>

<!-- آخر المراجعات -->
<div class="card card-blur">
  <div class="card-body">
    <h5 class="mb-3">آخر المراجعات</h5>
    {% if reviews and reviews|length %}
      <div class="list-group">
        {% for r in reviews %}
          <div class="list-group-item bg-transparent text-light border-secondary">
            <div class="d-flex justify-content-between">
              <div class="fw-bold">{{ r.rater_name }}</div>
              <div class="small text-soft">{{ r.created_at.strftime("%Y-%m-%d") }}</div>
            </div>
            <div class="mb-1">
              {% for i in range(1,6) %}
                {% if i <= r.stars %}
                  <span class="star text-warning">★</span>
                {% else %}
                  <span class="star text-muted">☆</span>
                {% endif %}
              {% endfor %}
            </div>
            {% if r.comment %}
              <div>{{ r.comment }}</div>
            {% else %}
              <div class="text-muted">لا توجد ملاحظة.</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">لا توجد مراجعات.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
