{# ============================================================
   app/templates/profile.html
   Profile Page â€” works with Cloudinary
   ============================================================ #}

{% extends "base.html" %}

{# == Local safe macros == #}
{% macro build_src(p) -%}
  {%- set s = (p or '') -%}
  {%- if s.startswith('http://') or s.startswith('https://') -%}
    {{- s -}}
  {%- else -%}
    {{- '/' ~ s.lstrip('/') if s else '' -}}
  {%- endif -%}
{%- endmacro %}

{% macro avatar_src(p) -%}
  {%- set s = (p or '') -%}
  {%- if s.startswith('http://') or s.startswith('https://') -%}
    {{- s -}}
  {%- elif s and (not s.startswith('/uploads/')) -%}
    {{- '/' ~ s.lstrip('/') -}}
  {%- else -%}
    {{- '/static/placeholder.png' -}}
  {%- endif -%}
{%- endmacro %}

{% from "_badges.html" import render_badges %}
{% block content %}

{# ğŸ”’ IMPORTANT:
   Prefer database image first, then session one.
   This ensures that if the session is missing, we donâ€™t fall back to â€œ1â€.
#}
{% set db_user = user %}
{% set sess    = session_user %}
{% set avatar_candidate = (db_user and db_user.avatar_path) or (sess and sess.avatar_path) or '' %}
{% set _ava3 = avatar_src(avatar_candidate) %}

<div class="d-flex align-items-center gap-3 mb-3">
  <div class="rounded-circle border" style="width:64px;height:64px;overflow:hidden">
    {% if _ava3 and not _ava3.endswith('placeholder.png') %}
      <img src="{{ _ava3 }}"
           alt="avatar"
           referrerpolicy="no-referrer"
           onerror="this.onerror=null;this.src='/static/placeholder.png'"
           style="width:100%;height:100%;object-fit:cover">
    {% else %}
      {# First letter only when thereâ€™s truly no image #}
      <div class="w-100 h-100 d-flex align-items-center justify-content-center fw-bold">
        {{ ((db_user.first_name or db_user.email or 'U')[:1] | upper) if db_user else 'U' }}
      </div>
    {% endif %}
  </div>

  <div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h2 class="m-0">{{ (db_user.first_name or '') }} {{ (db_user.last_name or '') }}</h2>
      {{ render_badges(db_user, '20px') }}
    </div>
    <div class="text-muted small mt-1">
      Email: {{ db_user.email or 'â€”' }} Â· Phone: {{ db_user.phone or 'â€”' }}
      Â· Member since: {{ (db_user.created_at.strftime('%d-%m-%Y') if db_user.created_at) }}
    </div>
  </div>
</div>

<hr class="my-3">

<div class="row gy-3">
  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">ğŸ“¦ My Listings</h5>
      <div>Total items: <strong>{{ items_count }}</strong></div>
      <div>Active: <strong>{{ items_active_count }}</strong></div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">â­ Ratings</h5>
      <div>Average: <strong>{{ avg_stars }}/5</strong></div>
      <div>Reviews count: <strong>{{ ratings_count }}</strong></div>
    </div>
  </div>
</div>

{% if reviews and reviews|length %}
<hr class="my-4">
<h5>Latest Reviews</h5>
<ul class="list-group">
  {% for r in reviews %}
    <li class="list-group-item">
      <div class="fw-bold text-warning">â˜… {{ r.stars }}/5</div>
      <div class="text-muted small">{{ r.created_at.strftime('%d-%m-%Y') if r.created_at }}</div>
      <div class="mt-1">{{ r.comment or 'â€”' }}</div>
      <div class="text-muted small">From: {{ r.rater_name }}</div>
    </li>
  {% endfor %}
</ul>
{% endif %}

<hr class="my-4">
<div class="text-center">
  <a href="/profile/docs" class="btn btn-outline-primary">ğŸ“„ Edit Documents or Profile Photo</a>
</div>

{% endblock %}
