{% extends "base.html" %}
{% block content %}

<style>
  /* ألوان عالية التباين للوضع الداكن */
  :root {
    --surface: rgba(18, 22, 30, .75);
    --surface-border: rgba(255,255,255,.18);
    --text-strong: #ffffff;
    --text-normal: #e6e9ef;
    --text-soft: #cfd3da;
    --text-dim: #b9bec7;
    --accent: #a78bfa;
    --chip-bg: rgba(255,255,255,.12);
  }
  .card-blur { background: var(--surface); border: 1px solid var(--surface-border); backdrop-filter: blur(6px); border-radius: 14px; color: var(--text-normal); }
  .text-soft{ color: var(--text-soft)!important } .text-dim{ color: var(--text-dim)!important } .text-strong{ color: var(--text-strong)!important }
  .stat-chip{ border-radius:999px; padding:.35rem .75rem; font-weight:600; background:var(--chip-bg); color:var(--text-strong); border:1px solid rgba(255,255,255,.1); }
  .star{ font-size:1.1rem; line-height:1; margin-inline:1px; }
  .section-title{ color:var(--text-strong); letter-spacing:.2px; }
  .review-item{ background:transparent; color:var(--text-normal); border-color:rgba(255,255,255,.14)!important; }
  .review-comment{ color:var(--text-normal); }
  .outlined{ box-shadow: inset 0 0 0 1px var(--accent); border-radius:16px; }
  .badge-icon{ height:24px; width:24px; margin-inline-start:6px; vertical-align:middle; display:inline-block; }
</style>

{# ==== لا نغيّر باك-إند: نحسب الفرونت فقط ==== #}
{# قيم افتراضية للحقول التي قد لا تكون متوفرة لديك #}
{% set _created = user.created_at if user.created_at else None %}
{% set _created_iso = _created.isoformat() if _created else "" %}
{% set _role = user.role %}
{% set _verified = 1 if user.is_verified else 0 %}
{% set _ratings_count = ratings_count|default(0) %}
{% set _avg_stars = avg_stars|default(0) %}
{% set _five_star_count = 0 %}        {# عدّل الرقم يدويًا إن أردت #}
{% set _returns_success_count = 0 %}  {# عدّل الرقم يدويًا إن أردت #}

<div class="mb-4 d-flex align-items-center justify-content-between">
  <h3 class="mb-0 text-strong">صفحتي</h3>
  <a class="btn btn-outline-light btn-sm" href="/u/{{ user.id }}">عرض عام</a>
</div>

<!-- بطاقة معلومات المستخدم -->
<div class="card card-blur mb-4 outlined">
  <div class="card-body d-flex align-items-center gap-4 flex-wrap">

    <div class="flex-grow-1">
      <h5 class="mb-1">
        {{ user.first_name }} {{ user.last_name }}
        {% if user.is_verified %}
          <img src="/static/img/adm.png" alt="موثّق" class="verified-badge">
        {% endif %}
        <!-- مكان الشارات (يُملأ بالسكربت) -->
        <span id="badges-profile"
              data-role="{{ _role }}"
              data-created="{{ _created_iso }}"
              data-verified="{{ _verified }}"
              data-stars-all="{{ _ratings_count }}"
              data-avg="{{ _avg_stars }}"
              data-stars5="{{ _five_star_count }}"
              data-returns="{{ _returns_success_count }}">
        </span>
      </h5>

      <div class="small text-soft mb-2">
        البريد: <span class="text-normal">{{ user.email }}</span>
        &nbsp;•&nbsp;
        الهاتف: <span class="text-normal">{{ user.phone }}</span>
      </div>

      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge bg-{% if user.status=='approved' %}success{% elif user.status=='pending' %}warning text-dark{% else %}danger{% endif %}">
          {{ user.status }}
        </span>
        <span class="badge bg-secondary"> {{ user.role }} </span>
        <span class="badge bg-dark-subtle text-dark">
          عضو منذ {{ joined_at.strftime("%Y-%m-%d") }}
        </span>
      </div>
    </div>

    <div class="text-end">
      <a href="/profile/edit" class="btn btn-primary">تعديل الملف</a>
    </div>
  </div>
</div>

<!-- الإحصائيات السريعة -->
<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="card card-blur outlined">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">العناصر المنشورة</div>
          <div class="fs-4 fw-bold text-strong">{{ items_count }}</div>
        </div>
        <span class="stat-chip">النشطة: {{ items_active_count }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-blur outlined">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">متوسط التقييم</div>
          <div class="d-flex align-items-end gap-2">
            <div class="fs-4 fw-bold text-strong">{{ "%.1f"|format(avg_stars) }}</div>
            <div aria-label="تقييم نجوم">
              {% for i in range(1,6) %}
                {% if i <= avg_stars|round(0, 'floor') %}
                  <span class="star text-warning">★</span>
                {% elif i - avg_stars < 1 and i > avg_stars %}
                  <span class="star text-warning">☆</span>
                {% else %}
                  <span class="star text-dim">☆</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
        <span class="stat-chip">التقييمات: {{ ratings_count }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-blur outlined">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">الرسائل غير المقروءة</div>
          <div class="fs-4 fw-bold text-strong">
            {% set unread = (request.state.unread_messages|default(0))|int %}
            {% if unread > 9 %}+9{% else %}{{ unread }}{% endif %}
          </div>
        </div>
        <a class="btn btn-outline-light" href="/messages">عرض الرسائل</a>
      </div>
    </div>
  </div>
</div>

<!-- آخر المراجعات -->
<div class="card card-blur outlined">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0 section-title">آخر المراجعات</h5>
      <a class="btn btn-sm btn-outline-secondary disabled">قريبًا: عرض الكل</a>
    </div>

    {% if reviews and reviews|length %}
      <div class="list-group">
        {% for r in reviews %}
          <div class="list-group-item review-item border-secondary">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
              <div class="fw-semibold text-strong">{{ r.rater_name }}</div>
              <div class="small text-soft">{{ r.created_at.strftime("%Y-%m-%d") }}</div>
            </div>

            <div class="mb-1">
              {% for i in range(1,6) %}
                {% if i <= r.stars %}
                  <span class="star text-warning">★</span>
                {% else %}
                  <span class="star text-dim">☆</span>
                {% endif %}
              {% endfor %}
            </div>

            {% if r.comment %}
              <div class="review-comment">
                {{ r.comment | e | replace('\n', '<br>') | safe }}
              </div>
            {% else %}
              <div class="text-soft">لا توجد ملاحظة نصّية.</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-light border-0 mb-0 text-dark">لا توجد تقييمات بعد.</div>
    {% endif %}
  </div>
</div>

<!-- سكربت عرض الشارات (فرونت فقط) -->
<script>
(function(){
  function daysFrom(iso){
    if(!iso) return 99999;
    const d = new Date(iso);
    if(isNaN(d.getTime())) return 99999;
    const ms = Date.now() - d.getTime();
    return Math.floor(ms / 86400000);
  }
  function add(img, alt){
    const el = document.createElement('img');
    el.src = img; el.alt = alt; el.className = 'badge-icon';
    return el;
  }
  function render(container){
    if(!container) return;
    const role = (container.dataset.role||'').toLowerCase();
    const created = container.dataset.created || '';
    const verified = Number(container.dataset.verified||0) === 1;
    const days = daysFrom(created);
    const fiveStar = Number(container.dataset.stars5||0);
    const returnsOk = Number(container.dataset.returns||0);
    const ratingsAll = Number(container.dataset.starsAll||0);
    const avg = Number(container.dataset.avg||0);

    // قواعدك:
    // 1) الأزرق/بنفسجي للأدمِن فقط
    if(role === 'admin'){
      container.appendChild(add('/static/img/adm.png','Admin'));
    }

    // 2) الأصفر (<60 يوم) → يختفي ويظهر PRO خضراء (60.. <365) → بعد عام PRO ذهبية (>=365)
    //    للأدمِن: لا نعرض الأصفر ولا PRO الخضراء ولا البنفسجية (حسب وصفك).
    const allowProYellow = (role !== 'admin');
    const allowProGreen  = (role !== 'admin');
    const allowViolet    = (role !== 'admin');

    if(allowProYellow && days < 60){
      container.appendChild(add('/static/img/jaune.png','New'));
    } else if(allowProGreen && days >= 60 && days < 365){
      container.appendChild(add('/static/img/ProVert.png','Pro Green'));
    } else if(days >= 365){
      container.appendChild(add('/static/img/ProGold.png','Pro Gold'));
    }

    // 3) البنفسجية (ثقة): توثيق يدوي OR ≥20 تقييم 5★
    if(allowViolet && (verified || fiveStar >= 20)){
      container.appendChild(add('/static/img/violet.png','Trust'));
    }

    // 4) الخضراء: ≥10 عمليات تأجير مُعادة بنجاح (يدويًا الآن من data-returns)
    if(returnsOk >= 10){
      container.appendChild(add('/static/img/Vert.png','Safe Renter'));
    }

    // 5) البرتقالية: ≥10 تقييم 5★ (الآن نعتمد data-stars5 فقط)
    if(fiveStar >= 10){
      container.appendChild(add('/static/img/orange.png','Top Rated'));
    }

    // ملاحظة: إذا ما عندك fiveStar/returns الآن، سيبقون مخفيين (القيمة 0).
    // يمكنك تغيير الأرقام يدويًا في الـ data-* حتى بدون باك-إند.
  }

  render(document.getElementById('badges-profile'));
})();
</script>

{% endblock %}
