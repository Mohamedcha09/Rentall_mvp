{# ============================================================
   app/templates/profile.html
   ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ â€” ØªØ¹Ù…Ù„ Ù…Ø¹ Cloudinary
   ============================================================ #}

{% extends "base.html" %}
{% from "base.html" import avatar_src, build_src %}
{% from "_badges.html" import render_badges %}
{% block content %}

{% set u = session_user or user %}

<div class="d-flex align-items-center gap-3 mb-3">
  <div class="rounded-circle border" style="width:64px;height:64px;overflow:hidden">
    {% set _ava3 = avatar_src(u.avatar_path if u else '') %}
    {% if _ava3 and not _ava3.endswith('placeholder.png') %}
      <img src="{{ _ava3 }}"
           alt="avatar"
           referrerpolicy="no-referrer"
           onerror="this.onerror=null;this.src='/static/placeholder.png'"
           style="width:100%;height:100%;object-fit:cover">
    {% else %}
      <div class="w-100 h-100 d-flex align-items-center justify-content-center fw-bold">
        {{ (u.first_name or u.email or 'U')[:1] | upper if u else 'U' }}
      </div>
    {% endif %}
  </div>

  <div>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <h2 class="m-0">{{ (u.first_name or user.first_name) }} {{ (u.last_name or user.last_name) }}</h2>
      {{ render_badges(user, '20px') }}
    </div>
    <div class="text-muted small mt-1">
      Ø§Ù„Ø¨Ø±ÙŠØ¯: {{ u.email or user.email }} Â· Ø§Ù„Ù‡Ø§ØªÙ: {{ u.phone or user.phone or 'â€”' }}
      Â· Ø¹Ø¶Ùˆ Ù…Ù†Ø°: {{ (user.created_at.strftime('%d-%m-%Y') if user.created_at) }}
    </div>
  </div>
</div>

<hr class="my-3">

<div class="row gy-3">
  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">ğŸ“¦ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙŠ</h5>
      <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: <strong>{{ items_count }}</strong></div>
      <div>Ø§Ù„ÙØ¹Ø§Ù„Ø©: <strong>{{ items_active_count }}</strong></div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h5>
      <div>Ø§Ù„Ù…ØªÙˆØ³Ø·: <strong>{{ avg_stars }}/5</strong></div>
      <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª: <strong>{{ ratings_count }}</strong></div>
    </div>
  </div>
</div>

{% if reviews and reviews|length %}
<hr class="my-4">
<h5>Ø¢Ø®Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</h5>
<ul class="list-group">
  {% for r in reviews %}
    <li class="list-group-item">
      <div class="fw-bold text-warning">â˜… {{ r.stars }}/5</div>
      <div class="text-muted small">{{ r.created_at.strftime('%d-%m-%Y') if r.created_at }}</div>
      <div class="mt-1">{{ r.comment or 'â€”' }}</div>
      <div class="text-muted small">Ù…Ù†: {{ r.rater_name }}</div>
    </li>
  {% endfor %}
</ul>
{% endif %}

<hr class="my-4">
<div class="text-center">
  <a href="/profile/docs" class="btn btn-outline-primary">ğŸ“„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø£Ùˆ ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</a>
</div>

{% endblock %}
