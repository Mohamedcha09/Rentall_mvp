{% extends "base.html" %}
{% block content %}

<style>
  /* ألوان عالية التباين للوضع الداكن */
  :root {
    --surface: rgba(18, 22, 30, .75);
    --surface-border: rgba(255,255,255,.18);
    --text-strong: #ffffff;
    --text-normal: #e6e9ef;
    --text-soft: #cfd3da;
    --text-dim: #b9bec7;
    --accent: #a78bfa;
    --chip-bg: rgba(255,255,255,.12);
  }
  .card-blur { background: var(--surface); border: 1px solid var(--surface-border); backdrop-filter: blur(6px); border-radius: 14px; color: var(--text-normal); }
  .text-soft{ color: var(--text-soft)!important } .text-dim{ color: var(--text-dim)!important } .text-strong{ color: var(--text-strong)!important }
  .stat-chip{ border-radius:999px; padding:.35rem .75rem; font-weight:600; background:var(--chip-bg); color:var(--text-strong); border:1px solid rgba(255,255,255,.1); }
  .star{ font-size:1.1rem; line-height:1; margin-inline:1px; }
  .section-title{ color:var(--text-strong); letter-spacing:.2px; }
  .review-item{ background:transparent; color:var(--text-normal); border-color:rgba(255,255,255,.14)!important; }
  .review-comment{ color:var(--text-normal); }
  .outlined{ box-shadow: inset 0 0 0 1px var(--accent); border-radius:16px; }
  .badge-icon{ height:24px; width:24px; margin-inline-start:6px; vertical-align:middle; display:inline-block; }
  .verified-badge{ width:16px; height:16px; vertical-align:-2px; margin-inline-start:.35rem; display:inline-block; }
  .verified-shadow{ filter: drop-shadow(0 0 2px rgba(29,161,242,.45)); }
</style>

{# قيم مساعدة من دون الاعتماد على باك-إند إضافي #}
{% set _created = user.created_at if user and user.created_at else None %}
{% set _created_iso = _created.isoformat() if _created else "" %}
{% set _role = user.role if user else '' %}
{% set _verified = 1 if (user and user.is_verified) else 0 %}
{% set _ratings_count = ratings_count|default(0) %}
{% set _avg_stars = avg_stars|default(0) %}
{% set _five_star_count = five_star_count|default(0) %}        {# عدد تقييمات 5★ (إن لم يكن لديك احسبه لاحقًا) #}
{% set _returns_success_count = returns_success_count|default(0) %}  {# عدد عمليات التأجير المعادة بنجاح #}

<div class="mb-4 d-flex align-items-center justify-content-between">
  <h3 class="mb-0 text-strong">
    صفحتي
  </h3>
  <a class="btn btn-outline-light btn-sm" href="/u/{{ user.id }}">عرض عام</a>
</div>

<!-- بطاقة معلومات المستخدم -->
<div class="card card-blur mb-4 outlined">
  <div class="card-body d-flex align-items-center gap-4 flex-wrap">

    <div class="flex-grow-1">
      <h5 class="mb-1">
        {{ user.first_name }} {{ user.last_name }}

        {# شارة التوثيق الزرقاء من Sprite في base.html #}
        {% if user.is_verified %}
          <svg class="verified-badge verified-shadow" aria-label="موثّق">
            <use href="#icon-verified"/>
          </svg>
        {% endif %}

        {# مكان الشارات (يمتلئ بالـJS حسب القواعد) #}
        <span id="badges-profile"
              data-role="{{ _role }}"
              data-created="{{ _created_iso }}"
              data-verified="{{ _verified }}"
              data-stars-all="{{ _ratings_count }}"
              data-avg="{{ _avg_stars }}"
              data-stars5="{{ _five_star_count }}"
              data-returns="{{ _returns_success_count }}">
        </span>
      </h5>

      <div class="small text-soft mb-2">
        البريد: <span class="text-normal">{{ user.email }}</span>
        &nbsp;•&nbsp;
        الهاتف: <span class="text-normal">{{ user.phone }}</span>
      </div>

      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="badge bg-{% if user.status=='approved' %}success{% elif user.status=='pending' %}warning text-dark{% else %}danger{% endif %}">
          {{ user.status }}
        </span>
        <span class="badge bg-secondary"> {{ user.role }} </span>
        <span class="badge bg-dark-subtle text-dark">
          عضو منذ {{ (user.created_at or joined_at).strftime("%Y-%m-%d") if (user.created_at or joined_at) else "" }}
        </span>
      </div>
    </div>

    <div class="text-end">
      <a href="/profile/edit" class="btn btn-primary">تعديل الملف</a>
    </div>
  </div>
</div>

<!-- الإحصائيات السريعة -->
<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="card card-blur outlined">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">العناصر المنشورة</div>
          <div class="fs-4 fw-bold text-strong">{{ items_count }}</div>
        </div>
        <span class="stat-chip">النشطة: {{ items_active_count }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-blur outlined">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">متوسط التقييم</div>
          <div class="d-flex align-items-end gap-2">
            <div class="fs-4 fw-bold text-strong">{{ "%.1f"|format(_avg_stars) }}</div>
            <div aria-label="تقييم نجوم">
              {% for i in range(1,6) %}
                {% if i <= _avg_stars|round(0, 'floor') %}
                  <span class="star text-warning">★</span>
                {% elif i - _avg_stars < 1 and i > _avg_stars %}
                  <span class="star text-warning">☆</span>
                {% else %}
                  <span class="star text-dim">☆</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
        <span class="stat-chip">التقييمات: {{ _ratings_count }}</span>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-blur outlined">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <div class="small text-soft">الرسائل غير المقروءة</div>
          <div class="fs-4 fw-bold text-strong">
            {% set unread = (request.state.unread_messages|default(0))|int %}
            {% if unread > 9 %}+9{% else %}{{ unread }}{% endif %}
          </div>
        </div>
        <a class="btn btn-outline-light" href="/messages">عرض الرسائل</a>
      </div>
    </div>
  </div>
</div>

<!-- آخر المراجعات -->
<div class="card card-blur outlined">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0 section-title">آخر المراجعات</h5>
      <a class="btn btn-sm btn-outline-secondary disabled">قريبًا: عرض الكل</a>
    </div>

    {% if reviews and reviews|length %}
      <div class="list-group">
        {% for r in reviews %}
          <div class="list-group-item review-item border-secondary">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
              <div class="fw-semibold text-strong">{{ r.rater_name }}</div>
              <div class="small text-soft">{{ r.created_at.strftime("%Y-%m-%d") }}</div>
            </div>

            <div class="mb-1">
              {% for i in range(1,6) %}
                {% if i <= r.stars %}
                  <span class="star text-warning">★</span>
                {% else %}
                  <span class="star text-dim">☆</span>
                {% endif %}
              {% endfor %}
            </div>

            {% if r.comment %}
              <div class="review-comment">
                {{ r.comment | e | replace('\n', '<br>') | safe }}
              </div>
            {% else %}
              <div class="text-soft">لا توجد ملاحظة نصّية.</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-light border-0 mb-0 text-dark">لا توجد تقييمات بعد.</div>
    {% endif %}
  </div>
</div>

<!-- سكربت عرض الشارات (فرونت فقط) -->
<script>
(function(){
  function daysFrom(iso){
    if(!iso) return 99999;
    const d = new Date(iso);
    if(isNaN(d.getTime())) return 99999;
    return Math.floor((Date.now() - d.getTime()) / 86400000);
  }
  function icon(path, alt){
    const el = document.createElement('img');
    el.src = path; el.alt = alt; el.className = 'badge-icon';
    return el;
  }
  function render(container){
    if(!container) return;

    const role       = (container.dataset.role||'').toLowerCase();
    const createdIso = container.dataset.created || '';
    const verified   = Number(container.dataset.verified||0) === 1;
    const days       = daysFrom(createdIso);
    const s5         = Number(container.dataset.stars5||0);
    const returnsOk  = Number(container.dataset.returns||0);

    // 1) البنفسجي-الأزرق (adm.png) للأدمِن فقط
    if(role === 'admin'){
      container.appendChild(icon('/static/img/adm.png','Admin'));
    }

    // 2) الأصفر (<60 يوم) → Pro أخضر (60.. <365) → Pro ذهبي (>=365)
    if(days < 60){
      container.appendChild(icon('/static/img/jaune.png','New'));
    } else if(days >= 60 && days < 365){
      container.appendChild(icon('/static/img/ProVert.png','Pro Green'));
    } else {
      container.appendChild(icon('/static/img/ProGold.png','Pro Gold'));
    }

    // 3) البنفسجي (ثقة): توثيق يدوي أو ≥20 تقييم 5★
    if(verified || s5 >= 20){
      container.appendChild(icon('/static/img/violet.png','Trust'));
    }

    // 4) الخضراء (Vert.png): ≥10 عمليات استئجار أُعيدت بنجاح
    if(returnsOk >= 10){
      container.appendChild(icon('/static/img/Vert.png','Safe Renter'));
    }

    // 5) البرتقالية: ≥10 تقييمات 5★
    if(s5 >= 10){
      container.appendChild(icon('/static/img/orange.png','Top Rated'));
    }
  }

  render(document.getElementById('badges-profile'));
})();
</script>

{% endblock %}
