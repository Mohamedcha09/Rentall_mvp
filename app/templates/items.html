{# app/templates/items.html #}
{% extends "base.html" %}
{% from "_badges.html" import render_badges %}

{% block head %}
<style>
/* ================= BASE COLORS ================= */
html[dir="rtl"] body{color:#0f172a}
h1,h2,h3,h4,h5,h6,.section-title{color:#0f172a}
.small,.text-muted,.chip,.pill{color:#6b7280}

/* ================= ITEM CARDS ================= */
.spot{position:relative;border:none;background:transparent;box-shadow:none;border-radius:14px}
.spot-media{position:relative;aspect-ratio:1/1;border-radius:14px;overflow:hidden;background:#eef2f7}
.spot-media img{width:100%;height:100%;object-fit:cover}
.spot-overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.04),rgba(0,0,0,.1))}
.category-chip{position:absolute;top:8px;left:8px;padding:4px 9px;font-size:.74rem;font-weight:800;color:#111;background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:999px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.fav-btn{display:none}
.spot-body{padding:10px 4px 0}
.spot-title{font-weight:800;color:#111;font-size:clamp(.92rem,.86rem + .2vw,1rem);margin-bottom:4px;line-height:1.2;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
.spot-meta{display:flex;flex-direction:column;gap:2px;margin-top:4px}
.spot-price{font-weight:900;color:#111;font-size:.95rem}
.spot-price span{font-weight:600;opacity:.85}
.spot-city{color:#6b7280;font-size:.9rem}
.spot-rating{font-weight:800;color:#111;font-size:.88rem}
.spot-rating::before{content:"★ ";font-weight:900}

/* ================= GRID ================= */
.grid-items{display:grid;gap:14px;padding-inline:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
@media (min-width:576px){ .grid-items{grid-template-columns:repeat(3,minmax(0,1fr))} }
@media (min-width:768px){ .grid-items{grid-template-columns:repeat(4,minmax(0,1fr))} }
@media (min-width:992px){ .grid-items{grid-template-columns:repeat(5,minmax(0,1fr))} }
@media (min-width:1200px){ .grid-items{grid-template-columns:repeat(6,minmax(0,1fr))} }

/* ================= TOP CATEGORY BAR ================= */
.toolbar{display:flex;gap:8px;align-items:center;overflow:auto hidden;white-space:nowrap;padding-bottom:4px}
.pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff;color:#0f172a;text-decoration:none;font-weight:600}
.pill.active{border-color:#6C63FF;background:#f4f3ff;color:#6C63FF}

/* ================= SUBCATEGORY CHIPS ================= */
.subcat-bar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
    margin-bottom:16px;
}
.subcat-chip{
    padding:7px 12px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    color:#0f172a;
    text-decoration:none;
    font-size:.82rem;
    font-weight:600;
}
.subcat-chip.active{
    background:#6C63FF;
    border-color:#6C63FF;
    color:#fff;
}

/* ================= LOCATION BAR ================= */
.items-locbar{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06);
  padding:8px 10px;margin-block:14px;display:flex;gap:6px;align-items:center}
#itemsCityInput{height:36px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:#fff;padding:0 12px}
.items-locbar .btn{height:36px;border-radius:10px;font-weight:800}
#itemsSearchBtn{background:#6C63FF;border:none;color:#fff;padding:0 14px}

/* CITY SUGGESTION */
#itemsCitySugg{display:none;position:absolute;inset-inline:0;top:calc(100% + 6px);z-index:1000;max-height:240px;overflow:auto;
  background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.08)}
#itemsCitySugg>div{padding:.5rem .6rem;font-size:.95rem;color:#0f172a;border-top:1px solid rgba(0,0,0,.04);cursor:pointer}
#itemsCitySugg>div:hover{background:#f7f7fb}

/* إخفاء Items + Category فقط في الهاتف */
@media (max-width: 576px) {
  .items-hide-mobile {
    display: none !important;
  }
}


/* ================================
   MOBILE — NEW CATEGORY SLIDER STYLE
================================ */
@media (max-width: 576px) {

  /* الشريط كامل */
  .toolbar {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    white-space: nowrap;
    padding: 12px 6px;
    margin: 0 -8px 12px;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    background: rgba(255, 255, 255, 0.75);
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.35);
    box-shadow: 0 4px 22px rgba(0,0,0,0.08);
  }

  /* كبس الفئة */
  .toolbar .pill {
    padding: 10px 18px;
    border-radius: 999px;
    background: rgba(240,240,255,0.7);
    font-size: 0.90rem;
    font-weight: 700;
    border: none;
    color: #333;
    transition: all .25s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  }

  /* الفئة المختارة */
  .toolbar .pill.active {
    background: linear-gradient(135deg, #786BFF, #A88BFF);
    color: #fff;
    box-shadow: 0 4px 12px rgba(120,107,255,0.35);
    transform: scale(1.05);
  }

  /* Scroll Bar تصميم */
  .toolbar::-webkit-scrollbar {
    height: 0px;
  }

}




</style>

<style>
/* Hide topbar + mobile tabbar + stripe only on items page */
header.topbar,
.m-top-tabs,
.mobile-tabbar,
.stripe-callout {
    display: none !important;
}
body.has-tabbar {
    padding-bottom: 0 !important;
}
</style>

<style>
/* Hide ONLY top elements on items page */
header.topbar,
.m-top-tabs,
.stripe-callout {
    display: none !important;
}

/* Keep bottom tabbar visible */
.mobile-tabbar {
    display: flex !important;
}

/* Prevent extra bottom padding removal */
body.has-tabbar {
    padding-bottom: calc(92px + max(env(safe-area-inset-bottom,0px), 0px)) !important;
}
</style>


{% endblock %}

{% block content %}

<section class="container" style="max-width:1200px;margin:auto">

<!-- ====== HIDE THIS PART ONLY (Items + Category) ON MOBILE ====== -->
<div class="items-hide-mobile d-flex align-items-center mb-2" style="gap:8px">
    <div class="d-flex align-items-center" style="gap:10px">
        <h2 class="mb-0">Items</h2>
        <span class="pill" style="font-size:.82rem">
            {% if current_category %}Category: <b>{{ current_category }}</b>{% else %}All categories{% endif %}
        </span>
    </div>
</div>

<!-- ====== S L I D E R  (Always Visible on Mobile) ====== -->
<div class="toolbar" style="margin-bottom:10px;">
  <a class="pill {% if not current_category %}active{% endif %}" href="/items">All</a>
  {% for cat in categories %}
    <a class="pill {% if current_category == cat.name %}active{% endif %}" 
       href="/items?category={{ cat.name | urlencode }}">
       {{ cat.name }}
    </a>
  {% endfor %}
</div>


  <!-- ================= SUBCATEGORIES (only if category selected) ================ -->
  {% if current_category and subcategories and subcategories|length > 0 %}
  <div class="subcat-bar">
    {% for sub in subcategories %}
      <a class="subcat-chip {% if current_sub == sub.name %}active{% endif %}"
         href="/items?category={{ current_category | urlencode }}&sub={{ sub.name | urlencode }}">
        {{ sub.name }}
      </a>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ================= LOCATION BAR ================= -->
  <form id="itemsLocForm" class="items-locbar" action="/items" method="get" role="search">
    <div style="flex:1;position:relative">
      <input type="text" class="form-control" id="itemsCityInput" name="city"
             placeholder="Type city / area …" autocomplete="off"
             value="{{ selected_city or '' }}">
      <div id="itemsCitySugg"></div>
    </div>

    {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
    {% if current_sub %}<input type="hidden" name="sub" value="{{ current_sub }}">{% endif %}

    <button class="btn" id="itemsSearchBtn" type="submit">Search</button>
  </form>

  <!-- ================= ITEMS GRID ================= -->
  {% if items_view and items_view|length %}
    <div class="grid-items">
      {% for it in items_view %}
        <a href="/items/{{ it.item.id }}" class="spot text-decoration-none">
          <div class="spot-media">
            {% if it.item.image_path %}
              <img src="{{ it.item.image_path | media_url }}" alt="">
            {% else %}
              <img src="/static/placeholder.jpg" alt="">
            {% endif %}
            <div class="spot-overlay"></div>
            {% if it.item.category %}
              <span class="category-chip">{{ it.item.category }}</span>
            {% endif %}
          </div>
          <div class="spot-body">
            <div class="spot-title">{{ it.item.title }}</div>
            <div class="spot-meta">
              <div class="spot-price">
                <strong>{{ it.display_price | money(display_currency) }}</strong>
                <span>/day</span>
              </div>
              <div class="spot-city">{{ it.item.city or '—' }}</div>
              {% if it.item.avg_stars %}
                <div class="spot-rating">{{ "%.1f"|format(it.item.avg_stars) }}</div>
              {% endif %}
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary mt-3">No items match this selection.</div>
  {% endif %}
</section>

{% endblock %}

{% block scripts %}
<script>

/* ===== Location bar logic (City/GPS) ===== */
(function itemsLocBar(){
  const form   = document.getElementById('itemsLocForm');
  const cityEl = document.getElementById('itemsCityInput');
  const latEl  = document.getElementById('itemsLat');
  const lngEl  = document.getElementById('itemsLng');
  const gpsBtn = document.getElementById('itemsUseGPS');
  const clearBtn = document.getElementById('itemsClearGPS');
  const sugg   = document.getElementById('itemsCitySugg');

  function setCookie(n,v,d=180){try{const e=new Date();e.setTime(e.getTime()+d*864e5);document.cookie=n+"="+encodeURIComponent(v||"")+";expires="+e.toUTCString()+";path=/;SameSite=Lax";}catch(_){}} 
  function getCookie(n){const m=document.cookie.match(new RegExp('(?:^| )'+n+'=([^;]+)'));return m?decodeURIComponent(m[1]):"";}
  function delCookie(n){try{document.cookie=n+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Lax";}catch(_){}} 

  // Simple init
  try{
    const u=new URL(location.href);
    const c=u.searchParams.get('city')||getCookie('city')||"";
    const lat=u.searchParams.get('lat')||getCookie('lat')||"";
    const lng=u.searchParams.get('lng')||getCookie('lng')||"";
    if(cityEl)cityEl.value=c; if(latEl)latEl.value=lat; if(lngEl)lngEl.value=lng;
  }catch(_){}

  // GPS
  gpsBtn?.addEventListener('click',()=>{
    if(!navigator.geolocation){alert('Your browser does not support geolocation.');return;}
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude,lng=pos.coords.longitude;
      setCookie('lat',lat);setCookie('lng',lng);setCookie('city',"");
      if(cityEl)cityEl.value=""; if(latEl)latEl.value=lat; if(lngEl)lngEl.value=lng;
      const u=new URL(location.href);
      u.searchParams.set('lat',lat);u.searchParams.set('lng',lng);u.searchParams.delete('city');
      location.href=u.toString();
    },()=>alert('Could not get your location.'));
  });

  // Clear
  clearBtn?.addEventListener('click',()=>{
    delCookie('lat');delCookie('lng');
    const u=new URL(location.href);
    u.searchParams.delete('lat');u.searchParams.delete('lng');
    if(!(cityEl?.value||"").trim()){delCookie('city');u.searchParams.delete('city');}
    location.href=u.toString();
  });

  // Save city manually
  cityEl?.addEventListener('change',()=>{
    setCookie('city',(cityEl.value||"").trim());
    setCookie('lat',"");setCookie('lng',"");
  });

  /* ===== Single city suggestion ===== */
  let t=null;
  const ALLOWED=new Set(['city','town','village','municipality']);
  const FALLBACK=new Set(['state','province']);
  function hideSugg(){ if(sugg){sugg.style.display='none';sugg.innerHTML='';} }
  function showSugg(){ if(sugg){sugg.style.display='block';} }
  function detectLang(q){
    const s=(q||'').trim();
    if(/[\u0600-\u06FF]/.test(s))return'ar';
    const fr=/[àâäæçéèêëîïôœùûüÿÀÂÄÆÇÉÈÊËÎÏÔŒÙÛÜŸ]/.test(s)||/\b(le|la|les|de|des|du|aux|au|à|sur|saint|sainte|chez)\b/i.test(s);
    return fr?'fr':'en';
  }
  function normalizePlace(p){
    const a=p.address||{},type=(p.type||'').toLowerCase(),cc=(a.country_code||'').toLowerCase();
    const city=a.city||a.town||a.village||a.municipality||a.state||a.province||(p.display_name||'').split(',')[0];
    const prioMap={city:1,town:2,village:3,municipality:3,state:6,province:6,administrative:8,county:8,region:8};
    return{city,country:a.country||'',cc,lat:p.lat,lon:p.lon,type,prio:(prioMap[type]??9)};
  }
  function pickBestUnique(list){
    const best=new Map();
    for(const p of list){
      const n=normalizePlace(p);
      if(!n.city||!n.cc)continue;
      const key=n.city.trim().toLowerCase()+'|'+n.cc;
      const prev=best.get(key);
      if(!prev||n.prio<prev.prio)best.set(key,n);
    }
    return Array.from(best.values());
  }

  cityEl?.addEventListener('input',function(){
    clearTimeout(t);
    const q=this.value.trim();
    if(q.length<2){hideSugg();return;}
    t=setTimeout(async()=>{
      try{
        const lang=detectLang(q);
        const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=30&accept-language='+encodeURIComponent(lang)+'&q='+encodeURIComponent(q);
        const r=await fetch(url,{headers:{'Accept':'application/json'}});
        if(!r.ok){hideSugg();return;}
        let data=await r.json();
        let f=data.filter(x=>ALLOWED.has((x.type||'').toLowerCase()));
        if(!f.length)f=data.filter(x=>FALLBACK.has((x.type||'').toLowerCase()));
        if(!f.length)f=data;
        const u=pickBestUnique(f).sort((a,b)=>a.prio-b.prio);
        const best=u[0];
        if(!best){hideSugg();return;}
        const label=(best.city||'').trim()+(best.country?`, ${best.country}`:'');
        sugg.innerHTML=`<div class="py-2 px-2" data-best="1"><i class="bi bi-geo-alt"></i> <span>${label}</span></div>`;
        sugg.dataset.lat=best.lat||'';sugg.dataset.lon=best.lon||'';
        showSugg();
      }catch(_){hideSugg();}
    },250);
  });

  // Pick suggestion
  sugg?.addEventListener('click',()=>{
    const label=(sugg.querySelector('[data-best] span')?.textContent||'').trim();
    const lat=sugg.dataset.lat||'';const lon=sugg.dataset.lon||'';
    if(!label)return;
    cityEl.value=label;latEl.value=lat;lngEl.value=lon;
    setCookie('city',label);setCookie('lat',lat);setCookie('lng',lon);
    const u=new URL(location.href);
    u.searchParams.set('city',label);u.searchParams.set('lat',lat);u.searchParams.set('lng',lon);
    const cat=form.querySelector('[name="category"]')?.value;
    const sort=form.querySelector('[name="sort"]')?.value;
    if(cat)u.searchParams.set('category',cat);
    if(sort)u.searchParams.set('sort',sort);
    location.href=u.toString();
  });

  // Manual submit
  form?.addEventListener('submit',function(e){
    e.preventDefault();
    const c=(cityEl?.value||"").trim();
    const lat=(latEl?.value||"").trim();
    const lng=(lngEl?.value||"").trim();
    const u=new URL(location.href);
    ['city','lat','lng'].forEach(k=>u.searchParams.delete(k));
    if(lat && lng){
      setCookie('lat',lat);setCookie('lng',lng);setCookie('city',c||"");
      u.searchParams.set('lat',lat);u.searchParams.set('lng',lng); if(c)u.searchParams.set('city',c);
    }else if(c){
      setCookie('city',c);setCookie('lat',"");setCookie('lng',"");
      u.searchParams.set('city',c);
    }else{
      delCookie('city');delCookie('lat');delCookie('lng');
    }
    const cat=form.querySelector('[name="category"]')?.value;
    const sort=form.querySelector('[name="sort"]')?.value;
    if(cat)u.searchParams.set('category',cat);
    if(sort)u.searchParams.set('sort',sort);
    location.href=u.toString();
  });

  // Hide suggestions when clicking outside
  document.addEventListener('click',(e)=>{ if(sugg && !sugg.contains(e.target) && e.target!==cityEl){hideSugg();} });
})();

// ===== Scroll slider automatically to active category =====
document.addEventListener("DOMContentLoaded", function () {
    const toolbar = document.querySelector(".toolbar");
    const active = document.querySelector(".pill.active");

    if (toolbar && active) {
        // Scroll so the active category is visible in the middle
        const offset = active.offsetLeft - (toolbar.clientWidth / 2) + (active.clientWidth / 2);
        toolbar.scrollTo({
            left: offset,
            behavior: "smooth"
        });
    }
});

</script>
{% endblock %}
