{# app/templates/items.html #}
{% extends "base.html" %}
{% from "_badges.html" import render_badges %}

{% block head %}
<style>
/* ============ Ø£Ø³Ø§Ø³ Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ø¶Ø­Ø© ÙˆØªØ¨Ø§ÙŠÙ† ============ */
html[dir="rtl"] body{color:#0f172a}
h1,h2,h3,h4,h5,h6,.section-title{color:#0f172a}
.small,.text-muted,.chip,.pill{color:#6b7280}

/* ============ Ø¨Ø·Ø§Ù‚Ø§Øª (Ù†ÙØ³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) ============ */
.spot{position:relative;border:none;background:transparent;box-shadow:none;border-radius:14px}
.spot-media{position:relative;aspect-ratio:1/1;border-radius:14px;overflow:hidden;background:#eef2f7}
.spot-media img{width:100%;height:100%;object-fit:cover}
.spot-overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.04),rgba(0,0,0,.1))}
.category-chip{position:absolute;top:8px;left:8px;padding:4px 9px;font-size:.74rem;font-weight:800;color:#111;background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:999px;box-shadow:0 3px 8px rgba(0,0,0,.08)}
.fav-btn{display:none}   /* Ù…Ø§ Ù†Ø­ØªØ§Ø¬ Ù‚Ù„Ø¨ Ù‡Ù†Ø§ */
.spot-body{padding:10px 4px 0}
.spot-title{font-weight:800;color:#111;font-size:clamp(.92rem,.86rem + .2vw,1rem);margin-bottom:4px;line-height:1.2;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
.spot-meta{display:flex;flex-direction:column;gap:2px;margin-top:4px}
.spot-price{font-weight:900;color:#111;font-size:.95rem}
.spot-price span{font-weight:600;opacity:.85}
.spot-city{color:#6b7280;font-size:.9rem}
.spot-rating{font-weight:800;color:#111;font-size:.88rem}
.spot-rating::before{content:"â˜… ";font-weight:900}
.owner-line,.spot-footer,.price-badge{display:none}

/* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± 2-3-4-5-6 Ø£Ø¹Ù…Ø¯Ø© Ù…Ø«Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.grid-items{display:grid;gap:14px;padding-inline:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
@media (min-width:576px){ .grid-items{grid-template-columns:repeat(3,minmax(0,1fr))} }
@media (min-width:768px){ .grid-items{grid-template-columns:repeat(4,minmax(0,1fr))} }
@media (min-width:992px){ .grid-items{grid-template-columns:repeat(5,minmax(0,1fr))} }
@media (min-width:1200px){ .grid-items{grid-template-columns:repeat(6,minmax(0,1fr))} }

/* ============ Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ±) ============ */
.toolbar{display:flex;gap:8px;align-items:center;overflow:auto hidden;white-space:nowrap}
.pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff;color:#0f172a;text-decoration:none}
.pill.active{border-color:#6C63FF;background:#f4f3ff}

/* ============ Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹ ONE-LINE Ù„ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª ============ */
.items-locbar{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.06);
  padding:8px 10px;margin-block:14px;display:flex;flex-wrap:nowrap;gap:6px;align-items:center}
.items-locbar .col{padding:0;margin:0}
.items-locbar .col--input{flex:1 1 auto;min-width:0;position:relative}
#itemsCityInput{height:36px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:#fff;padding:0 12px}
#itemsCityInput:focus{outline:none;border-color:#6C63FF;box-shadow:0 0 0 4px rgba(108,99,255,.18)}
.items-locbar .btn{height:36px;border-radius:10px;font-weight:800}
#itemsUseGPS{background:#fff;border:1px solid rgba(0,0,0,.08);color:#0f172a;padding:0 10px}
#itemsSearchBtn{background:#6C63FF;border:none;color:#fff;padding:0 14px}
#itemsClearGPS{color:#e5484d;border:none;background:transparent;padding:0 6px;height:auto;line-height:1;font-weight:800}
@media (max-width:576px){
  #itemsUseGPS{font-size:0}
  #itemsUseGPS::before{content:"ğŸ“";font-size:18px;line-height:1;display:inline-block;transform:translateY(1px)}
}

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© */
#itemsCitySugg{display:none;position:absolute;inset-inline:0;top:calc(100% + 6px);z-index:1000;max-height:240px;overflow:auto;
  background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.08)}
#itemsCitySugg>div{padding:.5rem .6rem;font-size:.95rem;color:#0f172a;border-top:1px solid rgba(0,0,0,.04);cursor:pointer}
#itemsCitySugg>div:first-child{border-top:none}
#itemsCitySugg>div:hover{background:#f7f7fb}

/* Ø±Ø£Ø³ Ø§Ù„Ù‚Ø³Ù… */
.section-title{font-weight:900;font-size:1.05rem}
</style>
{% endblock %}

{% block content %}

<section class="container" style="max-width:1200px;margin:auto">
  <div class="d-flex align-items-center justify-content-between mb-2" style="gap:8px">
    <div class="d-flex align-items-center" style="gap:10px">
      <h2 class="mb-0">Ø§Ù„Ø¹Ù†Ø§ØµØ±</h2>
      <span class="pill" style="font-size:.82rem">
        {% if current_category %}Ø§Ù„ØªØµÙ†ÙŠÙ: <b>{{ current_category }}</b>{% else %}ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª{% endif %}
      </span>
      <span class="pill" style="font-size:.82rem">
        Ø§Ù„ØªØ±ØªÙŠØ¨: {% if current_sort == 'new' %}Ø§Ù„Ø£Ø­Ø¯Ø«{% else %}Ø¹Ø´ÙˆØ§Ø¦ÙŠ{% endif %}
      </span>
    </div>

    <div class="toolbar">
      <a class="pill {% if not current_category %}active{% endif %}" href="/items">Ø§Ù„ÙƒÙ„</a>
      {% for cat in categories %}
        {% set key = cat.key if cat.key is defined else (cat.code if cat.code is defined else cat) %}
        {% set label = cat.label if cat.label is defined else (cat.name if cat.name is defined else key) %}
        <a class="pill {% if current_category == key %}active{% endif %}"
           href="/items?category={{ key }}{% if selected_city %}&city={{ selected_city | urlencode }}{% endif %}{% if lat %}&lat={{ lat }}{% endif %}{% if lng %}&lng={{ lng }}{% endif %}">
          {{ label }}
        </a>
      {% endfor %}
      {% set base_q = (current_category and ('&category=' ~ current_category)) or '' %}
      <a class="pill {% if current_sort != 'new' %}active{% endif %}"
         href="/items?sort=random{{ base_q }}{% if selected_city %}&city={{ selected_city | urlencode }}{% endif %}{% if lat %}&lat={{ lat }}{% endif %}{% if lng %}&lng={{ lng }}{% endif %}">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</a>
      <a class="pill {% if current_sort == 'new' %}active{% endif %}"
         href="/items?sort=new{{ base_q }}{% if selected_city %}&city={{ selected_city | urlencode }}{% endif %}{% if lat %}&lat={{ lat }}{% endif %}{% if lng %}&lng={{ lng }}{% endif %}">Ø§Ù„Ø£Ø­Ø¯Ø«</a>
    </div>
  </div>

  {# ========= Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ONE-LINE) ========= #}
  <form id="itemsLocForm" class="items-locbar" action="/items" method="get" role="search" novalidate>
    <div class="col col--input">
      <input type="text" class="form-control" id="itemsCityInput" name="city"
             placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø© â€¦" autocomplete="off" value="{{ selected_city or '' }}">
      <div id="itemsCitySugg"></div>
    </div>

    <button type="button" id="itemsUseGPS" class="btn" aria-label="Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ">GPS</button>
    <button class="btn" id="itemsSearchBtn" type="submit">Ø¨Ø­Ø«</button>
    <button type="button" id="itemsClearGPS" class="btn btn-link">Ø¥Ù„ØºØ§Ø¡</button>

    <input type="hidden" id="itemsLat" name="lat" value="{{ lat or '' }}">
    <input type="hidden" id="itemsLng" name="lng" value="{{ lng or '' }}">
    {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
    {% if current_sort %}<input type="hidden" name="sort" value="{{ current_sort }}">{% endif %}
  </form>

  {# ========= Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± ========= #}
  {% if items and items|length %}
    <div class="grid-items">
      {% for it in items %}
        <a href="/items/{{ it.id }}" class="spot text-decoration-none">
          <div class="spot-media">
            {% if it.image_path %}
              <img src="{{ it.image_path | media_url }}" alt="">
            {% else %}
              <img src="/static/placeholder.jpg" alt="">
            {% endif %}
            <div class="spot-overlay"></div>
            {% if it.category_label %}
              <span class="category-chip">{{ it.category_label }}</span>
            {% endif %}
          </div>
          <div class="spot-body">
            <div class="spot-title" title="{{ it.title }}">{{ it.title }}</div>
            <div class="spot-meta">
              {% if it.price_per_day is defined %}
                <div class="spot-price"><strong>{{ it.price_per_day }}</strong> <span>/ÙŠÙˆÙ…</span></div>
              {% endif %}
              <div class="spot-city">{{ it.city or 'â€”' }}</div>
              <div class="spot-rating">{{ it.rating|default(4.8) }}</div>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-secondary mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.</div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
/* ===== Ù…Ù†Ø·Ù‚ Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø¯ÙŠÙ†Ø©/GPS) ===== */
(function itemsLocBar(){
  const form   = document.getElementById('itemsLocForm');
  const cityEl = document.getElementById('itemsCityInput');
  const latEl  = document.getElementById('itemsLat');
  const lngEl  = document.getElementById('itemsLng');
  const gpsBtn = document.getElementById('itemsUseGPS');
  const clearBtn = document.getElementById('itemsClearGPS');
  const sugg   = document.getElementById('itemsCitySugg');

  function setCookie(n,v,d=180){try{const e=new Date();e.setTime(e.getTime()+d*864e5);document.cookie=n+"="+encodeURIComponent(v||"")+";expires="+e.toUTCString()+";path=/;SameSite=Lax";}catch(_){}} 
  function getCookie(n){const m=document.cookie.match(new RegExp('(?:^| )'+n+'=([^;]+)'));return m?decodeURIComponent(m[1]):"";}
  function delCookie(n){try{document.cookie=n+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Lax";}catch(_){}} 

  // ØªÙ‡ÙŠØ¦Ø© Ø¨Ø³ÙŠØ·Ø©
  try{
    const u=new URL(location.href);
    const c=u.searchParams.get('city')||getCookie('city')||"";
    const lat=u.searchParams.get('lat')||getCookie('lat')||"";
    const lng=u.searchParams.get('lng')||getCookie('lng')||"";
    if(cityEl)cityEl.value=c; if(latEl)latEl.value=lat; if(lngEl)lngEl.value=lng;
  }catch(_){}

  // GPS
  gpsBtn?.addEventListener('click',()=>{
    if(!navigator.geolocation){alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');return;}
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude,lng=pos.coords.longitude;
      setCookie('lat',lat);setCookie('lng',lng);setCookie('city',"");
      if(cityEl)cityEl.value=""; if(latEl)latEl.value=lat; if(lngEl)lngEl.value=lng;
      const u=new URL(location.href);
      u.searchParams.set('lat',lat);u.searchParams.set('lng',lng);u.searchParams.delete('city');
      location.href=u.toString();
    },()=>alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ.'));
  });

  // Ø¥Ù„ØºØ§Ø¡
  clearBtn?.addEventListener('click',()=>{
    delCookie('lat');delCookie('lng');
    const u=new URL(location.href);
    u.searchParams.delete('lat');u.searchParams.delete('lng');
    if(!(cityEl?.value||"").trim()){delCookie('city');u.searchParams.delete('city');}
    location.href=u.toString();
  });

  // Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§
  cityEl?.addEventListener('change',()=>{
    setCookie('city',(cityEl.value||"").trim());
    setCookie('lat',"");setCookie('lng',"");
  });

  /* ===== Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ø­Ø¯Ø© ===== */
  let t=null;
  const ALLOWED=new Set(['city','town','village','municipality']);
  const FALLBACK=new Set(['state','province']);
  function hideSugg(){ if(sugg){sugg.style.display='none';sugg.innerHTML='';} }
  function showSugg(){ if(sugg){sugg.style.display='block';} }
  function detectLang(q){
    const s=(q||'').trim();
    if(/[\u0600-\u06FF]/.test(s))return'ar';
    const fr=/[Ã Ã¢Ã¤Ã¦Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Å“Ã¹Ã»Ã¼Ã¿Ã€Ã‚Ã„Ã†Ã‡Ã‰ÃˆÃŠÃ‹ÃÃÃ”Å’Ã™Ã›ÃœÅ¸]/.test(s)||/\b(le|la|les|de|des|du|aux|au|Ã |sur|saint|sainte|chez)\b/i.test(s);
    return fr?'fr':'en';
  }
  function normalizePlace(p){
    const a=p.address||{},type=(p.type||'').toLowerCase(),cc=(a.country_code||'').toLowerCase();
    const city=a.city||a.town||a.village||a.municipality||a.state||a.province||(p.display_name||'').split(',')[0];
    const prioMap={city:1,town:2,village:3,municipality:3,state:6,province:6,administrative:8,county:8,region:8};
    return{city,country:a.country||'',cc,lat:p.lat,lon:p.lon,type,prio:(prioMap[type]??9)};
  }
  function pickBestUnique(list){
    const best=new Map();
    for(const p of list){
      const n=normalizePlace(p);
      if(!n.city||!n.cc)continue;
      const key=n.city.trim().toLowerCase()+'|'+n.cc;
      const prev=best.get(key);
      if(!prev||n.prio<prev.prio)best.set(key,n);
    }
    return Array.from(best.values());
  }

  cityEl?.addEventListener('input',function(){
    clearTimeout(t);
    const q=this.value.trim();
    if(q.length<2){hideSugg();return;}
    t=setTimeout(async()=>{
      try{
        const lang=detectLang(q);
        const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=30&accept-language='+encodeURIComponent(lang)+'&q='+encodeURIComponent(q);
        const r=await fetch(url,{headers:{'Accept':'application/json'}});
        if(!r.ok){hideSugg();return;}
        let data=await r.json();
        let f=data.filter(x=>ALLOWED.has((x.type||'').toLowerCase()));
        if(!f.length)f=data.filter(x=>FALLBACK.has((x.type||'').toLowerCase()));
        if(!f.length)f=data;
        const u=pickBestUnique(f).sort((a,b)=>a.prio-b.prio);
        const best=u[0];
        if(!best){hideSugg();return;}
        const label=(best.city||'').trim()+(best.country?`, ${best.country}`:'');
        sugg.innerHTML=`<div class="py-2 px-2" data-best="1"><i class="bi bi-geo-alt"></i> <span>${label}</span></div>`;
        sugg.dataset.lat=best.lat||'';sugg.dataset.lon=best.lon||'';
        showSugg();
      }catch(_){hideSugg();}
    },250);
  });

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­
  sugg?.addEventListener('click',()=>{
    const label=(sugg.querySelector('[data-best] span')?.textContent||'').trim();
    const lat=sugg.dataset.lat||'';const lon=sugg.dataset.lon||'';
    if(!label)return;
    cityEl.value=label;latEl.value=lat;lngEl.value=lon;
    setCookie('city',label);setCookie('lat',lat);setCookie('lng',lon);
    const u=new URL(location.href);
    u.searchParams.set('city',label);u.searchParams.set('lat',lat);u.searchParams.set('lng',lon);
    const cat=form.querySelector('[name="category"]')?.value;
    const sort=form.querySelector('[name="sort"]')?.value;
    if(cat)u.searchParams.set('category',cat);
    if(sort)u.searchParams.set('sort',sort);
    location.href=u.toString();
  });

  // submit ÙŠØ¯ÙˆÙŠ
  form?.addEventListener('submit',function(e){
    e.preventDefault();
    const c=(cityEl?.value||"").trim();
    const lat=(latEl?.value||"").trim();
    const lng=(lngEl?.value||"").trim();
    const u=new URL(location.href);
    ['city','lat','lng'].forEach(k=>u.searchParams.delete(k));
    if(lat && lng){
      setCookie('lat',lat);setCookie('lng',lng);setCookie('city',c||"");
      u.searchParams.set('lat',lat);u.searchParams.set('lng',lng); if(c)u.searchParams.set('city',c);
    }else if(c){
      setCookie('city',c);setCookie('lat',"");setCookie('lng',"");
      u.searchParams.set('city',c);
    }else{
      delCookie('city');delCookie('lat');delCookie('lng');
    }
    const cat=form.querySelector('[name="category"]')?.value;
    const sort=form.querySelector('[name="sort"]')?.value;
    if(cat)u.searchParams.set('category',cat);
    if(sort)u.searchParams.set('sort',sort);
    location.href=u.toString();
  });

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener('click',(e)=>{ if(sugg && !sugg.contains(e.target) && e.target!==cityEl){hideSugg();} });
})();
</script>
{% endblock %}
