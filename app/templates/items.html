{% extends "base.html" %}
{% from "_badges.html" import render_badges %}

{% block content %}

<style>
  /* ==== Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù‚Ø¯ÙŠÙ…Ø© (Ø£Ø¨Ù‚ÙŠØªÙ‡Ø§) ==== */
  .glass-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:14px;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 8px 24px rgba(0,0,0,.2);transition:transform .18s,box-shadow .18s,border-color .18s}
  .glass-card:hover{transform:translateY(-2px);box-shadow:0 14px 36px rgba(0,0,0,.28);border-color:rgba(255,255,255,.18)}
  .glass-btn{border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);color:#eaf0ff}
  .glass-btn:hover{border-color:rgba(255,255,255,.30);color:#fff}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(148,163,184,.10)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:#eaf0ff;text-decoration:none}
  .pill.active{border-color:rgba(99,102,241,.6);background:rgba(99,102,241,.18)}

  /* ====== Ù†ÙØ³ Ø´Ø¨ÙƒØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (2â†’6 Ø£Ø¹Ù…Ø¯Ø©) + ÙƒØ±ÙˆØª Ù…Ø±Ø¨Ø¹Ø© ÙˆØ¹ØµØ±ÙŠØ© ====== */
  .grid-items{
    display:grid;
    gap:14px;
    grid-template-columns:repeat(2,minmax(0,1fr));
    padding-inline:10px;
  }
  @media (min-width:576px){ .grid-items{grid-template-columns:repeat(3,minmax(0,1fr))} }
  @media (min-width:768px){ .grid-items{grid-template-columns:repeat(4,minmax(0,1fr))} }
  @media (min-width:992px){ .grid-items{grid-template-columns:repeat(5,minmax(0,1fr))} }
  @media (min-width:1200px){ .grid-items{grid-template-columns:repeat(6,minmax(0,1fr))} }

  /* Ø§Ù„ÙƒØ±Øª Ù…Ø«Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø¨Ø³ÙŠØ· ÙˆØ¨Ø¯ÙˆÙ† Ø²Ø¬Ø§Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶) */
  .grid-items article.glass-card{
    border:none !important;
    background:transparent !important;
    box-shadow:none !important;
    border-radius:14px !important;
  }

  /* Ø§Ù„ØµÙˆØ±Ø© Ù…Ø±Ø¨Ù‘Ø¹Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
  .item-img{
    width:100% !important;
    aspect-ratio:1/1 !important;
    height:auto !important;
    object-fit:cover !important;
    border-radius:14px !important;
    background:#eef2f7 !important;
    display:block;
  }

  /* Ø§Ù„Ø³Ø¹Ø± ÙƒØ³Ø·Ø± ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© (Ù„Ø§ ÙŠØºØ·ÙŠÙ‡Ø§) */
  .price-badge{
    position:static !important;
    display:block !important;
    background:transparent !important;
    border:none !important;
    padding:0 !important;
    margin:8px 2px 0 !important;
    color:#111 !important;
    font-weight:900 !important;
    font-size:.95rem !important;
  }

  /* Ù†ØµÙˆØµ ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© â€” Ø¹Ù†ÙˆØ§Ù† Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ + ÙˆØµÙ ØµØºÙŠØ± */
  .grid-items h5{
    font-weight:800;
    font-size:clamp(.92rem,.88rem + .2vw,1rem);
    margin:6px 2px 2px !important;
    line-height:1.2;
  }
  .grid-items .small.text-muted{
    color:#6b7280 !important;
    margin:2px 2px 0 !important;
  }

  /* Ø¥Ø®ÙØ§Ø¡ Ø³Ø·Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ø«Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
  .owner-line{display:none !important}

  /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£ØµØºØ± ÙˆØ£Ù†Ø¸Ù */
  .grid-items .glass-btn,
  .grid-items .btn-outline-primary{
    height:34px;
    border-radius:10px;
    padding:0 12px;
    font-weight:700;
  }

  /* ===== Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù†ÙØ³ Ø±ÙˆØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©) ===== */
  .items-locbar{
    --loc-bg:#fff;--loc-border:rgba(0,0,0,.08);--loc-shadow:0 8px 24px rgba(0,0,0,.06);
    --loc-radius:18px;--loc-pad:14px;--loc-primary:#6C63FF;--loc-danger:#e5484d;
    background:var(--loc-bg);border:1px solid var(--loc-border);border-radius:var(--loc-radius);
    box-shadow:var(--loc-shadow);padding:calc(var(--loc-pad) + 2px) var(--loc-pad);margin-block:16px;
  }
  .items-locbar .form-control{
    height:48px;border-radius:999px;border:1px solid var(--loc-border);background:#fafafa;
    transition:border-color .2s, box-shadow .2s; padding-inline:16px;
  }
  .items-locbar .form-control:focus{
    border-color:color-mix(in oklab,var(--loc-primary) 40%, #999);
    box-shadow:0 0 0 4px color-mix(in oklab,var(--loc-primary) 16%, transparent);
    background:#fff;
  }
  .items-locbar .btn.btn-primary{
    height:48px;border-radius:999px;background:var(--loc-primary);color:#fff;border:none;font-weight:800;
    box-shadow:0 10px 24px rgba(108,99,255,.18);
  }
  #itemsCitySugg{border-radius:12px;border:1px solid var(--loc-border);box-shadow:var(--loc-shadow);overflow:hidden}
  #itemsCitySugg>div{font-size:.95rem;color:#111;border-top:1px solid rgba(0,0,0,.04)}
  #itemsCitySugg>div:first-child{border-top:none}
  #itemsCitySugg>div:hover{background:#f7f7fb}

  /* ====== MOBILE ONE-LINE LOCBAR (Ø§Ù„Ù‡Ø§ØªÙ: Ø³Ø·Ø± ÙˆØ§Ø­Ø¯) ====== */
  @media (max-width:576px){
    .items-locbar.row{
      display:flex !important; flex-wrap:nowrap !important; align-items:center !important;
      gap:8px !important; padding:8px !important; background:#fff !important; border-radius:12px !important;
      box-shadow:none !important; --bs-gutter-x:0 !important; --bs-gutter-y:0 !important;
    }
    .items-locbar.row > [class*="col-"]{
      width:auto !important; flex:0 0 auto !important; padding:0 !important; margin:0 !important; min-width:0 !important;
    }
    .items-locbar .col-12.col-md-6{ flex:1 1 auto !important; min-width:0 !important; }
    .items-locbar .col-6.col-md-3.d-grid{ display:flex !important; align-items:center !important; gap:8px !important; }
    .items-locbar .col-6.col-md-3.d-grid:last-of-type{ display:flex !important; align-items:center !important; }

    .items-locbar .form-control,
    .items-locbar .btn{ height:34px !important; border-radius:10px !important; font-size:.88rem !important; }
    .items-locbar .form-control{
      padding:0 10px !important; background:#fff !important; border:1px solid rgba(0,0,0,.08) !important; box-shadow:none !important;
    }

    /* Ø²Ø± GPS = Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙ‚Ø· */
    #itemsUseGPS{
      font-size:0 !important; padding:0 10px !important;
      background:#fff !important; border:1px solid rgba(0,0,0,.08) !important; color:#111 !important;
    }
    #itemsUseGPS::before{
      content:"ğŸ“"; font-size:18px; line-height:1; display:inline-block; transform:translateY(1px);
    }

    /* Ø²Ø± Ø§Ù„Ø¨Ø­Ø« */
    .items-locbar .btn.btn-primary{ background:#6C63FF !important; box-shadow:none !important; padding:0 12px !important; }

    /* Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙƒØ±Ø§Ø¨Ø· ØµØºÙŠØ± */
    #itemsClearGPS{
      padding:0 6px !important; height:auto !important; line-height:1 !important;
      font-weight:800 !important; color:#e5484d !important; border:none !important; background:transparent !important;
    }

    /* Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø£ØµØºØ± */
    #itemsCitySugg{ border-radius:10px !important; box-shadow:0 6px 18px rgba(2,6,23,.08) !important; max-height:220px !important; font-size:.92rem !important; }
    #itemsCitySugg>div{ padding:.5rem .6rem !important; }
  }
</style>

<section class="container" style="max-width:1200px;margin:auto">
  <div class="d-flex align-items-center justify-content-between mb-3" style="gap:8px">
    <div class="d-flex align-items-center" style="gap:10px">
      <h2 class="mb-0">Ø§Ù„Ø¹Ù†Ø§ØµØ±</h2>
      <span class="chip">
        {% if current_category %}Ø§Ù„ØªØµÙ†ÙŠÙ: <b>{{ current_category }}</b>{% else %}ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª{% endif %}
      </span>
      <span class="chip">Ø§Ù„ØªØ±ØªÙŠØ¨: {% if current_sort == 'new' %}Ø§Ù„Ø£Ø­Ø¯Ø«{% else %}Ø¹Ø´ÙˆØ§Ø¦ÙŠ{% endif %}</span>
    </div>

    <div class="toolbar">
      <a class="pill {% if not current_category %}active{% endif %}" href="/items">Ø§Ù„ÙƒÙ„</a>
      {% for cat in categories %}
        {% set key = cat.key if cat.key is defined else (cat.code if cat.code is defined else cat) %}
        {% set label = cat.label if cat.label is defined else (cat.name if cat.name is defined else key) %}
        <a class="pill {% if current_category == key %}active{% endif %}"
           href="/items?category={{ key }}{% if selected_city %}&city={{ selected_city | urlencode }}{% endif %}{% if lat %}&lat={{ lat }}{% endif %}{% if lng %}&lng={{ lng }}{% endif %}">
          {{ label }}
        </a>
      {% endfor %}
      {% set base_q = (current_category and ('&category=' ~ current_category)) or '' %}
      <a class="pill {% if current_sort != 'new' %}active{% endif %}"
         href="/items?sort=random{{ base_q }}{% if selected_city %}&city={{ selected_city | urlencode }}{% endif %}{% if lat %}&lat={{ lat }}{% endif %}{% if lng %}&lng={{ lng }}{% endif %}">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</a>
      <a class="pill {% if current_sort == 'new' %}active{% endif %}"
         href="/items?sort=new{{ base_q }}{% if selected_city %}&city={{ selected_city | urlencode }}{% endif %}{% if lat %}&lat={{ lat }}{% endif %}{% if lng %}&lng={{ lng }}{% endif %}">Ø§Ù„Ø£Ø­Ø¯Ø«</a>
    </div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
  <form class="row g-2 align-items-center items-locbar" id="itemsLocForm" action="/items" method="get" role="search">
    <div class="col-12 col-md-6 position-relative">
      <input type="text" class="form-control" id="itemsCityInput" name="city" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø© â€¦" autocomplete="off" value="{{ selected_city or '' }}">
      <div id="itemsCitySugg" class="bg-white mt-1" style="display:none; position:absolute; z-index:1000; max-height:260px; overflow:auto; inset-inline:0;"></div>
    </div>
    <div class="col-6 col-md-3 d-grid">
      <!-- Ù…Ù‡Ù…: ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
      <button type="button" id="itemsUseGPS" class="btn btn-outline-secondary" aria-label="Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ" title="Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ"></button>
      <button type="button" id="itemsClearGPS" class="btn btn-link btn-sm">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div class="col-6 col-md-3 d-grid">
      <button class="btn btn-primary" type="submit">Ø¨Ø­Ø«</button>
    </div>

    <!-- Ø­Ù‚ÙˆÙ„ Ø®ÙÙŠØ© + Ø­ÙØ¸ category/sort -->
    <input type="hidden" id="itemsLat" name="lat" value="{{ lat or '' }}">
    <input type="hidden" id="itemsLng" name="lng" value="{{ lng or '' }}">
    {% if current_category %}<input type="hidden" name="category" value="{{ current_category }}">{% endif %}
    {% if current_sort %}<input type="hidden" name="sort" value="{{ current_sort }}">{% endif %}
  </form>

  {% if items and items|length %}
    <div class="grid-items">
      {% for it in items %}
        <article class="glass-card">
          <a href="/items/{{ it.id }}" style="display:block; position:relative">
            {% if it.image_path %}
              <img src="{{ it.image_path | media_url }}" class="item-img" alt="item" loading="lazy" referrerpolicy="no-referrer">
            {% else %}
              <div class="item-img d-grid place-items-center text-muted">Ù„Ø§ ØµÙˆØ±Ø©</div>
            {% endif %}
          </a>

          <div class="p-2">
            <div class="small text-muted mb-1">{{ it.category_label }}{% if it.city %} â€¢ {{ it.city }}{% endif %}</div>
            <h5 class="mb-1 text-truncate" title="{{ it.title }}">{{ it.title }}</h5>

            {% if it.price_per_day is defined %}
              <span class="price-badge">{{ it.price_per_day }} Ø¯/ÙŠÙˆÙ…</span>
            {% endif %}

            <div class="d-flex justify-content-between align-items-center mt-2">
              <a href="/items/{{ it.id }}" class="btn btn-sm glass-btn">ØªÙØ§ØµÙŠÙ„</a>
              <a href="/messages/start?user_id={{ it.owner_id }}&item_id={{ it.id }}" class="btn btn-sm btn-outline-primary">ØªÙˆØ§ØµÙ„</a>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.</p>
  {% endif %}
</section>

<script>
(function itemsLocBar(){
  const form   = document.getElementById('itemsLocForm');
  const cityEl = document.getElementById('itemsCityInput');
  const latEl  = document.getElementById('itemsLat');
  const lngEl  = document.getElementById('itemsLng');
  const gpsBtn = document.getElementById('itemsUseGPS');
  const clearBtn = document.getElementById('itemsClearGPS');
  const sugg   = document.getElementById('itemsCitySugg');

  function setCookie(n,v,d=180){try{const e=new Date();e.setTime(e.getTime()+d*864e5);document.cookie=n+"="+encodeURIComponent(v||"")+";expires="+e.toUTCString()+";path=/;SameSite=Lax";}catch(_){}} 
  function getCookie(n){const m=document.cookie.match(new RegExp('(?:^| )'+n+'=([^;]+)'));return m?decodeURIComponent(m[1]):"";}
  function delCookie(n){try{document.cookie=n+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Lax";}catch(_){}} 

  try{
    const u=new URL(location.href);
    const c=u.searchParams.get('city')||getCookie('city')||"";
    const lat=u.searchParams.get('lat')||getCookie('lat')||"";
    const lng=u.searchParams.get('lng')||getCookie('lng')||"";
    if(cityEl)cityEl.value=c; if(latEl)latEl.value=lat; if(lngEl)lngEl.value=lng;
  }catch(_){}

  gpsBtn?.addEventListener('click',()=>{
    if(!navigator.geolocation){alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');return;}
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude,lng=pos.coords.longitude;
      setCookie('lat',lat);setCookie('lng',lng);setCookie('city',"");
      cityEl.value="";latEl.value=lat;lngEl.value=lng;
      const u=new URL(location.href);
      u.searchParams.set('lat',lat);u.searchParams.set('lng',lng);u.searchParams.delete('city');
      location.href=u.toString();
    },()=>alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ.'));
  });

  clearBtn?.addEventListener('click',()=>{
    delCookie('lat');delCookie('lng');
    const u=new URL(location.href);
    u.searchParams.delete('lat');u.searchParams.delete('lng');
    if(!(cityEl?.value||"").trim()){delCookie('city');u.searchParams.delete('city');}
    location.href=u.toString();
  });

  cityEl?.addEventListener('change',()=>{
    setCookie('city',(cityEl.value||"").trim());
    setCookie('lat',"");setCookie('lng',"");
  });

  let t=null;
  function hideSugg(){if(sugg){sugg.style.display='none';sugg.innerHTML='';}}
  function showSugg(){if(sugg){sugg.style.display='block';}}
  function detectLang(q){
    const s=(q||'').trim();
    if(/[\u0600-\u06FF]/.test(s))return'ar';
    const fr=/[Ã Ã¢Ã¤Ã¦Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Å“Ã¹Ã»Ã¼Ã¿Ã€Ã‚Ã„Ã†Ã‡Ã‰ÃˆÃŠÃ‹ÃÃÃ”Å’Ã™Ã›ÃœÅ¸]/.test(s)||/\b(le|la|les|de|des|du|aux|au|Ã |sur|saint|sainte|chez)\b/i.test(s);
    return fr?'fr':'en';
  }
  const ALLOWED=new Set(['city','town','village','municipality']);
  const FALLBACK=new Set(['state','province']);
  function normalizePlace(p){
    const a=p.address||{},type=(p.type||'').toLowerCase(),cc=(a.country_code||'').toLowerCase();
    const city=a.city||a.town||a.village||a.municipality||a.state||a.province||(p.display_name||'').split(',')[0];
    const prioMap={city:1,town:2,village:3,municipality:3,state:6,province:6,administrative:8,county:8,region:8};
    return{city,country:a.country||'',cc,lat:p.lat,lon:p.lon,type,prio:(prioMap[type]??9)};
  }
  function pickBestUnique(list){
    const best=new Map();
    for(const p of list){
      const n=normalizePlace(p);
      if(!n.city||!n.cc)continue;
      const key=n.city.trim().toLowerCase()+'|'+n.cc;
      const prev=best.get(key);
      if(!prev||n.prio<prev.prio)best.set(key,n);
    }
    return Array.from(best.values());
  }

  cityEl?.addEventListener('input',function(){
    clearTimeout(t);
    const q=this.value.trim();
    if(q.length<2){hideSugg();return;}
    t=setTimeout(async()=>{
      try{
        const lang=detectLang(q);
        const url='https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=30&accept-language='+encodeURIComponent(lang)+'&q='+encodeURIComponent(q);
        const r=await fetch(url,{headers:{'Accept':'application/json'}});
        if(!r.ok){hideSugg();return;}
        let data=await r.json();
        let f=data.filter(x=>ALLOWED.has((x.type||'').toLowerCase()));
        if(!f.length)f=data.filter(x=>FALLBACK.has((x.type||'').toLowerCase()));
        if(!f.length)f=data;
        const u=pickBestUnique(f).sort((a,b)=>a.prio-b.prio);
        const best=u[0];
        if(!best){hideSugg();return;}
        const label=(best.city||'').trim()+(best.country?`, ${best.country}`:'');
        sugg.innerHTML=`<div class="py-2 px-2" data-best="1" style="cursor:pointer"><i class="bi bi-geo-alt"></i> <span>${label}</span></div>`;
        sugg.dataset.lat=best.lat||'';sugg.dataset.lon=best.lon||'';
        showSugg();
      }catch(_){hideSugg();}
    },250);
  });

  sugg?.addEventListener('click',()=>{
    const label=(sugg.querySelector('[data-best] span')?.textContent||'').trim();
    const lat=sugg.dataset.lat||'';const lon=sugg.dataset.lon||'';
    if(!label)return;
    cityEl.value=label;latEl.value=lat;lngEl.value=lon;
    setCookie('city',label);setCookie('lat',lat);setCookie('lng',lon);
    const u=new URL(location.href);
    u.searchParams.set('city',label);u.searchParams.set('lat',lat);u.searchParams.set('lng',lon);
    const cat=form.querySelector('[name="category"]')?.value;
    const sort=form.querySelector('[name="sort"]')?.value;
    if(cat)u.searchParams.set('category',cat);
    if(sort)u.searchParams.set('sort',sort);
    location.href=u.toString();
  });

  document.addEventListener('click',(e)=>{
    if(!sugg)return;
    if(!sugg.contains(e.target) && e.target!==cityEl){hideSugg();}
  });

  form?.addEventListener('submit',function(e){
    e.preventDefault();
    const c=(cityEl?.value||"").trim();
    const lat=(latEl?.value||"").trim();
    const lng=(lngEl?.value||"").trim();
    const u=new URL(location.href);
    ['city','lat','lng'].forEach(k=>u.searchParams.delete(k));
    if(lat && lng){
      setCookie('lat',lat);setCookie('lng',lng);setCookie('city',c||"");
      u.searchParams.set('lat',lat);u.searchParams.set('lng',lng);
      if(c)u.searchParams.set('city',c);
    }else if(c){
      setCookie('city',c);setCookie('lat',"");setCookie('lng',"");
      u.searchParams.set('city',c);
    }else{
      delCookie('city');delCookie('lat');delCookie('lng');
    }
    const cat=form.querySelector('[name="category"]')?.value;
    const sort=form.querySelector('[name="sort"]')?.value;
    if(cat)u.searchParams.set('category',cat);
    if(sort)u.searchParams.set('sort',sort);
    location.href=u.toString();
  });
})();
</script>

{% endblock %}
