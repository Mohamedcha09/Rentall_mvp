{% extends "base.html" %}
{% set u = session_user or {} %}
{% block content %}
<style>
  .ticket-wrap{max-width:980px;margin:auto}
  .chip{font-size:.8rem;padding:.25rem .55rem;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03)}
  .msg{border-radius:14px;padding:.6rem .8rem;white-space:pre-wrap}
  .msg-user{background:rgba(25,135,84,.08);border:1px solid rgba(25,135,84,.2)}
  .msg-agent{background:rgba(13,110,253,.08);border:1px solid rgba(13,110,253,.2)}
  .msg-system{background:rgba(108,117,125,.08);border:1px dashed rgba(108,117,125,.35);font-style:italic}
  .msg-meta{font-size:.78rem;color:#888}
  .card-chat{max-height:58vh;overflow:auto}
  .toolbar-sticky{position:sticky;bottom:0;z-index:2;background:linear-gradient(to top, rgba(0,0,0,.06), transparent 42%);padding-top:.4rem;border-top:1px solid rgba(255,255,255,.08)}
</style>

<div class="container py-3 ticket-wrap" dir="rtl">
  <div class="d-flex align-items-center justify-content-between">
    <h4 class="m-0">تذكرة #{{ ticket.id }} (MD)</h4>
    <a href="/md/inbox" class="btn btn-outline-secondary btn-sm"><i class="bi bi-inbox"></i> رجوع للصندوق</a>
  </div>
  <hr class="my-3">

  {% set is_resolved = (ticket.status == 'resolved') %}

  <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
    <span class="chip"><i class="bi bi-tag"></i> العنوان: {{ ticket.subject or "بدون عنوان" }}</span>
    <span class="chip"><i class="bi bi-person"></i> العميل: {{ ticket.user and (ticket.user.first_name or ticket.user.email) or "عميل" }}</span>
    {% if is_resolved %}
      <span class="chip text-bg-success border-0"><i class="bi bi-lock-fill"></i> منتهية</span>
    {% else %}
      <span class="chip text-bg-warning border-0 text-dark"><i class="bi bi-hourglass-split"></i> قيد المراجعة</span>
    {% endif %}
    {% if ticket.assigned_to_id %}
      <span class="chip"><i class="bi bi-person-badge"></i> مُعيّنة إلى: #{{ ticket.assigned_to_id }}</span>
    {% endif %}
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-header d-flex align-items-center gap-2">
      <i class="bi bi-chat-dots"></i> المحادثة
      <span class="ms-auto small text-muted">آخر تحديث: {{ ticket.updated_at and (ticket.updated_at|string)[:16] }}</span>
    </div>
    <div class="card-body card-chat">
      {% if msgs and msgs|length %}
        {% for m in msgs %}
          {% set who = (m.sender_role or '').lower() %}
          <div class="mb-3 {% if who=='agent' %}text-end{% endif %}">
            <div class="msg-meta mb-1">
              {{ m.created_at and m.created_at.strftime("%Y-%m-%d %H:%M") }} — 
              {% if who=='agent' %}وكيل{% elif who=='system' %}نظام{% else %}عميل{% endif %}
            </div>
            <div class="msg {% if who=='agent' %}msg-agent{% elif who=='system' %}msg-system{% else %}msg-user{% endif %}">
              {{ m.body }}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">لا توجد رسائل بعد.</div>
      {% endif %}
    </div>
  </div>

  {% if not is_resolved %}
    <div class="toolbar-sticky">
      <!-- فورم الرد (مستقل) -->
      <form id="replyForm" method="post" action="/md/ticket/{{ ticket.id }}/reply" class="p-2">
        <textarea class="form-control mb-2" name="body" rows="3" placeholder="اكتب ردّك هنا..." required></textarea>
        <button class="btn btn-primary me-2" type="submit"><i class="bi bi-send"></i> إرسال الرد</button>
      </form>

      <!-- الأزرار الأخرى كل زر داخل فورم مستقل -->
      {% if not ticket.assigned_to_id %}
      <form method="post" action="/md/tickets/{{ ticket.id }}/assign_self" class="d-inline">
        <button class="btn btn-outline-secondary mt-2" type="submit">
          <i class="bi bi-person-check"></i> تولّي التذكرة
        </button>
      </form>
      {% endif %}

      <form method="post" action="/md/tickets/{{ ticket.id }}/transfer_to_mod"
            onsubmit="return confirm('تحويل هذه التذكرة إلى فريق المراجعة (MOD)؟');"
            class="d-inline">
        <button class="btn btn-outline-warning mt-2" type="submit">
          <i class="bi bi-arrow-left-right"></i> تحويل إلى MOD
        </button>
      </form>

      <form method="post" action="/md/tickets/{{ ticket.id }}/resolve"
            onsubmit="return confirm('إغلاق نهائي للتذكرة؟ لا يمكن الرجوع.');"
            class="d-inline">
        <button class="btn btn-success mt-2" type="submit">
          <i class="bi bi-check2-circle"></i> إغلاق (نهائي)
        </button>
      </form>
    </div>
  {% endif %}
</div>
{% endblock %}
