{% extends "base.html" %}

{% block content %}

<!-- ===== زر الرجوع العائم (iOS style) ===== -->
<a href="/" class="back-btn-ios">
  <i class="bi bi-chevron-left"></i>
</a>

<style>
/* =====================================================
   زر الرجوع — iOS floating button style
   ===================================================== */
.back-btn-ios {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 12px);
    left: 14px;
    z-index: 9999;
    background: rgba(255,255,255,0.88);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    text-decoration: none;
}
.back-btn-ios:active { transform: scale(0.94); }

/* =====================================================
   إخفاء الهيدر + التابات + التاب بار + بنر Stripe
   ===================================================== */
header.topbar,
.m-top-tabs,
nav.desk-tabs,
.mobile-tabbar,
.stripe-callout,
.connect-banner,
.payout-banner,
.stripe-connect-banner {
    display: none !important;
}

/* منع padding للتاب بار */
body.has-tabbar {
    padding-bottom: 0 !important;
}
</style>

<!-- =====================================================
      My Tickets Content
===================================================== -->

<div class="container py-4" style="max-width:760px">

  <div class="d-flex justify-content-between align-items-center">
    <h3>My Tickets</h3>
    <a class="btn btn-primary" href="/support/new">+ New Ticket</a>
  </div>

  <div class="list-group mt-3">
    {% for t in tickets %}

      {% set unread_cs =
        (t.messages
        | selectattr('sender_role','equalto','agent')
        | selectattr('is_read','equalto',False)
        | list | length)
      %}

      <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
         href="/support/ticket/{{t.id}}">

        <div class="me-2">
          <div class="fw-semibold">#{{t.id}} — {{t.subject or 'Untitled'}}</div>
          <div class="small text-muted">
            Status: {{ t.status or 'new' }}
            {% if t.last_msg_at %}
              · Last activity: {{ (t.last_msg_at|string)[:16] }}
            {% endif %}
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          {% if unread_cs > 0 %}
            <span class="badge rounded-pill text-bg-primary">{{ unread_cs }}</span>
          {% elif t.unread_for_user %}
            <span class="badge rounded-pill text-bg-primary">•</span>
          {% endif %}
          <i class="bi bi-chevron-left opacity-50"></i>
        </div>

      </a>

    {% else %}
      <div class="text-muted">No tickets yet.</div>
    {% endfor %}
  </div>

</div>

{% endblock %}
