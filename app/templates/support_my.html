{% extends "base.html" %}

{% block content %}

<!-- ===== زر الرجوع العائم (iOS style) ===== -->
<a href="/" class="back-btn-ios">
  <i class="bi bi-chevron-left"></i>
</a>

<!-- ===== الشريط الثابت (Airbnb Sticky Header) ===== -->
<div id="ticketsSticky" class="tickets-sticky-bar">
    <a href="/" class="tickets-sticky-back"><i class="bi bi-chevron-left"></i></a>
    <div class="tickets-sticky-title">My Tickets</div>
    <div style="width:24px"></div>
</div>

<style>
/* =====================================================
   زر الرجوع — iOS floating button style
===================================================== */
.back-btn-ios {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 12px);
    left: 14px;
    z-index: 9999;
    background: #F7F4FF;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    text-decoration: none;
}
.back-btn-ios:active { transform: scale(0.94); }

/* =====================================================
   إخفاء الهيدر + التابات + التاب بار + بنر Stripe
===================================================== */
header.topbar,
.m-top-tabs,
nav.desk-tabs,
.mobile-tabbar,
.stripe-callout,
.connect-banner,
.payout-banner,
.stripe-connect-banner {
    display: none !important;
}

body.has-tabbar { padding-bottom: 0 !important; }

/* =====================================================
   شريط ثابت يظهر عند النزول — Airbnb style
===================================================== */
.tickets-sticky-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 58px;
    padding: calc(env(safe-area-inset-top) + 6px) 14px 8px 14px;
    background: #F7F4FF;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    opacity: 0;
    transform: translateY(-70px);
    transition: all .35s ease;
    z-index: 99999;
}

.tickets-sticky-bar.show {
    opacity: 1;
    transform: translateY(0);
}

.tickets-sticky-title {
    font-size: 18px;
    font-weight: 600;
    color: #111;
}

.tickets-sticky-back {
    font-size: 22px;
    color: #333;
}

/* =====================================================
   العنوان في أعلى الصفحة
===================================================== */
h3 {
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 20px;
}
</style>

<div class="container py-4" style="max-width:760px">

  <div class="d-flex justify-content-between align-items-center">
    <h3>My Tickets</h3>
    <a class="btn btn-primary" href="/support/new">+ New Ticket</a>
  </div>

  <div class="list-group mt-3">
    {% for t in tickets %}

      {% set unread_cs =
        (t.messages
        | selectattr('sender_role','equalto','agent')
        | selectattr('is_read','equalto',False)
        | list | length)
      %}

      {% if t.channel == 'chatbot' %}
  <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
     href="/support/chatbot/ticket/{{ t.id }}">
{% else %}
  <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
     href="/support/ticket/{{ t.id }}">
{% endif %}


        <div class="me-2">
          <div class="fw-semibold">#{{t.id}} — {{t.subject or 'Untitled'}}</div>
          <div class="small text-muted">
            Status: {{ t.status or 'new' }}
            {% if t.last_msg_at %}
              · Last activity: {{ (t.last_msg_at|string)[:16] }}
            {% endif %}
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          {% if unread_cs > 0 %}
            <span class="badge rounded-pill text-bg-primary">{{ unread_cs }}</span>
          {% elif t.unread_for_user %}
            <span class="badge rounded-pill text-bg-primary">•</span>
          {% endif %}
          <i class="bi bi-chevron-left opacity-50"></i>
        </div>

      </a>

    {% else %}
      <div class="text-muted">No tickets yet.</div>
    {% endfor %}
  </div>

</div>

<!-- =====================================================
     سكربت الشريط الثابت
===================================================== -->
<script>
document.addEventListener("scroll", function () {
    const bar = document.getElementById("ticketsSticky");

    if (window.scrollY > 100) {
        bar.classList.add("show");
    } else {
        bar.classList.remove("show");
    }
});
</script>

{% endblock %}
