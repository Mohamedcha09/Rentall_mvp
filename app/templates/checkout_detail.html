{% extends "base.html" %}
{% block content %}

{# ==== متغيرات العرض (العملة والرسوم التقديرية) ==== #}
{% set currency = (item and item.currency or CURRENCY or 'CAD')|upper %}
{% set rent = (booking.total_amount or 0.0) %}
{% set sevor_fee = (rent * 0.01) %}
{% set processing_fee_est = (rent * 0.029) + 0.30 %}

<h3 class="mb-3">Payment for Booking #{{ booking.id }}</h3>

<div class="card">
  <div class="card-body">
    <div class="mb-2">Item: <strong>{{ item.title }}</strong></div>
    <div class="mb-2">Owner: {{ owner.first_name }} {{ owner.last_name }}</div>
    <div class="mb-2">Dates: from {{ booking.start_date }} to {{ booking.end_date }}</div>
    <div class="mb-3">Amount: <strong>{{ "%.2f"|format(rent) }} {{ currency }}</strong></div>

    {% if booking.status != 'confirmed' %}
      <div class="alert alert-warning">The booking is not in the "confirmed" state.</div>
    {% else %}

      {# ===== ORDER SUMMARY ===== #}
<div class="card mb-3">
  <div class="card-body">
    <h5 class="mb-3">Order summary</h5>

    <div class="d-flex justify-content-between">
      <span>Rent for (“{{ item.title }}”)</span>
      <strong>{{ "%.2f"|format(rent_amount) }} {{ CURRENCY }}</strong>
    </div>

    <hr class="my-2">

    <div class="d-flex justify-content-between">
      <span>Sub-total</span>
      <strong>{{ "%.2f"|format(subtotal_before_tax) }} {{ CURRENCY }}</strong>
    </div>

    {# ===== Taxes block ===== #}
    {% if taxes and taxes.mode == 'computed' and taxes.tax_lines and taxes.tax_lines|length > 0 %}
      {% for t in taxes.tax_lines %}
        <div class="d-flex justify-content-between">
          <span>{{ t.name }} ({{ (t.rate * 100)|round(2) }}%)</span>
          <strong>{{ "%.2f"|format(t.amount) }} {{ CURRENCY }}</strong>
        </div>
      {% endfor %}

      <div class="d-flex justify-content-between mt-1">
        <span class="fw-semibold">Tax total</span>
        <strong>{{ "%.2f"|format(taxes.tax_total) }} {{ CURRENCY }}</strong>
      </div>

      <hr class="my-2">

      <div class="d-flex justify-content-between">
        <span>Total (incl. tax)</span>
        <strong>{{ "%.2f"|format(taxes.grand_total) }} {{ CURRENCY }}</strong>
      </div>

    {% else %}
      <div class="d-flex justify-content-between text-muted">
        <span>Taxes</span>
        <span>Calculated at Stripe</span>
      </div>

      <hr class="my-2">
      <div class="d-flex justify-content-between">
        <span>Total (before tax)</span>
        <strong>{{ "%.2f"|format(subtotal_before_tax) }} {{ CURRENCY }}</strong>
      </div>
    {% endif %}

    <div class="small text-muted mt-2">
      Stripe processing is included in the Sub-total (per your env % + fixed).
      Taxes are computed here when your region is known (e.g., CA-QC). If not, Stripe will finalize them at checkout.
    </div>
  </div>
</div>


      {# ✅ فورم الدفع (بدون تداخل أو تكرار) #}
      <form id="pay-form">
        <div id="payment-element"></div>
        <button class="btn btn-primary mt-3" id="submit-btn" type="submit">Pay Now</button>
        <div id="pay-msg" class="mt-3 text-muted small"></div>
      </form>

    {% endif %}
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
(() => {
  const payBtn = document.getElementById('submit-btn');
  const msgEl  = document.getElementById('pay-msg');
  const setMsg = (t) => { if (msgEl) msgEl.textContent = t || ""; };

  // مفتاح Stripe العلني يجب أن ترسله من الباك: pk
  const stripe = Stripe("{{ pk }}");

  function urlParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  async function showStatusFromReturn(){
    const clientSecret = urlParam('payment_intent_client_secret');
    if (!clientSecret) return false;
    const {paymentIntent} = await stripe.retrievePaymentIntent(clientSecret);
    if (!paymentIntent) return false;

    switch (paymentIntent.status) {
      case "succeeded":
        setMsg("Payment succeeded ✅");
        if (payBtn) payBtn.disabled = true;
        break;
      case "processing":
        setMsg("Your payment is processing…");
        break;
      case "requires_payment_method":
        setMsg("Payment failed. Try another card.");
        if (payBtn) payBtn.disabled = false;
        break;
      default:
        setMsg("Payment status: " + paymentIntent.status);
    }
    return true;
  }

  async function createIntent(){
    const res = await fetch("/api/checkout/{{ booking.id }}/intent", {
      method: "POST",
      headers: {"Content-Type": "application/json"}
    });
    if (!res.ok) {
      let txt = "An error occurred while creating the payment.";
      try { const j = await res.json(); if (j.detail) txt = j.detail; } catch(_){}
      throw new Error(txt);
    }
    return res.json();
  }

  {% if booking.status == 'confirmed' %}
  (async function init(){
    if (await showStatusFromReturn()) return;

    try {
      const { clientSecret } = await createIntent();
      const elements = stripe.elements({ clientSecret });
      const paymentElement = elements.create("payment");
      paymentElement.mount("#payment-element");

      document.getElementById("pay-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        setMsg("Confirming payment…");
        if (payBtn) payBtn.disabled = true;

        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: { return_url: window.location.href.split("?")[0] }
        });

        if (error) {
          setMsg(error.message || "An error occurred during payment.");
          if (payBtn) payBtn.disabled = false;
        }
      });
    } catch (err) {
      setMsg(err.message || "Unexpected error.");
    }
  })();
  {% endif %}
})();
</script>
{% endblock %}
