{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">الدفع للحجز #{{ booking.id }}</h3>

<div class="card">
  <div class="card-body">
    <div class="mb-2">العنصر: <strong>{{ item.title }}</strong></div>
    <div class="mb-2">المالك: {{ owner.first_name }} {{ owner.last_name }}</div>
    <div class="mb-2">التواريخ: من {{ booking.start_date }} إلى {{ booking.end_date }}</div>
    <div class="mb-3">
      المبلغ: <strong>{{ booking.total_amount }}</strong>
      <small id="currency-tag">—</small>
    </div>

    {% if booking.status != 'confirmed' %}
      <div class="alert alert-warning">الحجز ليس في حالة "confirmed".</div>
    {% else %}
      <form id="pay-form">
        <div id="payment-element"></div>
        <button class="btn btn-primary mt-3" id="submit-btn" type="submit">ادفع الآن</button>
        <div id="pay-msg" class="mt-3 text-muted small"></div>
      </form>
    {% endif %}
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  (async function () {
    function setMsg(t){ document.getElementById('pay-msg').textContent = t || ""; }

    {% if booking.status == 'confirmed' %}
    try {
      // 1) اجلب الإعدادات (publishable key + العملة)
      const cfg = await fetch("/api/pay/config").then(r => r.json());
      document.getElementById('currency-tag').textContent = cfg.currency?.toUpperCase?.() || '';

      // 2) أنشئ PaymentIntent لهذا الحجز
      const intentRes = await fetch("/api/pay/intent/{{ booking.id }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"}
      });
      if (!intentRes.ok) {
        const e = await intentRes.json().catch(() => ({ detail: "error" }));
        throw new Error(e.detail || "تعذّر إنشاء عملية الدفع");
      }
      const { clientSecret, alreadyPaid } = await intentRes.json();
      if (alreadyPaid) { setMsg("تم الدفع مسبقًا لهذا الحجز."); return; }

      // 3) حضّر Stripe Elements
      const stripe = Stripe(cfg.publishableKey);
      const elements = stripe.elements({ clientSecret });
      const paymentElement = elements.create("payment");
      paymentElement.mount("#payment-element");

      // 4) تأكيد الدفع
      document.getElementById("pay-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        setMsg("جارٍ تأكيد الدفع...");
        document.getElementById("submit-btn").disabled = true;

        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            // يمكنك توجيه المستخدم بعد الدفع إلى صفحة شكراً
            return_url: window.location.href
          }
        });

        if (error) {
          setMsg(error.message || "حدث خطأ أثناء الدفع");
          document.getElementById("submit-btn").disabled = false;
        }
      });
    } catch (e) {
      setMsg(e.message || "خطأ غير متوقع");
    }
    {% endif %}
  })();
</script>
{% endblock %}
