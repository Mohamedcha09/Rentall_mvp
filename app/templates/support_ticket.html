{# app/templates/support_ticket.html #}
{% extends "base.html" %}

{% block content %}
<div class="container py-3">

  <!-- Back + Title -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="/support/my" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-right"></i> Back</a>
      <h4 class="m-0">Ticket #{{ ticket.id }}</h4>
      {% if ticket.subject %}
        <span class="text-muted small d-none d-sm-inline">— {{ ticket.subject }}</span>
      {% endif %}
    </div>

    <div class="d-flex align-items-center gap-2">
      {% if ticket.status == 'resolved' %}
        <span class="badge bg-success">Closed</span>
      {% elif ticket.status == 'open' %}
        <span class="badge bg-primary">Open</span>
      {% else %}
        <span class="badge bg-secondary">New</span>
      {% endif %}
    </div>
  </div>

  <!-- Status banners -->
  {% if ticket.status == 'resolved' %}
    <div class="alert alert-success d-flex justify-content-between align-items-center" role="status">
      <div>
        ✅ The ticket has been resolved and closed.
        {% if ticket.assignee %}
          <strong>{{ ticket.assignee.first_name or 'Support Agent' }}</strong>
        {% endif %}
        {% if ticket.resolved_at %}
          — <span class="text-muted">({{ (ticket.resolved_at|string)[:16] }})</span>
        {% endif %}
      </div>
      <div class="small text-muted">
        You can reply below to automatically reopen the ticket.
      </div>
    </div>
  {% endif %}

  {% if ticket.assigned_to_id and ticket.assignee %}
    <div class="alert alert-info py-2">
      This conversation is handled by: <strong>{{ ticket.assignee.first_name or 'Support Agent' }}</strong>.
    </div>
  {% endif %}

  <!-- Body: two columns -->
  <div class="row g-3">
    <!-- Conversation -->
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-bold">Conversation</div>
          <div class="small text-muted">
            Last activity:
            {{ (ticket.last_msg_at or ticket.updated_at or ticket.created_at)|string }}
          </div>
        </div>

        <div class="card-body">
          <div id="chat" class="chat-thread">
            {% for m in msgs %}
              {% set is_user = (m.sender_id == session_user.id) and (m.sender_role == 'user') %}
              {% set is_agent = (m.sender_role == 'agent') %}
              <div class="chat-row {{ 'me' if is_user else 'them' }}">
                <div class="bubble">
                  <div class="meta">
                    <span class="name">
                      {% if is_user %}Me{% elif m.sender and m.sender.first_name %}{{ m.sender.first_name }}{% else %}Support{% endif %}
                    </span>
                    <span class="time">{{ (m.created_at|string)[:16] }}</span>
                  </div>
                  <div class="text">{{ m.body | e | replace('\n','<br>') | safe }}</div>
                </div>
              </div>
            {% else %}
              <div class="text-muted">No messages yet.</div>
            {% endfor %}
          </div>
        </div>

        <div class="card-footer">
          {% if ticket.status == 'resolved' %}
            <div class="alert alert-warning py-2 mb-2">
              This ticket is currently closed. Sending a new reply will automatically reopen it and notify the support agent.
            </div>
          {% endif %}

          <form method="post" action="/support/ticket/{{ ticket.id }}/reply">
            <div class="mb-2">
              <textarea name="body" class="form-control" rows="3" placeholder="Write your message to support…" required></textarea>
            </div>
            <div class="d-flex justify-content-end gap-2">
              <a href="/support/my" class="btn btn-outline-secondary">Cancel</a>
              <button class="btn btn-primary" type="submit">Send</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Ticket info -->
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Details</div>
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">ID</span>
            <span>#{{ ticket.id }}</span>
          </div>
          <div class="list-group-item">
            <div class="text-muted">Subject</div>
            <div>{{ ticket.subject or 'No subject' }}</div>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Status</span>
            <span>
              {% if ticket.status == 'resolved' %}
                Closed
              {% elif ticket.status == 'open' %}
                Open
              {% else %}
                New
              {% endif %}
            </span>
          </div>
          <div class="list-group-item">
            <div class="text-muted">Assigned to</div>
            <div>
              {% if ticket.assignee %}
                {{ ticket.assignee.first_name or 'Support Agent' }}
              {% else %}
                <span class="text-muted">Not yet assigned</span>
              {% endif %}
            </div>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Created</span>
            <span>{{ (ticket.created_at|string)[:16] }}</span>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Last updated</span>
            <span>{{ (ticket.updated_at|string)[:16] }}</span>
          </div>
          {% if ticket.resolved_at %}
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Resolved at</span>
              <span>{{ (ticket.resolved_at|string)[:16] }}</span>
            </div>
          {% endif %}
          {% if ticket.last_msg_at %}
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Last message</span>
              <span>{{ (ticket.last_msg_at|string)[:16] }}</span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Chat bubbles */
.chat-thread{ max-height:60vh; overflow:auto; padding:2px 4px; }
.chat-row{ display:flex; margin:.35rem 0; }
.chat-row.me{ justify-content:flex-end; }
.chat-row.them{ justify-content:flex-start; }
.chat-row .bubble{
  max-width:92%;
  border-radius:14px;
  padding:.55rem .7rem;
  border:1px solid var(--border);
  background:#fff;
}
[data-theme="dark"] .chat-row .bubble{
  background:rgba(255,255,255,.06);
}
.chat-row.me .bubble{
  background:#eff6ff;
  border-color:rgba(0,0,0,.06);
}
[data-theme="dark"] .chat-row.me .bubble{
  background:rgba(124,92,255,.18);
  border-color:rgba(255,255,255,.12);
}
.bubble .meta{ font-size:.8rem; opacity:.7; display:flex; gap:.5rem; margin-bottom:.25rem; }
.bubble .text{ white-space:pre-wrap; word-break:break-word; }
</style>

<script>
(function(){
  // Scroll to bottom of messages
  const chat = document.getElementById('chat');
  if (chat){ setTimeout(()=>{ chat.scrollTop = chat.scrollHeight; }, 50); }
})();
</script>
{% endblock %}
