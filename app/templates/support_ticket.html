{# app/templates/support_ticket.html #}
{% extends "base.html" %}

{% block content %}

<!-- ===== زر الرجوع العائم على الموبايل فقط ===== -->
<a href="/support/my" class="back-btn-ios d-md-none">
  <i class="bi bi-chevron-left"></i>
</a>

<!-- ===== الشريط الثابت (Mobile Sticky Header) ===== -->
<div id="ticketSticky" class="ticket-sticky-bar d-md-none">
    <a href="/support/my" class="ticket-sticky-back"><i class="bi bi-chevron-left"></i></a>
    <div class="ticket-sticky-title">Ticket #{{ ticket.id }}</div>
    <div style="width:24px"></div>
</div>

<style>

/* =====================================================
   زر الرجوع — iOS floating button (MOBILE ONLY)
===================================================== */
.back-btn-ios {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 12px);
    left: 14px;
    z-index: 9999;
    background: rgba(255,255,255,0.88);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    text-decoration: none;
}
.back-btn-ios:active { transform: scale(0.94); }

/* =====================================================
   إخفاء navbars ONLY ON MOBILE (لا تمس الحاسوب)
===================================================== */
@media (max-width: 768px){

    header.topbar,
    .m-top-tabs,
    nav.desk-tabs,
    .mobile-tabbar,
    .stripe-callout,
    .searchbar,
    .payout-banner,
    .connect-banner,
    .stripe-connect-banner {
        display: none !important;
    }

    body.has-tabbar { padding-bottom: 0 !important; }
}

/* =====================================================
   Sticky Header (Mobile Only)
===================================================== */
.ticket-sticky-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 58px;
    padding: calc(env(safe-area-inset-top) + 6px) 14px 8px 14px;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    opacity: 0;
    transform: translateY(-70px);
    transition: all .35s ease;
    z-index: 99999;
}

.ticket-sticky-bar.show {
    opacity: 1;
    transform: translateY(0);
}

.ticket-sticky-title {
    font-size: 18px;
    font-weight: 600;
    color: #111;
}

.ticket-sticky-back {
    font-size: 22px;
    color: #333;
}

/* =====================================================
   Chat bubbles (unchanged)
===================================================== */
.chat-thread{ max-height:60vh; overflow:auto; padding:2px 4px; }
.chat-row{ display:flex; margin:.35rem 0; }
.chat-row.me{ justify-content:flex-end; }
.chat-row.them{ justify-content:flex-start; }
.chat-row .bubble{
  max-width:92%;
  border-radius:14px;
  padding:.55rem .7rem;
  border:1px solid var(--border);
  background:#fff;
}
[data-theme="dark"] .chat-row .bubble{
  background:rgba(255,255,255,.06);
}
.chat-row.me .bubble{
  background:#eff6ff;
  border-color:rgba(0,0,0,.06);
}
[data-theme="dark"] .chat-row.me .bubble{
  background:rgba(124,92,255,.18);
  border-color:rgba(255,255,255,.12);
}
.bubble .meta{ font-size:.8rem; opacity:.7; display:flex; gap:.5rem; margin-bottom:.25rem; }
.bubble .text{ white-space:pre-wrap; word-break:break-word; }


/* =====================================================
   Chat bubbles — Airbnb premium style
===================================================== */
.chat-thread{
  max-height:60vh;
  overflow:auto;
  padding:6px 4px 10px;
  background:#fafafa;
  border-radius:16px;
}

/* صف الرسالة */
.chat-row{
  display:flex;
  margin:.55rem 0;
}

/* رسائلي */
.chat-row.me{
  justify-content:flex-end;
}

/* رسائل الدعم */
.chat-row.them{
  justify-content:flex-start;
}

/* فقاقيع الرسائل */
.chat-row .bubble{
  max-width:84%;
  padding:.7rem .9rem;
  border-radius:18px;
  background:#fff;
  border:1px solid rgba(0,0,0,0.06);
  box-shadow:0 1px 3px rgba(0,0,0,0.04);
}

/* رسائلي (Airbnb Blue bubble) */
.chat-row.me .bubble{
  background:#f1f7ff;
  border-color:rgba(0,0,0,0.05);
  box-shadow:0 1px 4px rgba(0,0,0,0.05);
}

/* الوضع الداكن */
[data-theme="dark"] .chat-thread{
  background:#0e0e12;
}
[data-theme="dark"] .chat-row .bubble{
  background:rgba(255,255,255,0.08);
  border-color:rgba(255,255,255,0.1);
  box-shadow:none;
}
[data-theme="dark"] .chat-row.me .bubble{
  background:rgba(124,92,255,0.25);
}

/* اسم + وقت */
.bubble .meta{
  font-size:.78rem;
  opacity:.65;
  display:flex;
  gap:.45rem;
  margin-bottom:.25rem;
  font-weight:500;
}

/* نص الرسالة */
.bubble .text{
  font-size:.95rem;
  line-height:1.35;
  white-space:pre-wrap;
  word-break:break-word;
}


</style>

<!-- =====================================================
      CONTENT (unchanged)
===================================================== -->

<div class="container py-3" style="max-width:900px">

  <!-- DESKTOP HEADER ONLY (لا يمسه شيء) -->
  <div class="d-none d-md-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <a href="/support/my" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-right"></i> Back</a>
      <h4 class="m-0">Ticket #{{ ticket.id }}</h4>
      {% if ticket.subject %}
        <span class="text-muted small d-none d-sm-inline">— {{ ticket.subject }}</span>
      {% endif %}
    </div>

    <div class="d-flex align-items-center gap-2">
      {% if ticket.status in ['resolved', 'closed'] %}
  <span class="badge bg-success">Closed</span>
{% elif ticket.status == 'open' %}
  <span class="badge bg-primary">Open</span>
{% else %}
  <span class="badge bg-secondary">New</span>
{% endif %}

  </div>

  <!-- MOBILE TITLE (تمت إضافته أعلى الصفحة) -->
  <div class="d-md-none" style="height:70px"></div>

  <!-- Status banners -->
  {% if ticket.status in ['resolved', 'closed'] %}
    <div class="alert alert-success d-flex justify-content-between align-items-center" role="status">
      <div>
        ✅ The ticket has been resolved and closed.
        {% if ticket.assignee %}
          <strong>{{ ticket.assignee.first_name or 'Support Agent' }}</strong>
        {% endif %}
        {% if ticket.resolved_at %}
          — <span class="text-muted">({{ (ticket.resolved_at|string)[:16] }})</span>
        {% endif %}
      </div>
      <div class="small text-muted">
        You can reply below to automatically reopen the ticket.
      </div>
    </div>
  {% endif %}

  {% if ticket.assigned_to_id and ticket.assignee %}
    <div class="alert alert-info py-2">
      This conversation is handled by: <strong>{{ ticket.assignee.first_name or 'Support Agent' }}</strong>.
    </div>
  {% endif %}

  <!-- Body -->
  <div class="row g-3">
    <!-- Conversation -->
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="fw-bold">Conversation</div>
          <div class="small text-muted">
            Last activity:
            {{ (ticket.last_msg_at or ticket.updated_at or ticket.created_at)|string }}
          </div>
        </div>

        <div class="card-body">
          <div id="chat" class="chat-thread">
            {% for m in msgs %}
              {% set is_user = (m.sender_id == session_user.id) and (m.sender_role == 'user') %}
              {% set is_agent = (m.sender_role == 'agent') %}
              <div class="chat-row {{ 'me' if is_user else 'them' }}">
                <div class="bubble">
                  <div class="meta">
                    <span class="name">
                      {% if is_user %}Me{% elif m.sender and m.sender.first_name %}{{ m.sender.first_name }}{% else %}Support{% endif %}
                    </span>
                    <span class="time">{{ (m.created_at|string)[:16] }}</span>
                  </div>
                  <div class="text">{{ m.body | e | replace('\n','<br>') | safe }}</div>
                </div>
              </div>
            {% else %}
              <div class="text-muted">No messages yet.</div>
            {% endfor %}
          </div>
        </div>

        <div class="card-footer">
          {% if ticket.status in ['resolved', 'closed'] %}
            <div class="alert alert-warning py-2 mb-2">
              This ticket is currently closed. Sending a new reply will automatically reopen it and notify the support agent.
            </div>
          {% endif %}

          {% if ticket.status not in ['resolved', 'closed'] %}
  <form method="post" action="/support/ticket/{{ ticket.id }}/reply">
    <div class="mb-2">
      <textarea name="body" class="form-control" rows="3"
        placeholder="Write your message to support…" required></textarea>
    </div>
    <div class="d-flex justify-content-end gap-2">
      <a href="/support/my" class="btn btn-outline-secondary">Cancel</a>
      <button class="btn btn-primary" type="submit">Send</button>
    </div>
  </form>
{% endif %}

        </div>
      </div>
    </div>

    <!-- Ticket info -->
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Details</div>
        <div class="list-group list-group-flush">
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">ID</span>
            <span>#{{ ticket.id }}</span>
          </div>
          <div class="list-group-item">
            <div class="text-muted">Subject</div>
            <div>{{ ticket.subject or 'No subject' }}</div>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Status</span>
            <span>
              {% if ticket.status in ['resolved', 'closed'] %}
                Closed
              {% elif ticket.status == 'open' %}
                Open
              {% else %}
                New
              {% endif %}
            </span>
          </div>
          <div class="list-group-item">
            <div class="text-muted">Assigned to</div>
            <div>
              {% if ticket.assignee %}
                {{ ticket.assignee.first_name or 'Support Agent' }}
              {% else %}
                <span class="text-muted">Not yet assigned</span>
              {% endif %}
            </div>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Created</span>
            <span>{{ (ticket.created_at|string)[:16] }}</span>
          </div>
          <div class="list-group-item d-flex justify-content-between">
            <span class="text-muted">Last updated</span>
            <span>{{ (ticket.updated_at|string)[:16] }}</span>
          </div>
          {% if ticket.resolved_at %}
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Resolved at</span>
              <span>{{ (ticket.resolved_at|string)[:16] }}</span>
            </div>
          {% endif %}
          {% if ticket.last_msg_at %}
            <div class="list-group-item d-flex justify-content-between">
              <span class="text-muted">Last message</span>
              <span>{{ (ticket.last_msg_at|string)[:16] }}</span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const chat = document.getElementById('chat');
  if (chat){ setTimeout(()=>{ chat.scrollTop = chat.scrollHeight; }, 50); }
})();

document.addEventListener("scroll", function () {
    const bar = document.getElementById("ticketSticky");

    if (window.scrollY > 120) {
        bar.classList.add("show");
    } else {
        bar.classList.remove("show");
    }
});
</script>

{% endblock %}
