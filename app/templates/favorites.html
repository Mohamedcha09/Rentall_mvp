{% extends "base.html" %}

{% block head %}
<style>
  .favorites-grid{
    display:grid; gap:14px;
    grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
  }
  @media (max-width:480px){
    .favorites-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
</style>
{% endblock %}

{% block content %}
<h4 class="mb-3">❤️ مفضلتي</h4>

{% if items and items|length > 0 %}
  <div class="favorites-grid">
    {% for it in items %}
      <a href="/items/{{ it.id }}" class="card spot text-decoration-none">
        <div class="spot-media">
          <img src="{{ it.image_path or '/static/placeholder.jpg' }}" alt="">
          <div class="spot-overlay"></div>

          {% if it.price_per_day is defined %}
            <span class="price-badge">{{ it.price_per_day|default(0) }}$ /يوم</span>
          {% endif %}
          {% if it.category is defined %}
            <span class="category-chip">{{ category_label(it.category) }}</span>
          {% endif %}

          <!-- زر المفضلة (معلّم مسبقاً كـ is-fav هنا) -->
          <button class="fav-btn is-fav" type="button" data-id="{{ it.id }}" aria-pressed="true">
            <i class="bi bi-heart-fill"></i>
          </button>
        </div>

        <div class="card-body spot-body">
          <div class="spot-title">{{ it.title }}</div>
          <div class="owner-line">
            <div class="owner-avatar--placeholder">🏷️</div>
            <span class="city-chip">{{ it.city or '—' }}</span>
          </div>
        </div>
      </a>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-secondary glass mt-2">لا توجد عناصر في المفضلة بعد.</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // تفعيل/تعطيل المفضلة عبر API الصحيح /api/favorites/{id}
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.fav-btn');
    if(!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const id = Number(btn.dataset.id);
    const isFav = btn.classList.contains('is-fav');
    const method = isFav ? 'DELETE' : 'POST';

    try{
      const res = await fetch(`/api/favorites/${id}`, { method });
      if(!res.ok) throw new Error('bad response');

      // حدّث الزر محليًا
      btn.classList.toggle('is-fav', !isFav);
      const icon = btn.querySelector('.bi');
      if(icon){
        icon.classList.toggle('bi-heart-fill', !isFav);
        icon.classList.toggle('bi-heart', isFav);
      }
      btn.setAttribute('aria-pressed', String(!isFav));
    }catch(err){
      console.error(err);
      alert('تعذّر حفظ التغيير في المفضلة مؤقتًا.');
    }
  });
</script>
{% endblock %}