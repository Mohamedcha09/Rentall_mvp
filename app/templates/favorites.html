{# app/templates/favorites.html #}
{% extends "base.html" %}

{% block head %}
<style>
  .favorites-grid{
    display:grid; gap:14px;
    grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
  }
  @media (max-width:480px){
    .favorites-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }

  /* Empty state: image only */
  .empty-box{ padding:24px 8px; text-align:center; }
  .empty-box img{
    display:block; margin:10px auto; max-width:320px; width:76%;
    height:auto; object-fit:contain; opacity:.98;
  }
</style>
{% endblock %}

{% block content %}
<h4 class="mb-3">‚ù§Ô∏è My Favorites</h4>

{% if items and items|length > 0 %}
  <div class="favorites-grid">
    {% for it in items %}
      <a href="/items/{{ it.id }}" class="card spot text-decoration-none">
        <div class="spot-media">
          <img src="{{ it.image_path or '/static/placeholder.jpg' }}" alt="">
          <div class="spot-overlay"></div>

          {% if it.price_per_day is defined %}
            <span class="price-badge">{{ it.price_per_day|default(0) }}$ /day</span>
          {% endif %}
          {% if it.category is defined %}
            <span class="category-chip">{{ category_label(it.category) }}</span>
          {% endif %}

          <!-- Favorite button (pre-marked as is-fav here) -->
          <button class="fav-btn is-fav" type="button" data-id="{{ it.id }}" aria-pressed="true">
            <i class="bi bi-heart-fill"></i>
          </button>
        </div>

        <div class="card-body spot-body">
          <div class="spot-title">{{ it.title }}</div>
          <div class="owner-line">
            <div class="owner-avatar--placeholder">üè∑Ô∏è</div>
            <span class="city-chip">{{ it.city or '‚Äî' }}</span>
          </div>
        </div>
      </a>
    {% endfor %}
  </div>
{% else %}
  {# Empty state image: son.png #}
  <div class="empty-box">
    <img src="{{ url_for('static', path='photo/son.png') }}" alt="No items in favorites">
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // Toggle favorite via the correct API /api/favorites/{id}
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.fav-btn');
    if(!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const id = Number(btn.dataset.id);
    const isFav = btn.classList.contains('is-fav');
    const method = isFav ? 'DELETE' : 'POST';

    try{
      const res = await fetch(`/api/favorites/${id}`, { method });
      if(!res.ok) throw new Error('bad response');

      // Update the button locally
      btn.classList.toggle('is-fav', !isFav);
      const icon = btn.querySelector('.bi');
      if(icon){
        icon.classList.toggle('bi-heart-fill', !isFav);
        icon.classList.toggle('bi-heart', isFav);
      }
      btn.setAttribute('aria-pressed', String(!isFav));
    }catch(err){
      console.error(err);
      alert('Failed to save favorite change temporarily.');
    }
  });
</script>
{% endblock %}
