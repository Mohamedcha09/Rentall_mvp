{# app/templates/favorites.html #}
{% extends "base.html" %}

{% block head %}
<style>
  /* ===== ستايل بطاقات Similar ===== */
  :root{ --brand1:#8b5cf6; --brand2:#22d3ee; }

  .sim-card{
    position:relative; display:block;
    background:#fff; border-radius:16px; padding:14px;
    box-shadow:0 10px 26px rgba(17,24,39,.10);
    border:1px solid rgba(17,24,39,.06);
    text-decoration:none; color:inherit;
  }
  .sim-card:hover{ box-shadow:0 14px 30px rgba(17,24,39,.14) }

  .sim-media{ position:relative; border-radius:14px; overflow:hidden; }
  .sim-img{ width:100%; display:block; aspect-ratio:16/9; object-fit:cover; height:auto; }

  .sim-chip{
    position:absolute; top:10px; left:10px; z-index:2;
    height:28px; line-height:28px; padding:0 10px;
    display:inline-flex; align-items:center; gap:6px;
    border-radius:999px; background:#fff; color:#111;
    border:1px solid #e5e7eb; font-weight:600; font-size:13px;
  }

  .sim-rate{
    position:absolute; top:10px; right:10px; z-index:2;
    height:28px; line-height:28px; padding:0 10px;
    display:inline-flex; align-items:center; gap:6px;
    border-radius:999px; background:#fff; color:#111;
    border:1px solid #e5e7eb; font-weight:700; font-size:13px;
    box-shadow:0 4px 10px rgba(0,0,0,.08);
  }
  .sim-rate.empty{ display:none; }
  .sim-rate .star{
    font-size:15px;
    background:linear-gradient(135deg,var(--brand1),var(--brand2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }

  .sim-logo{
    position:absolute; left:10px; bottom:10px; z-index:2;
    width:36px; height:36px; border-radius:50%; object-fit:cover;
    padding:2px; background:linear-gradient(135deg,var(--brand1),var(--brand2));
    box-shadow:0 6px 14px rgba(0,0,0,.18);
  }

  .sim-body{ padding-top:8px; }
  .sim-head{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    margin:0 0 4px 0;
  }
  .sim-title{
    margin:0; padding:0; font-weight:800; font-size:18px; line-height:1.15;
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }

  .sim-fav{
    position:static; background:transparent; border:0;
    display:inline-grid; place-items:center; cursor:pointer;
  }
  .sim-fav i{
    font-size:22px;
    background:linear-gradient(135deg,var(--brand1),var(--brand2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    filter:drop-shadow(0 0 3px rgba(139,92,246,.35));
    transition:transform .12s ease;
  }
  .sim-fav:hover i{ transform:translateY(-1px); }

  .sim-sub{ color:#6b7280; font-size:13px; margin:0; line-height:1.2; }
  .sim-meta{
    display:flex; align-items:center; gap:8px; color:#6b7280;
    font-size:13px; margin:2px 0 6px 0; line-height:1.2;
  }
  .sim-meta .vsep{ width:1px; height:12px; background:#e5e7eb; opacity:.9; }

  .sim-cut{ margin:2px 0 4px 0; border:0; height:0; border-top:1.8px dashed rgba(0,0,0,.18); opacity:.8; }

  .sim-price-row{ display:flex; align-items:baseline; justify-content:space-between; gap:6px; margin-top:-2px; }
  .sim-price-old{ font-size:12.5px; color:#9ca3af; text-decoration:line-through; }
  .sim-price-now{ font-size:15.5px; font-weight:800; color:#111; }
  .sim-unit{ font-size:11px; color:#6b7280; margin-left:4px; }

  .empty-box{ padding:24px 8px; text-align:center; }
  .empty-box img{
    display:block; margin:10px auto; max-width:320px; width:76%;
    height:auto; object-fit:contain; opacity:.98;
  }

  /* ===== الموبايل: عمودي ===== */
  .favorites-grid{
    display:flex;
    flex-direction:column;
    gap:16px;
    padding:0 12px 24px;
  }
  .favorites-grid .sim-card{
    width:100%;
    max-width:100%;
  }

  /* ===== الحاسوب: أفقي ===== */
  @media (min-width:992px){
    .favorites-grid{
      flex-direction:row;
      gap:18px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding:6px 16px 24px;
    }
    .favorites-grid .sim-card{
      flex:0 0 300px;
      max-width:300px;
      scroll-snap-align:start;
    }
  }

  .favorites-grid::-webkit-scrollbar{height:8px;}
  .favorites-grid::-webkit-scrollbar-thumb{background:rgba(0,0,0,.15);border-radius:4px;}
</style>
{% endblock %}

{% block content %}
<h4 class="mb-3">❤️ My Favorites</h4>

{% if items and items|length > 0 %}
  <div class="favorites-grid">
    {% for s in items %}

      {% set cover = (s.image_path.split(',')[0] if s.image_path and ',' in s.image_path
                      else (s.image_path.split('|')[0] if s.image_path and '|' in s.image_path
                      else s.image_path)) %}
      {% if cover and not (cover.startswith('http') or cover.startswith('/')) %}
        {% set cover = '/' ~ cover %}
      {% endif %}

      <a class="sim-card" href="/items/{{ s.id }}">
        <div class="sim-media">
          <img class="sim-img"
               src="{{ cover or url_for('static', path='placeholder.png') }}"
               alt="{{ s.title|e }}">

          <div class="sim-chip">{{ category_label(s.category) }}</div>

          <div class="sim-rate">
            <span class="star">★</span>{{ '%.1f'|format(s.rating) }}
          </div>
        </div>

        <div class="sim-body">
          <div class="sim-title">{{ s.title }}</div>
          <div class="sim-sub">{{ s.city or '—' }}</div>

          <hr class="sim-cut">

          <div class="sim-price-row">
            <div class="sim-price-now">
              {{ s.display_price }} {{ s.display_currency }}
              <span class="sim-unit">/ day</span>
            </div>
          </div>
        </div>
      </a>

    {% endfor %}
  </div>

{% else %}
  <div class="empty-box">
    <img src="{{ url_for('static', path='photo/son.png') }}">
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function () {
  async function toggleFav(el){
    const id = el.dataset.itemId;
    const icon = el.querySelector('i');
    const wasFilled = icon.classList.contains('bi-heart-fill');

    icon.classList.toggle('bi-heart-fill', !wasFilled);
    icon.classList.toggle('bi-heart', wasFilled);
    el.classList.toggle('on', !wasFilled);
    el.setAttribute('aria-pressed', String(!wasFilled));

    try{
      let res = await fetch(`/api/favorites/${id}`, {
        method: wasFilled ? 'DELETE' : 'POST',
        credentials: 'same-origin'
      });
      if (!res.ok) throw new Error();
    }catch{
      icon.classList.toggle('bi-heart-fill', wasFilled);
      icon.classList.toggle('bi-heart', !wasFilled);
      el.classList.toggle('on', wasFilled);
      el.setAttribute('aria-pressed', String(wasFilled));
    }
  }

  document.addEventListener('click', e=>{
    const fav = e.target.closest('.js-fav');
    if(!fav) return;
    e.preventDefault();
    e.stopPropagation();
    toggleFav(fav);
  });
})();
</script>
{% endblock %}
