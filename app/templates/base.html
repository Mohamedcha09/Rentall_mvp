<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <!-- viewport واحد مع دعم الحواف -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{{ title or "RentAll" }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- ستايل عام للمظهر الداكن/الفاتح إن وجد -->
  <link href="/static/style.css?v=1" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="{{ url_for('static', path='manifest.json') }}">
  <meta name="theme-color" content="#6C63FF">
  <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('/static/sw.js');}</script>

  <style>
    :root{
      /* سيتم ضبطها بالسكربت */
      --safe: 0px;
      --tabbar-height: 72px;            /* ارتفاع الشريط */
      --tabbar-radius: 18px;            /* تقويس علوي */
      --tabbar-shadow: 0 10px 40px rgba(0,0,0,.08), 0 0 0 1px rgba(0,0,0,.02) inset;
      --tabbar-bg: #ffffff;             /* أبيض 100% */
      --tab-inactive: #6b7280;          /* رمادي للنص */
      --tab-active: #111827;            /* أسود للنص النشط */
    }

    /* مساحة سفلية للمحتوى كي لا يختبئ خلف الشريط */
    body{ padding-bottom: calc(var(--tabbar-height) + var(--safe)); }

    /* ======== شريط سفلي على غرار Airbnb ======== */
    .mobile-tabbar{
      position: fixed;
      left: 12px; right: 12px;
      bottom: calc(var(--safe) + 6px);
      height: var(--tabbar-height);
      background: var(--tabbar-bg);
      border-radius: var(--tabbar-radius) var(--tabbar-radius) 0 0;
      box-shadow: var(--tabbar-shadow);
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      align-items: center;
      padding: 8px 10px 12px;
      border-top: 1px solid rgba(0,0,0,.06);
      z-index: 2147483647; /* فوق كل شيء */
      -webkit-backdrop-filter: none !important; /* لا شفافية */
      backdrop-filter: none !important;
      isolation: isolate;
    }
    @media (min-width: 992px){ .mobile-tabbar{ display:none; } } /* سطح المكتب */

    .mobile-tabbar a{
      text-decoration: none;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap: 4px;
      color: var(--tab-inactive);
      font-size: .82rem;
      line-height: 1;
      position: relative;
      white-space: nowrap;
    }
    .mobile-tabbar a .bi,
    .mobile-tabbar a img.tab-img{
      width: 22px; height: 22px; object-fit: contain;
    }
    .mobile-tabbar a.is-active{ color: var(--tab-active); font-weight: 700; }
    .mobile-tabbar a.is-active::after{
      content:"";
      position:absolute;
      bottom: -6px;
      width: 24px; height: 3px;
      border-radius: 999px;
      background: var(--tab-active);
    }

    /* زر عائم (+) إن احتجت */
    .fab, .btn-fab, .add-item-btn{
      position: fixed !important;
      right: 18px !important;
      bottom: calc(var(--safe) + var(--tabbar-height) + 14px) !important;
      z-index: 2147483647 !important;
    }

    /* وضع التطبيق (Standalone): بعض أجهزة iOS تُرجع env=0، نحط حد أدنى */
    @media (display-mode: standalone){
      :root{ --safe: max(env(safe-area-inset-bottom, 0px), 16px); }
      body{ padding-bottom: calc(var(--tabbar-height) + var(--safe)); }
    }
  </style>
</head>
<body>

  <!-- … محتوى موقعك العادي … -->

  <!-- ======== الشريط السفلي (نسخة Airbnb) ======== -->
  <nav class="mobile-tabbar" role="navigation" aria-label="التبويب السفلي" id="mobileTabbar">
    <a href="/" class="{% if request and request.url.path == '/' %}is-active{% endif %}">
      <i class="bi bi-house-door-fill"></i><span>الرئيسية</span>
    </a>

    {% if session_user %}
      <a href="/favorites" class="{% if request and request.url.path.startswith('/favorites') %}is-active{% endif %}">
        <i class="bi bi-bookmark-fill"></i><span>مفضلتي</span>
      </a>
    {% else %}
      <a href="/login"><i class="bi bi-bookmark"></i><span>مفضلتي</span></a>
    {% endif %}

    {% if session_user %}
      <a href="/bookings" class="{% if request and request.url.path.startswith('/bookings') %}is-active{% endif %}">
        <i class="bi bi-star-fill"></i><span>حجوزاتي</span>
      </a>
    {% else %}
      <a href="/login"><i class="bi bi-star"></i><span>حجوزاتي</span></a>
    {% endif %}

    {% if session_user %}
      <a href="/messages" class="{% if request and request.url.path.startswith('/messages') %}is-active{% endif %}" id="tabMessages">
        <i class="bi bi-chat-dots-fill"></i><span>الرسائل</span>
        <!-- عدّاد رسائل/إشعارات (يظهر تلقائيًا بالـ JS) -->
        <small class="position-absolute top-0 translate-middle badge rounded-pill bg-danger"
               style="inset-inline-end:10px; display:none;" id="badgeMsgs">0</small>
      </a>
    {% else %}
      <a href="/login" id="tabMessages"><i class="bi bi-chat-dots"></i><span>الرسائل</span></a>
    {% endif %}

    {% if session_user %}
      <a href="/profile" class="{% if request and request.url.path.startswith('/profile') %}is-active{% endif %}">
        <i class="bi bi-person-fill"></i><span>بروفايلي</span>
      </a>
    {% else %}
      <a href="/login"><i class="bi bi-person"></i><span>بروفايلي</span></a>
    {% endif %}
  </nav>

  <!-- Scripts أساسية -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ====== Safe-Area + عدّاد الإشعارات ====== -->
  <script>
  (function(){
    // 1) احسب الـ safe-area الحقيقي
    function computeSafe(){
      var safe = 0;
      try{
        var probe = document.createElement('div');
        probe.style.cssText =
          'position:fixed;bottom:0;left:0;right:0;' +
          'height:constant(safe-area-inset-bottom);height:env(safe-area-inset-bottom);' +
          'pointer-events:none;opacity:0;';
        document.body.appendChild(probe);
        safe = Math.max(0, probe.getBoundingClientRect().height || 0);
        probe.remove();
      }catch(_){}

      var isIOS = /iphone|ipod|ipad/i.test(navigator.userAgent);
      var isStandalone = (window.navigator.standalone === true) ||
                         (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches);
      if (isIOS && isStandalone && safe < 8) safe = 16; // حد أدنى آمن داخل PWA

      document.documentElement.style.setProperty('--safe', safe + 'px');
    }
    computeSafe();
    window.addEventListener('resize', computeSafe);
    if (window.visualViewport){
      visualViewport.addEventListener('resize', computeSafe);
      visualViewport.addEventListener('scroll', computeSafe);
    }

    // 2) عدّاد الرسائل/الإشعارات (99+)
    var badge = document.getElementById('badgeMsgs');
    function setBadge(n){
      if (!badge) return;
      if (n > 0){
        badge.textContent = (n > 99 ? '99+' : String(n));
        badge.style.display = '';
      }else{
        badge.textContent = '';
        badge.style.display = 'none';
      }
    }

    // اجلب العدّاد من API إن وُجد، مع مسارات بديلة
    const FEEDS = ['/api/notifs/unread_count','/api/notifications/unread','/notifications/json'];
    (async function(){
      for (const u of FEEDS){
        try{
          const r = await fetch(u, {credentials:'include'});
          if (!r.ok) continue;
          const d = await r.json();
          // دعم مفاتيح مختلفة
          const n = parseInt(d.count ?? d.unread ?? d.messages ?? 0) || 0;
          setBadge(n);
          break;
        }catch(_){}
      }
    })();
    // حدّث كل 30ث
    setInterval(async ()=> {
      try{
        const r = await fetch('/api/notifs/unread_count', {credentials:'include'});
        const d = r.ok ? await r.json() : {count:0};
        const n = parseInt(d.count||0) || 0;
        setBadge(n);
      }catch(_){}
    }, 30000);

    // 3) ضبط حالة التبويب النشط (لو حمّلت HTML من cache بدون كلاس)
    try{
      var path = location.pathname;
      var links = document.querySelectorAll('.mobile-tabbar a');
      links.forEach(a=>{
        a.classList.toggle('is-active', a.getAttribute('href') === path ||
          (path.startsWith('/favorites') && a.getAttribute('href').startsWith('/favorites')) ||
          (path.startsWith('/bookings') && a.getAttribute('href').startsWith('/bookings')) ||
          (path.startsWith('/messages') && a.getAttribute('href').startsWith('/messages')) ||
          (path.startsWith('/profile')  && a.getAttribute('href').startsWith('/profile')));
      });
    }catch(_){}
  })();
  </script>

</body>
</html>