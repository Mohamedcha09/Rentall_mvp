{% extends "base.html" %}

{% block head %}
<style>
  .topbar, .sidebar, .mobile-tabbar { display:none !important; }

  .page {
    margin:0 !important; padding:0 !important;
    min-height:100dvh; display:grid;
    grid-template-columns: 1fr 640px;
    background:
      radial-gradient(1200px 900px at 85% -10%, rgba(124,92,255,.14), transparent 45%),
      radial-gradient(900px 700px at -10% 110%, rgba(0,229,168,.08), transparent 40%),
      var(--bg);
  }
  @media (max-width: 1100px){ .page{ grid-template-columns: 1fr; } }

  /* القسم الأيسر */
  .hero{
    position:relative;
    display:flex; align-items:center; justify-content:center;
    padding: clamp(22px, 5vw, 80px);
    overflow:hidden;
  }
  .hero-inner{ max-width: 860px; width:100%; position:relative; z-index:2; }

  /* الصورة الكبيرة */
  .hero::before {
    content: "";
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background: url("{{ url_for('static', path='images/app.png') }}") no-repeat center top;
    background-size: contain;
    width: 100%;
    max-width: 700px;
    height: 340px;
    opacity: 0.95;
    z-index: 1;
  }
  @media (max-width: 992px){
    .hero::before { content: none !important; display: none !important; }
  }

  .brand-row{ display:flex; align-items:center; gap:12px; margin-bottom: 10px; }
  .brand-row img.logo{ height: 44px; width:auto; display:block; }
  .brand-row .name{
    font-weight:900; letter-spacing:.3px; font-size: clamp(22px, 3.2vw, 34px);
    background: linear-gradient(135deg,#6ee7f9,#7c5cff);
    -webkit-background-clip:text; background-clip:text; color: transparent;
  }

  .badge-soft{
    display:inline-flex; align-items:center; gap:8px;
    background: rgba(255,255,255,.06);
    border: 1px solid var(--border); color: var(--text);
    border-radius: 999px; padding: .25rem .6rem; font-weight:700; font-size:.85rem;
  }
  .hero h1{
    font-weight:900; line-height:1.35;
    font-size: clamp(24px, 3.6vw, 42px);
    margin: 6px 0 10px;
  }
  .hero p{ color: var(--muted); font-size: clamp(14px, 1.4vw, 16px); }

  .reg-col{
    display:flex; align-items:center; justify-content:center;
    padding: clamp(14px, 4vw, 32px);
    background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 92%, transparent),
                                        color-mix(in oklab, var(--panel) 84%, transparent));
    border-inline-start: 1px solid var(--border);
  }
  .card-reg{
    width:100%; max-width: 640px;
    background: linear-gradient(180deg, color-mix(in oklab, var(--card) 96%, transparent),
                                        color-mix(in oklab, var(--card) 88%, transparent));
    border:1px solid var(--border);
    border-radius: 18px; box-shadow: var(--shadow);
    padding: 18px 18px 20px;
  }
  .card-reg .head{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 12px;
  }
  .head .title{ font-weight:900; opacity:.95; font-size: 1.1rem; }
  .head .secure{
    display:inline-flex; align-items:center; gap:6px;
    padding:.25rem .55rem; border-radius:999px;
    background: rgba(76,175,80,.12);
    border: 1px solid rgba(76,175,80,.35);
    color:#b5f1c7; font-weight:700; font-size:.82rem;
  }

  .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 640px){ .grid-2{ grid-template-columns: 1fr; } }

  .form-label{ font-weight:800; }
  .form-control, .form-select{
    height: 48px; border-radius: 14px;
    background: color-mix(in oklab, var(--panel) 92%, transparent);
    border:1px solid var(--border); color: var(--text);
  }
  .form-control:focus, .form-select:focus{
    box-shadow:0 0 0 4px var(--ring);
    border-color: color-mix(in oklab, var(--primary) 60%, var(--border));
  }
  .form-text{ color: var(--muted) !important; }

  .pw-wrap{ position: relative; }
  .pw-input{ padding-inline-start: 44px !important; }
  .pw-toggle{
    position:absolute; inset-inline-start: 8px; top: 50%;
    transform: translateY(-50%);
    width: 34px; height: 34px; border-radius: 12px;
    display:grid; place-items:center; border:1px solid var(--border);
    background: rgba(255,255,255,.06); cursor:pointer;
  }
  .pw-toggle:hover{ filter:brightness(1.04); }

  .file-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width: 640px){ .file-row{ grid-template-columns: 1fr; } }

  .btn{ border-radius: 12px; }
  .btn-primary{
    background: linear-gradient(135deg, var(--primary), var(--primary-2));
    border:0; box-shadow:0 12px 28px rgba(124,92,255,.28);
  }
  .btn-success{ background:#22c55e; border:0; }
  .muted{ color: var(--muted); }

  /* الكاميرا */
  .cam-box{
    display:none; margin-top: 12px; padding:12px; border:1px dashed var(--border);
    border-radius:14px; background: rgba(255,255,255,.03);
  }
  .cam-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .cam-media{ width:100%; max-height: 360px; border-radius:12px; display:block; }
  #photoPreview{ display:none; }
  #canvas{ display:none; }
</style>
{% endblock %}

{% block content %}
<div class="page">
  <section class="hero">
    <div class="hero-inner">
      <div class="brand-row">
        <img class="logo" src="{{ url_for('static', path='images/ok.png') }}" alt="SEVOR">
        <div class="name">SEVOR</div>
      </div>

      <span class="badge-soft">
        <img src="{{ url_for('static', path='images/ok.png') }}" alt="" style="width:18px;height:18px;border-radius:6px;object-fit:cover">
        منصة الحجز الذكية
      </span>

      <h1>افتح حسابك وابدأ التواصل مع الأشياء التي تحتاجها يوميًا.</h1>
      <p class="muted">سجّل الآن لإدارة محادثاتك، مدفوعاتك، وإشعاراتك بسهولة وأمان — كل شيء في مكان واحد.</p>
    </div>
  </section>

  <section class="reg-col">
    <div class="card-reg">
      <div class="head">
        <div class="title">إنشاء حساب جديد</div>
        <div class="secure"><i class="bi bi-shield-lock"></i> آمن ومشفّر</div>
      </div>

      <form method="post" action="/register" enctype="multipart/form-data" novalidate>
        <div class="grid-2">
          <div>
            <label class="form-label">الاسم</label>
            <input type="text" name="first_name" class="form-control" required>
          </div>
          <div>
            <label class="form-label">اللقب</label>
            <input type="text" name="last_name" class="form-control" required>
          </div>
        </div>

        <div class="grid-2 mt-3">
          <div>
            <label class="form-label">البريد الإلكتروني</label>
            <input type="email" name="email" class="form-control" autocomplete="email" required>
          </div>
          <div>
            <label class="form-label">الهاتف</label>
            <input type="tel" name="phone" class="form-control" inputmode="tel" autocomplete="tel" required>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">كلمة المرور</label>
          <div class="pw-wrap">
            <button type="button" class="pw-toggle" id="pwToggle" aria-label="إظهار/إخفاء كلمة المرور"><i class="bi bi-eye-slash"></i></button>
            <input type="password" name="password" class="form-control pw-input" id="pwInput" minlength="6" required>
          </div>
          <div class="form-text">يتم تشفير كلمات المرور، ونستعمل التحقق بخطوتين لمنع إساءة الاستخدام.</div>
        </div>

        <!-- صورة الحساب — كاميرا فقط -->
        <div class="mt-3">
          <label class="form-label">صورة الحساب (التقاط بالكاميرا فقط)</label>

          <div class="cam-actions">
            <button type="button" class="btn btn-success btn-sm" id="openCamBtn">
              <i class="bi bi-camera"></i> افتح الكاميرا
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="snapBtn" style="display:none;">
              <i class="bi bi-record2"></i> التقط صورة
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="usePhotoBtn" style="display:none;">
              <i class="bi bi-check2-circle"></i> استخدم الصورة
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="retakeBtn" style="display:none;">
              <i class="bi bi-arrow-repeat"></i> أعد الالتقاط
            </button>
          </div>

          <div class="cam-box" id="camBox">
            <video id="video" class="cam-media" autoplay playsinline></video>
            <canvas id="canvas" class="cam-media"></canvas>
            <img id="photoPreview" class="cam-media" alt="معاينة الصورة">
          </div>

          <!-- حقل ملف مخفي: نملؤه برمجياً بعد الالتقاط -->
          <input type="file" name="avatar" id="avatarInput" accept="image/*"
                 style="position:absolute;left:-9999px;opacity:0;" tabindex="-1" aria-hidden="true">

          <div class="form-text">يجب التقاط صورة مباشرة عبر الكاميرا. لا يُسمح برفع صور من الجهاز.</div>
        </div>

        <div class="mt-3">
          <label class="form-label">نوع الوثيقة</label>
          <select name="doc_type" class="form-select" required>
            <option value="id_card">بطاقة تعريف</option>
            <option value="driver_license">رخصة سياقة</option>
            <option value="passport">جواز سفر</option>
          </select>
        </div>

        <div class="grid-2 mt-3">
          <div>
            <label class="form-label">بلد الإصدار</label>
            <input type="text" name="doc_country" class="form-control" required>
          </div>
          <div>
            <label class="form-label">تاريخ انتهاء الوثيقة</label>
            <input type="date" name="doc_expiry" class="form-control">
          </div>
        </div>

        <div class="file-row mt-3">
          <div>
            <label class="form-label">الوجه الأمامي للوثيقة</label>
            <input type="file" name="doc_front" class="form-control" accept=".jpg,.jpeg,.png,.pdf" required>
          </div>
          <div>
            <label class="form-label">الوجه الخلفي (اختياري)</label>
            <input type="file" name="doc_back" class="form-control" accept=".jpg,.jpeg,.png,.pdf">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-4">إنشاء الحساب</button>
        <div class="text-center mt-2">
          <a class="muted" href="/login">لديك حساب؟ سجّل الدخول</a>
        </div>
      </form>
    </div>
  </section>
</div>

<script>
(function(){
  // تبديل كلمة المرور
  const pwToggle = document.getElementById('pwToggle');
  const pwInput  = document.getElementById('pwInput');
  pwToggle?.addEventListener('click', () => {
    const isPass = pwInput.type === 'password';
    pwInput.type = isPass ? 'text' : 'password';
    pwToggle.innerHTML = isPass ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
  });

  // عناصر الكاميرا
  const form         = document.querySelector('form[action="/register"]');
  const openCamBtn   = document.getElementById('openCamBtn');
  const snapBtn      = document.getElementById('snapBtn');
  const usePhotoBtn  = document.getElementById('usePhotoBtn');
  const retakeBtn    = document.getElementById('retakeBtn');
  const camBox       = document.getElementById('camBox');
  const video        = document.getElementById('video');
  const canvas       = document.getElementById('canvas');
  const photoPreview = document.getElementById('photoPreview');
  const avatarInput  = document.getElementById('avatarInput');

  // 🔒 منع فتح منتقي الملفات نهائياً
  if (avatarInput) {
    const block = (e)=> e.preventDefault();
    avatarInput.addEventListener('click', block);
    avatarInput.addEventListener('focus', ()=> avatarInput.blur());
    avatarInput.addEventListener('keydown', block);
  }

  let stream = null, capturedBlob = null;

  function show(el){ el.style.display='block'; }
  function hide(el){ el.style.display='none'; }

  async function openCamera(){
    try{
      // لو تفضّل الكاميرا الخلفية على الهاتف استبدل 'user' بـ { ideal: 'environment' }
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
      video.srcObject = stream;
      show(camBox);
      show(snapBtn);
      hide(usePhotoBtn);
      hide(retakeBtn);
      hide(photoPreview);
      hide(canvas);
      capturedBlob = null;
    }catch(e){
      alert('تعذّر الوصول إلى الكاميرا. تأكد من منح الإذن وأن الصفحة تعمل عبر HTTPS.');
    }
  }

  function snapPhoto(){
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h) { alert('انتظر تشغيل الكاميرا…'); return; }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    canvas.toBlob((blob)=>{
      capturedBlob = blob;
      photoPreview.src = URL.createObjectURL(blob);
      hide(video);
      show(photoPreview);
      show(usePhotoBtn);
      show(retakeBtn);
      hide(snapBtn);
    }, 'image/jpeg', 0.9);
  }

  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject = null;
  }

  function retake(){
    capturedBlob=null;
    photoPreview.src='';
    hide(photoPreview);
    show(video);
    show(snapBtn);
    hide(usePhotoBtn);
    hide(retakeBtn);
  }

  function usePhoto(){
    if(!capturedBlob) return;
    const file = new File([capturedBlob], `avatar_${Date.now()}.jpg`, { type:'image/jpeg' });
    const dt = new DataTransfer(); dt.items.add(file); avatarInput.files = dt.files;
    stopCamera();
  }

  // تحقق قبل الإرسال: لازم صورة ملتقطة
  form?.addEventListener('submit', (e)=>{
    if (!avatarInput.files || avatarInput.files.length === 0){
      e.preventDefault();
      alert('الرجاء التقاط صورة عبر الكاميرا قبل إرسال النموذج.');
    }
  });

  openCamBtn?.addEventListener('click', openCamera);
  snapBtn?.addEventListener('click', snapPhoto);
  usePhotoBtn?.addEventListener('click', usePhoto);
  retakeBtn?.addEventListener('click', retake);
  window.addEventListener('beforeunload', stopCamera);
})();
</script>
{% endblock %}