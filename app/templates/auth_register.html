{% extends "base.html" %}

{% block head %}
<style>
  .topbar, .sidebar, .mobile-tabbar { display:none !important; }

  .page {
    margin:0 !important; padding:0 !important;
    min-height:100dvh; display:grid;
    grid-template-columns: 1fr 640px;
    background:
      radial-gradient(1200px 900px at 85% -10%, rgba(124,92,255,.14), transparent 45%),
      radial-gradient(900px 700px at -10% 110%, rgba(0,229,168,.08), transparent 40%),
      var(--bg);
  }
  @media (max-width: 1100px){ .page{ grid-template-columns: 1fr; } }

  /* Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø± */
  .hero{
    position:relative;
    display:flex; align-items:center; justify-content:center;
    padding: clamp(22px, 5vw, 80px);
    overflow:hidden;
  }
  .hero-inner{ max-width: 860px; width:100%; position:relative; z-index:2; }

  /* Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
  .hero::before {
    content: "";
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background: url("{{ url_for('static', path='images/app.png') }}") no-repeat center top;
    background-size: contain;
    width: 100%;
    max-width: 700px;
    height: 340px;
    opacity: 0.95;
    z-index: 1;
  }
  @media (max-width: 992px){
    .hero::before { content: none !important; display: none !important; }
  }

  .brand-row{ display:flex; align-items:center; gap:12px; margin-bottom: 10px; }
  .brand-row img.logo{ height: 44px; width:auto; display:block; }
  .brand-row .name{
    font-weight:900; letter-spacing:.3px; font-size: clamp(22px, 3.2vw, 34px);
    background: linear-gradient(135deg,#6ee7f9,#7c5cff);
    -webkit-background-clip:text; background-clip:text; color: transparent;
  }

  .badge-soft{
    display:inline-flex; align-items:center; gap:8px;
    background: rgba(255,255,255,.06);
    border: 1px solid var(--border); color: var(--text);
    border-radius: 999px; padding: .25rem .6rem; font-weight:700; font-size:.85rem;
  }
  .hero h1{
    font-weight:900; line-height:1.35;
    font-size: clamp(24px, 3.6vw, 42px);
    margin: 6px 0 10px;
  }
  .hero p{ color: var(--muted); font-size: clamp(14px, 1.4vw, 16px); }

  .reg-col{
    display:flex; align-items:center; justify-content:center;
    padding: clamp(14px, 4vw, 32px);
    background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 92%, transparent),
                                        color-mix(in oklab, var(--panel) 84%, transparent));
    border-inline-start: 1px solid var(--border);
  }
  .card-reg{
    width:100%; max-width: 640px;
    background: linear-gradient(180deg, color-mix(in oklab, var(--card) 96%, transparent),
                                        color-mix(in oklab, var(--card) 88%, transparent));
    border:1px solid var(--border);
    border-radius: 18px; box-shadow: var(--shadow);
    padding: 18px 18px 20px;
  }
  .card-reg .head{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 12px;
  }
  .head .title{ font-weight:900; opacity:.95; font-size: 1.1rem; }
  .head .secure{
    display:inline-flex; align-items:center; gap:6px;
    padding:.25rem .55rem; border-radius:999px;
    background: rgba(76,175,80,.12);
    border: 1px solid rgba(76,175,80,.35);
    color:#b5f1c7; font-weight:700; font-size:.82rem;
  }

  .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 640px){ .grid-2{ grid-template-columns: 1fr; } }

  .form-label{ font-weight:800; }
  .form-control, .form-select{
    height: 48px; border-radius: 14px;
    background: color-mix(in oklab, var(--panel) 92%, transparent);
    border:1px solid var(--border); color: var(--text);
  }
  .form-control:focus, .form-select:focus{
    box-shadow:0 0 0 4px var(--ring);
    border-color: color-mix(in oklab, var(--primary) 60%, var(--border));
  }
  .form-text{ color: var(--muted) !important; }

  .pw-wrap{ position: relative; }
  .pw-input{ padding-inline-start: 44px !important; }
  .pw-toggle{
    position:absolute; inset-inline-start: 8px; top: 50%;
    transform: translateY(-50%);
    width: 34px; height: 34px; border-radius: 12px;
    display:grid; place-items:center; border:1px solid var(--border);
    background: rgba(255,255,255,.06); cursor:pointer;
  }
  .pw-toggle:hover{ filter:brightness(1.04); }

  .file-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width: 640px){ .file-row{ grid-template-columns: 1fr; } }

  .btn{ border-radius: 12px; }
  .btn-primary{
    background: linear-gradient(135deg, var(--primary), var(--primary-2));
    border:0; box-shadow:0 12px 28px rgba(124,92,255,.28);
  }
  .btn-success{ background:#22c55e; border:0; }
  .muted{ color: var(--muted); }

  /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
  .cam-box{
    display:none; margin-top: 12px; padding:12px; border:1px dashed var(--border);
    border-radius:14px; background: rgba(255,255,255,.03);
  }
  .cam-actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .cam-media{ width:100%; max-height: 360px; border-radius:12px; display:block; }
  #photoPreview{ display:none; }
  #canvas{ display:none; }
</style>
{% endblock %}

{% block content %}
<div class="page">
  <section class="hero">
    <div class="hero-inner">
      <div class="brand-row">
        <img class="logo" src="{{ url_for('static', path='images/ok.png') }}" alt="SEVOR">
        <div class="name">SEVOR</div>
      </div>

      <span class="badge-soft">
        <img src="{{ url_for('static', path='images/ok.png') }}" alt="" style="width:18px;height:18px;border-radius:6px;object-fit:cover">
        Ù…Ù†ØµØ© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø°ÙƒÙŠØ©
      </span>

      <h1>Ø§ÙØªØ­ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§ ÙŠÙˆÙ…ÙŠÙ‹Ø§.</h1>
      <p class="muted">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù† Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒØŒ Ù…Ø¯ÙÙˆØ¹Ø§ØªÙƒØŒ ÙˆØ¥Ø´Ø¹Ø§Ø±Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ£Ù…Ø§Ù† â€” ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯.</p>
    </div>
  </section>

  <section class="reg-col">
    <div class="card-reg">
      <div class="head">
        <div class="title">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>
        <div class="secure"><i class="bi bi-shield-lock"></i> Ø¢Ù…Ù† ÙˆÙ…Ø´ÙÙ‘Ø±</div>
      </div>

      <form method="post" action="/register" enctype="multipart/form-data" novalidate>
        <div class="grid-2">
          <div>
            <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" name="first_name" class="form-control" required>
          </div>
          <div>
            <label class="form-label">Ø§Ù„Ù„Ù‚Ø¨</label>
            <input type="text" name="last_name" class="form-control" required>
          </div>
        </div>

        <div class="grid-2 mt-3">
          <div>
            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" name="email" class="form-control" autocomplete="email" required>
          </div>
          <div>
            <label class="form-label">Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" name="phone" class="form-control" inputmode="tel" autocomplete="tel" required>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <div class="pw-wrap">
            <button type="button" class="pw-toggle" id="pwToggle" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><i class="bi bi-eye-slash"></i></button>
            <input type="password" name="password" class="form-control pw-input" id="pwInput" minlength="6" required>
          </div>
          <div class="form-text">ÙŠØªÙ… ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ÙˆÙ†Ø³ØªØ¹Ù…Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ† Ù„Ù…Ù†Ø¹ Ø¥Ø³Ø§Ø¡Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</div>
        </div>

        <!-- ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ â€” ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙ‚Ø· -->
        <div class="mt-3">
          <label class="form-label">ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø§Ù„ØªÙ‚Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙ‚Ø·)</label>

          <div class="cam-actions">
            <button type="button" class="btn btn-success btn-sm" id="openCamBtn">
              <i class="bi bi-camera"></i> Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            </button>
            <button type="button" class="btn btn-secondary btn-sm" id="snapBtn" style="display:none;">
              <i class="bi bi-record2"></i> Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø©
            </button>
            <button type="button" class="btn btn-primary btn-sm" id="usePhotoBtn" style="display:none;">
              <i class="bi bi-check2-circle"></i> Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØ±Ø©
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="retakeBtn" style="display:none;">
              <i class="bi bi-arrow-repeat"></i> Ø£Ø¹Ø¯ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
            </button>
          </div>

          <div class="cam-box" id="camBox">
            <video id="video" class="cam-media" autoplay playsinline></video>
            <canvas id="canvas" class="cam-media"></canvas>
            <img id="photoPreview" class="cam-media" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
          </div>

          <!-- Ø­Ù‚Ù„ Ù…Ù„Ù Ù…Ø®ÙÙŠ: Ù†Ù…Ù„Ø¤Ù‡ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· -->
          <input type="file" name="avatar" id="avatarInput" accept="image/*"
                 style="position:absolute;left:-9999px;opacity:0;" tabindex="-1" aria-hidden="true">

          <div class="form-text">ÙŠØ¬Ø¨ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø±ÙØ¹ ØµÙˆØ± Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø².</div>
        </div>

        <div class="mt-3">
          <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label>
          <select name="doc_type" class="form-select" required>
            <option value="id_card">Ø¨Ø·Ø§Ù‚Ø© ØªØ¹Ø±ÙŠÙ</option>
            <option value="driver_license">Ø±Ø®ØµØ© Ø³ÙŠØ§Ù‚Ø©</option>
            <option value="passport">Ø¬ÙˆØ§Ø² Ø³ÙØ±</option>
          </select>
        </div>

        <div class="grid-2 mt-3">
          <div>
            <label class="form-label">Ø¨Ù„Ø¯ Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
            <input type="text" name="doc_country" class="form-control" required>
          </div>
          <div>
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label>
            <input type="date" name="doc_expiry" class="form-control">
          </div>
        </div>

        <div class="file-row mt-3">
          <div>
            <label class="form-label">Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ Ù„Ù„ÙˆØ«ÙŠÙ‚Ø©</label>
            <input type="file" name="doc_front" class="form-control" accept=".jpg,.jpeg,.png,.pdf" required>
          </div>
          <div>
            <label class="form-label">Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø®Ù„ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" name="doc_back" class="form-control" accept=".jpg,.jpeg,.png,.pdf">
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-4">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <div class="text-center mt-2">
          <a class="muted" href="/login">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        </div>
      </form>
    </div>
  </section>
</div>

<script>
(function(){
  // ØªØ¨Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  const pwToggle = document.getElementById('pwToggle');
  const pwInput  = document.getElementById('pwInput');
  pwToggle?.addEventListener('click', () => {
    const isPass = pwInput.type === 'password';
    pwInput.type = isPass ? 'text' : 'password';
    pwToggle.innerHTML = isPass ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
  });

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  const form         = document.querySelector('form[action="/register"]');
  const openCamBtn   = document.getElementById('openCamBtn');
  const snapBtn      = document.getElementById('snapBtn');
  const usePhotoBtn  = document.getElementById('usePhotoBtn');
  const retakeBtn    = document.getElementById('retakeBtn');
  const camBox       = document.getElementById('camBox');
  const video        = document.getElementById('video');
  const canvas       = document.getElementById('canvas');
  const photoPreview = document.getElementById('photoPreview');
  const avatarInput  = document.getElementById('avatarInput');

  // ğŸ”’ Ù…Ù†Ø¹ ÙØªØ­ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
  if (avatarInput) {
    const block = (e)=> e.preventDefault();
    avatarInput.addEventListener('click', block);
    avatarInput.addEventListener('focus', ()=> avatarInput.blur());
    avatarInput.addEventListener('keydown', block);
  }

  let stream = null, capturedBlob = null;

  function show(el){ el.style.display='block'; }
  function hide(el){ el.style.display='none'; }

  async function openCamera(){
    try{
      // Ù„Ùˆ ØªÙØ¶Ù‘Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ Ø§Ø³ØªØ¨Ø¯Ù„ 'user' Ø¨Ù€ { ideal: 'environment' }
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
      video.srcObject = stream;
      show(camBox);
      show(snapBtn);
      hide(usePhotoBtn);
      hide(retakeBtn);
      hide(photoPreview);
      hide(canvas);
      capturedBlob = null;
    }catch(e){
      alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† ÙˆØ£Ù† Ø§Ù„ØµÙØ­Ø© ØªØ¹Ù…Ù„ Ø¹Ø¨Ø± HTTPS.');
    }
  }

  function snapPhoto(){
    const w = video.videoWidth, h = video.videoHeight;
    if (!w || !h) { alert('Ø§Ù†ØªØ¸Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§â€¦'); return; }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    canvas.toBlob((blob)=>{
      capturedBlob = blob;
      photoPreview.src = URL.createObjectURL(blob);
      hide(video);
      show(photoPreview);
      show(usePhotoBtn);
      show(retakeBtn);
      hide(snapBtn);
    }, 'image/jpeg', 0.9);
  }

  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject = null;
  }

  function retake(){
    capturedBlob=null;
    photoPreview.src='';
    hide(photoPreview);
    show(video);
    show(snapBtn);
    hide(usePhotoBtn);
    hide(retakeBtn);
  }

  function usePhoto(){
    if(!capturedBlob) return;
    const file = new File([capturedBlob], `avatar_${Date.now()}.jpg`, { type:'image/jpeg' });
    const dt = new DataTransfer(); dt.items.add(file); avatarInput.files = dt.files;
    stopCamera();
  }

  // ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù„Ø§Ø²Ù… ØµÙˆØ±Ø© Ù…Ù„ØªÙ‚Ø·Ø©
  form?.addEventListener('submit', (e)=>{
    if (!avatarInput.files || avatarInput.files.length === 0){
      e.preventDefault();
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø¹Ø¨Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.');
    }
  });

  openCamBtn?.addEventListener('click', openCamera);
  snapBtn?.addEventListener('click', snapPhoto);
  usePhotoBtn?.addEventListener('click', usePhoto);
  retakeBtn?.addEventListener('click', retake);
  window.addEventListener('beforeunload', stopCamera);
})();
</script>
{% endblock %}