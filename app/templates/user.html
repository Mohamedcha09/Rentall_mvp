{% extends "base.html" %}
{% block content %}

<!-- ===== زر الرجوع iOS ===== -->
<a href="/" class="back-btn-ios">
  <i class="bi bi-chevron-left"></i>
</a>

<style>
/* =====================================================
   زر الرجوع — iOS floating button style
   ===================================================== */
.back-btn-ios {
    position: fixed;
    top: calc(env(safe-area-inset-top) + 12px);
    left: 14px;
    z-index: 9999;
    background: rgba(255,255,255,0.88);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    text-decoration: none;
}
.back-btn-ios:active { transform: scale(0.94); }

/* =====================================================
   إخفاء الهيدر + التابات + التاب بار + سترايب
   ===================================================== */
header.topbar,
.m-top-tabs,
nav.desk-tabs,
.mobile-tabbar,
.stripe-callout,
.connect-banner,
.payout-banner,
.stripe-connect-banner,
.searchbar {
    display: none !important;
}

body.has-tabbar { padding-bottom: 0 !important; }
</style>

<style>
/* ====================== NUMBERS LTR ====================== */
.num-ltr{
  direction:ltr;
  unicode-bidi:isolate;
  white-space:nowrap;
  font-variant-numeric:tabular-nums;
}

/* ====================== STATS STRIP ====================== */
.stats-strip{
  display:flex; gap:10px; padding:4px 2px; margin-bottom:12px;
  overflow-x:auto; overscroll-behavior-x:contain;
  -webkit-overflow-scrolling:touch;
}
.stats-chip{
  min-width:210px;
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  background:var(--surface);
  flex:0 0 auto;
}
.stats-strip::-webkit-scrollbar{ height:8px }
.stats-strip::-webkit-scrollbar-thumb{
  background:rgba(0,0,0,.15); border-radius:999px;
}

/* ====================== SIMILAR CARD DESIGN ====================== */
.sim-card{
  background:#fff;
  border-radius:22px;
  padding:14px;
  border:1px solid rgba(17,24,39,.06);
  box-shadow:0 8px 26px rgba(17,24,39,.06);
  transition:transform .18s ease, box-shadow .25s ease;
}
.sim-card:hover{
  transform:translateY(-4px);
  box-shadow:0 18px 38px rgba(17,24,39,.12);
}

.sim-img-box{
  position:relative;
  width:100%;
  aspect-ratio:16 / 10;
  border-radius:18px;
  overflow:hidden;
  background:#eee;
}

.sim-img-box img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

/* Labels */
.sim-chip{
  position:absolute;
  top:10px;
  left:10px;
  padding:6px 14px;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
  color:#111;
}

.sim-cat{
  position:absolute;
  top:10px;
  right:10px;
  padding:6px 14px;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  color:#555;
}

/* Heart */
.sim-heart{
  position:absolute;
  bottom:12px;
  right:12px;
  width:34px;
  height:34px;
  background:#ffffffcc;
  backdrop-filter:blur(6px);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  border:1px solid #e5e7eb;
  font-size:18px;
  color:#d54df2;
}

/* Body */
.sim-body{
  padding-top:12px;
}

.sim-title{
  font-size:18px;
  font-weight:800;
  margin:0 0 4px;
  color:#111;
}

.sim-sub{
  color:#6b728052;
  font-size:14px;
  margin-bottom:8px;
  border-bottom:1px dashed #e5e7eb;
  padding-bottom:8px;
}

.sim-price{
  font-size:18px;
  font-weight:900;
  color:#111;
}
</style>


{% macro build_src(p) -%}
  {% if p and (p.startswith('http://') or p.startswith('https://')) %}
    {{ p }}
  {% else %}
    {{ '/' ~ p.lstrip('/') if p else '/static/placeholder.png' }}
  {% endif %}
{%- endmacro %}

<div class="container py-4" style="max-width:760px">

<!-- ===================== USER HEADER ===================== -->
<section class="card p-3 p-md-4 mb-3">
  <div class="d-flex align-items-start align-items-md-center gap-3 flex-column flex-md-row">

    <div class="flex-shrink-0">
      {% if profile_user.avatar_path %}
        <img src="{{ build_src(profile_user.avatar_path) }}"
        class="rounded-circle"
        style="width:86px;height:86px;object-fit:cover;border:1px solid var(--border)">
      {% else %}
        <div class="rounded-circle d-grid place-items-center"
             style="width:86px;height:86px;background:rgba(255,255,255,.08);border:1px solid var(--border);">
          <span class="fw-bold fs-2">{{ (profile_user.first_name or 'U')[:1] }}</span>
        </div>
      {% endif %}
    </div>

    <div class="flex-grow-1 w-100">
      <h2 class="m-0 fw-bold">
        {{ profile_user.first_name }} {{ profile_user.last_name }}
      </h2>

      <div class="text-muted small mt-2 d-flex flex-wrap gap-3">
        <span><i class="bi bi-calendar-check"></i> Joined: {{ created_at_str }}</span>
        <span><i class="bi bi-box"></i> Listed items: {{ stats.items_count }}</span>

        {% if renter_reviews_count > 0 %}
        <span>
          <i class="bi bi-star-fill"></i>
          <span class="num-ltr">{{ '%.1f'|format(renter_reviews_avg) }}/5</span>
        </span>
        {% endif %}
      </div>

      {% if profile_user.bio %}
        <p class="mt-2 mb-0 text-muted">{{ profile_user.bio }}</p>
      {% endif %}
    </div>

  </div>
</section>

<!-- ===================== STATS ===================== -->
<section class="mb-3">
  <div class="stats-strip">
    <div class="stats-chip">
      <div class="text-muted small">Items</div>
      <div class="fs-4 fw-bold">{{ stats.items_count }}</div>
    </div>

    <div class="stats-chip">
      <div class="text-muted small">Renter rating</div>
      <div class="fs-4 fw-bold">
        {% if renter_reviews_count > 0 %}
          <span class="num-ltr">{{ '%.1f'|format(renter_reviews_avg) }}/5</span>
        {% else %}—{% endif %}
      </div>
    </div>

    <div class="stats-chip">
      <div class="text-muted small">Status</div>
      <div class="fs-6 fw-bold">
        {% if is_verified %}
          <span class="text-success">Verified</span>
        {% else %}
          <span class="text-muted">Standard</span>
        {% endif %}
      </div>
    </div>

    <div class="stats-chip">
      <div class="text-muted small">Member since</div>
      <div class="fs-6 fw-bold">{{ created_at_str }}</div>
    </div>
  </div>
</section>

<!-- ===================== TABS ===================== -->
<ul class="nav nav-pills mb-3">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pane-items">Listed items</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pane-about">About user</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pane-reviews">Reviews</button>
  </li>
</ul>

<div class="tab-content">

  <!-- ===================== ITEMS TAB ===================== -->
  <div class="tab-pane fade show active" id="pane-items">

    {% if items and items|length > 0 %}
      <div class="row g-3">

        {% for it in items %}
        <div class="col-6 col-md-4 col-lg-3">
          <div class="sim-card">

            <div class="sim-img-box">
              <img src="{{ build_src(it.image_path) }}">

              <div class="sim-chip">
                /day
              </div>

              {% if it.category_label %}
              <div class="sim-cat">{{ it.category_label }}</div>
              {% endif %}

              <div class="sim-heart">
                <i class="bi bi-heart"></i>
              </div>
            </div>

            <div class="sim-body">
              <div class="sim-title">{{ it.title }}</div>
              <div class="sim-sub">
                {{ it.category_label }} | {{ it.city or "" }}
              </div>

              <div class="sim-price">
                {{ it.display_price }} {{ it.display_currency }}
              </div>

              <a href="/items/{{ it.id }}" class="btn btn-primary w-100 mt-2">Details</a>
            </div>

          </div>
        </div>
        {% endfor %}

      </div>

    {% else %}
      <div class="card p-3 text-center text-muted">This user has no listed items currently.</div>
    {% endif %}
  </div>

  <!-- ===================== ABOUT TAB ===================== -->
  <div class="tab-pane fade" id="pane-about">
    <div class="card p-3">
      <strong>Full name</strong><br>
      <span class="text-muted">{{ profile_user.first_name }} {{ profile_user.last_name }}</span>

      <hr>

      <strong>Status</strong><br>
      {% if is_verified %}
        <span class="badge bg-success">Verified</span>
      {% else %}
        <span class="badge bg-secondary">Standard</span>
      {% endif %}
    </div>
  </div>

  <!-- ===================== REVIEWS ===================== -->
  <div class="tab-pane fade" id="pane-reviews">
    <div class="card p-3">
      {% if renter_reviews_count > 0 %}
        {% for r in renter_reviews %}
          <div class="border rounded p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div class="small text-muted">Owner #{{ r.owner_id }}</div>
              <div>
                {% for _ in range(r.stars) %}⭐{% endfor %}
              </div>
            </div>

            {% if r.comment %}
              <div>{{ r.comment }}</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">No reviews yet.</div>
      {% endif %}
    </div>
  </div>

</div>

</div>

{% endblock %}
