{% extends "base.html" %}
{% block content %}

<style>
/* Ø²Ø®Ø§Ø±Ù Ø®ÙÙŠÙØ© Ù„Ù„ØµÙØ­Ø© */
.profile-header .avatar-lg{
  width:84px;height:84px;border-radius:50%;object-fit:cover;
  border:1px solid var(--border);
  box-shadow:0 8px 26px rgba(0,0,0,.25);
}
.star{ font-size: 1rem; }
.star.filled{ color: #f5c34b; }
.tab-btn{ border-radius: 999px; }
.tab-btn.is-active{
  background: color-mix(in oklab, var(--primary) 22%, transparent);
  border: 1px solid color-mix(in oklab, var(--primary) 40%, var(--border));
  color: var(--text);
}
.tab-panel{ display:none; }
.tab-panel.is-active{ display:block; }
.meta-badge{
  border:1px solid var(--border); border-radius:12px; padding:.35rem .6rem;
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
}
.divider-ghost{height:1px;background:var(--border);margin:10px 0}
</style>

<!-- ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== -->
<section class="profile-header card p-3 mb-3">
  <div class="d-flex flex-wrap align-items-center gap-3">
    <!-- ØµÙˆØ±Ø© -->
    {% if profile_user.avatar_path %}
      <img src="/{{ profile_user.avatar_path }}" class="avatar-lg" alt="avatar">
    {% else %}
      <div class="avatar-lg d-grid place-items-center"
           style="width:84px;height:84px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid var(--border)">
        <span style="font-size:34px">ğŸ‘¤</span>
      </div>
    {% endif %}

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div class="flex-grow-1">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <h3 class="m-0">
          {{ (profile_user.first_name ~ ' ' ~ profile_user.last_name).strip() or 'Ù…Ø³ØªØ®Ø¯Ù…' }}
        </h3>
        {% if profile_user.status == 'approved' %}
          <i class="bi bi-patch-check-fill verify" title="Ù…ÙˆØ«Ù‘Ù‚"></i>
        {% endif %}
      </div>

      <div class="small text-muted d-flex flex-wrap gap-2 mt-1">
        {% if profile_user.city %}<span class="meta-badge"><i class="bi bi-geo-alt"></i> {{ profile_user.city }}</span>{% endif %}
        {% if profile_user.created_at %}
          <span class="meta-badge"><i class="bi bi-calendar2-check"></i>
            Ø§Ù†Ø¶Ù… {{ profile_user.created_at.strftime('%Y-%m-%d') if profile_user.created_at.__class__.__name__ == 'datetime' else profile_user.created_at }}
          </span>
        {% endif %}
        <span class="meta-badge"><i class="bi bi-box-seam"></i> Ø¹Ù†Ø§ØµØ±: {{ stats.total_items or 0 }}</span>
        <span class="meta-badge"><i class="bi bi-star-half"></i> ØªÙ‚ÙŠÙŠÙ…Ø§Øª: {{ stats.total_reviews or 0 }}</span>
      </div>

      <!-- Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
      <div class="mt-2">
        {% set avg = (stats.avg_rating or 0) | float %}
        {% for i in range(1,6) %}
          <i class="bi star {% if i <= avg|round(0, 'floor') %}filled bi-star-fill{% elif i-avg < 1 %}filled bi-star-half{% else %}bi-star{% endif %}"></i>
        {% endfor %}
        <span class="small text-muted ms-1">({{ '%.1f' % avg }})</span>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± -->
    <div class="d-flex gap-2 ms-auto">
      <a class="btn btn-primary btn-sm" href="/messages/new?to={{ profile_user.id }}">
        <i class="bi bi-chat-left-text"></i> Ù…Ø±Ø§Ø³Ù„Ø©
      </a>
      <a class="btn btn-ghost btn-sm" href="/search?q={{ (profile_user.first_name ~ ' ' ~ profile_user.last_name).strip()|urlencode }}">
        Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ù…Ø´Ø§Ø¨Ù‡Ø©
      </a>
    </div>
  </div>

  {% if profile_user.bio %}
    <div class="divider-ghost"></div>
    <div class="text-muted">{{ profile_user.bio }}</div>
  {% endif %}
</section>

<!-- ===== ØªØ¨ÙˆÙŠØ¨ Ø¨Ø³ÙŠØ· ===== -->
<section class="mb-3">
  <div class="d-flex gap-2 flex-wrap">
    <button class="btn btn-ghost tab-btn is-active" data-tab="tab-items"><i class="bi bi-box"></i> Ø§Ù„Ø¹Ù†Ø§ØµØ±</button>
    <button class="btn btn-ghost tab-btn" data-tab="tab-reviews"><i class="bi bi-star"></i> Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
    <button class="btn btn-ghost tab-btn" data-tab="tab-about"><i class="bi bi-info-circle"></i> Ø­ÙˆÙ„</button>
  </div>
</section>

<!-- ===== Ø§Ù„Ù„ÙˆØ­Ø§Øª ===== -->
<section id="tab-items" class="tab-panel is-active">
  {% if items and items|length > 0 %}
    <div class="home-grid">
      {% for it in items %}
        <article class="card spot">
          <div class="spot-media">
            {% if it.image_path %}
              <img src="/{{ it.image_path }}" alt="item">
            {% else %}
              <div class="d-flex align-items-center justify-content-center h-100 bg-dark-subtle">
                <span class="small text-muted">Ù„Ø§ ØµÙˆØ±Ø©</span>
              </div>
            {% endif %}
            <div class="spot-overlay"></div>
            {% if it.price_per_day is not none %}
              <div class="price-badge"><strong>{{ it.price_per_day }}</strong> Ø¯/ÙŠÙˆÙ…</div>
            {% endif %}
            {% if it.city %}<div class="category-chip">{{ it.city }}</div>{% endif %}
          </div>

          <div class="card-body d-flex flex-column gap-2">
            <h6 class="spot-title" title="{{ it.title }}">{{ it.title }}</h6>
            <div class="d-flex justify-content-between align-items-center">
              <a href="/items/{{ it.id }}" class="btn btn-sm btn-primary">ØªÙØ§ØµÙŠÙ„</a>
              <a href="/messages/new?item_id={{ it.id }}&to={{ profile_user.id }}" class="btn btn-sm btn-ghost">Ù…Ø±Ø§Ø³Ù„Ø©</a>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="card p-3 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
  {% endif %}
</section>

<section id="tab-reviews" class="tab-panel">
  {% if reviews and reviews|length > 0 %}
    <div class="d-flex flex-column gap-2">
      {% for r in reviews %}
        <div class="card p-2">
          <div class="d-flex align-items-center gap-2">
            {% if r.reviewer_avatar %}
              <img src="/{{ r.reviewer_avatar }}" class="rounded-circle" style="width:36px;height:36px;object-fit:cover;border:1px solid var(--border)">
            {% else %}
              <div class="rounded-circle d-grid place-items-center" style="width:36px;height:36px;background:rgba(255,255,255,.06);border:1px solid var(--border)">ğŸ‘¤</div>
            {% endif %}
            <div class="flex-grow-1">
              <div class="fw-bold small">{{ (r.reviewer_first_name ~ ' ' ~ r.reviewer_last_name).strip() or 'Ù…Ø³ØªØ®Ø¯Ù…' }}</div>
              <div class="small text-muted">
                {% for i in range(1,6) %}
                  <i class="bi star {% if i <= (r.rating or 0) %}filled bi-star-fill{% else %}bi-star{% endif %}"></i>
                {% endfor %}
                <span class="ms-1">{{ r.created_at.strftime('%Y-%m-%d') if r.created_at.__class__.__name__ == 'datetime' else r.created_at }}</span>
              </div>
            </div>
          </div>
          {% if r.comment %}
            <div class="mt-2 small">{{ r.comment }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="card p-3 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</div>
  {% endif %}
</section>

<section id="tab-about" class="tab-panel">
  <div class="card p-3">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="text-muted small">Ø§Ù„Ø§Ø³Ù…</div>
        <div class="fw-bold">{{ (profile_user.first_name ~ ' ' ~ profile_user.last_name).strip() or 'Ù…Ø³ØªØ®Ø¯Ù…' }}</div>
      </div>
      <div class="col-md-6">
        <div class="text-muted small">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</div>
        <div class="fw-bold">{{ profile_user.city or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
      </div>
      <div class="col-md-6">
        <div class="text-muted small">Ø§Ù„Ø­Ø§Ù„Ø©</div>
        <div class="fw-bold">
          {% if profile_user.status == 'approved' %}Ù…ÙˆØ«Ù‘Ù‚{% else %}ØºÙŠØ± Ù…ÙˆØ«Ù‘Ù‚{% endif %}
        </div>
      </div>
      <div class="col-md-6">
        <div class="text-muted small">Ø§Ù†Ø¶Ù…</div>
        <div class="fw-bold">
          {{ profile_user.created_at.strftime('%Y-%m-%d %H:%M') if profile_user.created_at.__class__.__name__ == 'datetime' else (profile_user.created_at or 'ØºÙŠØ± Ù…ØªÙˆÙØ±') }}
        </div>
      </div>
      <div class="col-12">
        <div class="text-muted small">Ù†Ø¨Ø°Ø©</div>
        <div class="fw-bold">{{ profile_user.bio or 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©.' }}</div>
      </div>
    </div>
  </div>
</section>

<script>
  // ØªØ¨ÙˆÙŠØ¨
  const tabs = document.querySelectorAll('.tab-btn');
  const panels = document.querySelectorAll('.tab-panel');
  tabs.forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.tab;
      tabs.forEach(b => b.classList.toggle('is-active', b === btn));
      panels.forEach(p => p.classList.toggle('is-active', p.id === id));
      // ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
      if (window.matchMedia('(max-width: 576px)').matches) window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
</script>

{% endblock %}
