{% extends "base.html" %}
{% block content %}

<style>
/* لجعل 3.0/5 تظهر بخط مستقيم في صفحات RTL */
.num-ltr{
  direction:ltr;              /* إجبار الاتجاه إلى اليسار */
  unicode-bidi:isolate;       /* عزل اتجاه النص */
  white-space:nowrap;         /* منع التفاف السطر */
  font-variant-numeric:tabular-nums; /* أرقام متراصة إن دعم الخط */
}
</style>

{# ====== Helper: يبني مسار صورة صالح سواء كان http(s) أو مسار محلي ====== #}
{% macro build_src(p) -%}
  {%- set s = (p or '') -%}
  {%- if s.startswith('http://') or s.startswith('https://') -%}
    {{- s -}}
  {%- else -%}
    {{- '/' ~ s.lstrip('/') if s else '/static/placeholder.png' -}}
  {%- endif -%}
{%- endmacro %}

<section class="card p-3 p-md-4 mb-3">
  <div class="d-flex align-items-start align-items-md-center gap-3 flex-column flex-md-row">

    <div class="flex-shrink-0">
      {% if profile_user.avatar_path %}
        <img src="{{ build_src(profile_user.avatar_path) }}"
             alt="avatar"
             class="rounded-circle"
             style="width:86px;height:86px;object-fit:cover;border:1px solid var(--border)">
      {% else %}
        <div class="rounded-circle d-grid place-items-center"
             style="width:86px;height:86px;background:rgba(255,255,255,.06);border:1px solid var(--border);">
          <span class="fw-bold fs-2">{{ (profile_user.first_name or 'U')[:1] }}</span>
        </div>
      {% endif %}
    </div>

    <div class="flex-grow-1 w-100">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <h2 class="m-0 fw-bold">
          {{ profile_user.first_name }} {{ profile_user.last_name }}
        </h2>

        {% if is_verified %}
          <span class="d-inline-flex align-items-center gap-1 px-2 py-1 rounded-3"
                style="border:1px solid var(--border);background:rgba(124,92,255,.15);">
            <i class="bi bi-patch-check-fill" style="color:#72d3ff"></i>
            <span class="small">موثّق</span>
          </span>
        {% endif %}

        {% if is_new %}
          <span class="badge rounded-pill bg-warning text-dark">جديد</span>
        {% endif %}
      </div>

      <div class="text-muted small mt-2 d-flex flex-wrap gap-3">
        {% if created_at_str %}<span><i class="bi bi-calendar-check"></i> انضمّ: {{ created_at_str }}</span>{% endif %}
        <span><i class="bi bi-box"></i> عناصر معروضة: {{ stats.items_count or 0 }}</span>
        {# legacy rating fields إن وجدت #}
        {% if rating_count and rating_value %}
          <span>
            <i class="bi bi-star-fill"></i>
            <a class="link-underline link-underline-opacity-0" href="/users/{{ profile_user.id }}?tab=reviews" title="عرض المراجعات">
              <span class="num-ltr" dir="ltr">&lrm;{{ '%.1f'|format(rating_value) }}/5</span> ({{ rating_count }})
            </a>
          </span>
        {% endif %}
      </div>

      {% if profile_user.bio %}
        <p class="mt-2 mb-0 text-muted">{{ profile_user.bio }}</p>
      {% endif %}
    </div>

    <div class="d-flex gap-2 ms-md-auto">
      {% if session_user and session_user.id != profile_user.id %}
        <a href="/messages/new?to={{ profile_user.id }}" class="btn btn-primary">
          <i class="bi bi-chat-text"></i> مراسلة
        </a>
      {% endif %}
      <a class="btn btn-ghost" href="/items?owner={{ profile_user.id }}"><i class="bi bi-grid"></i> كل عناصره</a>
    </div>

  </div>
</section>

<div class="col-6 col-md-3">
  <div class="card p-3 h-100 position-relative">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <div class="text-muted small">تقييم كمستأجر</div>
        <div class="fs-4 fw-bold">
          {% if renter_reviews_count and renter_reviews_count > 0 %}
            <span class="num-ltr" dir="ltr">&lrm;{{ '%.1f'|format(renter_reviews_avg|float) }}/5</span>
          {% else %}—{% endif %}
        </div>
      </div>
      <i class="bi bi-star-fill fs-3 opacity-75"></i>
    </div>
    <div class="small text-muted mt-1">
      {% if renter_reviews_count and renter_reviews_count > 0 %}
        {{ renter_reviews_count }} مراجعة
      {% else %}
        لا توجد مراجعات
      {% endif %}
    </div>
    <a href="/users/{{ profile_user.id }}?tab=reviews" class="stretched-link" aria-label="المراجعات"></a>
  </div>
</div>


  <div class="col-6 col-md-3">
    <div class="card p-3 h-100 position-relative">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">تقييم (قديم)</div>
          <div class="fs-4 fw-bold">
            {% if rating_count and rating_value %}
              <span class="num-ltr" dir="ltr">&lrm;{{ '%.1f'|format(rating_value) }}/5</span>
            {% else %}—{% endif %}
          </div>
        </div>
        <i class="bi bi-star fs-3 opacity-75"></i>
      </div>
      <div class="small text-muted mt-1">
        {% if rating_count %}{{ rating_count }} مراجعة{% else %}لا توجد مراجعات{% endif %}
      </div>
      <a href="/users/{{ profile_user.id }}?tab=reviews" class="stretched-link" aria-label="المراجعات"></a>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card p-3 h-100">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">الحالة</div>
          <div class="fs-6 fw-bold">
            {% if is_verified %}<span class="text-success">موثّق</span>{% else %}<span class="text-muted">عادي</span>{% endif %}
          </div>
        </div>
        <i class="bi bi-shield-check fs-3 opacity-75"></i>
      </div>
    </div>
  </div>

  <div class="col-6 col-md-3">
    <div class="card p-3 h-100">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted small">عضو منذ</div>
          <div class="fs-6 fw-bold">{{ created_at_str or '—' }}</div>
        </div>
        <i class="bi bi-calendar3 fs-3 opacity-75"></i>
      </div>
    </div>
  </div>
</section>

<ul class="nav nav-pills mb-3" id="userTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-items" data-bs-toggle="tab" data-bs-target="#pane-items" type="button" role="tab">العناصر المعروضة</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-about" data-bs-toggle="tab" data-bs-target="#pane-about" type="button" role="tab">حول المستخدم</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-reviews" data-bs-toggle="tab" data-bs-target="#pane-reviews" type="button" role="tab">المراجعات</button>
  </li>
</ul>

<div class="tab-content" id="userTabsContent">
  {# ========= تبويب العناصر ========= #}
  <div class="tab-pane fade show active" id="pane-items" role="tabpanel" aria-labelledby="tab-items">
    {% if items and items|length > 0 %}
      <div class="row g-3">
        {% for it in items %}
          <div class="col-6 col-md-4 col-lg-3">
            <article class="card h-100">
              <div class="position-relative" style="aspect-ratio:16/10;overflow:hidden;border-bottom:1px solid var(--border);background:rgba(255,255,255,.04);">
                {% if it.image_path %}
                  <img src="{{ build_src(it.image_path) }}" alt="" style="width:100%;height:100%;object-fit:cover;display:block;">
                {% else %}
                  <div class="d-grid place-items-center text-muted" style="width:100%;height:100%;">لا صورة</div>
                {% endif %}
                <div class="position-absolute top-0 start-0 m-2 px-2 py-1 rounded-pill text-white"
                     style="background:rgba(0,0,0,.55);backdrop-filter:blur(6px);border:1px solid var(--border);font-weight:700;">
                  {{ it.price_per_day }} د/يوم
                </div>
                {% if it.category_label %}
                  <div class="position-absolute top-0 end-0 m-2 px-2 py-1 rounded-pill small"
                       style="background:rgba(124,92,255,.18);border:1px solid rgba(124,92,255,.35);color:#cfe2ff;">
                    {{ it.category_label }}
                  </div>
                {% endif %}
              </div>
              <div class="card-body d-flex flex-column">
                <h6 class="mb-1 text-truncate" title="{{ it.title }}">{{ it.title }}</h6>
                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <a href="/items/{{ it.id }}" class="btn btn-sm btn-primary">تفاصيل</a>
                  <span class="small text-muted">{% if it.created_at %}{{ it.created_at.strftime("%Y-%m-%d") }}{% endif %}</span>
                </div>
              </div>
            </article>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="card p-3 text-center text-muted">لا توجد عناصر معروضة لهذا المستخدم حالياً.</div>
    {% endif %}
  </div>

  {# ========= تبويب حول المستخدم ========= #}
  <div class="tab-pane fade" id="pane-about" role="tabpanel" aria-labelledby="tab-about">
    <div class="card p-3">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="mb-2"><strong>الاسم الكامل</strong></div>
          <div class="text-muted">{{ profile_user.first_name }} {{ profile_user.last_name }}</div>
        </div>
        <div class="col-md-6">
          <div class="mb-2"><strong>الحالة</strong></div>
          <div>
            {% if is_verified %}<span class="badge bg-success">موثّق</span>{% else %}<span class="badge bg-secondary">عادي</span>{% endif %}
            {% if is_new %}<span class="badge bg-warning text-dark ms-1">جديد</span>{% endif %}
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-2"><strong>عضو منذ</strong></div>
          <div class="text-muted">{{ created_at_str or '—' }}</div>
        </div>
      </div>
    </div>
  </div>

  {# ========= تبويب المراجعات ========= #}
  <div class="tab-pane fade" id="pane-reviews" role="tabpanel" aria-labelledby="tab-reviews">
    <div class="card p-3">

      <div class="d-flex align-items-center gap-2 mb-2">
        <h5 class="m-0">تقييمه كمستأجر</h5>
        <span class="badge bg-light text-dark">
          ⭐ <span class="num-ltr" dir="ltr">&lrm;{{ renter_reviews_avg }}/5</span> — {{ renter_reviews_count }} مراجعة
        </span>
      </div>

      {% if renter_reviews_count > 0 %}
        <div class="d-flex flex-column gap-2">
          {% for r in renter_reviews %}
            <div class="border rounded p-2">
              <div class="d-flex align-items-center justify-content-between">
                <div class="small text-muted">من مالك #{{ r.owner_id }}</div>
                <div title="{{ r.stars }} / 5">
                  {% for _ in range(r.stars) %}⭐{% endfor %}
                  {% for _ in range(5 - r.stars) %}☆{% endfor %}
                </div>
              </div>
              {% if r.comment %}
                <div class="mt-1">{{ r.comment }}</div>
              {% endif %}
              <div class="small text-muted mt-1">{{ r.created_at.strftime("%Y-%m-%d") if r.created_at else "" }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">لا توجد مراجعات بعد.</div>
      {% endif %}

      {% if rating_count and rating_value %}
        <hr>
        <div class="d-flex align-items-center gap-3">
          <div class="display-6 fw-bold">
            <span class="num-ltr" dir="ltr">&lrm;{{ '%.1f'|format(rating_value) }}/5</span>
          </div>
          <div class="text-muted">(نظام التقييم القديم) — {{ rating_count }} مراجعة</div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="py-2"></div>

<script>
(function(){
  try{
    var p = new URLSearchParams(location.search);
    var want = p.get('tab') || (location.hash || '').replace('#','');
    if(want === 'reviews'){
      var btn = document.getElementById('tab-reviews');
      if(btn){ btn.click(); }
    }
  }catch(e){}
})();
</script>

{% endblock %}
