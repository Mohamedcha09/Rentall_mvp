{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <h3 class="mb-3">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h3>

  <div class="row g-3">
    <!-- ØºÙŠØ± Ù…Ø¯Ø±ÙˆØ³Ø© -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header bg-warning-subtle fw-bold">ØºÙŠØ± Ù…Ø¯Ø±ÙˆØ³Ø©</div>
        <div class="list-group list-group-flush" id="pendingList">
          {% for r in pending %}
            <a href="#" class="list-group-item list-group-item-action"
               data-report='{{ {
                 "id": r.id, "item_id": getattr(r,"item_id", None), "reason": r.reason,
                 "note": getattr(r,"note",""), "image_index": getattr(r,"image_index", None),
                 "reporter_id": getattr(r,"reporter_id", None),
                 "status": r.status or "pending",
                 "created_at": (r.created_at.isoformat() if getattr(r,"created_at",None) else "")
               } | tojson | safe }}'>
              ğŸš© #{{ r.id }} â€” {{ 'ØµÙˆØ±Ø© #' ~ r.image_index if r.image_index is not none else 'Ù…Ù†Ø´ÙˆØ±' }} #{{ r.item_id }}
              <div class="small text-muted">Ø§Ù„Ø³Ø¨Ø¨: {{ r.reason }}</div>
            </a>
          {% else %}
            <div class="list-group-item text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø©.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- ØªÙ…Øª Ø¯Ø±Ø§Ø³ØªÙ‡Ø§ -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header bg-success-subtle fw-bold">ØªÙ…Øª Ø¯Ø±Ø§Ø³ØªÙ‡Ø§</div>
        <div class="list-group list-group-flush" id="doneList">
          {% for r in processed %}
            <a href="#" class="list-group-item list-group-item-action"
               data-report='{{ {
                 "id": r.id, "item_id": getattr(r,"item_id", None), "reason": r.reason,
                 "note": getattr(r,"note",""), "image_index": getattr(r,"image_index", None),
                 "reporter_id": getattr(r,"reporter_id", None),
                 "status": r.status or "closed",
                 "tag": getattr(r,"tag",""),
                 "updated_at": (r.updated_at.isoformat() if getattr(r,"updated_at",None) else (r.created_at.isoformat() if getattr(r,"created_at",None) else ""))
               } | tojson | safe }}'>
              âœ… #{{ r.id }} â€” {{ 'ØµÙˆØ±Ø© #' ~ r.image_index if r.image_index is not none else 'Ù…Ù†Ø´ÙˆØ±' }} #{{ r.item_id }}
              <div class="small text-muted">
                Ø§Ù„Ø­Ø§Ù„Ø©: {{ r.status }}{% if r.tag %} â€” {{ r.tag }}{% endif %}
              </div>
              {% if r.note %}<div class="small text-muted">Ù…Ù„Ø§Ø­Ø¸Ø©: {{ r.note }}</div>{% endif %}
            </a>
          {% else %}
            <div class="list-group-item text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…Ù†ØªÙ‡ÙŠØ©.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ + Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
  <div class="card mt-3" id="details" style="display:none">
    <div class="card-header fw-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</div>
    <div class="card-body">
      <div id="dSummary" class="mb-2"></div>

      <!-- Ù‚Ø±Ø§Ø±Ø§Øª Ù„Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚ -->
      <form id="decisionForm" method="post" class="row g-2" style="display:none">
        <input type="hidden" name="note" id="noteInput">
        <div class="col-12">
          <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù‚Ø±Ø§Ø±</label>
          <textarea id="noteArea" class="form-control" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
        <div class="col-12 d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-warning" data-action="suspend_item">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
          <button type="submit" class="btn btn-danger"  data-action="remove_item">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
          <button type="submit" class="btn btn-secondary" data-action="reject_report">âŒ Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº</button>
          <a class="btn btn-outline-primary" id="viewItemBtn" target="_blank">ğŸ”— Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</a>
        </div>
      </form>

      <!-- Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ -->
      <form id="restoreForm" method="post" class="mt-2" style="display:none">
        <div class="d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-success" data-action="restore_item">â™»ï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
          <button type="submit" class="btn btn-outline-warning" data-action="reopen">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø¨Ù„Ø§Øº</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const details   = document.getElementById('details');
  const summary   = document.getElementById('dSummary');
  const decForm   = document.getElementById('decisionForm');
  const resForm   = document.getElementById('restoreForm');
  const noteArea  = document.getElementById('noteArea');
  const noteInput = document.getElementById('noteInput');
  const viewItem  = document.getElementById('viewItemBtn');

  let current = null;

  function setDecisionAction(form, action){
    // Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª: /admin/reports/{id}/decision
    form.action = '/admin/reports/' + current.id + '/decision';
    // Ø­Ù‚Ù† action
    const old = form.querySelector('input[name="action"]');
    if (old) old.remove();
    const a = document.createElement('input');
    a.type='hidden'; a.name='action'; a.value = action;
    form.appendChild(a);
  }

  function setReopenAction(form){
    // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­: /admin/reports/{id}/reopen
    form.action = '/admin/reports/' + current.id + '/reopen';
    const old = form.querySelector('input[name="action"]');
    if (old) old.remove();
  }

  function show(r){
    current = r;
    const itemLabel = (r.image_index!=null) ? ('ØµÙˆØ±Ø© #' + r.image_index) : 'Ø§Ù„Ù…Ù†Ø´ÙˆØ±';
    summary.innerHTML =
      '<div class="mb-1">Ø§Ù„Ø¨Ù„Ø§Øº #'+r.id+' â€” '+ itemLabel +' #'+(r.item_id||'-')+'</div>'+
      '<div><b>Ø§Ù„Ø³Ø¨Ø¨:</b> '+(r.reason||'')+'</div>'+
      (r.note?'<div class="text-muted small">Ù…Ù„Ø§Ø­Ø¸Ø©: '+r.note+'</div>':'');

    // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
    viewItem.href = '/items/' + (r.item_id || '');

    // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠ Ù†Ù…ÙˆØ°Ø¬ØŸ
    const st = (r.status || '').toLowerCase();
    const isPending = !st || st==='pending' || st==='open';
    decForm.style.display = isPending ? '' : 'none';
    resForm.style.display = isPending ? 'none' : '';
    details.style.display = '';
  }

  function hookList(list){
    list.querySelectorAll('a.list-group-item').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const data = JSON.parse(a.getAttribute('data-report')||'{}');
        show(data);
      });
    });
  }
  hookList(document.getElementById('pendingList'));
  hookList(document.getElementById('doneList'));

  // Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚
  decForm?.addEventListener('submit', function(e){
    e.preventDefault();
    const btn = e.submitter;
    const act = btn?.dataset?.action || '';
    noteInput.value = noteArea.value || '';
    setDecisionAction(decForm, act);
    decForm.submit();
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹/Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­
  resForm?.addEventListener('submit', function(e){
    e.preventDefault();
    const btn = e.submitter;
    const act = btn?.dataset?.action || '';
    if (act === 'reopen'){
      setReopenAction(resForm);
    }else{
      setDecisionAction(resForm, act); // restore_item
    }
    resForm.submit();
  });
})();
</script>
{% endblock %}