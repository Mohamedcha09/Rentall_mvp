{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <h3 class="mb-3">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h3>
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header bg-warning-subtle fw-bold">ØºÙŠØ± Ù…Ø¯Ø±ÙˆØ³Ø©</div>
        <div class="list-group list-group-flush" id="pendingList">
          {% for r in reports if (r.status or 'pending') == 'pending' %}
            <a href="#" class="list-group-item list-group-item-action"
               data-report='{{ {
                 "id": r.id, "item_id": getattr(r,"item_id", None), "reason": r.reason,
                 "note": getattr(r,"note",""), "image_index": getattr(r,"image_index", None),
                 "reporter_id": getattr(r,"reporter_id", None),
                 "created_at": (r.created_at.isoformat() if getattr(r,"created_at",None) else "")
               } | tojson | safe }}'>
              ğŸš© #{{ r.id }} â€” {{ 'ØµÙˆØ±Ø© #' ~ r.image_index if r.image_index is not none else 'Ù…Ù†Ø´ÙˆØ±' }} #{{ r.item_id }}
              <div class="small text-muted">Ø§Ù„Ø³Ø¨Ø¨: {{ r.reason }}</div>
            </a>
          {% else %}
            <div class="list-group-item text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø©.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-header bg-success-subtle fw-bold">ØªÙ…Øª Ø¯Ø±Ø§Ø³ØªÙ‡Ø§</div>
        <div class="list-group list-group-flush" id="doneList">
          {% for r in reports if (r.status or 'pending') != 'pending' %}
            <a href="#" class="list-group-item list-group-item-action"
               data-report='{{ {
                 "id": r.id, "item_id": getattr(r,"item_id", None), "reason": r.reason,
                 "note": getattr(r,"note",""), "image_index": getattr(r,"image_index", None),
                 "reporter_id": getattr(r,"reporter_id", None),
                 "created_at": (r.created_at.isoformat() if getattr(r,"created_at",None) else "")
               } | tojson | safe }}'>
              âœ… #{{ r.id }} â€” {{ 'ØµÙˆØ±Ø© #' ~ r.image_index if r.image_index is not none else 'Ù…Ù†Ø´ÙˆØ±' }} #{{ r.item_id }}
              <div class="small text-muted">Ø§Ù„Ù‚Ø±Ø§Ø±: {{ r.note or 'â€”' }}</div>
            </a>
          {% else %}
            <div class="list-group-item text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…Ù†ØªÙ‡ÙŠØ©.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-3" id="details" style="display:none">
    <div class="card-header fw-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</div>
    <div class="card-body">
      <div id="dSummary" class="mb-2"></div>

      <form id="decisionForm" method="post" class="row g-2" style="display:none">
        <input type="hidden" name="report_id" id="repId">
        <div class="col-12">
          <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù‚Ø±Ø§Ø±</label>
          <textarea name="note" class="form-control" rows="2"></textarea>
        </div>
        <div class="col-12 d-flex gap-2">
          <button formaction="/admin/reports/{{ 0 }}/decision" onclick="return setAct(this,'suspend_item')" class="btn btn-warning">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
          <button formaction="/admin/reports/{{ 0 }}/decision" onclick="return setAct(this,'delete_item')" class="btn btn-danger">Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
          <button formaction="/admin/reports/{{ 0 }}/decision" onclick="return setAct(this,'close_only')" class="btn btn-secondary">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº ÙÙ‚Ø·</button>
        </div>
      </form>

      <form id="restoreForm" method="post" class="mt-2" style="display:none">
        <input type="hidden" name="note" value="ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ±/ÙØªØ­ Ø§Ù„Ø¨Ù„Ø§Øº">
        <button formaction="/admin/reports/{{ 0 }}/decision" onclick="return setAct(this,'restore_item')" class="btn btn-success">Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
        <button formaction="/admin/reports/{{ 0 }}/reopen" class="btn btn-outline-primary ms-2">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø¨Ù„Ø§Øº</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function setAct(btn, act){
  const f = btn.closest('form');
  const rid = document.getElementById('repId').value;
  f.action = '/admin/reports/'+rid+'/decision';
  const a = document.createElement('input'); a.type='hidden'; a.name='action'; a.value=act;
  f.appendChild(a);
  return true;
}
(function(){
  function show(r){
    const d = document.getElementById('details');
    const s = document.getElementById('dSummary');
    const decision = document.getElementById('decisionForm');
    const restore  = document.getElementById('restoreForm');
    document.getElementById('repId').value = r.id;
    s.innerHTML =
      '<div class="mb-1">Ø§Ù„Ø¨Ù„Ø§Øº #'+r.id+' â€” '+(r.image_index!=null?'ØµÙˆØ±Ø© #'+r.image_index:'Ø§Ù„Ù…Ù†Ø´ÙˆØ±')+' #'+(r.item_id||'-')+'</div>'+
      '<div><b>Ø§Ù„Ø³Ø¨Ø¨:</b> '+(r.reason||'')+'</div>'+
      (r.note?'<div class="text-muted small">Ù…Ù„Ø§Ø­Ø¸Ø©: '+r.note+'</div>':'');
    const isPending = !r.status || r.status==='pending';
    decision.style.display = isPending ? '' : 'none';
    restore.style.display  = isPending ? 'none' : '';
    d.style.display = '';
  }
  document.querySelectorAll('#pendingList a, #doneList a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const data = JSON.parse(a.getAttribute('data-report')||'{}');
      data.status = a.closest('#pendingList') ? 'pending' : 'closed';
      show(data);
    });
  });
})();
</script>
{% endblock %}