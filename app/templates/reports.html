{% extends "base.html" %}
{% block content %}
<div class="container py-3">
  <h3 class="mb-3">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h3>
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header fw-bold">ØºÙŠØ± Ù…Ø¯Ø±ÙˆØ³Ø©</div>
        <div class="list-group list-group-flush" id="list-pending">
          {% for r in pending %}
            <a href="#" class="list-group-item list-group-item-action" data-id="{{ r.id }}" data-status="{{ r.status }}" data-item="{{ r.item_id }}" data-reason="{{ r.reason|e }}" data-reporter="{{ r.reporter.full_name if r.reporter else ('User#' ~ r.reporter_id) }}" data-reporter-id="{{ r.reporter_id }}" data-note="{{ r.note or '' }}">
              ğŸš© #{{ r.id }} â€” Ø¹Ù†ØµØ± #{{ r.item_id }} â€” {{ r.created_at.strftime("%Y-%m-%d %H:%M") }}
              <div class="small text-muted mt-1">{{ r.reason }}</div>
            </a>
          {% else %}
            <div class="p-3 text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-header fw-bold">ØªÙ…Øª Ø¯Ø±Ø§Ø³ØªÙ‡Ø§</div>
        <div class="list-group list-group-flush" id="list-processed">
          {% for r in processed %}
            <a href="#" class="list-group-item list-group-item-action" data-id="{{ r.id }}" data-status="{{ r.status }}" data-item="{{ r.item_id }}" data-reason="{{ r.reason|e }}" data-reporter="{{ r.reporter.full_name if r.reporter else ('User#' ~ r.reporter_id) }}" data-reporter-id="{{ r.reporter_id }}" data-note="{{ r.note or '' }}">
              âœ… #{{ r.id }} â€” Ø¹Ù†ØµØ± #{{ r.item_id }} â€” {{ r.updated_at.strftime("%Y-%m-%d %H:%M") if r.updated_at else '' }}
              <div class="small text-muted mt-1">{{ r.reason }}</div>
            </a>
          {% else %}
            <div class="p-3 text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Ù„ÙˆØ­Ø© ØªÙØ§ØµÙŠÙ„ -->
  <div class="offcanvas offcanvas-start show d-none" tabindex="-1" id="reportDrawer" style="visibility:visible;">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</h5>
      <button class="btn-close" id="drawerClose"></button>
    </div>
    <div class="offcanvas-body" id="drawerBody">
      <div class="text-muted">Ø§Ø®ØªØ± Ø¨Ù„Ø§ØºÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</div>
    </div>
  </div>
</div>

<script>
(function(){
  const body = document.getElementById('drawerBody');
  const drawer = document.getElementById('reportDrawer');
  const closeBtn = document.getElementById('drawerClose');

  function openDrawer(){ drawer.classList.remove('d-none'); }
  function closeDrawer(){ drawer.classList.add('d-none'); }

  closeBtn.addEventListener('click', closeDrawer);

  function renderPendingView(data){
    body.innerHTML = `
      <div class="mb-2"><b>Ø§Ù„Ø¨Ù„Ø§Øº #${data.id}</b> â€” Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± #${data.item_id}</div>
      <div class="mb-2"><b>Ø§Ù„Ù…Ø¨Ù„Ù‘Øº:</b> ${data.reporter} (ID: ${data.reporter_id})</div>
      <div class="mb-2"><b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${data.reason||''}</div>
      ${data.note ? `<div class="mb-2"><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${data.note}</div>` : ''}
      <hr>
      <form method="post" action="/admin/reports/${data.id}/action" onsubmit="return submitAction(event)">
        <input type="hidden" name="report_id" value="${data.id}">
        <div class="mb-2">
          <label class="form-label">Ù‚Ø±Ø§Ø±</label>
          <select class="form-select" name="action" required>
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="suspend_item">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ø¤Ù‚ØªÙ‹Ø§</option>
            <option value="remove_item">Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</option>
            <option value="reject_report">Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº</option>
          </select>
        </div>
        <div class="mb-2">
          <input class="form-control" name="suspend_days" type="number" min="1" step="1" placeholder="Ø£ÙŠØ§Ù… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        </div>
        <div class="mb-2">
          <textarea class="form-control" name="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
        <button class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø±</button>
      </form>
    `;
  }

  function renderProcessedView(data){
    body.innerHTML = `
      <div class="mb-2"><b>Ø§Ù„Ø¨Ù„Ø§Øº #${data.id}</b> â€” Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± #${data.item_id}</div>
      <div class="mb-2"><b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${data.reason||''}</div>
      ${data.note ? `<div class="mb-2"><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${data.note}</div>` : ''}
      <hr>
      <form method="post" action="/admin/reports/${data.id}/action" onsubmit="return submitAction(event)">
        <input type="hidden" name="report_id" value="${data.id}">
        <div class="mb-2">
          <label class="form-label">Ø¥Ø¬Ø±Ø§Ø¡</label>
          <select class="form-select" name="action" required>
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="restore_item">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± (ÙÙƒ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù)</option>
            <option value="reopen">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø¨Ù„Ø§Øº</option>
          </select>
        </div>
        <div class="mb-2">
          <textarea class="form-control" name="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
        <button class="btn btn-primary">ØªÙ†ÙÙŠØ°</button>
      </form>
    `;
  }

  // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  document.getElementById('list-pending')?.addEventListener('click', (e)=>{
    const row = e.target.closest('a[data-id]'); if(!row) return;
    e.preventDefault();
    openDrawer();
    renderPendingView({
      id: row.dataset.id,
      item_id: row.dataset.item,
      reason: row.dataset.reason,
      note: row.dataset.note,
      reporter: row.dataset.reporter,
      reporter_id: row.dataset.reporterId
    });
  });

  document.getElementById('list-processed')?.addEventListener('click', (e)=>{
    const row = e.target.closest('a[data-id]'); if(!row) return;
    e.preventDefault();
    openDrawer();
    renderProcessedView({
      id: row.dataset.id,
      item_id: row.dataset.item,
      reason: row.dataset.reason,
      note: row.dataset.note
    });
  });

  window.submitAction = async function(ev){
    ev.preventDefault();
    const f = ev.target;
    const fd = new FormData(f);
    const res = await fetch(f.action, { method:'POST', body: fd });
    if(res.ok){ location.reload(); } else { alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'); }
    return false;
  }
})();
</script>
{% endblock %}