{# Final deposit summary page â€” shown to both parties #}
{% extends "base.html" %}
{% block title %}Final Result â€” Booking #{{ bk.id }}{% endblock %}

{% block head %}
<style>
  .wrap{max-width:1100px;margin:auto}
  .card{border:1px solid var(--border,#e5e7eb);background:#fff;border-radius:14px;padding:16px}
  .k{opacity:.7}
  .chip{padding:.35rem .6rem;border:1px solid var(--border,#e5e7eb);border-radius:999px}
  .grid{display:grid;gap:12px}
  .evs{display:flex;flex-wrap:wrap;gap:8px}
  .evs img,.evs video{width:88px;height:88px;border-radius:10px;object-fit:cover;border:1px solid var(--border,#e5e7eb)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .ok{color:#198754} .bad{color:#dc3545}
</style>

<style>
/* ================================
   ğŸ“± MOBILE (max-width: 768px)
   ================================ */
@media (max-width: 768px) {

  /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
  header,
  .top-navbar,
  .site-header,
  .nav-top,
  .mobile-topbar {
      display: none !important;
      opacity: 0 !important;
      height: 0 !important;
  }

  /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
  .mobile-tabbar,
  .bottom-nav,
  .footer-nav {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
  }

  /* Ø¥Ø®ÙØ§Ø¡ banner Stripe Connect */
  .stripe-connect-banner,
  .connect-now-box,
  .alert-stripe {
      display: none !important;
  }

  /* ====== ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ®Ø·ÙŠØ· ====== */
  .wrap {
      max-width: 100%;
      padding: 14px;
  }

  .grid {
      grid-template-columns: 1fr !important;
  }

  .card {
      padding: 16px;
      border-radius: 14px;
      margin-bottom: 16px;
  }

  h4 {
      font-size: 1.25rem;
      margin-bottom: 10px;
      line-height: 1.35;
  }

  .chip {
      padding: .35rem .7rem;
      font-size: .85rem;
  }

  /* ØµÙˆØ± Ø§Ù„Ø£Ø¯Ù„Ø© */
  .evs {
      gap: 6px !important;
  }

  .evs img,
  .evs video {
      width: 76px !important;
      height: 76px !important;
      border-radius: 10px;
  }

  /* Ø¨Ø·Ø§Ù‚Ø© item */
  .card img {
      width: 90px !important;
      height: 90px !important;
  }

  /* Financial Summary on mobile */
  .card .d-flex {
      font-size: .95rem;
  }

  /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
  .btn-outline-secondary {
      width: 100%;
      text-align: center;
      padding: 10px;
      font-size: .95rem;
  }

}
</style>

<style>
@media (max-width: 768px) {

  /* ğŸ§¨ Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± */
  header,
  .site-header,
  .top-navbar,
  .nav-top,
  .main-header,
  .navbar,
  .navbar-top,
  .nav-main,
  .nav-container,
  .navtabs-container,
  .tabs-wrapper,
  .tabs,
  nav[role="navigation"],
  nav.tabs,
  nav.tabbed,
  .tabbed-nav,
  .nav-tabs,
  .flex-tabs,
  .mobile-nav,
  .page-header {
      display: none !important;
      height: 0 !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
  }

  /* ğŸ§¨ Ø£ÙŠØ¶Ø§Ù‹ stripe connect */
  .stripe-connect-banner,
  .connect-now-box,
  .alert-stripe {
      display: none !important;
  }

  /* ğŸ§¨ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
  .mobile-tabbar,
  .bottom-nav,
  .footer-nav {
      display: none !important;
      opacity: 0 !important;
      height: 0 !important;
  }

  /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ */
  body {
      padding-top: 0 !important;
      margin-top: 0 !important;
  }

}
</style>

<style>
@media (max-width: 768px) {

  /* Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ Ø¹Ù†Ø§ØµØ± ØªØ­ØªÙˆÙŠ Tabs Ù…Ø«Ù„ (Home / Notifications / Payouts) */
  .tabs,
  .tabs-container,
  .tabs-wrapper,
  .profile-tabs,
  .account-tabs,
  .user-tabs,
  .nav-tabs,
  .top-tabs,
  nav.tabs,
  .section-tabs,
  .subnav,
  .sub-nav,
  .subnavbar {
      display: none !important;
      height: 0 !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
  }

  /* Ø¥Ø®ÙØ§Ø¡ Ø£ÙŠ div ÙÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø¨Ø§Ø´Ø±Ø© */
  .wrap ~ div:first-child,
  .wrap + div,
  .wrap + section {
      display: none !important;
  }

  /* Ø¥Ø®ÙØ§Ø¡ stripe connect */
  .stripe-connect-banner,
  .connect-now-box,
  .alert-stripe {
      display: none !important;
  }

  /* Ø¥Ø®ÙØ§Ø¡ navbar Ø§Ù„Ø¹Ù„ÙˆÙŠ */
  header,
  .site-header,
  .top-navbar,
  nav[role="navigation"] {
      display: none !important;
  }

  /* Ø¥Ø®ÙØ§Ø¡ navbar Ø§Ù„Ø³ÙÙ„ÙŠ */
  .mobile-tabbar,
  .bottom-nav {
      display: none !important;
  }
}
</style>
<style>
@media (max-width: 768px) {
    .m-top-tabs {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <h4 class="mb-2">Final Result â€” Booking #{{ bk.id }}</h4>

  <div class="d-flex flex-wrap gap-2 mb-3">
    <span class="chip">Booking Status: {{ bk.status or 'â€”' }}</span>
    <span class="chip">Deposit Status: {{ bk.deposit_status or 'â€”' }}</span>
    {% if bk.dm_decision %}
      <span class="chip">DM Decision: {{ bk.dm_decision }}</span>
    {% endif %}
  </div>

  <div class="grid" style="grid-template-columns: 1fr 370px;">

    <!-- Left: Item details + evidence -->
    <div class="grid">
      <div class="card">
        <h6 class="mb-2">Item</h6>
        <div class="d-flex gap-3">
          {# Safe image #}
          {% set img = '/static/placeholder.jpg' %}
          {% if item and item.image_path %}
            {% if item.image_path.startswith('http://') or item.image_path.startswith('https://') %}
              {% set img = item.image_path %}
            {% else %}
              {% set img = '/' ~ item.image_path.lstrip('/') %}
            {% endif %}
          {% endif %}
          <img src="{{ img }}" style="width:110px;height:110px;object-fit:cover;border-radius:10px" alt="">

          <div>
            <div class="fw-bold">{{ item.title if item else 'â€”' }}</div>
            <div class="k">{{ category_label(item.category) if item and item.category else 'â€”' }}</div>
            <div class="k">Daily Price: {{ item.price_per_day if item else 0 }} CAD</div>
            <div class="k">Period: {{ bk.start_date }} â†’ {{ bk.end_date }} ({{ bk.days }} days)</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h6 class="mb-2"><i class="bi bi-exclamation-octagon me-1"></i> Owner Report</h6>
        <div class="k">Type: <b>{{ bk.owner_report_type or 'â€”' }}</b></div>
        {% if bk.owner_report_reason %}
          <div class="mt-1" style="white-space:pre-wrap">{{ bk.owner_report_reason }}</div>
        {% endif %}
        {% set owner_evs = (bk.deposit_evidences or []) | selectattr('side','equalto','owner') | list %}
        <div class="evs mt-2">
          {% if owner_evs and owner_evs|length %}
            {% for ev in owner_evs[:12] %}
              {% set _v = (ev.kind=='video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank">
                {% if _v %}<video src="{{ ev.file_path }}" muted></video>{% else %}<img src="{{ ev.file_path }}">{% endif %}
              </a>
            {% endfor %}
          {% else %}
            <div class="k">No evidence from the owner.</div>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <h6 class="mb-2"><i class="bi bi-person-bounding-box me-1"></i> Renter Evidence</h6>
        {% set renter_evs = (bk.deposit_evidences or []) | selectattr('side','equalto','renter') | list %}
        <div class="evs">
          {% if renter_evs and renter_evs|length %}
            {% for ev in renter_evs[:12] %}
              {% set _v = (ev.kind=='video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank">
                {% if _v %}<video src="{{ ev.file_path }}" muted></video>{% else %}<img src="{{ ev.file_path }}">{% endif %}
              </a>
            {% endfor %}
          {% else %}
            <div class="k">No evidence from the renter.</div>
          {% endif %}
        </div>
      </div>

      <!-- Renter evidence â€” before pickup -->
      <div class="card mt-2">
        <h6 class="mb-2">Renter Evidence â€” Before Pickup</h6>
        <div class="evs">
          {% if renter_pickup and renter_pickup|length %}
            {% for ev in renter_pickup[:12] %}
              {% set _v = (ev.kind=='video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank">
                {% if _v %}<video src="{{ ev.file_path }}" muted></video>{% else %}<img src="{{ ev.file_path }}">{% endif %}
              </a>
            {% endfor %}
          {% else %}
            <div class="k">No pre-pickup photos from the renter.</div>
          {% endif %}
        </div>
      </div>

      <!-- Renter evidence â€” after return -->
      <div class="card mt-2">
        <h6 class="mb-2">Renter Evidence â€” After Return</h6>
        <div class="evs">
          {% if renter_return and renter_return|length %}
            {% for ev in renter_return[:12] %}
              {% set _v = (ev.kind=='video') or (ev.file_path and ('.mp4' in ev.file_path or '.mov' in ev.file_path or '.m4v' in ev.file_path)) %}
              <a href="{{ ev.file_path }}" target="_blank">
                {% if _v %}<video src="{{ ev.file_path }}" muted></video>{% else %}<img src="{{ ev.file_path }}">{% endif %}
              </a>
            {% endfor %}
          {% else %}
            <div class="k">No post-return photos from the renter.</div>
          {% endif %}
        </div>
      </div>

    </div>

    <!-- Right: final financial summary -->
    {% set hold_amt = (bk.hold_deposit_amount or bk.deposit_amount or 0) %}
    {% set charged = (bk.deposit_charged_amount or (bk.dm_decision_amount if bk.dm_decision=='withhold' else 0) or 0) %}
    {% set refunded = (hold_amt - charged) if hold_amt else 0 %}
    <div class="grid">
      <div class="card">
        <h6 class="mb-2">Financial Summary â€” Deposit</h6>
        <div class="d-flex justify-content-between"><span>Held Deposit Amount</span><b>{{ hold_amt }} CAD</b></div>
        <div class="d-flex justify-content-between"><span>Final Charge</span>
          <b class="{{ charged>0 and 'bad' or '' }}">{{ charged }} CAD</b></div>
        <div class="d-flex justify-content-between"><span>Refunded to Renter</span>
          <b class="{{ refunded>0 and 'ok' or '' }}">{{ refunded }} CAD</b></div>
        {% if bk.dm_decision_note %}
          <hr>
          <div class="k"><span class="mono">Reason:</span> {{ bk.dm_decision_note }}</div>
        {% endif %}
      </div>

      <div class="card">
        <h6 class="mb-2">Rent Summary</h6>
        <div class="d-flex justify-content-between"><span>Daily Price</span><b>{{ item.price_per_day if item else 0 }} CAD</b></div>
        <div class="d-flex justify-content-between"><span>Number of Days</span><b>{{ bk.days }}</b></div>
        <div class="d-flex justify-content-between"><span>Total Rent (Approx.)</span>
          <b>{{ (item.price_per_day or 0) * (bk.days or 0) if item else 0 }} CAD</b></div>
      </div>

      <div class="card">
        <div class="k mono small">
          {% if bk.dm_decision_at %}dm_decision_at: {{ bk.dm_decision_at }}<br>{% endif %}
          {% if bk.returned_at %}returned_at: {{ bk.returned_at }}<br>{% endif %}
          {% if bk.accepted_at %}accepted_at: {{ bk.accepted_at }}<br>{% endif %}
        </div>
        <div class="mt-2">
          <a class="btn btn-outline-secondary btn-sm" href="/bookings/flow/{{ bk.id }}">Back to Booking Flow</a>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
