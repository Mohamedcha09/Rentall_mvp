{% extends "base.html" %}
{% block head %}
<style>
.case-wrap{max-width:950px;margin:auto}
.box{border:1px solid var(--border);border-radius:14px;padding:14px}
.k{opacity:.7}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
.imgs{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.imgs img{width:180px;height:120px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
.decision-form{border:1px dashed var(--border);border-radius:12px;padding:14px;margin-top:18px}
.badge-soft{border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:13px}
.alert-note{background:color-mix(in oklab,var(--surface) 90%,transparent);border-radius:10px;padding:12px;margin-top:10px}
</style>
{% endblock %}

{% block content %}
<div class="case-wrap">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Deposit Case #{{ booking.id }}</h4>
    <a href="/deposit-manager" class="btn btn-outline-light btn-sm">← Back to List</a>
  </div>

  <div class="box mb-3">
    <div class="d-flex justify-content-between">
      <div>
        <div><strong>Item:</strong> {{ item.title if item else '—' }}</div>
        <div class="k small">
          From {{ booking.start_date }} to {{ booking.end_date }} ({{ booking.days }} days)
        </div>
      </div>
      <div class="text-end">
        <div class="badge-soft mono">{{ booking.status }}</div>
        <div class="badge-soft mono">Deposit: {{ booking.deposit_status or '—' }}</div>
      </div>
    </div>
    <hr>
    <div class="small k mono">
      Owner #{{ booking.owner_id }} — Renter #{{ booking.renter_id }}<br>
      Payment Method: {{ booking.payment_method or '—' }}<br>
      Rental Amount: {{ booking.total_amount }}$<br>
      Held Deposit: {{ booking.hold_deposit_amount or booking.deposit_amount or 0 }}$
    </div>
  </div>

  {% if dispute %}
  <div class="box mb-3">
    <h6 class="mb-2">Owner Report Details</h6>
    <div><strong>Issue Type:</strong> {{ dispute.issue_type or '—' }}</div>
    <div><strong>Description:</strong> {{ dispute.description or '—' }}</div>
    {% if dispute.created_at %}
      <div class="small k mono mt-1">Report Date: {{ dispute.created_at }}</div>
    {% endif %}
    {% if dispute.evidence_paths %}
      <div class="imgs">
        {% for img in dispute.evidence_paths %}
          <img src="{{ img }}" alt="evidence">
        {% endfor %}
      </div>
    {% endif %}
  </div>
  {% endif %}

  {% if renter_reply %}
  <div class="box mb-3">
    <h6 class="mb-2">Renter Reply</h6>
    <div>{{ renter_reply.text or '—' }}</div>
    {% if renter_reply.images %}
      <div class="imgs">
        {% for img in renter_reply.images %}
          <img src="{{ img }}" alt="reply-evidence">
        {% endfor %}
      </div>
    {% endif %}
    {% if renter_reply.created_at %}
      <div class="small k mono mt-1">Reply Date: {{ renter_reply.created_at }}</div>
    {% endif %}
  </div>
  {% endif %}

  {% if decision %}
  <div class="alert alert-success">
    <strong>Decision Made:</strong> {{ decision.decision_label }}<br>
    <span class="k">{{ decision.reason or '—' }}</span><br>
    <span class="small mono">Date: {{ decision.decided_at }}</span>
  </div>
  {% else %}
  <div class="decision-form">
    <h6 class="mb-2">Final Decision</h6>
    <form method="post" action="/deposits/{{ booking.id }}/decision">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label small k">Decision Type</label>
          <select class="form-select form-select-sm" name="decision" required>
            <option value="refund_all">Full Refund</option>
            <option value="refund_partial">Partial Refund</option>
            <option value="withhold_all">Full Withhold</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small k">Partial Amount (if any)</label>
          <input class="form-control form-control-sm" type="number" name="amount" min="0" value="0">
        </div>
        <div class="col-md-5">
          <label class="form-label small k">Reason</label>
          <input class="form-control form-control-sm" type="text" name="reason" placeholder="Example: Minor scratches + 1-day delay">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-success btn-sm">
          <i class="bi bi-shield-check"></i> Apply Decision
        </button>
        <a href="/deposit-manager" class="btn btn-outline-light btn-sm ms-2">Back</a>
      </div>
    </form>
    <div class="alert-note k small mt-2">
      After executing the decision, the corresponding amount will be automatically transferred to the owner or renter, and the deposit status will be updated.
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
