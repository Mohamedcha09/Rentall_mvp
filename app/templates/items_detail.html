{% extends "base.html" %}
{% from "_badges.html" import render_badges %}
{% block content %}

<style>
/* ===============  Glass & Modern UI  =============== */
:root{
  --bg-1:#0b1220;
  --bg-2:#0f172a;
  --card:#0f172acc;
  --stroke:rgba(255,255,255,.12);
  --stroke-soft:rgba(255,255,255,.08);
  --txt:#eaf0ff;
  --muted:#9fb0d8;
  --brand:#3b82f6;
  --brand-2:#22d3ee;
  --ok:#10b981;
  --warn:#f59e0b;
  --glass:rgba(255,255,255,.06);
  --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
}

.items-shell{
  max-width:1100px;margin:18px auto;padding:0 12px;
}

.grid-2{
  display:grid;gap:18px;
  grid-template-columns:1.2fr .8fr;
}
@media (max-width: 920px){
  .grid-2{ grid-template-columns:1fr; }
}

.card-glass{
  background:linear-gradient(180deg, var(--glass), transparent);
  border:1px solid var(--stroke);
  border-radius:16px; overflow:hidden; backdrop-filter: blur(8px);
  box-shadow: var(--shadow);
}

.card-body{ padding:18px; }
.card-title{ margin:0 0 8px 0; font-weight:800; letter-spacing:.2px; }
.small-muted{ color:var(--muted); font-size:13px; }
.badge-pill{
  display:inline-block; padding:6px 10px; border-radius:999px;
  border:1px solid var(--stroke); background:rgba(255,255,255,.05);
  font-size:12px; color:var(--muted);
}

/* ===============  Gallery  =============== */
.gallery{
  background: #0c1324; border-bottom:1px solid var(--stroke-soft);
}
.gallery-main{
  position:relative; aspect-ratio: 16/10; width:100%;
  background: #0a0f1e;
}
.gallery-main img{
  width:100%; height:100%; object-fit:cover; display:block;
}
.gallery-zoom{
  position:absolute; bottom:10px; right:10px;
  background:rgba(0,0,0,.45);
  border:1px solid var(--stroke); border-radius:12px;
  padding:8px 12px; font-size:13px; color:#fff; cursor:pointer;
  backdrop-filter: blur(6px);
}
/* Ø²Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â‹® Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© */
.gallery-menu{
  position:absolute; top:10px; right:10px;
}
.gallery-menu .btn-menu{
  background:rgba(0,0,0,.45); color:#fff; border:1px solid var(--stroke);
  border-radius:12px; padding:6px 10px; line-height:1; font-weight:700;
}
.gallery-menu .dropdown-menu{
  border-radius:12px; overflow:hidden; border:1px solid var(--stroke);
}

.thumbs{
  display:flex; gap:10px; padding:12px; overflow-x:auto;
  background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
}
.thumbs img{
  width:86px; height:60px; object-fit:cover; border-radius:10px;
  border:1px solid var(--stroke-soft); cursor:pointer; opacity:.85;
  transition:transform .15s ease, opacity .15s ease, box-shadow .15s ease;
}
.thumbs img:hover{ transform:translateY(-2px); opacity:1; box-shadow:0 4px 14px rgba(0,0,0,.25); }
.thumbs img.active{ outline:2px solid var(--brand); opacity:1; }

/* ===============  Buttons  =============== */
.btnx{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 16px; border-radius:12px; font-weight:700;
  text-decoration:none; cursor:pointer; user-select:none;
  border:1px solid var(--stroke); backdrop-filter: blur(8px);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  color:var(--txt); transition: transform .12s ease, background .2s ease, border-color .2s ease;
}
.btnx:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.2); }
.btnx-primary{
  border-color: rgba(59,130,246,.6);
  background: linear-gradient(180deg, rgba(59,130,246,.35), rgba(59,130,246,.1));
}
.btnx-green{
  border-color: rgba(16,185,129,.6);
  background: linear-gradient(180deg, rgba(16,185,129,.35), rgba(16,185,129,.1));
}
.btnx-ghost{
  border-color: var(--stroke);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
.btns-row{ display:flex; flex-wrap:wrap; gap:10px; }

/* ===============  Lightbox  =============== */
.lightbox{
  position:fixed; inset:0; display:none; place-items:center; z-index:9999;
  background:rgba(0,0,0,.8);
}
.lightbox.show{ display:grid; }
.lightbox img{ max-width:92vw; max-height:88vh; border-radius:14px; border:1px solid var(--stroke); }
.lightbox .close{
  position:absolute; top:18px; right:18px;
  background:rgba(0,0,0,.6); border:1px solid var(--stroke);
  color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
}

/* ===============  Owner card  =============== */
.owner-row{ display:flex; align-items:center; gap:12px; }
.owner-avatar{
  width:62px;height:62px;border-radius:50%;object-fit:cover;
  box-shadow:0 0 0 2px var(--stroke);
}

.hr{ border:0; height:1px; background:var(--stroke-soft); margin:14px 0; }
</style>

<section class="items-shell">
  {% if not item %}
    <div class="card-glass">
      <div class="card-body"><div class="alert alert-danger">Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</div></div>
    </div>
  {% else %}

  <div class="grid-2">

    <!-- =================== Ø¨Ø·Ø§Ù‚Ø©/Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ØµØ± =================== -->
    <div class="card-glass">
      <div class="gallery">

        {# Ù…ØµØ§Ø¯Ø± Ø§Ù„ØµÙˆØ±: Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ù…ØªØ¹Ø¯Ø¯Ø© Ù…ÙØµÙˆÙ„Ø© , Ø£Ùˆ | #}
        {% set _srcs = [] %}
        {% if item.image_path %}
          {% set _raw = item.image_path %}
          {% if ',' in _raw %}
            {% set _srcs = _raw.split(',') %}
          {% elif '|' in _raw %}
            {% set _srcs = _raw.split('|') %}
          {% else %}
            {% set _srcs = [_raw] %}
          {% endif %}
        {% endif %}

        {% set current = _srcs[0] if _srcs else None %}

        {# Ø¯Ø§Ù„Ø© build_src #}
        {% macro build_src(p) -%}
          {%- set s = (p or '') -%}
          {%- if not (s.startswith('http') or s.startswith('/')) -%}
            {%- set s = '/' + s -%}
          {%- endif -%}
          {{- s -}}
        {%- endmacro %}

        <div class="gallery-main" id="gMain">
          {% if current %}
            <img id="mainImg" src="{{ build_src(current) }}" alt="item image">
            <button class="gallery-zoom" id="zoomBtn">ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
          {% else %}
            <div style="display:grid;place-items:center;height:100%;color:var(--muted);font-size:13px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
          {% endif %}

          <!-- Ø²Ø± â‹® -->
          <div class="gallery-menu dropdown">
            <button class="btn-menu" data-bs-toggle="dropdown" aria-expanded="false" title="Ø®ÙŠØ§Ø±Ø§Øª">â‹®</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <button class="dropdown-item" id="openReportBtn" type="button">ğŸš© Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>
              </li>
            </ul>
          </div>
        </div>

        {% if _srcs|length > 1 %}
          <div class="thumbs" id="thumbs">
            {% for s in _srcs %}
              {% set src = build_src(s.strip()) %}
              <img data-src="{{ src }}" data-index="{{ loop.index0 }}" class="{% if loop.index0==0 %}active{% endif %}" src="{{ src }}" alt="thumb {{ loop.index }}">
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="card-body">
        <h2 class="card-title">{{ item.title }}</h2>
        <div class="small-muted" style="margin-bottom:8px">
          {{ item.category_label }} â€¢ {{ item.city or "Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠÙ†Ø©" }}
        </div>
        <div style="font-size:22px; font-weight:800; margin:6px 0 12px 0">
          {{ item.price_per_day }} <span style="font-size:14px;color:var(--muted)">Ø¯/ÙŠÙˆÙ…</span>
        </div>

        {% if item.description %}
          <p style="white-space:pre-wrap;line-height:1.9;color:#cdd7ee">{{ item.description }}</p>
        {% else %}
          <div class="badge-pill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ</div>
        {% endif %}

        <div class="hr"></div>

        <div class="btns-row">
          {% if owner %}
            <a class="btnx btnx-primary" href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">
              ğŸ’¬ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ
            </a>
            {% if session_user and session_user.status == 'approved' and session_user.id != owner.id %}
              <a class="btnx btnx-green" href="/bookings/new?item_id={{ item.id }}">âœ… Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†</a>
            {% elif not session_user %}
              <a class="btnx btnx-primary" href="/login">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø¬Ø²</a>
            {% else %}
              <span class="badge-pill" title="ÙŠÙ„Ø²Ù… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ø­Ø¬Ø²">Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙÙØ¹Ù„ Ù„Ù„Ø­Ø¬Ø²</span>
            {% endif %}
          {% endif %}
          <a class="btnx btnx-ghost" href="/items">â†©ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</a>
        </div>
      </div>
    </div>

    <!-- =================== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ =================== -->
    <div class="card-glass">
      <div class="card-body">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
          <h5 style="margin:0">Ø§Ù„Ù…Ø§Ù„Ùƒ</h5>
          <span class="badge-pill">Stripe Connect â€¢ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span>
        </div>

        {% if owner %}
          <div class="owner-row">
            <img class="owner-avatar"
                 src="{{ owner.avatar_path or url_for('static', path='placeholder.png') }}"
                 alt="owner">
            <div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <strong>{{ owner.first_name }} {{ owner.last_name }}</strong>
                {{ render_badges(owner_badges, 22) }}
              </div>
              <div class="small-muted">
                Ø¹Ø¶Ùˆ Ù…Ù†Ø° {{ owner.created_at.strftime("%Y-%m-%d") if owner.created_at else "" }}
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="btns-row">
            <a href="/users/{{ owner.id }}" class="btnx btnx-ghost">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¹Ø§Ù…</a>

            <a class="btnx btnx-primary" href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">Ø±Ø§Ø³Ù„ Ø§Ù„Ù…Ø§Ù„Ùƒ</a>
          </div>
        {% else %}
          <div class="small-muted">Ù„Ø§ ØªØªÙˆÙØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ.</div>
        {% endif %}
      </div>
    </div>

  </div>
  {% endif %}
</section>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportLabel" aria-hidden="true" dir="rtl">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="/reports" id="reportForm">
        <div class="modal-header">
          <h5 class="modal-title" id="reportLabel">ğŸš© Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ù…Ù†Ø´ÙˆØ±</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="item_id" value="{{ item.id }}">
          <input type="hidden" name="image_index" id="rf_image_index" value="0">
          <input type="hidden" name="image_url" id="rf_image_url" value="">

          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø³Ø¨Ø¨</label>
            <select class="form-select" name="reason" required>
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ù„Ø§Øº</option>
              <option value="nudity">Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù„Ø§Ø¦Ù‚/Ø¹ÙØ±ÙŠ</option>
              <option value="violence">Ø¹Ù†Ù/ÙƒØ±Ø§Ù‡ÙŠØ©</option>
              <option value="scam">Ø§Ø­ØªÙŠØ§Ù„/Ø®Ø¯Ø§Ø¹</option>
              <option value="copyright">Ø­Ù‚ÙˆÙ‚ Ù…Ù„ÙƒÙŠØ©</option>
              <option value="spam">Ø³Ø¨Ø§Ù…/Ù…Ø²Ø¹Ø¬</option>
              <option value="other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea class="form-control" name="note" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ ØªØ³Ø§Ø¹Ø¯Ù†Ø§ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©â€¦"></textarea>
          </div>

          <div class="small text-muted">
            Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ±Ø§Ø¨Ø·Ù‡Ø§ Ù„ÙŠØªÙˆÙ„Ù‰ ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ­Ù‚Ù‚.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="btn btn-danger">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="hr"></div>

<!-- === ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ù„Ù„Ù…Ù†Ø´ÙˆØ± === -->
<div>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h5 style="margin:0">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h5>
    <span class="badge-pill">
      â­ {{ item_rating_avg or 0 }}/5 â€” {{ item_rating_count or 0 }} Ù…Ø±Ø§Ø¬Ø¹Ø©
    </span>
  </div>

  {% if item_reviews and item_reviews|length %}
    <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px">
      {% for r in item_reviews %}
        <div class="card-glass" style="padding:12px">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            {% set avatar = (r.rater.avatar_path if r.rater and r.rater.avatar_path else url_for('static', path='placeholder.png')) %}
            <img src="{{ avatar }}"
                 alt="avatar" style="width:42px;height:42px;border-radius:50%;object-fit:cover;border:1px solid var(--stroke-soft)">
            <div>
              <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                <strong>{{ (r.rater.first_name ~ ' ' ~ r.rater.last_name) if r.rater else 'Ù…Ø³ØªØ£Ø¬Ø±' }}</strong>
                <span class="small-muted">â€¢ {{ r.created_at.strftime("%Y-%m-%d") if r.created_at else "" }}</span>
              </div>
              <div title="{{ r.stars }} / 5">
                {% for _ in range(r.stars) %}â­{% endfor %}
                {% for _ in range(5 - r.stars) %}â˜†{% endfor %}
              </div>
            </div>
          </div>

          {% if r.comment %}
            <div style="margin-top:6px;white-space:pre-wrap">{{ r.comment }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="small-muted" style="margin-top:6px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø¨Ø¹Ø¯.</div>
  {% endif %}
</div>

<!-- ===============  Lightbox & Gallery JS (Ø®ÙÙŠÙ)  =============== -->
<script>
(function(){
  const main = document.getElementById('mainImg');
  const thumbs = document.getElementById('thumbs');
  const zoomBtn = document.getElementById('zoomBtn');

  // Lightbox
  let lb = null;
  function openLightbox(src){
    if(!lb){
      lb = document.createElement('div');
      lb.className = 'lightbox';
      lb.innerHTML = '<button class="close">Ø¥ØºÙ„Ø§Ù‚ âœ•</button><img alt="preview">';
      document.body.appendChild(lb);
      lb.querySelector('.close').onclick = () => lb.classList.remove('show');
      lb.onclick = (e)=>{ if(e.target===lb) lb.classList.remove('show'); };
    }
    lb.querySelector('img').src = src;
    lb.classList.add('show');
  }

  if(zoomBtn && main){
    zoomBtn.addEventListener('click', ()=> openLightbox(main.src));
  }

  // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØºÙ‘Ø±Ø§Øª
  if(thumbs && main){
    thumbs.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.tagName==='IMG'){
        main.src = t.dataset.src || t.src;
        [...thumbs.querySelectorAll('img')].forEach(i=>i.classList.remove('active'));
        t.classList.add('active');

        // ØªØ­Ø¯ÙŠØ« Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        try{
          const idx = parseInt(t.getAttribute('data-index') || '0', 10) || 0;
          document.getElementById('rf_image_index')?.setAttribute('value', String(idx));
          document.getElementById('rf_image_url')?.setAttribute('value', t.dataset.src || t.src || '');
        }catch(_){}
      }
    });

    // Ø³Ø­Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
    let sx=0, dx=0;
    thumbs.addEventListener('touchstart', e=>{ sx=e.touches[0].clientX; }, {passive:true});
    thumbs.addEventListener('touchmove', e=>{ dx=e.touches[0].clientX - sx; }, {passive:true});
    thumbs.addEventListener('touchend', ()=>{
      thumbs.scrollBy({left: -dx, behavior:'smooth'});
      sx=dx=0;
    });
  }

  // Ø£Ø³Ù‡Ù… Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±
  function step(dir){
    if(!thumbs) return;
    const imgs = [...thumbs.querySelectorAll('img')];
    if(imgs.length<=1) return;
    let i = imgs.findIndex(n=>n.classList.contains('active'));
    if(i<0) i = 0;
    let j = (i + dir + imgs.length) % imgs.length;
    imgs[j].click();
    imgs[j].scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  }
  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') step(+1);
    if(e.key==='ArrowLeft') step(-1);
  });

  // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
  const openReportBtn = document.getElementById('openReportBtn');
  if(openReportBtn){
    openReportBtn.addEventListener('click', function(){
      const activeThumb = document.querySelector('#thumbs img.active') || document.querySelector('#thumbs img');
      const idx = activeThumb ? parseInt(activeThumb.getAttribute('data-index') || '0', 10) || 0 : 0;
      const url = activeThumb ? (activeThumb.dataset.src || activeThumb.src || (main?.src||'')) : (main?.src||'');

      const idxEl = document.getElementById('rf_image_index');
      const urlEl = document.getElementById('rf_image_url');
      if(idxEl) idxEl.setAttribute('value', String(idx));
      if(urlEl) urlEl.setAttribute('value', url);

      const m = new bootstrap.Modal(document.getElementById('reportModal'));
      m.show();
    });
  }
})();
</script>

{% endblock %}
