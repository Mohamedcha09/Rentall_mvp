{% extends "base.html" %}
{% from "_badges.html" import render_badges %}
{% block content %}

{% if not item %}
  <div class="alert alert-danger">العنصر غير موجود.</div>
{% else %}
<section class="container" style="max-width:1100px;margin:auto">
  <div class="row" style="display:grid;grid-template-columns:1.2fr .8fr;gap:18px">

    <!-- بطاقة العنصر -->
    <div>
      <div class="card" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden">
        {% if item.image_path %}
          <img src="/{{ item.image_path }}" alt="item"
               style="width:100%;max-height:460px;object-fit:cover">
        {% endif %}
        <div class="card-body">
          <h2 class="card-title" style="margin-bottom:6px">{{ item.title }}</h2>
          <div class="text-muted small" style="margin-bottom:10px">
            {{ item.category_label }} • {{ item.city or "بدون مدينة" }}
          </div>
          <div class="h5" style="margin-bottom:12px">{{ item.price_per_day }} د/يوم</div>
          <p style="white-space:pre-wrap">{{ item.description or "" }}</p>
        </div>
      </div>
    </div>

    <!-- بطاقة المالك والإجراءات -->
    <div>
      <div class="card" style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:14px">
        <div class="card-body">
          <h5 class="mb-3">المالك</h5>

          {% if owner %}
            <div class="d-flex align-items-center gap-3" style="margin-bottom:8px">
              <img src="{{ owner.avatar_path or url_for('static', path='placeholder.png') }}"
                   alt="owner"
                   style="width:56px;height:56px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 2px rgba(255,255,255,.12)">
              <div>
                <div style="display:flex;align-items:center;gap:8px">
                  <strong>{{ owner.first_name }} {{ owner.last_name }}</strong>
                  {{ render_badges(owner_badges, 22) }}
                </div>
                <div class="text-muted small">
                  عضو منذ {{ owner.created_at.strftime("%Y-%m-%d") if owner.created_at else "" }}
                </div>
              </div>
            </div>

            <div class="d-flex gap-2 mb-2">
              <a href="/u/{{ owner.id }}" class="btn btn-sm btn-outline-light">الملف العام</a>
              {% if session_user and session_user.id != owner.id %}
                <a class="btn btn-sm btn-primary"
                   href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">
                   تواصل مع المالك
                </a>
                {% if session_user.status == 'approved' %}
                  <a class="btn btn-sm btn-success" href="/bookings/new?item_id={{ item.id }}">احجز الآن</a>
                {% else %}
                  <span class="badge bg-warning text-dark">حسابك غير مُفعّل للحجز</span>
                {% endif %}
              {% else %}
                <span class="text-muted small">سجّل الدخول للتواصل أو الحجز.</span>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <a href="/items" class="btn btn-outline-light" style="margin-top:12px">رجوع للقائمة</a>
    </div>

  </div>
</section>
{% endif %}

{% endblock %}
