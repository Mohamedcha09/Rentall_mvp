{% extends "base.html" %}
{% block content %}
{% if not item %}
  <div class="alert alert-danger">العنصر غير موجود.</div>
{% else %}
{% set _now = today if today is defined else (datetime.utcnow() if datetime is defined else None) %}
{% set _created = owner.created_at if owner and owner.created_at else _now %}
{% set _days = (_now - _created).days if (_now and _created) else 99999 %}
{% set _is_admin = (owner and owner.role == 'admin') %}
{% set _is_verified_manual = owner and owner.is_verified %}
{% set _five_star_count = five_star_count|default(0) %}
{% set _returns_success_count = returns_success_count|default(0) %}
{% set show_admin_blue = _is_admin %}
{% set show_yellow_seed = (_days < 60) %}
{% set show_pro_green  = (_days >= 60 and _days < 365) %}
{% set show_pro_gold   = (_days >= 365) %}
{% set show_violet_trust = (_is_verified_manual or _five_star_count >= 20) %}
{% set show_green_shield = (_returns_success_count >= 10) %}
{% set show_orange_top = (_five_star_count >= 10) %}

<style>
  .badge-icon{height:24px;width:24px;margin-inline-start:6px;vertical-align:middle;display:inline-block;}
</style>

<div class="row">
  <div class="col-md-7">
    <div class="card">
      {% if item.image_path %}<img src="/{{ item.image_path }}" class="card-img-top" style="max-height:400px;object-fit:cover" alt="item">{% endif %}
      <div class="card-body">
        <h3 class="card-title">{{ item.title }}</h3>
        <div class="small text-muted mb-1">{{ item.category_label }}</div>
        <p class="text-muted">{{ item.city or "" }}</p>
        <p class="fw-bold">{{ item.price_per_day }} د/يوم</p>
        <p>{{ item.description or "" }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card mb-3">
      <div class="card-body">
        <h5>المالك</h5>

        {% if owner %}
          <!-- اسم المالك + شارات -->
          <div class="mb-2">
            <strong>{{ owner.first_name }} {{ owner.last_name }}</strong>
            {% if owner.is_verified %}
              <img src="/static/verified.png" class="verified-badge" alt="موثّق">
            {% endif %}
            {% if show_admin_blue %}
              <img src="/static/img/adm.png" class="badge-icon" alt="Admin">
            {% endif %}
            {% if show_yellow_seed %}
              <img src="/static/img/jaune.png" class="badge-icon" alt="Nouveau">
            {% elif show_pro_green %}
              <img src="/static/img/ProVert.png" class="badge-icon" alt="Pro Vert">
            {% elif show_pro_gold %}
              <img src="/static/img/ProGold.png" class="badge-icon" alt="Pro Gold">
            {% endif %}
            {% if show_violet_trust %}
              <img src="/static/img/violet.png" class="badge-icon" alt="Trust">
            {% endif %}
            {% if show_green_shield %}
              <img src="/static/img/Vert.png" class="badge-icon" alt="Safe Renter">
            {% endif %}
            {% if show_orange_top %}
              <img src="/static/img/orange.png" class="badge-icon" alt="Top Rated">
            {% endif %}
          </div>

          <!-- رابط الملف العام -->
          <a href="/u/{{ owner.id }}" class="btn btn-sm btn-outline-light">الملف العام</a>
        {% endif %}

        <!-- منطق المراسلة الأصلي -->
        {% if session_user and session_user.id != owner.id %}
          {% if session_user.status == 'approved' %}
            <div class="d-grid gap-2 mt-3">
              <a class="btn btn-primary"
                 href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">
                 تواصل مع المالك
              </a>
              <a class="btn btn-success"
                 href="/bookings/new?item_id={{ item.id }}">
                 احجز الآن
              </a>
            </div>
          {% else %}
            <div class="alert alert-warning mt-3 small">
              حسابك قيد المراجعة؛ حالياً يمكنك مراسلة الدعم فقط لحل مشاكل التفعيل.
            </div>
            <a class="btn btn-outline-light" href="/messages/support">راسل الدعم</a>
          {% endif %}
        {% else %}
          <div class="small text-muted mt-2">سجّل الدخول للتواصل.</div>
        {% endif %}
      </div>
    </div>
    <a href="/items" class="btn btn-outline-light">رجوع للقائمة</a>
  </div>
</div>
{% endif %}
{% endblock %}
