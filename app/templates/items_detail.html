{% extends "base.html" %}
{% from "_badges.html" import render_badges %}
{% block content %}

<style>
/* ‚Äî‚Äî Original base ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
:root{
  --bg-1:#0b1220; --bg-2:#0f172a; --card:#0f172acc;
  --stroke:rgba(255,255,255,.12); --stroke-soft:rgba(255,255,255,.08);
  --txt:#eaf0ff; --muted:#9fb0d8; --brand:#3b82f6; --ok:#10b981;
  --warn:#f59e0b; --glass:rgba(255,255,255,.06);
  --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
}
.items-shell{max-width:1100px;margin:18px auto;padding:0 12px}
.grid-2{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
@media (max-width:920px){.grid-2{grid-template-columns:1fr}}
.card-glass{background:linear-gradient(180deg,var(--glass),transparent);border:1px solid var(--stroke);border-radius:16px;overflow:hidden;backdrop-filter:blur(8px);box-shadow:var(--shadow)}
.card-body{padding:18px}
.card-title{margin:0 0 8px 0;font-weight:800;letter-spacing:.2px}
.small-muted{color:var(--muted);font-size:13px}
.badge-pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.05);font-size:12px;color:var(--muted)}
.gallery{background:#0c1324;border-bottom:1px solid var(--stroke-soft)}
.gallery-main{position:relative;aspect-ratio:16/10;width:100%;background:#0a0f1e}
.gallery-main img{width:100%;height:100%;object-fit:cover;display:block}
.gallery-zoom{position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,.45);border:1px solid var(--stroke);border-radius:12px;padding:8px 12px;font-size:13px;color:#fff;cursor:pointer;backdrop-filter:blur(6px)}
.gallery-menu{position:absolute;top:10px;right:10px}
.gallery-menu .btn-menu{background:rgba(0,0,0,.45);color:#fff;border:1px solid var(--stroke);border-radius:12px;padding:6px 10px;line-height:1;font-weight:700}
.gallery-menu .dropdown-menu{border-radius:12px;overflow:hidden;border:1px solid var(--stroke)}
.thumbs{display:flex;gap:10px;padding:12px;overflow-x:auto;background:linear-gradient(180deg,rgba(255,255,255,.03),transparent)}
.thumbs img{width:86px;height:60px;object-fit:cover;border-radius:10px;border:1px solid var(--stroke-soft);cursor:pointer;opacity:.85;transition:transform .15s ease,opacity .15s ease,box-shadow .15s ease}
.thumbs img:hover{transform:translateY(-2px);opacity:1;box-shadow:0 4px 14px rgba(0,0,0,.25)}
.thumbs img.active{outline:2px solid var(--brand);opacity:1}
.btnx{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:12px;font-weight:700;text-decoration:none;cursor:pointer;user-select:none;border:1px solid var(--stroke);backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));color:var(--txt);transition:transform .12s ease,background .2s ease,border-color .2s ease}
.btnx:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2)}
.btnx-primary{border-color:rgba(59,130,246,.6);background:linear-gradient(180deg,rgba(59,130,246,.35),rgba(59,130,246,.1))}
.btnx-green{border-color:rgba(16,185,129,.6);background:linear-gradient(180deg,rgba(16,185,129,.35),rgba(16,185,129,.1))}
.btnx-ghost{border-color:var(--stroke);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
.btns-row{display:flex;flex-wrap:wrap;gap:10px}
.lightbox{position:fixed;inset:0;display:none;place-items:center;z-index:9999;background:rgba(0,0,0,.8)}
.lightbox.show{display:grid}
.lightbox img{max-width:92vw;max-height:88vh;border-radius:14px;border:1px solid var(--stroke)}
.lightbox .close{position:absolute;top:18px;right:18px;background:rgba(0,0,0,.6);border:1px solid var(--stroke);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.owner-row{display:flex;align-items:center;gap:12px}
.owner-avatar{width:62px;height:62px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 2px var(--stroke)}
.hr{border:0;height:1px;background:var(--stroke-soft);margin:14px 0}

/* ‚Äî‚Äî Mobile Airbnb ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
@media (max-width:768px){
  body{background:#fff;color:#111}
  .items-shell{padding:0;margin:0;max-width:none}
  .grid-2{display:block}

  /* Cover */
  .gallery{background:#000;border:0}
  .gallery-main{height:58vh;max-height:520px;border-radius:0}
  .gallery-main img{object-fit:cover}

  /* Floating buttons + counter */
  .air-fab,.air-fab-right .air-fab{
    appearance:none;border:0;cursor:pointer;width:44px;height:44px;border-radius:50%;
    background:rgba(255,255,255,.9);box-shadow:0 8px 20px rgba(0,0,0,.18);
    display:grid;place-items:center;font-size:18px;line-height:1
  }
  .air-fab{position:absolute;top:16px;left:12px}
  .air-fab-right{position:absolute;top:16px;right:12px;display:flex;gap:10px}
  .air-pager{position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,.65);color:#fff;font-weight:600;padding:6px 10px;border-radius:10px;font-size:12px}

  /* White rounded sheet */
  .card-glass{background:transparent;border:0;box-shadow:none}
  .air-sheet{background:#fff;color:#111;margin-top:-24px;border-top-left-radius:28px;border-top-right-radius:28px;padding:22px 18px 10px;box-shadow:0 -6px 20px rgba(0,0,0,.06);border:1px solid #eee;border-bottom:0}

  .card-title{font-size:22px;font-weight:800;margin-bottom:6px;color:#111}
  .small-muted{color:#6b7280!important}
  .hr{background:#eee}

  /* Bottom booking bar */
  .air-sticky{position:sticky;bottom:0;z-index:20;background:#fff;border-top:1px solid #eee;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .air-price{display:flex;flex-direction:column;line-height:1.2}
  .air-price .now{font-weight:800;font-size:18px}
  .air-price .per{color:#6b7280;font-size:12px}
  .air-cta{flex:0 0 auto;min-width:140px;text-align:center;padding:12px 16px;border-radius:12px;font-weight:700;color:#fff;background:linear-gradient(90deg,#ff385c,#e61e4d);border:0;text-decoration:none;display:inline-block}

  /* Golden laurel badge around rating */
  .laurel-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:8px 0 12px 0}
  .laurel-mid{display:flex;align-items:center;gap:10px;flex:1;justify-content:center}
  .laurel{height:20px;width:auto;opacity:.95}
  .score{font-weight:800;font-size:18px;color:#111;display:flex;align-items:center;gap:6px}
  .score small{color:#6b7280;font-weight:600}

  /* Reviews (cloud-like swipeable cards) */
  .rv-strip{display:flex;gap:14px;overflow-x:auto;scroll-snap-type:x mandatory;padding:2px 2px 12px 2px}
  .rv-card{scroll-snap-align:start;flex:0 0 84vw;background:#fff;border:1px solid #eee;border-radius:16px;padding:14px;box-shadow:0 6px 14px rgba(0,0,0,.05)}
  .rv-head{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .rv-ava{width:40px;height:40px;border-radius:50%;object-fit:cover}
  .rv-meta{color:#6b7280;font-size:12px}
  .rv-stars{font-size:13px;color:#111}
  .rv-more{display:inline-block;margin-top:4px;font-weight:600}
  .btn-outline-pale{display:block;width:100%;text-align:center;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:10px 14px;font-weight:700}

  /* Bottom-Sheet for report (Bootstrap offcanvas) */
  .offcanvas-bottom{border-top-left-radius:18px;border-top-right-radius:18px}
}
</style>

<section class="items-shell">
  {% if not item %}
    <div class="card-glass"><div class="card-body"><div class="alert alert-danger">Item not found.</div></div></div>
  {% else %}

  <div class="grid-2">
    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî Item card/gallery ‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <div class="card-glass">
      <div class="gallery">

        {# Gather images #}
        {% set _srcs = [] %}
        {% if item.image_path %}
          {% set _raw = item.image_path %}
          {% if ',' in _raw %}{% set _srcs = _raw.split(',') %}
          {% elif '|' in _raw %}{% set _srcs = _raw.split('|') %}
          {% else %}{% set _srcs = [_raw] %}{% endif %}
        {% endif %}
        {% set current = _srcs[0] if _srcs else None %}

        {% macro build_src(p) -%}
          {%- set s = (p or '') -%}
          {%- if not (s.startswith('http') or s.startswith('/')) -%}{%- set s = '/' + s -%}{%- endif -%}
          {{- s -}}
        {%- endmacro %}

        <div class="gallery-main" id="gMain">
          {% if current %}
            <img id="mainImg" src="{{ build_src(current) }}" alt="item image">
            <button class="gallery-zoom" id="zoomBtn">Zoom image</button>
          {% else %}
            <div style="display:grid;place-items:center;height:100%;color:#8b94a7;font-size:13px">No image</div>
          {% endif %}

          <!-- ‚ãÆ Menu -->
          <div class="gallery-menu dropdown">
            <button class="btn-menu" data-bs-toggle="dropdown" aria-expanded="false" title="Options">‚ãÆ</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><button class="dropdown-item" data-bs-toggle="offcanvas" data-bs-target="#reportSheet" id="openReportBtn" type="button">üö© Report listing</button></li>
            </ul>
          </div>

          <!-- Mobile floating buttons + counter -->
          <button type="button" class="air-fab" onclick="history.back()" aria-label="Back"><i class="bi bi-arrow-left"></i></button>
          <div class="air-fab-right">
            <button type="button" aria-label="Share" class="air-fab" onclick="navigator.share ? navigator.share({url:location.href}) : alert('Copy the link manually');"><i class="bi bi-share"></i></button>
            <button type="button" aria-label="Save" class="air-fab"><i class="bi bi-heart"></i></button>
          </div>
          <div class="air-pager" id="airPager">1/1</div>
        </div>

        {% if _srcs|length > 1 %}
          <div class="thumbs" id="thumbs">
            {% for s in _srcs %}
              {% set src = build_src(s.strip()) %}
              <img data-src="{{ src }}" data-index="{{ loop.index0 }}" class="{% if loop.index0==0 %}active{% endif %}" src="{{ src }}" alt="thumb {{ loop.index }}">
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- ‚Äî‚Äî‚Äî Rounded content sheet (mobile) ‚Äî‚Äî‚Äî -->
      <div class="card-body air-sheet">
        <h2 class="card-title">{{ item.title }}</h2>
        <div class="small-muted" style="margin-bottom:8px">
          {{ item.category_label }} ‚Ä¢ {{ item.city or "No city" }} ‚Ä¢ {{ owner and owner.country or "" }}
        </div>

        <!-- Golden laurel row + rating inside it -->
        {% set _avg = item_rating_avg or 0 %}
        {% set _cnt = item_rating_count or 0 %}
        <div class="laurel-row">
          <div class="score">‚≠ê {{ '%.2f'|format(_avg) }} <small>/ 5</small></div>
          <div class="laurel-mid">
            <img class="laurel" src="{{ url_for('static', path='photo/ion.png') }}" alt="laurel left">
            <span style="font-weight:800">Visitor Favorite</span>
            <img class="laurel" src="{{ url_for('static', path='photo/ion2.png') }}" alt="laurel right">
          </div>
          <div class="score">{{ _cnt }} <small>review(s)</small></div>
        </div>

        {% if item.description %}
          <p style="white-space:pre-wrap;line-height:1.9;color:#374151">{{ item.description }}</p>
        {% else %}
          <div class="badge-pill">No description</div>
        {% endif %}

        <div class="hr"></div>

        <!-- Reviews as a horizontal slider -->
        <h5 style="margin:0 0 8px 0">Reviews</h5>
        {% if item_reviews and item_reviews|length %}
          <div class="rv-strip">
            {% for r in item_reviews %}
              <div class="rv-card">
                <div class="rv-head">
                  {% set avatar = (r.rater.avatar_path if r.rater and r.rater.avatar_path else url_for('static', path='placeholder.png')) %}
                  <img class="rv-ava" src="{{ avatar }}" alt="avatar">
                  <div>
                    <div style="font-weight:700">{{ (r.rater.first_name ~ ' ' ~ r.rater.last_name) if r.rater else 'Renter' }}</div>
                    <div class="rv-meta">{{ r.city or '' }} <span>‚Ä¢</span> {{ r.created_at.strftime("%B %Y") if r.created_at }}</div>
                  </div>
                </div>
                <div class="rv-stars" title="{{ r.stars }} / 5">
                  {% for _ in range(r.stars) %}‚≠ê{% endfor %}{% for _ in range(5 - r.stars) %}‚òÜ{% endfor %}
                </div>
                {% if r.comment %}
                  <div style="margin-top:6px;white-space:pre-wrap">{{ r.comment }}</div>
                  <a href="/items/{{ item.id }}#review-{{ r.id }}" class="rv-more">View more</a>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          <a href="/items/{{ item.id }}#all-reviews" class="btn-outline-pale">View all {{ _cnt }} review(s)</a>
        {% else %}
          <div class="small-muted">No reviews yet.</div>
        {% endif %}

        <div class="hr"></div>

        <!-- Buttons -->
        <div class="btns-row">
          {% if owner %}
            <a class="btnx btnx-primary" href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">üí¨ Contact owner</a>
            {% if session_user and session_user.status == 'approved' and session_user.id != owner.id %}
              <a class="btnx btnx-green" href="/bookings/new?item_id={{ item.id }}">‚úÖ Book now</a>
            {% elif not session_user %}
              <a class="btnx btnx-primary" href="/login">Log in to book</a>
            {% else %}
              <span class="badge-pill" title="Account activation required to book">Your account isn‚Äôt activated for booking</span>
            {% endif %}
          {% endif %}
          <a class="btnx btnx-ghost" href="/items">‚Ü©Ô∏é Back to list</a>
        </div>
      </div>

      <!-- Bottom booking bar -->
      <div class="air-sticky">
        <div class="air-price">
          <span class="now">{{ item.price_per_day }} {{ item.currency or 'KWD' }}</span>
          <span class="per">per day</span>
        </div>
        {% if owner and session_user and session_user.status == 'approved' and session_user.id != owner.id %}
          <a class="air-cta" href="/bookings/new?item_id={{ item.id }}">Book now</a>
        {% elif not session_user %}
          <a class="air-cta" href="/login">Sign in to pay</a>
        {% else %}
          <a class="air-cta" href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">Contact</a>
        {% endif %}
      </div>
    </div>

    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî Owner card ‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <div class="card-glass">
      <div class="card-body">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
          <h5 style="margin:0">Owner</h5>
          <span class="badge-pill">Stripe Connect ‚Ä¢ Receive earnings</span>
        </div>

        {% if owner %}
          <div class="owner-row">
            <img class="owner-avatar" src="{{ owner.avatar_path or url_for('static', path='placeholder.png') }}" alt="owner">
            <div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <strong>{{ owner.first_name }} {{ owner.last_name }}</strong>
                {{ render_badges(owner_badges, 22) }}
              </div>
              <div class="small-muted">Member since {{ owner.created_at.strftime("%Y-%m-%d") if owner.created_at else "" }}</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="btns-row">
            <a href="/users/{{ owner.id }}" class="btnx btnx-ghost">üë§ Public profile</a>
            <a class="btnx btnx-primary" href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">Message owner</a>
          </div>
        {% else %}
          <div class="small-muted">Owner information not available.</div>
        {% endif %}
      </div>
    </div>

  </div>
  {% endif %}
</section>

<!-- ‚Äî‚Äî Bottom Sheet: Report listing ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
<div class="offcanvas offcanvas-bottom" tabindex="-1" id="reportSheet" aria-labelledby="reportLabel" dir="rtl">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="reportLabel">üö© Report listing</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body small">
    <form method="post" action="/reports" id="reportForm">
      <input type="hidden" name="item_id" value="{{ item.id }}">
      <input type="hidden" name="image_index" id="rf_image_index" value="0">
      <input type="hidden" name="image_url" id="rf_image_url" value="">
      <div class="mb-3">
        <label class="form-label">Reason</label>
        <select class="form-select" name="reason" required>
          <option value="" selected disabled>Select a report reason</option>
          <option value="nudity">Inappropriate content/Nudity</option>
          <option value="violence">Violence/Hate</option>
          <option value="scam">Scam/Fraud</option>
          <option value="copyright">Copyright</option>
          <option value="spam">Spam</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Additional notes</label>
        <textarea class="form-control" name="note" rows="3" placeholder="Write details that help us review‚Ä¶"></textarea>
      </div>
      <button class="btn btn-danger w-100" type="submit">Submit report</button>
    </form>
  </div>
</div>

<script>
(function(){
  const main = document.getElementById('mainImg');
  const thumbs = document.getElementById('thumbs');
  const zoomBtn = document.getElementById('zoomBtn');
  const pager = document.getElementById('airPager');

  // Lightbox
  let lb=null;
  function openLightbox(src){
    if(!lb){
      lb=document.createElement('div');
      lb.className='lightbox';
      lb.innerHTML='<button class="close">Close ‚úï</button><img alt="preview">';
      document.body.appendChild(lb);
      lb.querySelector('.close').onclick=()=>lb.classList.remove('show');
      lb.onclick=(e)=>{ if(e.target===lb) lb.classList.remove('show'); };
    }
    lb.querySelector('img').src=src; lb.classList.add('show');
  }
  if(zoomBtn && main){ zoomBtn.addEventListener('click', ()=>openLightbox(main.src)); }

  // Image counter
  function setPager(i,t){ if(pager){ pager.textContent=(i+1)+'/'+t; } }
  let activeIdx=0;
  function totalImgs(){ return thumbs ? thumbs.querySelectorAll('img').length : (main?1:0); }
  setPager(activeIdx,totalImgs());

  // Switch image from thumbnails
  if(thumbs && main){
    thumbs.addEventListener('click', (e)=>{
      const t=e.target;
      if(t.tagName==='IMG'){
        main.src=t.dataset.src||t.src;
        [...thumbs.querySelectorAll('img')].forEach(i=>i.classList.remove('active'));
        t.classList.add('active');
        activeIdx=parseInt(t.getAttribute('data-index')||'0',10)||0;
        setPager(activeIdx,totalImgs());
        // Fill report values
        document.getElementById('rf_image_index')?.setAttribute('value', String(activeIdx));
        document.getElementById('rf_image_url')?.setAttribute('value', t.dataset.src || t.src || '');
      }
    });
    // Horizontal drag
    let sx=0,dx=0;
    thumbs.addEventListener('touchstart',e=>{sx=e.touches[0].clientX},{passive:true});
    thumbs.addEventListener('touchmove',e=>{dx=e.touches[0].clientX-sx},{passive:true});
    thumbs.addEventListener('touchend',()=>{thumbs.scrollBy({left:-dx,behavior:'smooth'});sx=dx=0});
  }

  // Keyboard arrows
  function step(dir){
    if(!thumbs) return;
    const imgs=[...thumbs.querySelectorAll('img')];
    if(imgs.length<=1) return;
    let i=imgs.findIndex(n=>n.classList.contains('active')); if(i<0) i=0;
    let j=(i+dir+imgs.length)%imgs.length; imgs[j].click();
    imgs[j].scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
  }
  window.addEventListener('keydown',e=>{ if(e.key==='ArrowRight')step(+1); if(e.key==='ArrowLeft')step(-1); });

  // When the report Sheet opens for the first time, prepare current values
  const reportSheet = document.getElementById('reportSheet');
  reportSheet?.addEventListener('show.bs.offcanvas', ()=>{
    const activeThumb=document.querySelector('#thumbs img.active')||document.querySelector('#thumbs img');
    const idx=activeThumb?parseInt(activeThumb.getAttribute('data-index')||'0',10)||0:0;
    const url=activeThumb?(activeThumb.dataset.src||activeThumb.src||(main?.src||'')):(main?.src||'');
    document.getElementById('rf_image_index')?.setAttribute('value', String(idx));
    document.getElementById('rf_image_url')?.setAttribute('value', url);
  });

})();
</script>

{% endblock %}
