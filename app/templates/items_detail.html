{% extends "base.html" %}
{% from "_badges.html" import render_badges %}
{% block content %}

<style>
/* ===============  Glass & Modern UI  =============== */
:root{
  --bg-1:#0b1220;
  --bg-2:#0f172a;
  --card:#0f172acc;
  --stroke:rgba(255,255,255,.12);
  --stroke-soft:rgba(255,255,255,.08);
  --txt:#eaf0ff;
  --muted:#9fb0d8;
  --brand:#3b82f6;
  --brand-2:#22d3ee;
  --ok:#10b981;
  --warn:#f59e0b;
  --glass:rgba(255,255,255,.06);
  --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
}

.items-shell{
  max-width:1100px;margin:18px auto;padding:0 12px;
}

.grid-2{
  display:grid;gap:18px;
  grid-template-columns:1.2fr .8fr;
}
@media (max-width: 920px){
  .grid-2{ grid-template-columns:1fr; }
}

.card-glass{
  background:linear-gradient(180deg, var(--glass), transparent);
  border:1px solid var(--stroke);
  border-radius:16px; overflow:hidden; backdrop-filter: blur(8px);
  box-shadow: var(--shadow);
}

.card-body{ padding:18px; }
.card-title{ margin:0 0 8px 0; font-weight:800; letter-spacing:.2px; }
.small-muted{ color:var(--muted); font-size:13px; }
.badge-pill{
  display:inline-block; padding:6px 10px; border-radius:999px;
  border:1px solid var(--stroke); background:rgba(255,255,255,.05);
  font-size:12px; color:var(--muted);
}

/* ===============  Gallery  =============== */
.gallery{
  background: #0c1324; border-bottom:1px solid var(--stroke-soft);
}
.gallery-main{
  position:relative; aspect-ratio: 16/10; width:100%;
  background: #0a0f1e;
}
.gallery-main img{
  width:100%; height:100%; object-fit:cover; display:block;
}
.gallery-zoom{
  position:absolute; bottom:10px; right:10px;
  background:rgba(0,0,0,.45);
  border:1px solid var(--stroke); border-radius:12px;
  padding:8px 12px; font-size:13px; color:#fff; cursor:pointer;
  backdrop-filter: blur(6px);
}
.thumbs{
  display:flex; gap:10px; padding:12px; overflow-x:auto;
  background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
}
.thumbs img{
  width:86px; height:60px; object-fit:cover; border-radius:10px;
  border:1px solid var(--stroke-soft); cursor:pointer; opacity:.85;
  transition:transform .15s ease, opacity .15s ease, box-shadow .15s ease;
}
.thumbs img:hover{ transform:translateY(-2px); opacity:1; box-shadow:0 4px 14px rgba(0,0,0,.25); }
.thumbs img.active{ outline:2px solid var(--brand); opacity:1; }

/* ===============  Buttons  =============== */
.btnx{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 16px; border-radius:12px; font-weight:700;
  text-decoration:none; cursor:pointer; user-select:none;
  border:1px solid var(--stroke); backdrop-filter: blur(8px);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  color:var(--txt); transition: transform .12s ease, background .2s ease, border-color .2s ease;
}
.btnx:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.2); }
.btnx-primary{
  border-color: rgba(59,130,246,.6);
  background: linear-gradient(180deg, rgba(59,130,246,.35), rgba(59,130,246,.1));
}
.btnx-green{
  border-color: rgba(16,185,129,.6);
  background: linear-gradient(180deg, rgba(16,185,129,.35), rgba(16,185,129,.1));
}
.btnx-ghost{
  border-color: var(--stroke);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
}
.btns-row{ display:flex; flex-wrap:wrap; gap:10px; }

/* ===============  Lightbox  =============== */
.lightbox{
  position:fixed; inset:0; display:none; place-items:center; z-index:9999;
  background:rgba(0,0,0,.8);
}
.lightbox.show{ display:grid; }
.lightbox img{ max-width:92vw; max-height:88vh; border-radius:14px; border:1px solid var(--stroke); }
.lightbox .close{
  position:absolute; top:18px; right:18px;
  background:rgba(0,0,0,.6); border:1px solid var(--stroke);
  color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer;
}

/* ===============  Owner card  =============== */
.owner-row{ display:flex; align-items:center; gap:12px; }
.owner-avatar{
  width:62px;height:62px;border-radius:50%;object-fit:cover;
  box-shadow:0 0 0 2px var(--stroke);
}

.hr{ border:0; height:1px; background:var(--stroke-soft); margin:14px 0; }
</style>

<section class="items-shell">
  {% if not item %}
    <div class="card-glass">
      <div class="card-body"><div class="alert alert-danger">العنصر غير موجود.</div></div>
    </div>
  {% else %}

  <div class="grid-2">

    <!-- =================== بطاقة/معرض العنصر =================== -->
    <div class="card-glass">
      <div class="gallery">

        {# ====== إعداد مصادر الصور ======
           يدعم:
           - قيمة واحدة (item.image_path)
           - قيم متعددة مفصولة بفواصل , أو |
        #}
        {% set _srcs = [] %}
        {% if item.image_path %}
          {% set _raw = item.image_path %}
          {% if ',' in _raw %}
            {% set _srcs = _raw.split(',') %}
          {% elif '|' in _raw %}
            {% set _srcs = _raw.split('|') %}
          {% else %}
            {% set _srcs = [_raw] %}
          {% endif %}
        {% endif %}

        {# اجعل أول صورة هي الحالية #}
        {% set current = _srcs[0] if _srcs else None %}

        {# دالة صغيرة لبناء src صحيح (Cloudinary/محلي) #}
        {% macro build_src(p) -%}
          {%- set s = (p or '') -%}
          {%- if not (s.startswith('http') or s.startswith('/')) -%}
            {%- set s = '/' + s -%}
          {%- endif -%}
          {{- s -}}
        {%- endmacro %}

        <div class="gallery-main" id="gMain">
          {% if current %}
            <img id="mainImg" src="{{ build_src(current) }}" alt="item image">
          {% else %}
            <div style="display:grid;place-items:center;height:100%;color:var(--muted);font-size:13px">لا توجد صورة</div>
          {% endif %}
          {% if current %}
            <button class="gallery-zoom" id="zoomBtn">تكبير الصورة</button>
          {% endif %}
        </div>

        {% if _srcs|length > 1 %}
          <div class="thumbs" id="thumbs">
            {% for s in _srcs %}
              {% set src = build_src(s.strip()) %}
              <img data-src="{{ src }}" class="{% if loop.index0==0 %}active{% endif %}" src="{{ src }}" alt="thumb {{ loop.index }}">
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="card-body">
        <h2 class="card-title">{{ item.title }}</h2>
        <div class="small-muted" style="margin-bottom:8px">
          {{ item.category_label }} • {{ item.city or "بدون مدينة" }}
        </div>
        <div style="font-size:22px; font-weight:800; margin:6px 0 12px 0">
          {{ item.price_per_day }} <span style="font-size:14px;color:var(--muted)">د/يوم</span>
        </div>

        {% if item.description %}
          <p style="white-space:pre-wrap;line-height:1.9;color:#cdd7ee">{{ item.description }}</p>
        {% else %}
          <div class="badge-pill">لا يوجد وصف</div>
        {% endif %}

        <div class="hr"></div>

        <div class="btns-row">
          {% if owner %}
            <a class="btnx btnx-primary" href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">
              💬 تواصل مع المالك
            </a>
            {% if session_user and session_user.status == 'approved' and session_user.id != owner.id %}
              <a class="btnx btnx-green" href="/bookings/new?item_id={{ item.id }}">✅ احجز الآن</a>
            {% elif not session_user %}
              <a class="btnx btnx-primary" href="/login">سجّل الدخول للحجز</a>
            {% else %}
              <span class="badge-pill" title="يلزم تفعيل الحساب للحجز">حسابك غير مُفعل للحجز</span>
            {% endif %}
          {% endif %}
          <a class="btnx btnx-ghost" href="/items">↩︎ رجوع للقائمة</a>
        </div>
      </div>
    </div>

    <!-- =================== بطاقة المالك =================== -->
    <div class="card-glass">
      <div class="card-body">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
          <h5 style="margin:0">المالك</h5>
          <span class="badge-pill">Stripe Connect • استلام الأرباح</span>
        </div>

        {% if owner %}
          <div class="owner-row">
            <img class="owner-avatar"
                 src="{{ owner.avatar_path or url_for('static', path='placeholder.png') }}"
                 alt="owner">
            <div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <strong>{{ owner.first_name }} {{ owner.last_name }}</strong>
                {{ render_badges(owner_badges, 22) }}
              </div>
              <div class="small-muted">
                عضو منذ {{ owner.created_at.strftime("%Y-%m-%d") if owner.created_at else "" }}
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="btns-row">
            <a href="/u/{{ owner.id }}" class="btnx btnx-ghost">👤 الملف العام</a>
            <a class="btnx btnx-primary" href="/messages/start?user_id={{ owner.id }}&item_id={{ item.id }}">راسل المالك</a>
          </div>
        {% else %}
          <div class="small-muted">لا تتوفر معلومات المالك.</div>
        {% endif %}
      </div>
    </div>

  </div>
  {% endif %}
</section>

<!-- ===============  Lightbox & Gallery JS (خفيف)  =============== -->
<script>
(function(){
  const main = document.getElementById('mainImg');
  const thumbs = document.getElementById('thumbs');
  const zoomBtn = document.getElementById('zoomBtn');

  // Lightbox
  let lb = null;
  function openLightbox(src){
    if(!lb){
      lb = document.createElement('div');
      lb.className = 'lightbox';
      lb.innerHTML = '<button class="close">إغلاق ✕</button><img alt="preview">';
      document.body.appendChild(lb);
      lb.querySelector('.close').onclick = () => lb.classList.remove('show');
      lb.onclick = (e)=>{ if(e.target===lb) lb.classList.remove('show'); };
    }
    lb.querySelector('img').src = src;
    lb.classList.add('show');
  }

  if(zoomBtn && main){
    zoomBtn.addEventListener('click', ()=> openLightbox(main.src));
  }

  // تبديل الرئيسي عند الضغط على المصغّرات
  if(thumbs && main){
    thumbs.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.tagName==='IMG'){
        main.src = t.dataset.src || t.src;
        [...thumbs.querySelectorAll('img')].forEach(i=>i.classList.remove('active'));
        t.classList.add('active');
      }
    });

    // سحب على الهاتف
    let sx=0, dx=0;
    thumbs.addEventListener('touchstart', e=>{ sx=e.touches[0].clientX; }, {passive:true});
    thumbs.addEventListener('touchmove', e=>{ dx=e.touches[0].clientX - sx; }, {passive:true});
    thumbs.addEventListener('touchend', ()=>{
      // تمرير بسيط
      thumbs.scrollBy({left: -dx, behavior:'smooth'});
      sx=dx=0;
    });
  }

  // أسهم الكيبورد لتبديل الصور
  function step(dir){
    if(!thumbs) return;
    const imgs = [...thumbs.querySelectorAll('img')];
    if(imgs.length<=1) return;
    let i = imgs.findIndex(n=>n.classList.contains('active'));
    if(i<0) i = 0;
    let j = (i + dir + imgs.length) % imgs.length;
    imgs[j].click();
    imgs[j].scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
  }
  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') step(+1);
    if(e.key==='ArrowLeft') step(-1);
  });

})();
</script>

{% endblock %}