{% extends "base.html" %}
{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
      <h4 class="mb-1">تذكرة (CS) #{{ ticket.id }}</h4>

      <div class="text-muted small">
        الموضوع: <strong>{{ ticket.subject or 'بدون عنوان' }}</strong> ·
        العميل: {{ ticket.user.full_name }} (ID {{ ticket.user_id }})
      </div>

      <div class="mt-2 d-flex flex-wrap align-items-center gap-1">
        {# حالة التذكرة #}
        {% set st = (ticket.status or 'new') %}
        <span class="badge {% if st=='resolved' %}bg-success{% elif st=='open' %}bg-primary{% else %}bg-secondary{% endif %}">
          {% if st=='resolved' %}منتهية{% elif st=='open' %}قيد المراجعة{% else %}جديدة{% endif %}
        </span>

        {# المكلّف #}
        {% if ticket.assigned_to_id %}
          <span class="badge bg-outline border text-muted">مكلّف: {{ ticket.assigned_to_id }}</span>
        {% else %}
          <span class="badge bg-warning text-dark">غير معيّنة</span>
        {% endif %}

        {# القسم الحالي (queue) مع افتراضي cs #}
        <span class="badge bg-info text-dark">
          القسم: {{ (ticket.queue|default('cs'))|upper }}
        </span>
      </div>
    </div>

    <!-- أزرار أعلى -->
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/cs/inbox">العودة للصندوق</a>

      {% if not ticket.assigned_to_id %}
        <button class="btn btn-outline-primary btn-sm" onclick="assignSelf({{ ticket.id }})">تولّي</button>
      {% endif %}

      {% if ticket.status != 'resolved' %}
        <button class="btn btn-success btn-sm" onclick="resolveTicket({{ ticket.id }})">تمّ الحل</button>
      {% endif %}
    </div>
  </div>

  <!-- شريط تحويل الأقسام -->
  <div class="card mb-3">
    <div class="card-body d-flex flex-wrap gap-2 align-items-center">
      <div class="fw-semibold me-2">تحويل إلى قسم:</div>

      <!-- تحويل إلى MD -->
      <form method="post" action="/cs/tickets/{{ ticket.id }}/transfer" class="m-0">
        <input type="hidden" name="to" value="md">
        <button class="btn btn-outline-dark btn-sm" type="submit" title="تحويل التذكرة إلى قسم MD (إدارة الودائع)">
          MD
        </button>
      </form>

      <!-- تحويل إلى MOD -->
      <form method="post" action="/cs/tickets/{{ ticket.id }}/transfer" class="m-0">
        <input type="hidden" name="to" value="mod">
        <button class="btn btn-outline-dark btn-sm" type="submit" title="تحويل التذكرة إلى قسم MOD (المراجعين)">
          MOD
        </button>
      </form>

      <!-- (اختياري) إعادة إلى CS لإرجاعها للقسم الأساسي -->
      <form method="post" action="/cs/tickets/{{ ticket.id }}/transfer" class="m-0 ms-auto">
        <input type="hidden" name="to" value="cs">
        <button class="btn btn-outline-secondary btn-sm" type="submit" title="إرجاع التذكرة إلى قسم CS">
          رجوع إلى CS
        </button>
      </form>
    </div>
  </div>

  <!-- الرسائل -->
  <div class="card mb-3">
    <div class="card-body">
      {% if msgs and msgs|length %}
        {% for m in msgs %}
          <div class="d-flex {% if m.sender_role=='user' %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
            <div class="p-2 rounded-3"
                 style="max-width: 90%; background: {% if m.sender_role=='user' %}#eef6ff{% else %}#f5f5f7{% endif %};">
              <div class="small text-muted mb-1">
                {{ m.created_at }} — {{ 'العميل' if m.sender_role=='user' else 'الدعم' }}
              </div>
              <div dir="auto">{{ m.body | e | replace('\n','<br>') | safe }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">لا توجد رسائل بعد.</div>
      {% endif %}
    </div>
  </div>

  <!-- نموذج رد الوكيل (إن لم تكن منتهية) -->
  {% if ticket.status != 'resolved' %}
  <div class="card">
    <div class="card-header fw-semibold">ردّ الدعم</div>
    <div class="card-body">
      <form method="post" action="/cs/ticket/{{ ticket.id }}/reply">
        <textarea name="body" class="form-control mb-2" rows="4" placeholder="اكتب ردّك هنا..." required></textarea>
        <div class="d-flex gap-2">
          <button class="btn btn-primary">إرسال</button>

          {% if not ticket.assigned_to_id %}
            <button class="btn btn-outline-primary" type="button" onclick="assignSelf({{ ticket.id }})">
              تولّي ثم أكتب
            </button>
          {% endif %}

          <button class="btn btn-outline-success ms-auto" type="button" onclick="resolveTicket({{ ticket.id }})">
            إنهاء كتذكرة محلولة
          </button>
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <div class="alert alert-success mt-3 mb-0">
    هذه التذكرة مُغلقة كـ <strong>منتهية</strong>. يمكنك استعراضها فقط.
  </div>
  {% endif %}

</div>

<!-- Actions -->
<script>
async function resolveTicket(id){
  try{
    const r = await fetch(`/cs/tickets/${id}/resolve`, { method:'POST' });
    if(!r.ok) throw 0;
    window.location.href = '/cs/inbox';
  }catch(e){
    alert('تعذّر إغلاق التذكرة');
  }
}
async function assignSelf(id){
  try{
    const r = await fetch(`/cs/tickets/${id}/assign_self`, { method:'POST' });
    if(!r.ok) throw 0;
    location.reload();
  }catch(e){
    alert('تعذّر التولّي');
  }
}
</script>
{% endblock %}
