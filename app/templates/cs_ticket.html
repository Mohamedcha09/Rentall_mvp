{% extends "base.html" %}
{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
      <h4 class="mb-1">Ticket (CS) #{{ ticket.id }}</h4>

      <div class="text-muted small">
        Subject: <strong>{{ ticket.subject or 'No Title' }}</strong> ·
        Client: {{ ticket.user.full_name }} (ID {{ ticket.user_id }})
      </div>

      <div class="mt-2 d-flex flex-wrap align-items-center gap-1">
        {# Ticket Status #}
        {% set st = (ticket.status or 'new') %}
        <span class="badge {% if st=='resolved' %}bg-success{% elif st=='open' %}bg-primary{% else %}bg-secondary{% endif %}">
          {% if st=='resolved' %}Resolved{% elif st=='open' %}In Review{% else %}New{% endif %}
        </span>

        {# Assigned Agent #}
        {% if ticket.assigned_to_id %}
          <span class="badge bg-outline border text-muted">Assigned To: {{ ticket.assigned_to_id }}</span>
        {% else %}
          <span class="badge bg-warning text-dark">Unassigned</span>
        {% endif %}

        {# Current Queue (default cs) #}
        <span class="badge bg-info text-dark">
          Queue: {{ (ticket.queue|default('cs'))|upper }}
        </span>
      </div>
    </div>

    <!-- Top Buttons -->
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/cs/inbox">Back to Inbox</a>

      {% if not ticket.assigned_to_id %}
        <button class="btn btn-outline-primary btn-sm" onclick="assignSelf({{ ticket.id }})">Take Ownership</button>
      {% endif %}

      {% if ticket.status != 'resolved' %}
        <button class="btn btn-success btn-sm" onclick="resolveTicket({{ ticket.id }})">Mark as Resolved</button>
      {% endif %}
    </div>
  </div>

  <!-- Queue Transfer Bar -->
  <div class="card mb-3">
    <div class="card-body d-flex flex-wrap gap-2 align-items-center">
      <div class="fw-semibold me-2">Transfer to Department:</div>

      <!-- Transfer to MD -->
      <form method="post" action="/cs/tickets/{{ ticket.id }}/transfer" class="m-0">
        <input type="hidden" name="to" value="md">
        <button class="btn btn-outline-dark btn-sm" type="submit" title="Transfer ticket to MD (Deposit Management)">
          MD
        </button>
      </form>

      <!-- Transfer to MOD -->
      <form method="post" action="/cs/tickets/{{ ticket.id }}/transfer" class="m-0">
        <input type="hidden" name="to" value="mod">
        <button class="btn btn-outline-dark btn-sm" type="submit" title="Transfer ticket to MOD (Moderators)">
          MOD
        </button>
      </form>

      <!-- (Optional) Return to CS -->
      <form method="post" action="/cs/tickets/{{ ticket.id }}/transfer" class="m-0 ms-auto">
        <input type="hidden" name="to" value="cs">
        <button class="btn btn-outline-secondary btn-sm" type="submit" title="Return ticket to CS">
          Return to CS
        </button>
      </form>
    </div>
  </div>

  <!-- Messages -->
  <div class="card mb-3">
    <div class="card-body">
      {% if msgs and msgs|length %}
        {% for m in msgs %}
          <div class="d-flex {% if m.sender_role=='user' %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
            <div class="p-2 rounded-3"
                 style="max-width: 90%; background: {% if m.sender_role=='user' %}#eef6ff{% else %}#f5f5f7{% endif %};">
              <div class="small text-muted mb-1">
                {{ m.created_at }} — {{ 'Client' if m.sender_role=='user' else 'Support' }}
              </div>
              <div dir="auto">{{ m.body | e | replace('\n','<br>') | safe }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">No messages yet.</div>
      {% endif %}
    </div>
  </div>

  <!-- Agent Reply Form (if not resolved) -->
  {% if ticket.status != 'resolved' %}
  <div class="card">
    <div class="card-header fw-semibold">Support Reply</div>
    <div class="card-body">
      <form method="post" action="/cs/ticket/{{ ticket.id }}/reply">
        <textarea name="body" class="form-control mb-2" rows="4" placeholder="Write your reply here..." required></textarea>
        <div class="d-flex gap-2">
          <button class="btn btn-primary">Send</button>

          {% if not ticket.assigned_to_id %}
            <button class="btn btn-outline-primary" type="button" onclick="assignSelf({{ ticket.id }})">
              Take Ownership then Reply
            </button>
          {% endif %}

          <button class="btn btn-outline-success ms-auto" type="button" onclick="resolveTicket({{ ticket.id }})">
            Mark as Solved
          </button>
        </div>
      </form>
    </div>
  </div>
  {% else %}
  <div class="alert alert-success mt-3 mb-0">
    This ticket is <strong>Resolved</strong>. You can only view it.
  </div>
  {% endif %}

</div>

<!-- Actions -->
<script>
async function resolveTicket(id){
  try{
    const r = await fetch(`/cs/tickets/${id}/resolve`, { method:'POST' });
    if(!r.ok) throw 0;
    window.location.href = '/cs/inbox';
  }catch(e){
    alert('Failed to close the ticket');
  }
}
async function assignSelf(id){
  try{
    const r = await fetch(`/cs/tickets/${id}/assign_self`, { method:'POST' });
    if(!r.ok) throw 0;
    location.reload();
  }catch(e){
    alert('Failed to take ownership');
  }
}
</script>
{% endblock %}