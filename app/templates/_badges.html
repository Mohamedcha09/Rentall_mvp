{# app/templates/_badges.html #}
{% macro _img(name, alt, size) -%}
  <img src="/static/img/{{ name }}.png"
       alt="{{ alt }}"
       class="badge-icon"
       style="height:{{ size }}px;width:{{ size }}px;margin-inline-start:6px;vertical-align:middle;object-fit:contain;">
{%- endmacro %}

{% macro render_badges(subject, size=22) -%}
  {# لو مافيه موضوع، لا نرسم شيء #}
  {% if not subject %}
    {# لا شيء #}
  {% else %}
    {%- set names = [] -%}

    {# 1) لو قائمة جاهزة #}
    {% if subject is sequence and (subject is not string) %}
      {%- set names = subject -%}
    {% else %}
      {%- set u = subject -%}

      {# helpers: نقرأ من dict أو object مع default #}
      {%- set role         = (u['role'] if u is mapping else u.role)|default('') -%}
      {%- set is_verified  = (u['is_verified'] if u is mapping else u.is_verified)|default(false) -%}

      {%- set b_admin      = (u['badge_admin'] if u is mapping else u.badge_admin)|default(false) -%}
      {%- set b_new        = (u['badge_new_yellow'] if u is mapping else u.badge_new_yellow)|default(false) -%}
      {%- set b_pg         = (u['badge_pro_green'] if u is mapping else u.badge_pro_green)|default(false) -%}
      {%- set b_pgld       = (u['badge_pro_gold'] if u is mapping else u.badge_pro_gold)|default(false) -%}
      {%- set b_vio        = (u['badge_purple_trust'] if u is mapping else u.badge_purple_trust)|default(false) -%}
      {%- set b_vert       = (u['badge_renter_green'] if u is mapping else u.badge_renter_green)|default(false) -%}
      {%- set b_orng       = (u['badge_orange_stars'] if u is mapping else u.badge_orange_stars)|default(false) -%}

      {# الأزرق (أدمن) #}
      {% if role|lower == 'admin' or b_admin %}{%- set _ = names.append('adm') -%}{% endif %}

      {# البنفسجي (توثيق من الأدمِن) #}
      {% if is_verified or b_vio %}{%- set _ = names.append('violet') -%}{% endif %}

      {# أصفر / برو أخضر / برو ذهبي (أولوية: ذهبـي ثم أخضر ثم أصفر) #}
      {% if b_pgld %}{%- set _ = names.append('ProGold') -%}
      {% elif b_pg %}{%- set _ = names.append('ProVert') -%}
      {% elif b_new %}{%- set _ = names.append('jaune') -%}{% endif %}

      {# درع أخضر (≥5 استعمالات) #}
      {% if b_vert %}{%- set _ = names.append('Vert') -%}{% endif %}

      {# برتقالي (≥20 تقييم كلهم 5 نجوم) #}
      {% if b_orng %}{%- set _ = names.append('orange') -%}{% endif %}
    {% endif %}

    {% if names and names|length %}
      <span class="user-badges">
        {%- for n in names %}
          {{ _img(n, 'badge ' ~ n, size) }}
        {%- endfor %}
      </span>
    {% endif %}
  {% endif %}
{%- endmacro %}

<style>
.badge-icon{display:inline-block}
.user-badges{display:inline-flex;align-items:center}
</style>
