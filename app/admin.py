# app/admin.py
from datetime import datetime
import os

from fastapi import APIRouter, Depends, Request, HTTPException, Form
from fastapi.responses import RedirectResponse
from sqlalchemy.orm import Session

from .database import get_db
from .models import User, Document, MessageThread, Message
from .notifications_api import push_notification  # NEW
from .email_service import send_email             # ูุฅุฑุณุงู ุงูุฅูููู ุนูุฏ ุงูููุงููุฉ

router = APIRouter()

BASE_URL = (os.getenv("SITE_URL") or os.getenv("BASE_URL") or "http://localhost:8000").rstrip("/")


# ---------------------------
# Helpers
# ---------------------------
def require_admin(request: Request) -> bool:
    u = request.session.get("user")
    return bool(u and (u.get("role") or "").lower() == "admin")


def _open_or_create_admin_thread(db: Session, admin_id: int, user_id: int) -> MessageThread:
    """ุงูุชุญ ุฃู ุฃูุดุฆ ุฎูุท ุฑุณุงุฆู ุจูู ุงูุฃุฏููู ูุงููุณุชุฎุฏู."""
    thread = (
        db.query(MessageThread)
        .filter(
            ((MessageThread.user_a_id == admin_id) & (MessageThread.user_b_id == user_id)) |
            ((MessageThread.user_a_id == user_id) & (MessageThread.user_b_id == admin_id))
        )
        .order_by(MessageThread.created_at.desc())
        .first()
    )
    if not thread:
        thread = MessageThread(user_a_id=admin_id, user_b_id=user_id, item_id=None)
        db.add(thread)
        db.commit()
        db.refresh(thread)
    return thread


def _refresh_session_user_if_self(request: Request, user: User) -> None:
    """ูู ุงูุฃุฏููู ุนุฏูู ููุณูุ ุญุฏูุซ ุงูููู ุฏุงุฎู session ุญุชู ุชุธูุฑ ููุฑูุง ูู ุงููุงุฌูุฉ."""
    sess = request.session.get("user")
    if not sess or sess.get("id") != user.id:
        return
    sess["role"] = user.role
    sess["status"] = user.status
    sess["is_verified"] = bool(user.is_verified)
    for k in [
        "badge_admin", "badge_new_yellow", "badge_pro_green", "badge_pro_gold",
        "badge_purple_trust", "badge_renter_green", "badge_orange_stars",
    ]:
        if hasattr(user, k):
            sess[k] = getattr(user, k)
    if hasattr(user, "is_deposit_manager"):
        sess["is_deposit_manager"] = bool(getattr(user, "is_deposit_manager", False))
    # ุงูุชุจ ุงูุชุญุฏูุซุงุช ูุฑูุฉ ุฃุฎุฑู ุฏุงุฎู ุงูุณูุดู
    request.session["user"] = sess


# ---------------------------
# ููุญุฉ ุงูุฃุฏููู
# ---------------------------
@router.get("/admin")
def admin_dashboard(request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    pending_users = (
        db.query(User)
        .filter(User.status == "pending")
        .order_by(User.created_at.desc())
        .all()
    )
    all_users = db.query(User).order_by(User.created_at.desc()).all()

    return request.app.templates.TemplateResponse(
        "admin_dashboard.html",
        {
            "request": request,
            "title": "ููุญุฉ ุงูุฃุฏููู",
            "pending_users": pending_users,
            "all_users": all_users,
            "session_user": request.session.get("user"),
        },
    )


# ---------------------------
# ูุฑุงุฑุงุช ุงูุชุณุฌูู
# ---------------------------
@router.post("/admin/users/{user_id}/approve")
def approve_user(user_id: int, request: Request, db: Session = Depends(get_db)):
    """
    ููุงููุฉ ุงูุฃุฏูู: ููุนูู ุฒุฑ ุงูุญุฌุฒ ุนุจุฑ ุชุบููุฑ status ุฅูู approvedุ
    ููู ูุง ูููุณ is_verified (ุชูุนูู ุงูุจุฑูุฏ ูุจูู ุนุจุฑ ุฑุงุจุท ุงูุฅูููู ููุท).
    ููุง ูุฑุณู ุจุฑูุฏุงู ูููุณุชุฎุฏู:
      - ุฅู ูุงู ุจุฑูุฏู ููุนูุงู => "ุญุณุงุจู 100% โ ููููู ุงูุญุฌุฒ".
      - ุฅู ูู ููู => "ุชูุช ุงูููุงููุฉ โ ูุนูู ุจุฑูุฏู ูุฅููุงู 100%".
    """
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    user = db.query(User).get(user_id)
    if not user:
        return RedirectResponse(url="/admin", status_code=303)

    # ููุงููุฉ ุงูุญุณุงุจ (ุชุดุบูู ุฒุฑ ุงูุญุฌุฒ)
    user.status = "approved"

    # ูุง ูุบููุฑ is_verified ููุง โ ุชูุนูู ุงูุจุฑูุฏ ูุชู ููุท ุนุจุฑ /activate/verify

    # (ุงุฎุชูุงุฑู) ูุณู ูู ุงููุณุชูุฏุงุช ูู approved
    for d in (user.documents or []):
        d.review_status = "approved"
        d.reviewed_at = datetime.utcnow()

    db.commit()
    _refresh_session_user_if_self(request, user)

    # ุฅุฑุณุงู ุฅูููู ุจุญุณุจ ุญุงูุฉ ุชูุนูู ุงูุจุฑูุฏ
    try:
        home_url = f"{BASE_URL}/"
        logo = f"{BASE_URL}/static/images/ok.png"
        brand = f"{BASE_URL}/static/images/base.png"

        if bool(getattr(user, "is_verified", False)):
            # ุจุฑูุฏู ููุนูู => 100%
            subject = "ุชู ุชูุนูู ุญุณุงุจู 100% โ ููููู ุงูุญุฌุฒ ุงูุขู ๐"
            year = datetime.utcnow().year
            html = f"""<!doctype html>
<html lang="ar" dir="rtl">
  <head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ุชูุนูู 100%</title></head>
  <body style="margin:0;background:#0b0f1a;color:#e5e7eb;font-family:Tahoma,Arial,'Segoe UI',sans-serif;">
    <div style="display:none;max-height:0;overflow:hidden;opacity:0">ุชู ุชูุนูู ุญุณุงุจู 100% โ ููููู ุงูุญุฌุฒ ุงูุขู</div>
    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background:#0b0f1a;padding:24px 12px">
      <tr><td align="center">
        <table role="presentation" width="640" cellspacing="0" cellpadding="0" style="width:100%;max-width:640px;background:#0f172a;border:1px solid #1f2937;border-radius:16px;overflow:hidden">
          <tr>
            <td style="padding:20px 24px;background:linear-gradient(90deg,#111827,#0b1220)">
              <table width="100%"><tr>
                <td align="right"><img src="{brand}" alt="ุงุณู ุงููููุน" style="height:22px;opacity:.95"></td>
                <td align="left"><img src="{logo}" alt="Logo" style="height:36px;border-radius:8px"></td>
              </tr></table>
            </td>
          </tr>
          <tr><td style="padding:28px 26px">
            <h2 style="margin:0 0 12px;font-size:22px;color:#fff;">ูุฑุญุจูุง {user.first_name} ๐</h2>
            <p style="margin:0 0 12px;line-height:1.9;color:#cbd5e1">
              ุชูุช ููุงููุฉ ุงูุฃุฏููู ุนูู ุญุณุงุจูุ ูุญุณุงุจู ุงูุขู <b style="color:#fff">ููุนูู 100%</b>.
              ุจุฅููุงูู ุงุณุชุฎุฏุงู ูู ุงููุฒุงูุงุ ุจูุง ูููุง ุฒุฑ <b>ุงุญุฌุฒ ุงูุขู</b>.
            </p>
            <table role="presentation" cellspacing="0" cellpadding="0" border="0" align="center" style="margin:26px auto">
              <tr><td bgcolor="#16a34a" style="border-radius:10px;">
                <a href="{home_url}" target="_blank"
                   style="font-family:Tahoma,Arial,sans-serif;font-size:16px;line-height:16px;text-decoration:none;
                          padding:14px 22px;display:inline-block;color:#ffffff;border-radius:10px;font-weight:700">
                  ุงุจุฏุฃ ุงูุขู
                </a>
              </td></tr>
            </table>
            <p style="margin:0;color:#94a3b8;font-size:13px">ูุตูุญุฉ: ุญุฏูุซ ุตูุฑุชู ูุนุฑูู ุจููุณู ูุฒูุงุฏุฉ ุงูุซูุฉ ูุงููุจูู ุงูุณุฑูุน.</p>
          </td></tr>
          <tr><td style="padding:18px 24px;background:#0b1220;color:#94a3b8;font-size:12px;text-align:center">
            ุฅุฐุง ูู ุชุทูุจ ูุฐู ุงูุนูููุฉุ ุชุฌุงูู ุงูุฑุณุงูุฉ.
          </td></tr>
        </table>
        <div style="color:#64748b;font-size:11px;margin-top:12px">&copy; {year} RentAll โ ุฌููุน ุงูุญููู ูุญููุธุฉ</div>
      </td></tr>
    </table>
  </body>
</html>"""
            text = f"ูุฑุญุจูุง {user.first_name}\n\nุชู ุชูุนูู ุญุณุงุจู 100% ูููููู ุงูุขู ุงูุญุฌุฒ.\n{home_url}"
        else:
            # ุจุฑูุฏู ุบูุฑ ููุนูู => ูุญุชุงุฌ ุชูุนูู ุงูุจุฑูุฏ ูุฅููุงู 100%
            verify_page = f"{BASE_URL}/verify-email?email={user.email}"
            subject = "ุชูุช ููุงููุฉ ุงูุฃุฏูู โ ูุนูู ุจุฑูุฏู ูุฅููุงู 100%"
            year = datetime.utcnow().year
            html = f"""<!doctype html>
<html lang="ar" dir="rtl">
  <head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ุฃููู ุชูุนูู ุงูุจุฑูุฏ</title></head>
  <body style="margin:0;background:#0b0f1a;color:#e5e7eb;font-family:Tahoma,Arial,'Segoe UI',sans-serif;">
    <div style="display:none;max-height:0;overflow:hidden;opacity:0">ุชูุช ุงูููุงููุฉ โ ุฃููู ุชูุนูู ุงูุจุฑูุฏ ูุฅุชูุงู ุญุณุงุจู</div>
    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background:#0b0f1a;padding:24px 12px">
      <tr><td align="center">
        <table role="presentation" width="640" cellspacing="0" cellpadding="0" style="width:100%;max-width:640px;background:#0f172a;border:1px solid #1f2937;border-radius:16px;overflow:hidden">
          <tr>
            <td style="padding:20px 24px;background:linear-gradient(90deg,#111827,#0b1220)">
              <table width="100%"><tr>
                <td align="right"><img src="{brand}" alt="ุงุณู ุงููููุน" style="height:22px;opacity:.95"></td>
                <td align="left"><img src="{logo}" alt="Logo" style="height:36px;border-radius:8px"></td>
              </tr></table>
            </td>
          </tr>
          <tr><td style="padding:28px 26px">
            <h2 style="margin:0 0 12px;font-size:22px;color:#fff;">ูุฑุญุจูุง {user.first_name} ๐</h2>
            <p style="margin:0 0 12px;line-height:1.9;color:#cbd5e1">
              ุชูุช ููุงููุฉ ุงูุฃุฏููู ุนูู ุญุณุงุจู. ุจูู ุฎุทูุฉ ูุงุญุฏุฉ ูุฅููุงู ุงูุชูุนูู 100%: <b style="color:#fff">ูุนูู ุจุฑูุฏู</b>.
              ุงูุชุญ ุฑุณุงุฆู ุจุฑูุฏู ูุงุถุบุท ุนูู ุฑุงุจุท <b>ุชูุนูู ุงูุญุณุงุจ</b>. ุฅู ูู ุชุฌุฏ ุงูุฑุณุงูุฉุ ุชููุฏ ูุฌูุฏ Spam.
            </p>
            <table role="presentation" cellspacing="0" cellpadding="0" border="0" align="center" style="margin:26px auto">
              <tr><td bgcolor="#2563eb" style="border-radius:10px;">
                <a href="{verify_page}" target="_blank"
                   style="font-family:Tahoma,Arial,sans-serif;font-size:16px;line-height:16px;text-decoration:none;
                          padding:14px 22px;display:inline-block;color:#ffffff;border-radius:10px;font-weight:700">
                  ุชุนูููุงุช ุงูุชูุนูู
                </a>
              </td></tr>
            </table>
          </td></tr>
          <tr><td style="padding:18px 24px;background:#0b1220;color:#94a3b8;font-size:12px;text-align:center">
            ุฅุฐุง ูู ุชุทูุจ ูุฐู ุงูุนูููุฉุ ุชุฌุงูู ุงูุฑุณุงูุฉ.
          </td></tr>
        </table>
        <div style="color:#64748b;font-size:11px;margin-top:12px">&copy; {year} RentAll โ ุฌููุน ุงูุญููู ูุญููุธุฉ</div>
      </td></tr>
    </table>
  </body>
</html>"""
            text = (
                f"ูุฑุญุจูุง {user.first_name}\n\n"
                f"ุชูุช ููุงููุฉ ุงูุฃุฏูู ุนูู ุญุณุงุจู. ูุฅููุงู 100% ูุนูู ุจุฑูุฏู ูู ุฑุณุงูุฉ ุงูุชูุนูู.\n"
                f"{verify_page}"
            )

        send_email(user.email, subject, html, text_body=text)
    except Exception:
        # ูุง ููุณุฑ ุงูุทูุจ ุฅุฐุง ูุดู ุงูุฅุฑุณุงู
        pass

    return RedirectResponse(url="/admin", status_code=303)


@router.post("/admin/users/{user_id}/reject")
def reject_user(user_id: int, request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    user = db.query(User).get(user_id)
    if not user:
        return RedirectResponse(url="/admin", status_code=303)

    user.status = "rejected"
    for d in (user.documents or []):
        d.review_status = "rejected"
        d.reviewed_at = datetime.utcnow()
    db.commit()
    _refresh_session_user_if_self(request, user)

    # (ุงุฎุชูุงุฑู) ุฅูููู ุฑูุถ
    try:
        subject = "ูู ูุชู ูุจูู ุญุณุงุจู ุญุงููุงู"
        html = f"""
        <div style="font-family:Tahoma,Arial,sans-serif;direction:rtl;text-align:right;line-height:1.8">
          <p>ูุนุชุฐุฑุ ูู ูุชู ูุจูู ุญุณุงุจู ุญุงููุงู. ููููู ุฅุนุงุฏุฉ ุฑูุน ุตูุฑ ูุงุถุญุฉ ูุจุทุงูุชู ูุตูุฑุชู ุงูุดุฎุตูุฉ ุซู ุทูุจ ุงููุฑุงุฌุนุฉ ูุฑุฉ ุฃุฎุฑู.</p>
          <p><a href="{BASE_URL}/activate">ุฅููุงู ุงูุชูุนูู</a></p>
        </div>
        """
        send_email(user.email, subject, html, text_body="ูู ูุชู ูุจูู ุญุณุงุจู ุญุงููุงู.")
    except Exception:
        pass

    return RedirectResponse(url="/admin", status_code=303)


# ---------------------------
# ุงูุชูุซูู (Verification)
# ---------------------------
@router.post("/admin/users/{user_id}/verify")
def verify_user(user_id: int, request: Request, db: Session = Depends(get_db)):
    """
    ุฒุฑ ุชูุซูู ุงูุจุฑูุฏ ุงููุฏูู ุจูุงุณุทุฉ ุงูุฃุฏูู (ุฅู ุงุญุชุฌุชู).
    ูุง ุนูุงูุฉ ูู ุจููุงููุฉ ุงูุญุฌุฒ. ูุฐุง ูุถุจุท is_verified ููุท.
    """
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    admin = request.session.get("user")
    user = db.query(User).get(user_id)
    if not user:
        return RedirectResponse(url="/admin", status_code=303)

    user.is_verified = True
    if hasattr(user, "verified_at"):
        user.verified_at = datetime.utcnow()
    if hasattr(user, "verified_by_id") and admin:
        user.verified_by_id = admin.get("id")
    db.commit()
    _refresh_session_user_if_self(request, user)

    return RedirectResponse(url="/admin", status_code=303)


@router.post("/admin/users/{user_id}/unverify")
def unverify_user(user_id: int, request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    user = db.query(User).get(user_id)
    if not user:
        return RedirectResponse(url="/admin", status_code=303)

    user.is_verified = False
    if hasattr(user, "verified_at"):
        user.verified_at = None
    if hasattr(user, "verified_by_id"):
        user.verified_by_id = None
    db.commit()
    _refresh_session_user_if_self(request, user)

    return RedirectResponse(url="/admin", status_code=303)


# ---------------------------
# ูุฑุงุฌุนุฉ ูุซุงุฆู ูุฑุฏูุฉ (ุงุฎุชูุงุฑู)
# ---------------------------
@router.post("/admin/documents/{doc_id}/approve")
def approve_document(doc_id: int, request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    doc = db.query(Document).get(doc_id)
    if doc:
        doc.review_status = "approved"
        doc.reviewed_at = datetime.utcnow()
        db.commit()

    return RedirectResponse(url="/admin", status_code=303)


@router.post("/admin/documents/{doc_id}/reject")
def reject_document(doc_id: int, request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    doc = db.query(Document).get(doc_id)
    if doc:
        doc.review_status = "rejected"
        doc.reviewed_at = datetime.utcnow()
        db.commit()

    return RedirectResponse(url="/admin", status_code=303)


# ---------------------------
# ูุฑุงุณูุฉ ุงููุณุชุฎุฏู + ุทูุจ ุชุตุญูุญ
# ---------------------------
@router.post("/admin/users/{user_id}/message")
def admin_message_user(user_id: int, request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    admin = request.session.get("user")
    if not admin:
        return RedirectResponse(url="/login", status_code=303)

    thread = _open_or_create_admin_thread(db, admin["id"], user_id)

    first_msg = db.query(Message).filter(Message.thread_id == thread.id).first()
    if not first_msg:
        db.add(Message(thread_id=thread.id, sender_id=admin["id"], body="ูุฑุญุจูุง! ูุฑุฌู ุงุณุชููุงู/ุชุตุญูุญ ุจูุงูุงุช ุงูุชุญูู."))
        db.commit()

    return RedirectResponse(url=f"/messages/{thread.id}", status_code=303)


@router.post("/admin/users/{user_id}/request_fix")
def admin_request_fix(
    user_id: int,
    request: Request,
    db: Session = Depends(get_db),
    reason: str = Form("ูุญุชุงุฌ ุตูุฑุฉ ุฃูุถุญ ุฃู ูุซููุฉ ุตุงูุญุฉ.")
):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    admin = request.session.get("user")
    if not admin:
        return RedirectResponse(url="/login", status_code=303)

    user = db.query(User).get(user_id)
    if not user:
        return RedirectResponse(url="/admin", status_code=303)

    for d in (user.documents or []):
        d.review_status = "needs_fix"
        d.reviewed_at = datetime.utcnow()
        if d.review_note:
            d.review_note = f"{d.review_note.strip()}\n- {reason.strip()}"
        else:
            d.review_note = reason.strip()

    db.commit()

    thread = _open_or_create_admin_thread(db, admin["id"], user_id)
    fix_link = "/profile/docs"
    body = f"ูุฑุญุจูุง {user.first_name}ุ\nููุงู ููุงุญุธุงุช ุนูู ูุณุชูุฏุงุช ุงูุชุญูู:\n- {reason}\nูุฑุฌู ุงูุชุตุญูุญ ููุง: {fix_link}"
    db.add(Message(thread_id=thread.id, sender_id=admin["id"], body=body))
    db.commit()

    return RedirectResponse(url="/admin", status_code=303)


# ---------------------------
# ุฅุฏุงุฑุฉ ุงูุดุงุฑุงุช (Badges)
# ---------------------------
@router.post("/users/{user_id}/badges")
def set_badges(
    user_id: int,
    badge_purple_trust: str | None = Form(None),
    request: Request = None,
    db: Session = Depends(get_db)
):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    u = db.query(User).get(user_id)
    if not u:
        return RedirectResponse(url="/admin", status_code=303)

    u.badge_purple_trust = bool(badge_purple_trust)
    u.is_verified = u.badge_purple_trust
    db.add(u)
    db.commit()
    db.refresh(u)
    _refresh_session_user_if_self(request, u)
    return RedirectResponse(url="/admin", status_code=303)


# ---------------------------
# (NEW) ุฅุฏุงุฑุฉ ุตูุงุญูุฉ ูุชุญููู ุงููุฏูุนุฉ + ุฅุดุนุงุฑ
# ---------------------------
@router.post("/admin/users/{user_id}/deposit_manager/enable")
def enable_deposit_manager(user_id: int, request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    u = db.query(User).get(user_id)
    if u and hasattr(u, "is_deposit_manager"):
        u.is_deposit_manager = True
        db.commit()
        _refresh_session_user_if_self(request, u)
        # ุฅุดุนุงุฑ + ุฑุงุจุท ููุญุฉ DM
        push_notification(
            db, u.id,
            "ุชู ููุญู ุฏูุฑ ูุชุญููู ุงููุฏูุนุฉ",
            "ููููู ุงูุขู ูุฑุงุฌุนุฉ ุงููุฏุงุฆุน ูุงุชุฎุงุฐ ุงููุฑุงุฑุงุช.",
            "/dm/deposits",
            "role"
        )
    return RedirectResponse(url="/admin", status_code=303)


@router.post("/admin/users/{user_id}/deposit_manager/disable")
def disable_deposit_manager(user_id: int, request: Request, db: Session = Depends(get_db)):
    if not require_admin(request):
        return RedirectResponse(url="/login", status_code=303)

    u = db.query(User).get(user_id)
    if u and hasattr(u, "is_deposit_manager"):
        u.is_deposit_manager = False
        db.commit()
        _refresh_session_user_if_self(request, u)
        push_notification(
            db, u.id,
            "ุชู ุฅูุบุงุก ุฏูุฑ ูุชุญููู ุงููุฏูุนุฉ",
            "ูู ุชุนุฏ ุชููู ุตูุงุญูุฉ ุฅุฏุงุฑุฉ ุงููุฏุงุฆุน.",
            "/",
            "role"
        )
    return RedirectResponse(url="/admin", status_code=303)